<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#0f1f3d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Servis">
  <title>AC EURO &amp; Progresklima — Servis</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>


@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap');
:root{
  --navy:#0f1f3d;--navy2:#1a3a6b;--blue:#2d5fa6;
  --green:#6abf3e;--green2:#5aaf2e;
  --bg:#eef1f7;--card:#fff;--border:#d0d8e8;
  --text:#1a2540;--muted:#6b7a99;--lt:#8a9ab8;
  --err:#e74c3c;--warn:#f0a500;--locked:#f4f6fb;
  --brand:#0f1f3d;--brand2:#1a3a6b;--brand-accent:#6abf3e;--brand-accent2:#5aaf2e;
}
/* ── DARK MODE ───────────────────────────────── */
body.dark-mode {
  --bg:#0f1218;--card:#1a2030;--border:#2a3448;
  --text:#e2e8f0;--muted:#8896b0;--lt:#5a6a85;
  --locked:#141c2a;--navy:#1e3a5f;--navy2:#243d62;
}
body.dark-mode .topbar,body.dark-mode #topbar-accent { filter: brightness(.85); }
body.dark-mode .zcard { background:var(--card); border-color:var(--border); }
body.dark-mode .zcard:hover { background:#202838; }
body.dark-mode .zcard.active { background:#1e3050; }
body.dark-mode .list-panel { background:#141a26; }
body.dark-mode .detail-panel { background:var(--bg); }
body.dark-mode input,body.dark-mode textarea,body.dark-mode select {
  background:var(--card);color:var(--text);border-color:var(--border);
}
body.dark-mode .modal-box { background:#1a2030;color:var(--text); }
body.dark-mode .chart-wrap { background:var(--card);border-color:var(--border); }
body.dark-mode .stat-card { background:var(--card);border-color:var(--border); }
body.dark-mode .btn-ghost { background:var(--card);color:var(--text);border-color:var(--border); }
body.dark-mode .dsec { background:var(--card);border-color:var(--border); }
body.dark-mode .dsec-hdr { background:#202838;color:var(--text); }
body.dark-mode .stav-sel { background:var(--card);color:var(--text); }
body.dark-mode #tab-sklad table thead tr { background:#202838; }
body.dark-mode .recent-tbl th { background:#202838; }
body.dark-mode #sl-modal .modal-box { background:#1a2030; }
#dark-toggle {
  background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);
  color:rgba(255,255,255,.85);border-radius:7px;padding:5px 10px;
  cursor:pointer;font-size:14px;line-height:1;transition:background .2s;
}
#dark-toggle:hover { background:rgba(255,255,255,.2); }
/* Progresklima theme */
body.brand-progres {
  --brand:#0a3d8f;--brand2:#1254c4;--brand-accent:#1e90ff;--brand-accent2:#1678d4;
  --bg:#eef3fb;--border:#c5d5ee;
}
body.brand-progres .topbar { background:linear-gradient(135deg,#0a3d8f 0%,#1254c4 100%) !important; }
body.brand-progres .btn-next { background:#1e90ff !important; }
body.brand-progres .btn-next:hover { background:#1678d4 !important; }
body.brand-progres .progress { border-bottom-color:#c5d5ee; }
body.brand-progres .stab.active { background:#0a3d8f; color:#fff; }
body.brand-progres .panel .ph { border-left:3px solid #1e90ff; }
body.brand-progres #calendar-strip { border-bottom-color:#c5d5ee; }
/* AC EURO theme (default) */
body.brand-aceuro .topbar { background:linear-gradient(135deg,#0f1f3d 0%,#1a3a6b 100%) !important; }
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"DM Sans",sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* LOGIN */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0a1628 0%,#1a3a6b 50%,#0f2d1a 100%);padding:20px}
.login-card{background:rgba(255,255,255,.97);border-radius:16px;padding:40px 36px;
  width:100%;max-width:400px;box-shadow:0 24px 80px rgba(0,0,0,.35)}
.login-logo{height:44px;display:block;margin:0 auto 28px}
.login-title{text-align:center;font-size:20px;font-weight:700;color:var(--navy);margin-bottom:4px}
.login-sub{text-align:center;font-size:12px;color:var(--muted);margin-bottom:28px}
.login-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--muted);font-size:11px}
.login-divider::before,.login-divider::after{content:"";flex:1;height:1px;background:var(--border)}
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.fg label{font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted)}
.fg input{border:1.5px solid var(--border);border-radius:8px;padding:11px 14px;font-family:inherit;font-size:14px;color:var(--text);outline:none;transition:border-color .15s;width:100%}
.fg input:focus{border-color:var(--blue)}
.btn-login{width:100%;padding:13px;border:none;border-radius:8px;background:var(--navy);
  color:#fff;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-login:hover{background:var(--navy2)}.btn-login:disabled{opacity:.6;cursor:not-allowed}
.btn-google{width:100%;padding:12px;border:1.5px solid var(--border);border-radius:8px;
  background:#fff;color:var(--text);font-family:inherit;font-size:14px;font-weight:600;
  cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-google:hover{border-color:var(--blue);background:#f5f8ff}
.btn-google img{width:18px;height:18px}
.login-err{background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:10px 13px;font-size:12px;color:#b91c1c;display:none;margin-top:12px}

/* OFFLINE BANNER */
#offline-banner{background:#e67e22;color:#fff;text-align:center;font-size:12px;font-weight:600;
  padding:8px 16px;display:none;align-items:center;justify-content:center;gap:8px;flex-shrink:0}
#offline-banner.show{display:flex}

/* TOPBAR */
#app-screen{display:none;flex-direction:column;min-height:100vh}
.topbar{background:var(--navy);height:54px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.topbar img{height:32px}
.topbar-right{display:flex;align-items:center;gap:12px}
.user-badge{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,.8);font-size:12px}
.user-avatar{width:28px;height:28px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;flex-shrink:0}
.btn-signout{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);border-radius:6px;padding:5px 12px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-signout:hover{background:rgba(255,255,255,.2)}

/* PROGRESS */
.progress{background:var(--navy2);display:flex;overflow-x:auto;padding:0 16px;flex-shrink:0}
.stab{display:flex;align-items:center;gap:7px;padding:10px 14px;border:none;background:none;font-family:inherit;color:#fff;cursor:pointer;border-bottom:3px solid transparent;opacity:.5;transition:all .2s;white-space:nowrap}
.stab.done{opacity:.75}.stab.active{opacity:1;border-bottom-color:var(--green)}
.stab.done .snum{background:var(--green)}.stab.active .snum{background:var(--blue)}
.snum{width:20px;height:20px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.slbl{font-size:11px;font-weight:500}
.schk{font-size:10px;display:none}.stab.done .schk{display:inline}
@media(max-width:500px){.slbl{display:none}}

/* MAIN */
.main{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:24px 16px 80px}
.card{background:var(--card);border-radius:10px;box-shadow:0 4px 32px rgba(15,31,61,.10);width:100%;max-width:660px;overflow:hidden}
.panel{display:none}.panel.active{display:block;animation:fadeUp .2s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* STEP PARTS */
.ph{background:linear-gradient(135deg,var(--navy),var(--navy2));padding:20px 26px 16px;display:flex;align-items:flex-start;gap:13px}
.ph-icon{width:38px;height:38px;border-radius:9px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.ph h2{font-size:16px;font-weight:700;color:#fff;margin-bottom:3px}
.ph p{font-size:11px;color:rgba(255,255,255,.6);line-height:1.5}
.pbody{padding:22px 26px;display:flex;flex-direction:column;gap:15px}
.pfoot{padding:13px 26px 22px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border)}
.pctr{font-size:11px;color:var(--muted);font-weight:500}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 20px;border-radius:6px;font-family:inherit;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .15s}
.btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:var(--blue);color:var(--blue)}
.btn-next{background:var(--blue);color:#fff}.btn-next:hover{background:var(--navy2)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:var(--green2)}
.btn-green:disabled{opacity:.6;cursor:not-allowed}

/* FIELDS */
.fg2{display:flex;flex-direction:column;gap:5px}
.fg2 label{font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted)}
.fg2 input,.fg2 textarea,.fg2 select{border:1.5px solid var(--border);border-radius:6px;padding:10px 13px;font-family:inherit;font-size:14px;color:var(--text);outline:none;transition:border-color .15s;width:100%}
.fg2 input:focus,.fg2 textarea:focus{border-color:var(--blue)}
.fg2 input.err{border-color:var(--err)}
.ferr{font-size:10px;color:var(--err);display:none}.ferr.show{display:block}
.two{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:500px){.two{grid-template-columns:1fr}}
.fg2 textarea{resize:vertical;min-height:110px;line-height:1.6}

/* DOTTED LINES */
.dotlines-wrap{position:relative}
.dotline-row{height:32px;position:relative}
.dotline-row::after{content:"";position:absolute;bottom:4px;left:0;right:0;border-bottom:1.5px dotted #c8d4e4;pointer-events:none}
.dotlines-ta{position:absolute;top:0;left:0;right:0;background:transparent;border:none;outline:none;font-family:"DM Sans",sans-serif;font-size:13px;color:var(--text);padding:3px 5px;resize:none;overflow:hidden;z-index:2;line-height:32px}
.dotlines-ta:focus{background:rgba(45,95,166,.03);border-radius:4px}

/* ITEMS TABLE */
.items-tbl{width:100%;border-collapse:collapse}
.items-tbl thead tr{background:var(--navy)}
.items-tbl thead th{padding:7px 8px;font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:#fff;text-align:right}
.items-tbl thead th:first-child{text-align:left}
.items-tbl tbody tr{border-bottom:1px solid var(--border)}
.items-tbl td{padding:0}
.items-tbl td input{width:100%;border:none;border-left:1px solid transparent;outline:none;font-family:"DM Mono",monospace;font-size:12px;color:var(--text);padding:5px 8px;text-align:right;background:transparent;transition:all .15s;min-height:28px}
.items-tbl td:first-child input{font-family:"DM Sans",sans-serif;text-align:left}
.items-tbl td input:focus{background:rgba(45,95,166,.06);border-left-color:var(--blue)}
.items-tbl td.cel input{background:rgba(45,95,166,.05);color:var(--navy2);font-weight:600}
.sep-row td{padding:4px 8px;font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);background:var(--bg);border-top:2px solid var(--border)}
.total-bar{display:flex;align-items:center;justify-content:space-between;background:var(--navy);padding:9px 14px}
.total-bar span{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:rgba(255,255,255,.7)}
.total-bar strong{font-family:"DM Mono",monospace;font-size:16px;font-weight:700;color:var(--green)}

/* ASSIGNED BANNER */
.assigned-badge{background:rgba(106,191,62,.15);border:1.5px solid rgba(106,191,62,.4);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12px;color:#2d6b00}
.assigned-badge .ab-icon{font-size:18px;flex-shrink:0}

/* PHOTOS */
.photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px}
.photo-thumb{position:relative;border-radius:6px;overflow:hidden;border:1.5px solid var(--border);background:#fff;display:flex;flex-direction:column}
.photo-thumb img{width:100%;aspect-ratio:4/3;object-fit:cover;display:block}
.photo-del{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.55);border:none;border-radius:50%;width:20px;height:20px;color:#fff;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:background .15s}
.photo-del:hover{background:var(--err)}
.photo-add{aspect-ratio:4/3;border-radius:6px;border:2px dashed var(--border);background:var(--locked);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;transition:all .15s;font-size:11px;color:var(--muted);font-weight:600}
.photo-add:hover{border-color:var(--blue);background:rgba(45,95,166,.05);color:var(--blue)}
#photo-input{display:none}
.upload-prog{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px 14px;font-size:12px;color:var(--muted);display:none}
.upload-prog .bar{height:4px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden}
.upload-prog .bar-fill{height:100%;background:var(--green);border-radius:2px;transition:width .3s;width:0%}

/* SIGNATURE */
.sig-wrap{border:1.5px solid var(--border);border-radius:6px;overflow:hidden}
.sig-bar{background:var(--navy);color:#fff;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;padding:7px 13px;display:flex;justify-content:space-between;align-items:center}
/* Fullscreen signature overlay */
.sig-fs-overlay{position:fixed;inset:0;background:var(--navy);z-index:500;display:none;flex-direction:column}
.sig-fs-overlay.open{display:flex}
.sig-fs-bar{padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.sig-fs-bar span{color:#fff;font-size:13px;font-weight:700}
.sig-fs-canvas{flex:1;width:100%;cursor:crosshair;display:block;background:#fff}
.sig-fs-foot{padding:12px 16px;display:flex;gap:10px;justify-content:flex-end}
.sig-area{position:relative;height:90px;background:#fafbfd;cursor:pointer}
.sig-area canvas{position:absolute;top:0;left:0;width:100%;height:100%}
.sig-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:11px;color:#c8d4e4;pointer-events:none;transition:opacity .2s}
.sig-hint.hidden{opacity:0}
.sig-preview{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.sig-preview img{max-height:80px;max-width:100%;object-fit:contain}
.sig-foot{display:flex;align-items:center;justify-content:space-between;padding:6px 12px;border-top:1px solid var(--border)}
.sig-foot label{font-size:10px;color:var(--muted)}
.sig-foot input{border:none;border-bottom:1px dotted var(--border);font-family:inherit;font-size:11px;background:transparent;outline:none;width:110px;padding:1px 3px}
.btn-sigclr{background:none;border:none;cursor:pointer;font-size:10px;color:var(--muted);font-family:inherit;padding:3px 7px;border-radius:4px;transition:all .15s}
.btn-sigclr:hover{color:var(--err);background:#fef0ef}

/* PREVIEW */
.prev-wrap{border:1.5px solid var(--border);border-radius:8px;overflow:hidden}
.prev-hdr{background:var(--navy);color:rgba(255,255,255,.8);font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;padding:8px 14px;display:flex;gap:7px;align-items:center}
.prev-body{padding:14px 16px;font-size:12px;max-height:280px;overflow-y:auto;line-height:1.6}
.psec{margin-bottom:12px}.psec:last-child{margin-bottom:0}
.psec-title{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding-bottom:5px;border-bottom:1px solid var(--border);margin-bottom:7px}
.prow{display:flex;justify-content:space-between;gap:12px;padding:2px 0}
.prow .pl{color:var(--muted);flex-shrink:0}.prow .pv{font-weight:500;text-align:right}
.ptext{background:var(--bg);border-radius:4px;padding:7px 10px;font-size:11.5px;white-space:pre-wrap;line-height:1.65}

/* STATUS */
.status-box{border-radius:8px;padding:14px 16px;display:flex;gap:12px;align-items:flex-start}
.status-box.info{background:#f0f8ff;border:1.5px solid #bde0ff}
.status-box.success{background:#f0faf0;border:1.5px solid #b8e6b0}
.status-box.warn{background:#fffbf0;border:1.5px solid #f0d080}
.status-line{font-size:12px;color:var(--muted);text-align:center;padding:8px 0;min-height:30px}

/* PENDING UPLOAD BADGE */
.pending-badge{background:var(--warn);color:#fff;font-size:9px;font-weight:700;border-radius:20px;padding:2px 8px;display:none}
.pending-badge.show{display:inline-block}

/* PRINT */
@media screen{#print-container{display:none}}
@page{size:A4 portrait;margin:0}
@media print{html,body{width:210mm;margin:0;padding:0}body>*:not(#print-container){display:none!important}#print-container{display:block!important;width:210mm}*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}


/* ══ KANCELÁŘ EXTRA ══ */



*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"IBM Plex Sans",sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* LOGIN */
#login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#0a1628 0%,#1a3a6b 50%,#0f2d1a 100%);padding:20px}
.lcard{background:rgba(255,255,255,.97);border-radius:16px;padding:38px 34px;width:100%;max-width:380px;box-shadow:0 24px 80px rgba(0,0,0,.35)}
.lcard img{height:40px;display:block;margin:0 auto 24px}
.lcard h1{text-align:center;font-size:19px;font-weight:700;color:var(--navy);margin-bottom:3px}
.lcard .sub{text-align:center;font-size:11px;color:var(--muted);margin-bottom:26px}
.fg{display:flex;flex-direction:column;gap:5px;margin-bottom:13px}
.fg label{font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted)}
.fg input{border:1.5px solid var(--border);border-radius:7px;padding:10px 13px;font-family:inherit;font-size:14px;color:var(--text);outline:none;transition:border-color .15s;width:100%}
.fg input:focus{border-color:var(--blue)}
.btn-email{width:100%;padding:12px;border:none;border-radius:7px;background:var(--navy);color:#fff;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;transition:all .15s}
.btn-email:hover{background:var(--navy2)}.btn-email:disabled{opacity:.6;cursor:not-allowed}
.btn-google{width:100%;padding:11px;border:1.5px solid var(--border);border-radius:7px;background:#fff;color:var(--text);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-google:hover{border-color:var(--blue);background:#f5f8ff}
.btn-google img{width:18px;height:18px}
.divider{display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--muted);font-size:11px}
.divider::before,.divider::after{content:"";flex:1;height:1px;background:var(--border)}
.lerr{background:#fef2f2;border:1px solid #fecaca;border-radius:6px;padding:9px 12px;font-size:12px;color:#b91c1c;display:none;margin-top:10px}

/* APP */
#app{display:none;flex-direction:column;min-height:100vh}
.topbar{background:var(--navy);height:54px;padding:0 20px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.topbar-logo{height:30px}
.topbar-right{display:flex;align-items:center;gap:12px}
.badge-admin{background:rgba(106,191,62,.2);border:1px solid rgba(106,191,62,.4);color:#a0e070;font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;padding:3px 9px;border-radius:20px}
.user-info{display:flex;align-items:center;gap:8px;color:rgba(255,255,255,.8);font-size:12px}
.av{width:28px;height:28px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.btn-out{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);border-radius:6px;padding:5px 12px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-out:hover{background:rgba(255,255,255,.2)}

/* TABS */
.tabs{background:var(--navy2);display:flex;padding:0 20px;gap:4px;flex-shrink:0}
.tab-btn{padding:10px 16px;border:none;background:none;font-family:inherit;font-size:12px;font-weight:600;color:rgba(255,255,255,.6);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap}
.tab-btn.active{color:#fff;border-bottom-color:var(--green)}
.tab-btn:hover:not(.active){color:rgba(255,255,255,.85)}
.tab-panel{display:none;flex:1}.tab-panel.active{display:flex;flex-direction:column}

/* LAYOUT */
.layout{display:grid;grid-template-columns:340px 1fr;flex:1;min-height:0;height:calc(100vh - 98px);overflow:hidden}
@media(max-width:860px){.layout{grid-template-columns:1fr;height:auto}}

/* LIST PANEL */
.list-panel{background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.list-hdr{padding:14px 16px 10px;border-bottom:1px solid var(--border);flex-shrink:0}
.list-hdr h2{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:9px;display:flex;align-items:center;gap:8px}
.search-row{display:flex;gap:7px}
.search-inp{flex:1;border:1.5px solid var(--border);border-radius:6px;padding:7px 11px;font-family:inherit;font-size:12px;color:var(--text);outline:none;transition:border-color .15s}
.search-inp:focus{border-color:var(--blue)}
.filter-sel{border:1.5px solid var(--border);border-radius:6px;padding:7px 9px;font-family:inherit;font-size:11px;color:var(--text);outline:none;background:var(--card);cursor:pointer}
.date-filter{display:flex;gap:6px;margin-top:7px}
.date-filter input{flex:1;border:1.5px solid var(--border);border-radius:6px;padding:5px 9px;font-family:inherit;font-size:11px;color:var(--text);outline:none;transition:border-color .15s}
.date-filter input:focus{border-color:var(--blue)}
.date-filter label{font-size:9px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;display:flex;flex-direction:column;gap:3px;flex:1}
.list-scroll{flex:1;overflow-y:auto}
.list-status{padding:20px;text-align:center;font-size:12px;color:var(--muted)}

/* ZAKÁZKA CARD */
.zcard{padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;position:relative;border-left:3px solid transparent}
.zcard:hover{background:var(--blue2)}
.zcard.active{background:var(--blue2);border-left-color:var(--blue)}
.zcard.new-pulse{animation:newPulse .8s ease 2}
@keyframes newPulse{0%,100%{background:transparent}50%{background:rgba(106,191,62,.15)}}
.zcard-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:3px}
.zcard-title{font-size:13px;font-weight:700;color:var(--navy);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.stav-badge{font-size:9px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:2px 8px;border-radius:20px;white-space:nowrap;flex-shrink:0}
.stav-nova{background:#fef9ec;color:#b45309;border:1px solid #fcd34d}
.stav-kezprac{background:#e0f2fe;color:#0369a1;border:1px solid #7dd3fc}
.stav-rozprac{background:#fff7ed;color:#c2410c;border:1px solid #fdba74}
.stav-zpracovana{background:#f0faf0;color:#166534;border:1px solid #86efac}
.stav-fakturovana{background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd}
.stav-naceste{background:#fef3c7;color:#92400e;border:1px solid #fcd34d}
.stav-zaplacena{background:#d1fae5;color:#065f46;border:1px solid #6ee7b7}
.zcard-meta{font-size:11px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
.zcard-cena{font-family:"DM Mono",monospace;font-size:11px;font-weight:600;color:var(--navy2);margin-top:2px}
.offline-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--warn);margin-left:4px;vertical-align:middle;title:"Offline zakázka"}

/* DETAIL PANEL */
.detail-panel{overflow-y:auto;background:var(--bg);flex:1}
.detail-empty{display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:12px;color:var(--muted);font-size:13px}
.detail-empty svg{opacity:.3}
.detail-inner{padding:20px;max-width:760px;margin:0 auto}
.detail-hdr{background:linear-gradient(135deg,var(--navy),var(--navy2));border-radius:10px;padding:18px 22px;margin-bottom:14px;display:flex;align-items:flex-start;justify-content:space-between;gap:16px}
.detail-hdr-left h2{font-size:17px;font-weight:700;color:#fff;margin-bottom:4px}
.detail-hdr-left .meta{font-size:11px;color:rgba(255,255,255,.65);line-height:1.7}
.detail-hdr-right{display:flex;flex-direction:column;gap:8px;align-items:flex-end;flex-shrink:0}

/* DETAIL SECTIONS */
.dsec{background:var(--card);border-radius:8px;box-shadow:0 2px 12px rgba(15,31,61,.07);margin-bottom:12px;overflow:hidden}
.dsec-hdr{background:var(--navy);color:rgba(255,255,255,.85);font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;padding:8px 16px;display:flex;align-items:center;gap:7px;justify-content:space-between}
.dsec-body{padding:14px}
.drow{display:flex;justify-content:space-between;gap:12px;padding:4px 0;font-size:13px;border-bottom:1px solid var(--locked)}
.drow:last-child{border-bottom:none}
.dl{color:var(--muted);flex-shrink:0}.dv{font-weight:500;text-align:right}
.prace-text{background:var(--locked);border-radius:5px;padding:10px 12px;font-size:12.5px;white-space:pre-wrap;line-height:1.7;color:var(--text)}

/* CENY TABLE */
.ceny-tbl{width:100%;border-collapse:collapse}
.price-locked{pointer-events:none!important;user-select:none}
.ceny-tbl input.price-locked{background:rgba(250,250,252,.7)!important;color:#9aaac4!important;cursor:not-allowed!important}
.ceny-tbl thead tr{background:var(--navy)}
.ceny-tbl thead th{padding:7px 9px;font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:#fff;text-align:right}
.ceny-tbl thead th:first-child{text-align:left}
.ceny-tbl tbody tr{border-bottom:1px solid var(--border)}
.ceny-tbl td{padding:0}
.ceny-tbl td input{width:100%;border:none;border-left:2px solid transparent;outline:none;font-family:"DM Mono",monospace;font-size:12px;color:var(--text);padding:5px 9px;text-align:right;background:transparent;transition:all .15s;min-height:28px}
.ceny-tbl td:first-child input{font-family:"IBM Plex Sans",sans-serif;text-align:left}
.ceny-tbl td input:focus{background:var(--blue2);border-left-color:var(--blue)}
.ceny-tbl td.cel-col input{background:rgba(45,95,166,.05);color:var(--navy2);font-weight:600}
.sep-tr td{padding:4px 9px;font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);background:var(--bg);border-top:2px solid var(--border)}
.total-bar{display:flex;justify-content:space-between;align-items:center;background:var(--navy);padding:9px 14px;border-radius:0 0 6px 6px}
.total-bar span{font-size:10px;font-weight:700;color:rgba(255,255,255,.7);letter-spacing:.06em;text-transform:uppercase}
.total-bar strong{font-family:"DM Mono",monospace;font-size:16px;font-weight:700;color:var(--green)}
.duzp-row{display:flex;align-items:center;gap:10px;padding:10px 0 0}
.duzp-row label{font-size:11px;font-weight:700;color:var(--navy);white-space:nowrap}
.duzp-row input{border:1.5px solid var(--border);border-radius:5px;padding:6px 10px;font-family:inherit;font-size:12px;outline:none;transition:border-color .15s}
.duzp-row input:focus{border-color:var(--blue)}

/* PHOTOS */
.photo-grid-detail{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;padding:4px 0}
.photo-thumb-d{border-radius:6px;overflow:hidden;border:1px solid var(--border);aspect-ratio:4/3;cursor:pointer;transition:transform .15s}
.photo-thumb-d:hover{transform:scale(1.02)}
.photo-thumb-d img{width:100%;height:100%;object-fit:cover;display:block}

/* LIGHTBOX */
#lightbox{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:1000;display:none;align-items:center;justify-content:center;padding:20px}
#lightbox.open{display:flex}
#lightbox img{max-width:100%;max-height:90vh;border-radius:6px;object-fit:contain}
#lightbox-close{position:fixed;top:16px;right:20px;color:#fff;font-size:28px;cursor:pointer;background:none;border:none;line-height:1}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;border-radius:6px;font-family:inherit;font-size:12px;font-weight:600;border:none;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--blue);color:#fff}.btn-primary:hover{background:var(--navy2)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:var(--green2)}
.btn-green:disabled{opacity:.6;cursor:not-allowed}
.btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:var(--blue);color:var(--blue)}
.btn-red{background:var(--err);color:#fff}.btn-red:hover{opacity:.85}
.stav-sel{border:1.5px solid var(--border);border-radius:6px;padding:6px 10px;font-family:inherit;font-size:12px;color:var(--text);outline:none;background:var(--card);cursor:pointer}
.save-status{font-size:11px;color:var(--green);min-height:16px}

/* DASHBOARD */
#tab-dash{padding:20px;overflow-y:auto}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;margin-bottom:20px}
.stat-card{background:var(--card);border-radius:8px;padding:16px 18px;box-shadow:0 2px 12px rgba(15,31,61,.07)}
.stat-card .val{font-family:"DM Mono",monospace;font-size:26px;font-weight:700;color:var(--navy);line-height:1}
.stat-card .lbl{font-size:11px;color:var(--muted);margin-top:5px}
.stat-card .sub{font-size:10px;color:var(--lt);margin-top:2px}
.stat-card.green .val{color:var(--green)}
.stat-card.blue .val{color:var(--blue)}
.stat-card.warn .val{color:var(--warn)}

.chart-wrap{background:var(--card);border-radius:8px;padding:18px;box-shadow:0 2px 12px rgba(15,31,61,.07);margin-bottom:16px}
.chart-wrap h3{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:14px;letter-spacing:.04em}
.chart-bar-list{display:flex;flex-direction:column;gap:8px}
.cbl-row{display:flex;align-items:center;gap:10px}
.cbl-lbl{font-size:11px;color:var(--muted);width:110px;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cbl-bar-wrap{flex:1;height:18px;background:var(--bg);border-radius:4px;overflow:hidden}
.cbl-bar{height:100%;background:var(--blue);border-radius:4px;transition:width .5s ease;min-width:2px}
.cbl-val{font-family:"DM Mono",monospace;font-size:11px;color:var(--navy2);width:70px;text-align:right;flex-shrink:0}

.recent-tbl{width:100%;border-collapse:collapse}
.recent-tbl th{font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);padding:6px 10px;text-align:left;border-bottom:2px solid var(--border)}
.recent-tbl td{padding:8px 10px;font-size:12px;border-bottom:1px solid var(--locked)}
.recent-tbl tr:hover td{background:var(--blue2)}
.recent-tbl tr{cursor:pointer}

/* USERS PANEL */
#tab-users{padding:20px;overflow-y:auto}
.users-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.users-hdr h2{font-size:15px;font-weight:700;color:var(--navy)}
.user-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.user-row{background:var(--card);border-radius:8px;padding:14px 16px;display:flex;align-items:center;gap:14px;box-shadow:0 2px 12px rgba(15,31,61,.07)}
.user-av{width:36px;height:36px;border-radius:50%;background:var(--navy2);display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#fff;flex-shrink:0}
.user-info-cell{flex:1;min-width:0}
.user-info-cell .nm{font-size:13px;font-weight:700;color:var(--navy);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-info-cell .em{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.user-stats{font-size:11px;color:var(--muted);text-align:right;flex-shrink:0}

.add-user-form{background:var(--card);border-radius:8px;padding:18px;box-shadow:0 2px 12px rgba(15,31,61,.07)}
.add-user-form h3{font-size:13px;font-weight:700;color:var(--navy);margin-bottom:14px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
@media(max-width:600px){.form-row{grid-template-columns:1fr}}
.form-inp{display:flex;flex-direction:column;gap:4px}
.form-inp label{font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted)}
.form-inp input{border:1.5px solid var(--border);border-radius:6px;padding:9px 12px;font-family:inherit;font-size:13px;color:var(--text);outline:none;transition:border-color .15s}
.form-inp input:focus{border-color:var(--blue)}
.add-status{font-size:12px;margin-top:8px;min-height:18px}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:900;display:none;align-items:center;justify-content:center;padding:20px}
.modal-overlay.open{display:flex}
.modal-box{background:#fff;border-radius:12px;padding:26px;width:100%;max-width:420px;box-shadow:0 24px 80px rgba(0,0,0,.3)}
.modal-box h3{font-size:16px;font-weight:700;color:var(--navy);margin-bottom:16px}
.modal-foot{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

/* PRINT */
@media screen{#print-container{display:none}}
@page{size:A4 portrait;margin:0}
@media print{html,body{width:210mm;margin:0;padding:0}body>*:not(#print-container){display:none!important}#print-container{display:block!important;width:210mm}*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}


/* ══ PWA EXTRA ══════════════════════════════════════════════ */
* { -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overscroll-behavior: none; }
body { margin: 0; background: var(--bg); }

/* Safe area pro iPhone notch */
.topbar {
  padding-top: max(10px, env(safe-area-inset-top));
  padding-left: max(16px, env(safe-area-inset-left));
  padding-right: max(16px, env(safe-area-inset-right));
}

/* Přizpůsobení pro mobil */
@media (max-width: 600px) {
  .main { padding: 8px; }
  .card { border-radius: 12px; }
  .two { grid-template-columns: 1fr; }
  .pfoot { padding: 12px 16px; }
  .btn-next, .btn { min-height: 44px; }
  input, select, textarea { font-size: 16px !important; } /* Zabraň zoom na iOS */
  .login-card { padding: 28px 20px; margin: 16px; }
  /* Kancelář mobilní */
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .list-panel { max-height: none; }
}

/* Scrollbar styling */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* Animace přepnutí obrazovky */
#app-technik, #app-kancelar {
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Offline banner */
#offline-banner {
  display: none;
  background: #92400e;
  color: #fef3c7;
  text-align: center;
  padding: 6px 16px;
  font-size: 12px;
  font-weight: 600;
}

/* Kancelář badge fix */
.badge-admin {
  font-size: 10px;
  font-weight: 700;
  background: rgba(255,255,255,.18);
  color: #fff;
  padding: 3px 9px;
  border-radius: 20px;
  letter-spacing: .04em;
}

  
/* PWA Mobile */
* { -webkit-tap-highlight-color: transparent; }
html,body { height:100%; overscroll-behavior:none; margin:0; }
.topbar { padding-top:max(10px,env(safe-area-inset-top)); }
@media(max-width:600px){
  .main{padding:8px;} .card{border-radius:12px;}
  .two{grid-template-columns:1fr;} .pfoot{padding:12px 16px;}
  input,select,textarea{font-size:16px!important;}
  .login-card{padding:28px 20px;margin:16px;}
  .stats-grid{grid-template-columns:1fr 1fr;}
}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
#app-technik,#app-kancelar{animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
.badge-admin{font-size:10px;font-weight:700;background:rgba(255,255,255,.18);color:#fff;padding:3px 9px;border-radius:20px;letter-spacing:.04em;}
#offline-banner{display:none;background:#92400e;color:#fef3c7;text-align:center;padding:6px 16px;font-size:12px;font-weight:600;}

/* ══ SERVISNÍ LIST MODAL ══ */
.sl-panel { display:none; }
.sl-panel.sl-active { display:block; }
.sl-dot {
  font-size:10px;font-weight:600;padding:4px 10px;border-radius:20px;
  background:rgba(255,255,255,.12);color:rgba(255,255,255,.5);
  white-space:nowrap;cursor:pointer;transition:all .15s;
}
.sl-dot.sl-dot-active {
  background:rgba(255,255,255,.25);color:#fff;
}
.sl-dot.sl-dot-done {
  background:rgba(106,191,62,.25);color:#a0e070;
}
@media(max-width:700px){
  .sl-dot { display:none; }
  .sl-dot.sl-dot-active { display:inline-block; }
}
#sl-modal { z-index:950; }

/* ══ CHAT ══ */
#chat-messages-\3 { scrollbar-width: thin; }
/* ══ SKLAD / ŠABLONY ══ */
#tab-sklad table th { font-weight:700; color:var(--navy); }
#tab-sklad table td { vertical-align:middle; }
/* ══ MONTHLY CHART ══ */
#monthly-chart { max-height: 200px; }
/* ══ UNPAID ══ */
#unpaid-list { max-height: 400px; overflow-y: auto; }
  </style>
</head>
<body>

<!-- ══ LOGIN ══════════════════════════════════════════════════ -->
<!-- LOGIN -->
<div id="login-screen" style="display:flex">
  <div class="login-card">
    <img class="login-logo" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEA3ADcAAD/2wBDAAIBAQEBAQIBAQECAgICAgQDAgICAgUEBAMEBgUGBgYFBgYGBwkIBgcJBwYGCAsICQoKCgoKBggLDAsKDAkKCgr/2wBDAQICAgICAgUDAwUKBwYHCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgr/wAARCAEYAYEDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD987rSbS7GXDI39+JyjfmDWXe6H4stMzaB4pDY5EGowCRT7bl2sP1rdo615eMyfBYxXfNCX80JShL74tX9HdeRLipHG3vxA8W+GDv8V+BJnhHW80uTzUA9SpAI/Grug/F3wB4gIjtdfihkP/LG6/dtn054rpCoIwR271y3i/4QeDvFoeebTxbXLf8ALza4U59x0NfFZpl/iPk6dbJsVTxcV/y6xEVGXpGtSUVftz035yMZRxEdYO/k/wDNHURzRTIJIpFZWHDKcg06vDta8FfFH4WSG/0LVbiazXnzbZiQB/tIc4/lVzw7+0brtoVh8S6VHdIDgywHY/5dD+lfEYfx/wAlyvMf7N4rwVbLq/8AfXPTfmpxV2vNRcfMyWMjGXLVi4s9lormvDPxZ8E+JwI7bVlgmb/lhdfI34Z4P4GukDqwDKcg9CK/acmz/JOIcIsVlmJhWpvrCSkvR2ej8nZnXGcZq8XcWiiivXKCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigBGjVwVYZB6g1wXxB+B2keIVfUvDipZ3h5KjiOQ+47H3Fd9QRkYr5nirg/h3jPLJYHN8OqsHs38UX3hLeL80/J3WhE6cKkbSR8wazoOqeHb99N1i0eCZDyrDr7g9x71r+GPid4y8KMqWOqtLAP+Xe5+dce2eR+Fe3+MvA+ieNdONlqkADgfubhR88Z9j6e1eEeM/BWr+CdUaw1NMxtzBcKPlkX1Hv7V/A3iH4YcZeDGZrNclxNT6q3aNWDcZQ7Qq8tl5J25Zdk3Y82ph54d80Xoep+Evj14c1nba67EbCc4G5jujJ+vUfjXc291b3UK3FvOkiMMq6MCDXy6FBA5rZ8LeOfE3g+YSaRqTiPOWt5Dujb8O31FfacC/SmzbBOOG4no+2ht7WmlGovOUNIy+XI/U1p4trSZ9G0Vw/gn426B4hKWOsKLG6PA3t+7c+zdvoa7dXVxuQ5BHUV/Y/DHF/DnGOXrG5PiY1YdbbxfaUXaUX5NI7oyjNXixaKKK+kKCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACs3xV4W0rxdpMmk6rAGVhlHA+ZG7MD61pUVyY/AYPNMHUwmLpqdKonGUZK6ae6aE0mrM+bvGfg/VPBWsvpOoqSuSYJgPlkX1H9RWSGIGBX0T8QPA9j450J9NuMJMvzW02OY3/wPcV876vYX2hanNpOowmOaByrqfX/AAr/ADR8afCfEeG+eKphU5YKs26cnryvd05Puvst/FHXdM8fFQeHlfowD47V1ngT4v8AiDwey2ly5u7IcGCRuUH+ye306Vxgm96Xzq/MeHuJM94UzKOPymvKjVj1i9Gu0ltJPqpJowhiXB3TPpbwr400HxhYi90e8DkD95E3Dxn0IrWBB5FfLujeIdU8P3yalpF28EydGU9R6EdxXtXwz+MumeMFXStXMdrqAGAu7CTe657+1f3t4TfSCynjR08szlRw+Neie1Oq/wC638Mn/I3r9lvZenh8bTq+69GdxRQDmiv6RO0KKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAK8x/aI+Hp1XSD4y0iD/SbJP8ASlQcyRev1HX6V6dTZ4o54XhmQMrKQysOCCOlfK8acJZbxvw3XyjGr3ai0fWElrGS80/vV1s2ZVqUa9NwkfHo1LA+9+tKNUB6nJzxWl8bfBD/AA58bz6dEhFnc/v7Jv8AYJ5X8DkflXH/AG7HAav8rM74fxvD+b18txkeWrRk4yXmnuvJ7p9U0z5acJU5uMt0b51TAxmlj1eWORZYZSrKcqwOCK5/7fxy1BvgeCcgV5ioOLutxH0N8GPj9b6u0XhXxhcql0cLa3j8CX0Vj2b37162DkA18Of2gYyHjYgg5BHGK98/Z3+Py66YvAvjC6xdhdtjdyN/rgP4GP8Ae9D3r+1vA7xuq42VPh3iKpeppGjWl9rooTf838svtbPWzfs4LHOVqdR+j/zPZ6KAcjNFf10esFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAecftNeAh4v+H0up2cG680rM8RA5ZP41/Ln8K+VvNAP3q+7Z4IrmF7edAyOpVlI4IPBFfF/xV8IP4G8f6l4c2ERxXBa3JHWNvmX9Dj8K/i76T3CEcNmGG4ioR0q/uqn+KKvBvzcU16RR4+ZUUpKouuhhCX3P40eZ/tGo6K/k+yPLshxkzyP1p0N1PbzJcQSMjowZHU4KkdCDUdFUm4u6DY+qv2d/jLH8RtBGjazOBq9jGBMCf9enQSD39ff616VXw/4N8Wat4I8SWviXRpSs1tJnHZ17qfYivsrwR4u0vxz4YtPE+kSZiuYwSueUb+JT7g8V/oD4EeJsuMsmeWZhO+Mw6V296lPZT82vhn8n1PdwOJVaHLLdGtRRRX78d4UUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABXz9+2b4TWG70vxpBHgSqbW4YDuMspP4bvyr6BrhP2kvDf8Awknwh1SOOPdLaItzF6gocn/x3dX5t4u8Px4k8PcfhkrzjB1I9+an76t5tJx+ZzYuHtMPJfM+Rdy+tJ5gqsZ16k/rSG4T1Ff5k2Z8vzlrzVpvm/7VVjcqOlIbn0osyedFkyehJr2H9kn4n/2H4lfwFqtwRaakd1puPCTjt/wIfqBXiZn9F/OpLDVrvTL6LUbGby5reRZI3U8qwOQa+p4M4mxnB3EuGzbD705e8v5oPSUX6q/o7PoaUMS6NVTXQ/QCisD4Y+NLX4g+CNP8V2pGbq3BmUfwSDhl/MGt+v8AUvAY7DZngaWLw8uanUipRfdSV0/uZ9bGUZxUlswooorrKCiiigAoorl/i58RrL4Z+C7jxDMVa4P7qxhb/lpKRwPoOSfYV5+a5pgcly2rj8ZNQpUouUm+iWr+fZdXoiZSjCLk9kdRRXxfL8YfijNK0r+PNUBZiSFvHA59ADxSf8Ld+J//AEPurf8Agc/+NfzU/pT8N30y+t/4FD/M87+06f8AKz7Ror4u/wCFu/E//ofdW/8AA5/8aP8AhbvxP/6H3Vv/AAOf/Gl/xNPw5/0L6v8A4FD/ADD+06f8rPtGivi7/hbvxP8A+h91b/wOf/Gj/hbvxP8A+h91b/wOf/Gj/iafhz/oX1f/AAKH+Yf2nT/lZ9o0V8Xf8Ld+J/8A0Purf+Bz/wCNH/C3fif/AND7q3/gc/8AjR/xNPw5/wBC+r/4FD/MP7Tp/wArPtGivi3/AIW58T/+h+1b/wADn/xqex+NvxY0+UTW/j3USR2ln8wfk2RV0/pTcMOaU8BWS8nBv7rr80H9p0v5WfZdFeYfs3/GnV/ihZXmk+JYY/t+nqjm4iQKJkbIyQOAQRzjjkVs/Gv4xad8JtCScQLc6jdErZWpbAOOrt/sjP4nj3H7fg/EDhjGcHrib23LhOVtuSs1Z8ri1r73N7qSvd2te6O2NelKj7S+h21FfH+vftCfFzX7lp5fGFxbIT8sNkBEqj0+UZP4k1m/8Lc+J/8A0Purf+Bz/wCNfiuJ+lJwpTrONDBVpRWzbhG/y5n+ZxvM6V9Is+0qK+Lv+Fu/E/8A6H3Vv/A5/wDGj/hbvxP/AOh91b/wOf8Axrn/AOJp+HP+hfV/8Ch/mL+06f8AKz7Ror4u/wCFu/E//ofdW/8AA5/8aP8AhbvxP/6H3Vv/AAOf/Gj/AImn4c/6F9X/AMCh/mH9p0/5WfaNFfF3/C3fif8A9D7q3/gc/wDjR/wt34n/APQ+6t/4HP8A40f8TT8Of9C+r/4FD/MP7Tp/ys+0aK+Lv+Fu/E//AKH3Vv8AwOf/ABrpvhJq3xb+J3jS38PxePNYW2U+bfzC9f8AdxA89+p6D3NehlX0k8pzrMqOAweWVpVaslGKUoatu3fbu+i1KjmMJyUVF3Z9V0Vl/wDCM2P/AD3u/wDwYS//ABVFf0N7fH/8+o/+Bv8A+QO/3uxqUUUV6BQUUUUAFFFFABRRRQAUUUUAFVdasItV0m50yddyXEDxuCOzKR/WrVIxwKirThVpyhNXTVn6MGro/PjWUl0jV7rSp8B7a4eJh6FWI/pVb7acckVvftE6ePD3xr8R6cPlU6i0qjHZ8OP/AEKuKN72D9+1f5OZ3lzyrOcTgnvSqTh/4DJr9D89rVfZ1ZQ7No1Wu8/x0n20D+L9KyTej++aPtvP3jXl8qMXiDUN2P71NN4MdeayzeL3zSG754NHKhfWGfUn7Cfj/wC0war8PrqbJjIu7RSex+VwPyU/ia+ietfCH7MPjY+E/jbol08m2K7ufsc3P8Mvyj/x4g/hX3eORmv9Afo78QSzjgGOEqO88LOVP/t12lH7ruK8on2GSYn2+Ds94u36hRRRX7yeyFFFFAB9K8q+NXwK8Y/FrX4rweLbW1sbWLba2jQuxBP3mODgkn9AK3vi/wDHLw58JrdILmE3mozrugsY3CnbnG5m52j8CTXjGrftf/E+9mLabaabZx5+VVty7Ae5ZufyFfhXirx54XU6Msg4gqzqu6c6dLmurapTlFxXZ8rlvZtbHFiq+GS9nUd/JGr/AMMV+I/+h3sv/AR/8aX/AIYr8R/9DvZf+Aj/AONc5/w1h8Y/+gpZ/wDgAlL/AMNYfGP/AKCll/4AJX4H/av0af8AoAxX/gUv/lxwc2Xfyv8Ar5nRf8MV+I/+h3sv/AR/8aP+GK/Ef/Q72X/gI/8AjXO/8NYfGP8A6Cll/wCACUf8NYfGP/oKWX/gAlH9q/Rp/wCgDFf+BS/+XBzZd/K/6+Z0X/DFfiP/AKHey/8AAR/8aP8AhivxH/0O9l/4CP8A41zv/DWHxj/6Cll/4AJR/wANYfGP/oKWX/gAlH9q/Rp/6AMV/wCBS/8Alwc2Xfyv+vmb837FvihEJh8Z2DNjhWt3UH8ea8h1/Rbvw5rd3oF+0Zns7hoZTE25SynBwe4rvZf2rPjFLG0Z1a0G5SMrYoCPcV5zNNLcTPcTyF3dizuxyWJ5JNfnfH+M8L8TSoLhPDVqUk37R1G2mrKySc563vd3VuzvphXeGaXskxtGKK9F/Zx+FR+IfjAalqlvu0vTGWS53DiV8/LH79Mn2HvXyHDfD+YcU55QyvAxvUqySXZLrJ+UVdvyRjTpyqzUY7s9V/Zz8DW/ws+H13458Tv9nmvrcXFwZBjyLdQSoPuckn6gdq8I+KnxBv8A4l+M7rxLdlliY+XZwk/6qEfdH16k+5Nep/tafFUOyfDDRLgbV2y6qyHv1SLj/vo/8Brwmv1zxg4hwGW4fDcD5NL/AGXBfxH/AM/K2rk3/hbd+nO5L7KOvF1IxSoQ2j+YVb0PQ9V8SatBoeiWbXF1cybIYk6k/wBB71Ur6M/ZO+FH9i6Q3xF1u2Iur+Pbp6OvMcJ6v9W7e31r4Pw44HxfH/FFLLad40/iqTX2YLd+r0jHza6JmGHoOvVUenU5XTP2MvHNzbrLqfiXTrZ2GTGgeTHsTgVa/wCGKvEn/Q72X/gK/wDjX0QOBiiv7VpfR58L6dNRlhpyfd1al39zS+5I9hZfhl0/Fnzv/wAMVeJP+h3sv/AV/wDGj/hirxJ/0O9l/wCAr/419EUVp/xL54W/9Akv/BtX/wCSD6hhu34s+d/+GKvEn/Q72X/gK/8AjR/wxV4k/wCh3sv/AAFf/Gvoiij/AIl88Lf+gSX/AINq/wDyQfUMN2/Fnzv/AMMVeJP+h3sv/AV/8a9T+Cnwgs/hLoEtk1wlzfXMm67u0TaGA+6o74A/Umu1or6Hhjwj4D4QzVZjlmGcayTScpzla+jspNpO2l97NrqaUsJQpS5orUMD3/Oiiiv0o6QooooAKKKKACiiigAooooAKKKKACiiigD4k/bksxpnx6up1GBdWFvL9Tt2n+VeOm65zuNe5/8ABQ6AQfFvTblf+WuiJn6iRxXgJkwetf5leKuGjhfEbNIL/n9J/wDgXvfqfmWbS9nmVWPn/wAEtm6I6MTSfacnkmqnm855oMmeua/P7I872haNyAeho+0+gNVPMHpR5g6EUxe0NDS9Xm0vUrfU7c7ZLedJUI7FWBH8q/S7w7qcetaBZaxEwZbq0jlUjvuUH+tfmD5nrX6Jfs36u2t/A3wvfs+T/ZUaHn+5lf6V/VH0XcwlDNsxwV9JQhP/AMBk4v8A9LR9XwrWvWqQ7pP7v+HO4ooor+zD7QKzfF3inS/Bvh288SazLst7SEu3PLHso9ycAfWtIkAZNfNn7V/xVPiHXx4A0e4zZ6c+b1lPEk/933Cj9SfQV+feJvHOG4B4Vq5hJp1X7lKL+1UadvlHWUvJW3aMMTXVCk5deh5p438X6p478UXninV5My3UuQueI0HCqPYDArJoor/MjGYvE4/F1MTiJOVSbcpSe7k3dt+rPm23J3Zc0Lw9rfifUk0fw9pc15cyfdhhTJx3J9B7mu0j/Zg+NMiB/wDhFY1yOjahBn/0Ot39mn4nfDH4cWd/L4reWDULmVQtyLZpAYgOFG3JHzZJ4549K9U/4ak+Co/5meT/AMAZf/ia/oHw/wDDnwpzfh2njeIM5jTrzu/ZxrUqbgk7JSU4yk5O1+i1sr7vvoYfCypp1J6+p4h/wy78af8AoWIf/BjD/wDF0f8ADLvxp/6FiH/wYw//ABde4f8ADUnwW/6GeX/wBl/+Jo/4ak+C3/Qzy/8AgDL/APE19v8A8Qp+j9/0PP8Ay5w//wArNvq2A/n/ABR4f/wy78af+hYh/wDBjD/8XUd1+zN8YLK2kvLzw/bxRRIXlkfUoQFUDJJO7pivdP8AhqT4Lf8AQzy/+AMv/wATXn37Qf7RWgeK/DKeE/h/qMksd23/ABMbgwtHhB0jG4AnPf2GO9eJxH4f+AuR5JXxtDNZ15wjeNOGIoSlOW0UlGm3a7V30V2RUoYGEG1K/wA0eHEYOM9KKKK/lo8wtaJo2o+IdXttD0m2aW5uphHDGvdj/T3r6ivrjQf2a/g4sVuEkukTbHnrdXbDlj3wOvsoxXKfsm/CtbCyf4n69bgSTIyaaJB9yP8Aik/HGAfTPrXnf7QXxSb4k+NHSwnLaZpxaGxAPD8/NJ/wIjj2Ar+kuGKcPCTw8nxLXilmOPThhoveFN6upbzVpdf+Xa+0z0aa+qYf2j+KW39f10OJ1LUb3V9Qm1TUrhpbi4lMk0rnlmJyTUFFFfzfUqTqzc5u7erb1bb6s87c7T4F/C+b4neNYrK4jb+zrTE2oSD+4DwgPqx4+mT2r69t7eG0gS1tolSONAsaKMBQBgADsK8F+AXxn+D3w98ER6RqU9xaahJKz38jWrOJWycEFc8BcAD613f/AA1J8Fv+hnl/8AZf/ia/ubwTxfh1wVwlCdbM8OsViLTq3qwTjp7tOzaa5E9dPiculj28G8PRpayV3uehUV57/wANSfBb/oZ5f/AGX/4mj/hqT4Lf9DPL/wCAMv8A8TX7J/xEfw//AOhth/8AwdT/APkjr+s4f+dfeehUV57/AMNSfBb/AKGeX/wBl/8AiaP+GpPgt/0M8v8A4Ay//E0f8RH8P/8AobYf/wAHU/8A5IPrOH/nX3noVFeef8NS/Bb/AKGeX/wBl/8Aia7vSdUtda0yDV7Hf5NzEJIjJGUYqRkEg8j8a9fKOKOG8/qSp5ZjKVeUVdqnOM2l3fK3YuFWnU+F3LFFFFe6WFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAHxz/wUa4+JmiFep0Y5/wC/hr533EjAzXsP/BUX/gox/wAE0/2PvjPovgL9tGDxc/iDUPDy32mnQNMlmi+yGaRBkpIoDb0bjHTFfM4/4Lnf8EDAMmz+JX/ghuf/AI/X8p8c/Rv8SOMOLMXnOAjT9jXlzRu53typa2ptbro2fCZplVXEY+pUVSCu9m9dvQ7fkjHFKQcfrXDj/gub/wAEDOpsviV/4Ibn/wCP0H/guf8A8EC8f8evxK/8ENz/APH6+S/4lK8Wv5aP/gVT/wCVHB/Ylb/n7D/wJ/5Hb4LHNKV3EEVw3/D87/ggYDg2nxK/8ENz/wDH6X/h+h/wQMHS0+JX/ghuf/j9P/iUnxa/lo/+BVP/AJUH9h1v+fsP/An/AJHcBTnIOPavvn9jG5Nz+zvoJZs7BOg/CV6/M7/h+h/wQL7WfxK/8ENz/wDH6/Rz9gD48fs+/tLfsvaD8Yv2XotVTwXqc10NLXWbZorjMc7xyFlZmIG9Wxz0xX6h4TeB3HXhpxFUzPOFTVKdN01yubfM5QkvihFWtF9T3Mgy6pg8W5ynF3jbR36ryPaaKKK/og+uEfpwM18afF7wV4g8F+OtQttctZAs93JNbXBB2zIzEhge/Xn0NfZlV9R0rTNYtzaarp8NzEesc8QdT+Br8r8VfDKj4l5VRoe3dGrRk5Qlbmj7ySakrreys07rszmxWGWJile1j4Tor7Rf4Q/CyRtz/DzRie5/s2P/AOJpP+FPfCr/AKJ3o3/guj/wr+d39FniW+mYUv8AwGf+R5/9mVP5kfF+cUV9of8ACnvhV/0TvRv/AAXR/wCFH/CnvhV/0TvRv/BdH/hS/wCJWeJv+g+j/wCAz/yD+zKv8yPi+ivtD/hT3wq/6J3o3/guj/wo/wCFPfCr/onejf8Aguj/AMKP+JWeJv8AoPo/+Az/AMg/syr/ADI+L6K+0P8AhT3wq/6J3o3/AILo/wDCj/hT3wq/6J3o3/guj/wo/wCJWeJv+g+j/wCAz/yD+zKv8yPi+ut+DPw1uvif41g0YIws4f3uoSgfdiHb6seB9c9q+o/+FPfCr/onejf+C6P/AArS8P8AhDwt4UEq+GvD9nYCYgyi0t1j346Z2jmvZ4e+jDjcJnVCvmuLp1MPCSc4RUryS15bvZN6Pra9tS6eWtTTlJNDda8PLdeD7rwzo+218zT3trbYMCIFCq4x0A4r4y8U+DfE3gvU30nxLpE1rMjEDeh2uPVW6MPcV9wkZGKgvdOsNRhNtqFnFPGesc0YZT+Br9h8UvCHB+I9LDyhiHQq0E4xfLzQcXbRxvG1raNPRbp6W68VhI4hLWzR8JDnpRX2nN8JvhjcMXn+H+jMT1J02L/4mmf8Ke+FX/RO9G/8F0f+Ffg8vos8Rp+7mFK3+GZw/wBmVP5kfF9FfaH/AAp74Vf9E70b/wAF0f8AhR/wp74Vf9E70b/wXR/4VP8AxKzxL/0H0f8AwGf+Qf2ZU/mR8X0V9of8Ke+FX/RO9G/8F0f+FH/CnvhV/wBE70b/AMF0f+FH/ErPE3/QfR/8Bn/kH9mVf5kfF9FfaH/CnvhV/wBE70b/AMF0f+FH/CnvhV/0TvRv/BdH/hR/xKzxN/0H0f8AwGf+Qf2ZV/mR85fs6fClviN4wF9qdvu0vTGWS63DiV/4Y/fOMn2HvX1gihFCqMADgCqWheG9A8MWpsfDujW1jCzl2itYVRSx4zgDrwKvV/SXhb4dYXw54f8Aqikp16j5qk0rcz+ylfXlitEu7b0vY9HDUFh6dt31Ciiiv0s6AooooAKKKKACiiigAooooAKKKKACiiigAooooA/nf/4PEdJkt/2zfhjrRQ7bn4dSRBvUx3spP/oYr8girH+Kv3F/4PJvAEzeIPgj8Tktz5Zs9X0t5QONwaCUA/gT+tfiAYCe1fuHCrVTIKDXZr7pM+LzN8uOmn/WiIcHuf1pCh+tT/Zz6UfZzX0PKzg50QbDjJ60hRvSp/s7eho8hs4o5WPmRBtNf1af8G3TRt/wR/8AhZ5Y6HUwfr9vnzX8qQhJ7Gv6lv8Ag2O1pdX/AOCQ/gW1DZbT9a1i2k9j9tkcD8nFfE8eQ/4SIP8Avr8pHsZLJPFteX6o/QKiiivyQ+qCgkAZNFcj8fPi94c+AXwT8WfGzxbMqad4U8PXeq3W4/fWCJpNg9WYqFA6kkCtKVKpXqxp01eUmkl3b0SJnONODlLZanwr/wAFD/8Ag4m+CP7Evxx1L9nrwT8G9Q8fa/oLLF4guY9aSxs7KdlDmAP5UrSuoYbgFAU5GSQQPnz/AIi3Lf8A6Maf/wAOAP8A5Cr8gfip8RPEXxd+JniD4qeLrtp9U8R6zc6lfysfvSzStI34ZY8ele7/ALMP/BIL/goT+2F8NYPjF8BvgG+peGbuaSKz1e916wsUuWjco/lrcTo7qGBXcF25BGcg1/WEPDLw8yPKqUs2jFSslKc6soJztrb3ox72S6I/JpcT8RY7FyWEba1ajGKbS+5v1Z+g/wDxFuW//RjT/wDhwB/8hUf8Rblv/wBGNP8A+HAH/wAhV8gf8Q7P/BWj/o3Gw/8AC40j/wCSq574rf8ABCb/AIKgfBn4daz8VPG/7OcaaN4f06a/1eay8VaZcyQW0SF5JBFHcM7hVUkhQTgHiuanwt4K1aihCdFtuySxErtvZfxDSWacawi5OM7L/p2v/kT7ii/4O3LLzV8/9hqXZn5tnxAGce3+hV+gP/BNj/gqD8Df+Clnw61Pxb8MtI1DQ9Y8PzRxeIfDWrOjTWnmBjHIsifLLE21gGABypBUcZ/lfr9KP+CO3xE1n9jT/gn1+0/+3DLctamTTLDwv4SLHH2jVZPMClB3MZuYnPsG9DXFxv4XcK4XI3Uy2i6ddzhGHvykpOc4xs1Jy6Nu6ta3a5tkfFGa1cdy4mfNTSk3olZJN30S7H1J+0B/wdNeEvhJ8cPFvws8H/soN4l0zw34gutMtPEC+NBAuoCCVojOsf2R9qsVJX5jwQe9fSn/AASY/wCCtviP/gqHrHjF7f8AZrbwbo3hC3tRNqr+JftoubmdpNsKr9njxhI3YnJxlePmFfzRTTS3M7XE8rO8jlndzksSckk9zX9L3/BAT9lpf2aP+CcfhS+1bTPI1vx7I3ifVS64cLcKotkPpi3SI47F29TXj+I/BnBvCXCynh6H+0TcYRk5zeq1lLl5rbJ9LJtHZw3nOc5vmrjUqfu0m2rL0Sva+/n0PtekbAHNLXjP/BQj9pSx/ZH/AGMPiH8f7i5SO50Lw9KNKDn79/MRBarjvmaSP8M1+A4TC1sdi6eGpK85yUUu7bsvxZ+g1qsKFKVSe0U2/RanwL+07/wdB+EvgP8AtCeMPgr4R/ZXbxRY+FdeuNKTX18Zi3W9eBzHI6x/ZXwu9WA+Y5AB717p/wAEof8Agsf4j/4KgfEfxP4W0/8AZgfwlpHhTR4rrUNcbxR9tBnmk2wwBPs0eCypM2d3Hl9Dnj+bnUtQvdW1CfVNSuXmuLmZpbiaQ5aR2OWYnuSSTX9Gn/BuJ+y2vwB/4J7af8RdZ03yda+Juovrtw7rhvsQHlWa/Qxq0o/67mv6B8QuCuDOEuEfa0qH+0S5YRk5z1lvKVua2yb2sm0fnvD2dZzm2b8kqn7tXk1ZbdFe192j6H/by/4KJfs4f8E8vhpB8Qfjxr1wbnUXeLQfD2mRiS+1OVACwjQkAKuV3SMQq7gM5IB/OXWf+Dtnw9HqMieH/wBiG9ltFYiKS98dpHI47EqtowU+wY/Wvib/AILz/tWTftRf8FE/FkWmau1xoHgVh4Z0NFfMf+js32iRR0y1w0vzdwq9gK+eP2Z/2R/2jv2xfHLfDn9mz4Uaj4p1WKHzbmO0aOKK2jzgPNNKyRRKTwC7DJ4GTXqcK+FnCmH4bp4/PI3nKKnJym4Rgnqlo42srXbb17HLmvFOa1MylQwLsk7KyUnJr1T+Vj9Vv+Ity3/6Maf/AMOAP/kKj/iLct/+jGn/APDgD/5Cr4/H/Buz/wAFaCAf+GcbDn/qeNI/+SqX/iHZ/wCCtH/RuNh/4XGkf/JVdn+rPgl/z9o/+FEv/lhj/aXG38s//Bf/ANqfX/8AxFuW/wD0Y0//AIcAf/IVTad/wdkz61qNvo+l/sHzT3V3OkNtBH4+y0kjMFVQPsXJJIFfHX/EOz/wVo/6NxsP/C40j/5Kr3b/AIJp/wDBAL9tzwB+2z4C+JX7VnwdsdH8FeGNXGr306+JbC7Ms9upltovKgmdiDOsWeMbQ2fSuTH5F4K4PA1a8JUpuEW1GOIk3JpXSSVS7b2RtQx3GtatGDU0m0rumkl5v3T9rfGfxu8M/Bv4DXXx3+O08HhvT9G8PrqfiQGYzLYny1Z4lYKDKQ52LhQXOMDJxX5Z+PP+Ds/4e6d4ourH4cfsc6rqukRSlbTUNW8XR2k06g8OYUtpRHn03sa7n/g6R/aj/wCFd/sqeGv2YdC1LZf/ABB1sXWqwq3J02yKyYPs1wYMf9cmr8HvDvh3XvF2vWXhbwvo9zqGpajdJbWFjZwmSW4mdgqRoo5ZiSAAOua8Twz8OcizrIpZpm9NyU5PkXNKMVGOl9Gnvdau1kdvE3EePwWOWFwkrWSu7Jtt9NU+lj9kP+Ity3/6Maf/AMOAP/kKj/iLct/+jGn/APDgD/5Cr440n/g3p/4Kz6tpkGpr+zNBAs8YkWG68ZaTHIoIyAym6yp9jyOhwasH/g3Z/wCCtAGT+zjYf+FxpH/yVX0z4Z8E07e0o/8AhRL/AOWHmLM+Nmvhn/4L/wDtT6//AOIty3/6Maf/AMOAP/kKus+C/wDwddfB3xZ47sfDvxl/Zb1fwto93cLFPrum+JU1D7ICQN7wm3iLIOpKsTgcKa/JD9rv9h39pv8AYW8Z6b4D/ac+HP8Awj2o6vp/23TFj1K2u47iEOULLJbyOuQwIKkhhwcYIJ8z8MeHtV8W+JLDwroVm9xfanexWllbxLlpZZHCIoHcliB+NexDwv8ADjMMD7bDUU4SV1ONWbXqnzuLt80cb4o4jw9fkqT95PVOKXyeiZ/XJ/w1t+zR/wBFu8Nf+DNP8aK/Mf8A4hrr/wD6K3q//gzor8G/1e8Pv+hrL/wX/wAE+7/tHiL/AKBV/wCBP/I/X6iiivzc+nCiiigAooooAKKKKACiiigAooooA/Ln/g7I+Dc3j7/gndovxKsrUvL4M8fWs8zqOVt7iGWBvw3tF+Qr+b/7GTyP5V/Yh/wU1/Z8/wCGo/2C/il8EobYTXereE7l9MQrn/S4R50OPfzI1r+QWWwkhlaGSIhlYqwI6EV+yeHlZYjKZ0XvCX4S1X43PieJE6OMjPpJfl/SMk2ZPX+VJ9jPYfpWr9jJH3cfhQbQ9kr7/wBgfO/WTKNoTz/SkNmw64rW+wkj7lH2LnG0flR7APrLMn7G/wDdH5V/SH/waX+Ml1r/AIJwa54QebdJoXxIvl25+6k1vbSKPz3H8a/nT+wNj7lfuF/wZ+/EZU0b4yfBuabDJdabrVvFnqGWSCQ49tsY/GvkOOcI58O1JL7Li/xt+p7OQYpf2lGPdNfhf9D9r6KKK/Cz78K/NL/g54/ahPwj/Yo074BaLqJi1T4ma4sNxGj/ADDTrQpNMfYNJ5Ce4LD1r9LGbaM4zX83P/BxT+1D/wAND/8ABRXWfB+kah5ujfDfTovDtmqPlDcqTLduP9rzZDGT/wBMB6V+k+FGSf2zxjRlNXhQvUfrH4f/ACZp+iZ81xZjvqeTzSes/dXz3/C58HE5NfrP+y3/AMHLvgX9lv8AZ48G/s+eFP2MLmaz8JeH7bThc/8ACYKn2mREHmTlfsx2mSTe5GTgua/PT9kb9hv9pj9ubxTqvg79mn4fHXr3RLBbzU1e+ht0hiZwikvKyrkseFBycE9jXvX/ABD1/wDBVr/o3i1/8Kqw/wDj1f0nxXDgbNnHBZ5Xp3pvmUZVeRptbtKUXttfufmuUyz3CXr4GEve0uo836M+z/8AiLa0f/oyi5/8LRf/AJGrzj9rn/g5w1L9o39mrxr8CPBv7Ms/hi98X6BPpJ1xvFIuPs0M6+XMQggUkmJnUfMMFs9q+d/+Iev/AIKtf9G8Wv8A4VVh/wDHqP8AiHr/AOCrX/RvFr/4VVh/8er5LD8O+DWFxEK1OrR5otNfv29U7rR1Gn6PQ9apmPGdWm4SjOzVv4ff/t0+KlVpGCIpJJwAByTX6Cf8FRXX9kf9gX9nv/gnJprCDV5NIbx98RYkOHOoXm/7PFL6mNZJUwe0cZ54Nb37Gn/Bvx+3HpP7UvgbXv2m/hDZaN4C0rX4dQ8T30viCzmUW1vmYxlI5GYiQoIzgcb8nAGa+U/+CmP7TUn7Xn7cfxD+OEN00mnXuuvZ6CuflTTrVRb220fwgxxK5A/idj1NfWf2jgOJuI8PSwdWNWlh06snFqS53eFNNrS6TnK3dRfY8pYbEZZl1SdaLjOpaKTVnyr3pPX/ALdXzZzX7E37Ouq/tZftX+A/2e9LjkI8TeIoLe+ljHMNoDvuJPbbCsjfhX9beg6Ppfh3RbXw/olhHa2Vjbpb2ltCuEhiRQqIo7AKAB9K/Dr/AINVf2Xf+Er+N/jf9rTXtOD2nhTSl0PQ5JU4+23XzzOh/vJDGFPtc+9fuhX4T41539f4khgIP3cPHX/HOzf/AJLyr1ufd8E4H6vlrxD3qP8ABaL8bhX5A/8AB1j+1F/Ynw98A/sh6DqRWfXL1/EfiCKNuttDuhtkYejSmVvrAK/X1nCda/lm/wCCxX7UX/DWv/BQv4hfEbTr/wA/RtO1T+xPD218oLOzHkhlPpJIskv/AG1rh8Hck/tTi1YmavDDxc/+3n7sV66uS/wm/GWO+q5Q6UXrUdvlu/8AL5njX7M3wQ8Q/tKftBeDvgL4WjY3vivxDa6dG6rnylkkAeQ+yJuc+ymv6iP2tvjD4Q/4J8/sEeJviB4bt4rOz8A+ChZeF7MgY89Ilt7KEDv+8MQ+ma/IH/g1v/ZcHxJ/az8R/tM67p4k034eaEbfTJHTgane5RWB/wBm3S4z3/eL+Pvf/B1h+1MNE+GvgH9kPQNRxPr99J4h8RRI/K21v+6tkYdw8rytj1gB9K+748/4y7xGwOQR1p0rSn87Tl/5Ikl5yseDkK/sjh2vj38U9I/kv/Jm/uPxI1LUr/WNQn1bVLuS4ubqZ5rieVyzySMcsxJ5JJJJPvX9EH/BtZ+yuvwN/YIj+L+uaYIta+J+ryaqZHXEi6fFmC1Q+x2yyj1E49q/Ar9nj4NeI/2iPjt4Q+BXhKNjqHi3xFaaXbsFz5XnSqhkP+yikuT2Ck1/XV8Mfh94c+E/w50H4YeELJbfS/D2kW+nafCgwEhhjWNR+SiuzxxztYXKKGVU3Z1Zc0l/dhsvRyd1/hMeBsC6uLni5bRVl6v/AIH5m4Biiiiv5hP1AKR+FNLXk37dH7Rum/sm/sjfEH9oG/mRZfDfhq4m05XOBLeuvl2sf/Ap3jX8a3wuGrY3Eww9JXnNqKXdt2X4mdWrCjSlUm7JJt/I/nw/4L4ftR/8NNf8FH/F0ek6gZ9D8CrH4Y0bD5XNtk3LDtzcvOM9wq16B/wbU/stj44/t7/8Le1zSxNo/wAMdFk1QPIm5DqMx8i1T0yA00oPYwjvivz41rV9R8Qaxda9rF2893e3MlxdTyHLSSOxZmJ7kkk/jX9E/wDwbZfsvf8ACiv+Cf1v8VNY04Q6z8TtVk1eZnTDixiLQWik9wVWSUe09f1px3iaPBnhx9QoOzcY0Y+d17z+cVJ+rPyTIqU864k9vU2Tc39+i++x+hC8AfSkb7p+lLXn37Vnx50P9mH9m/xv8fvEJT7P4T8NXeopG7Y8+aOImKEe7ybEHuwr+SaFCria8KNNXlJpJd23ZI/XKlSFKm5ydkld/I/n4/4OKf2oF/aE/wCCimseDdHvxNo3w206Lw7Z7G+RrlSZrpx7+bIYyf8ApiKof8G+P7LR/aS/4KMeHdd1fTPtGifDy1k8S6nvTKGWIiO1Q9s/aJI3x3ETe9fGPjPxZrnj3xfqvjjxPfPdalrOoz32oXMjZaWaWQyOxPclmJr98f8Ag1//AGW/+FU/saav+0XrmnCPU/iXrTGykdMONNs2eCMD2ab7Q3uNp9K/rvi+vS4H8NvqlF2lyKjF95SXvS9bc0vU/IcnpyzziX201pdzfotl+SP0u2L/AHf0FFTUV/HvKj9hCiiiqAKKKKACiiigAooooAKKKKACiiigBsyJLE0UihlYYYEdQa/k7/4K/fsnXP7IP/BQX4hfC+HTTBpN5q76x4dO3CtY3RMsYX1CksnHdK/rGr8lf+DqD9iST4kfBLw3+2X4M0Uyal4IkOm+JnhTLPps7AxyN7RS5GewmPpX3HAGZxwGeKjN+7VXL/29vH/L5nzvE2EeIy51I7w1+XX/AD+R+BX2c5+6KUW5H8Iq35WOwoEePSv3/wBmfmftWVBbk9QKd9lbGePyq15fvSiMU/ZoXtWVRanHA5r9G/8Ag1++L6fDT/gpNH4EvLvy7fxx4TvtOALYDTRKLqMH/vy4HuRX53+V7frXrH7C3xpn/Zv/AGw/hv8AGyK48qPw/wCL7Ke8YHrbmUJMPxjZx+NeZnWXrH5TXw6WsotL1tp+Njqy/FvDY6nVeya+7r+B/XwDkZoqDS7+01XToNUsJlkguYVlhkU5DIwBBHsQRU9fy1qtz9l3OK/aQ+Llj8Av2f8Axr8b9SiEkHhHwtf6vJEx4k+z27yhfxKgfjX8h3jPxZrvj3xfqnjjxPfPdalrGozXt/cyHLSzSuXdj7lmJr+v/wCNXwo8LfHb4ReJvgt44ilfR/FehXWk6mIG2v5FxE0TlT2YBiQexAr8GPjp/wAGv37eXgnxXdQfBLW/CvjbRDMxsLp9WGn3Xl54EsU4CK2Ou12Ffu3gzxBw3kkcVDHVo0qs3GzlonFX0T2TTbum1fTex8Hxpl+ZY50nQg5Rje6Wru7dDx7/AIJQf8Fc9T/4JexeMrWw+A1h4xTxe9o8k8usNZT2xgEgChxFIGQ+aTjA5Gc19j/8RbWt/wDRj9p/4Xjf/IdfLQ/4Nwv+Crp/5oroX/hbaf8A/HaP+IcH/gq7/wBEW0L/AMLbT/8A47X6JmuE8Ic7x88bja1GdWdrv2zV7JJaKaWyXQ+dwlbjDA0FRowmorZcl/PrE+pf+ItrW/8Aox+0/wDC8b/5DoH/AAdta5n/AJMftf8AwvG/+Q6+Wv8AiHB/4Ku/9EW0L/wttP8A/jtH/EOF/wAFXRyfgtoX/hbaf/8AHa87/V7wR/no/wDg+X/yw6P7Q43/AJZ/+C1/8ifoP8QP+CxXxH/aL/4I1/GX9reT4Kp4DLXH/CI+FfK1xrt7ya68mCa4VjDHsEa3LEEZy0TcjbX4G1/S14j/AOCSVh4y/wCCPOlf8E5Ytct9F1uz0O0uhq23zIk1tZhdyu+3lo2maSMkZIRsjoBX5Oa7/wAG2P8AwVO0vVZrDTPhp4Z1OCNyI7208Y2iRyjsQJmRx+KisPDjiTgfLIY6nSqww6daTipStemklBqUnrf3nu2m30sXxHlueYp0JShKo1BXaX2m23otun3En/BLz/gunr//AATb+A2ofAiH9nKw8W2t54hl1WHUTr7WMqNJHGjRsBDIHA8oEHjGSOa+lf8AiLa1v/ox+0/8Lxv/AJDr5a/4hwf+Crv/AERbQv8AwttP/wDjtH/EOD/wVd/6ItoX/hbaf/8AHa9TMMu8Hc1xs8Xiq1GVSbvJ+3au/RTS+5HNh8RxlhaMaNKE1GOiXJf84nufx7/4Oo/jL8SfhTrPgP4VfszaX4S1bV7CW0i8Qz+JHvXslkUo0kUYgjHmAElSSQDgkHGK/KOWWW4laaVy7uxZmY5JJ6mvun/iHB/4Ku/9EW0L/wALbT//AI7Xpv7Kf/Bsh+2l4r+LGlS/tQjQvCPg+1vUl1g2utxXt5dwqwLQwpDuVWYDbudgFyThsYPpZXm3hjwhg6ry7EUoJ6yUanPKVlovilJ+SXc5sVhOKM4rQWIpzbWivGyV/kkfpT/wQM/ZbP7M3/BODwne6xYfZ9Z8dl/FGrl02tsuAPswP0tlhPPdmr8Ov+Cw37UX/DW3/BQr4g/EfTr/AO0aNpuqNoXh1lbKGysyYVdf9mRxJL/21r+kz9pjQPizo37KHivwb+yz4Zhn8WJ4Ul03wbp5u47aOGZo/JibzJCFQRg7+T/Bgc1+Ab/8G43/AAVflcyP8GNDJJyS3jbT8n/yLX5v4ZZzk1XPswz/ADXE06VSq2oqc4p2k+aVk3skoxT8mj6TibBY2OX4fAYSlKUYq7aTautFt82z07/g15/ZXPxT/a+179pHXNO36Z8N9F2WEkifKdSvQ8SYz1KQrOfYsh9K/f4cDFfIv/BFb9g3xR+wB+xhafDb4m6VbWvjPXNZudW8VJbXKTrHKxEUMQkQlWCwxxngkbnb1NfXVfnPiPn9PiPiyviKUuanC0INapxj1Xk5Xa8mfScN5e8uymFOStJ+8/V/5KyCiiivhT3Qr8kv+DrP9orVfCvwY+H37MmiXTRxeLNWuNY1wKceZBZhFhjPqDLKX+sS1+ttfAH/AAXO/wCCSnxB/wCCj3hjwr44+CHiTTrTxh4OS5gj0/WJmit9RtZijFBIA3lyKyZBI2kMQSMA19n4e4zKsv4wwuIzGSjSi27vZS5Xyt+SlbXpueLxDRxeIyerTw6vJpaLdq6v+B/ONX6u/s7/APB0N4l+BnwI8HfBa6/Y603Um8JeGrLR11C28WvapcpbQpCsnlfZn2EqgJAYjJOK8Ok/4NwP+CraOUX4NaC4BwGXxrp+D78yg0n/ABDg/wDBV3/oi2hf+Ftp/wD8dr+nM9zDw04mowp5liqNSMHdfvVGzen2ZL8T8wwGH4myycpYalOLej9y/wCaZ9S/8RbWt/8ARj9p/wCF43/yHXzf/wAFLv8Agvr8Xf8AgoN8ER+z3pPwesPA/h27vornXfI1h724v/KbfHEXMcYSMOFcjaSSi8gDByv+IcH/AIKu/wDRFtC/8LbT/wD47R/xDg/8FXf+iLaF/wCFtp//AMdrxcBlvg3leMhi8NVoKpB3i3Wbs1s7Sm1ddNNDtxGJ4yxVGVKpCbjJWfuW0+UUz4z+FXw58R/GD4meH/hV4Qs2n1TxJrVrpmnxIuS008qxp+GWyfYV/XT+z/8AB3w7+z98E/CfwT8JxKuneFfD1rpdqQMFxDEqFz7sQWPuxr8tP+COP/BAD40fsz/tD6X+1P8AtgXmjW114Y82Xw14V0q9F2xu3jaMXE8ijYAgdmVVLHftJI24P691+X+MPF2B4gx9DB4CqqlKkm24/C5y00ez5Ut1p7zR9Twfk9fL6E62Ijyznok97L8rv8gooor8aPswooooAKKKKACiiigAooooAKKKKACiiigArnfi58LfBvxu+GOvfCP4haUl7oniPSp9P1K1kHDxSoVb6EZyD2IBroqKqEpQkpRdmtUKUYyi4vZn8h37c37JHjX9iL9p/wAU/s7+N7eQvo18x0y9ZcLfWTktBOvqGTGfRgw7V5IFBPAr+jX/AIOFP+CYzftj/AAftBfCnQFm+IXw+spJRFBH+91XSxl5bfjlnT5pEH+8P4q/nPkjkhkaKVCrKxDKwwQR2r+mOFM8p8QZVGrf95HSa8+/o9193Q/H87y6WV450/svWL8u3yIsY4ApdjelPor6fkPH5hvl+9OUbSCvUdDRRRyi5j+qP/gjH+0zF+1R/wAE6fh146ur8Tarpelf2HrgLZdbmzPkZb3ZFjf/AIHX1LX4X/8ABqj+1zH4W+KvjD9jjxNqhW38TW39t+HI5H4+1wALPGvu0WGx/wBMjX7oV/MXFuVvKM/rUbe63zR9Ja/hqvkfseRYz69ldOo3qlZ+q/q4UUUV82euFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAjokilHUEEYII61+An/Bwl/wAEirn9nXx9eftmfAHw0T4E8R3gfxNplnB8uh30h5kwOkErHOeiuSOhFfv5WR488C+Efib4N1L4f+PNAttU0bWLN7XUtPu4g8c8TjDKwPt+Ve/w3n+J4dzJYinrF6Sj/Mv81un+h5eb5XSzXCOlLR9H2f8Al3P40/L+lHl/Svu//gsj/wAEePGn/BPn4iTfEb4b2V3q3wq1y9b+ytRKb30iVssLS4IHbkI54YDB5r4Z8hs/dFf0/lmMwmb4KOKwsuaEvw8n2a6o/G8Zh6+AxEqNZWkv6uvIrGIZ7UvljHHWrHkN6CjyCD0Fd/1dnL7RHa/su/HnxZ+y3+0H4S+P/gicpqHhfWobyNQcCVAcSRn2ZCyn2av62vgZ8YPCHx/+EHhv40+AtQS50fxNo1vqNjIjA4SVA2w46MpJUjsQRX8ePkMa/aj/AINgv2/4rnSdU/YH+JGthZrXzdV8CSXEn34yc3Noue4J81QOxf0r8y8TeHJ4zLI5hSjeVHfzg9//AAF6+jZ9jwfm0cPjHhZv3Z7f4v8Ag7fcfsjRQOlFfz+fqIUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQBz/AMUvhZ8P/jV4C1T4YfFLwrZ63oOs2rW+o6bfRbo5kP8AIjqCMEEAg5r+ej/grx/wRR+IX7CHiS6+LXwesr3X/hXfXDNDeKpkuNDYnIgucclOyy9DjDYPX+jeqXiLw5oXi3Q7rw14n0e11DTr6BobyxvYFkinjYYZHVgQwI7GvquFeLMfwvjOel71OXxQez812kuj+/Q8TO8jw2c0OWek1tLt6915H8cQtRnk5pRbDpX69f8ABVf/AIN3tb8Izal8ff2EdIa+0nD3GreAFYtcWnUs1mTnzE/6ZE7hj5d3QfkzqOkX+kX82l6tYy21zbyNHPbzxlHjcHBVlPIIPav6k4fzrKeJMGsRgp37p/FF9pLp67Po2fi+aZfjsoxHssRG3Z9H6P8ApmYLX2rpvg78UPHXwI+J+h/GD4aa1Jp+u+HtRjvdNuozysiHOCO6kZBHQgkVjeR6ilEAx0r3Z4OnVg4TV09Gu6POjiJQkpRdmj+q3/gn7+2p4C/bw/Zq0P45eDLiKO7mhW38RaWr5fTr9VHmwsOuM/Mp7qQa9tr+Zb/gkj/wUh8Tf8E8P2gU1bU5bm78CeI5IrXxhpMZziMEhbqNenmR7if9oEr3Ff0o+AfHXhL4m+DNM8f+BNdt9T0fV7NLrTr+0kDRzxOMqwIr+TuPOEK/CuavkTdCpdwfbvF+cfxVn3P2/hnPqedYL3n+8jpJfqvJ/gzYooor4U+lCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAAgHqK+K/+CkP/BE/9nD9u+2vPHegW8Pgz4htGTF4k061HlXrjoLuEYEmem8YcepxivtSivRyvNsxybFrE4Ko4TXVdfJrZryehyY3A4TMKDo4iClF9/07PzR/Kp+2R+wD+03+wv40fwr8dvh/cW1pJMV03xBaIZbC/XsY5gMZx1U4YdxXi46YPf3r+vX4lfDD4e/GHwdeeAPij4N0/XtFv4il3pup2qyxSD3DDg+hHI7V+UH7ev8AwbPaXqbXvxD/AGE/FQs52LSv4H1+4zC3fbbXB5T0CyZH+0K/oXhXxey7HqNDNkqVTbnXwP16x+d15o/K864ExeGbq4F88P5ftL/P8/I/GnjJFfoh/wAEUf8AgsPe/sZ+JYP2e/j5q09z8NNYux9kvJHLt4euHIHmKD/ywY/fUfd5Ydwfhz43fAD42/s3+MJvAXxz+GOseGNVhYj7Nqtk0YkAP3o2I2yL/tKSPeuN8/vX6Xm2XZTxPlUsNiLTpzV001o+kotdV0+56HyGCxeOyfHKrS92cd0/xTR/YZoHiDRfFOiWniTw7qsF9YX9uk9neWsoeOaNhlXVhwQQQc1cr+er/gkP/wAFuPGf7E+oWfwO+PNxd678MLifbA+TJdaAWPLw5+/Dk5aPtyV9D++fwr+K/wAOvjb4F0/4mfCrxhYa7oWqW4msdS064EkcintkdGHQqcEHIIFfyVxZwhmXCmNdOsuak37k0tJLs+0u6+66P3LI8+wmd4fmpu018Ueq/wA15nRUUUV8me4FFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAHEfHT9nD4HftLeEJfAnx0+GOkeJdLlUjyNTtQ7Rkj70bjDRt7qQa/Lf9tH/g178P6o114v8A2I/ic2nTHLr4S8VymSEnrshuVG5fQCQN7tX6/wBGB6V9BknFGe8PTvgqzjHrF6xfrF6fNWfmeXmOS5bmkbYimm++z+8/k0/aZ/Yb/a0/Y/1uTR/2gPglrWhRq5WLUjb+dZT+6XEe6Nvpuz7V2H7AH/BUn9pb/gnp4zGo/C/xD/aPhu6mDaz4Q1Ry9ndjuyjrDJjo649wRxX9RniXwr4Y8ZaNN4d8XeHrHVLC5QpcWWoWqTRSKezI4IP5V8NftXf8G7n/AAT/AP2jZLnXvBPhW7+HGuzlm+2+EnC2zMe7Wr5jAz/cCV+p4TxSyvN8K8JnmG92Wja96L8+V6r5NvsfF1+C8ZgKyr5dV1Wyej+/Z/Ox6p+wD/wVq/ZO/wCCgXh+C3+H3i6PRvFyQK2peC9ZlEd3E2PmMROFuEz/ABJn3Ar6gr+fT4+f8G3P/BQv9m/Xx4+/Zj8Z6f41j0+bz9PudB1FtO1WEqcqwjcgbh/sSE+lek/sxf8ABeX9uz9iDWrb4Pf8FL/gP4o1nTLdhENcvNKNpq1ug4ySwWO6HuSGP9418nmfBuX46+I4exEasd/ZtpTXpezfzs/U9vB8QYrDWpZrScH/ADW91+ttvldeh+4VFeI/slf8FFP2P/22NCTVvgB8ZdN1K78sNc6FdP8AZ9Qtj3DwPhvxGV9DXtwIPQ1+fYjDYjCVXSrwcZLdNWf3M+ppVqVeCnTkmn1WoUUUViaBRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAEA8EVk+MfAXgf4h6NJ4d8feDtL1vT5lKy2WrWEdxE4PUFJAQaKKcZSjK8XZiaUlZnyZ8Y/+CEn/AATz+J2ur4z8HfDW++HXiGOTzLbW/h3qkmmSQSdQyxpmMH6KK0PA/wCy5/wUj/ZqiSx+EP7aGmfE/Q4ABDoPxd0Vxdqg/hGpWrFye2XjaiivWeeZnOmqdaftIrpNKdvRyu18mji/s7CRm5048j7x9377aP5pnrngz49fG2xRbH47fswazotyvEmoeFNRi1qwY9yCojuFH1h/GvSvD3jHw74pUnRtRDuqhnt5Y2ilQHuyOAw/EUUVz1adKpR9rGPL5K9vxbf4mkJzjU5G7+v/AALGnRRRXAdQUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAH/2Q==" alt="AC EURO">
    <div class="login-title">Servisní systém</div>
    <div class="login-sub">Přihlaste se pro přístup k formulářům</div>
    <button class="btn-google" id="btn-google" onclick="loginGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
      Přihlásit se přes Google
    </button>
    <div id="popup-tip" style="display:none;font-size:11px;color:#b45309;background:#fef9ec;border:1px solid #fcd34d;border-radius:6px;padding:8px 12px;margin-top:8px;line-height:1.5">
      ⚠ Prohlížeč blokuje přihlašovací okno.<br>Klikněte na ikonu <strong>🚫</strong> nebo <strong>📷</strong> v adresním řádku a zvolte <strong>Povolit popup</strong>. Nebo se přihlaste e-mailem níže.
    </div>
    <div class="login-divider">nebo e-mailem</div>
    <div class="fg"><label>E-mail</label>
      <input type="email" id="l-email" placeholder="vas@email.cz" autocomplete="email"></div>
    <div class="fg"><label>Heslo</label>
      <input type="password" id="l-pass" placeholder="••••••••" autocomplete="current-password"
        onkeydown="if(event.key==='Enter')loginEmail()"></div>
    <button class="btn-login" id="btn-login" onclick="loginEmail()">Přihlásit se</button>
    <div class="login-err" id="login-err"></div>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:#6b7a99">
      Nemáte účet? <a href="#" onclick="showRegister();return false" style="color:var(--blue);font-weight:600">Registrovat se</a>
    </div>
  </div>

  <!-- Registrační formulář -->
  <div class="login-card" id="register-card" style="display:none">
    <img class="login-logo" src="data:image/jpeg;base64,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">
    <div class="login-title">Registrace</div>
    <div class="login-sub">Nový účet — po registraci bude schválen adminem</div>
    <div class="fg"><label>Jméno a příjmení</label>
      <input type="text" id="r-name" placeholder="Jan Novák" autocomplete="name"></div>
    <div class="fg"><label>E-mail</label>
      <input type="email" id="r-email" placeholder="vas@email.cz" autocomplete="email"></div>
    <div class="fg"><label>Heslo</label>
      <input type="password" id="r-pass" placeholder="min. 6 znaků"></div>
    <div class="fg"><label>Heslo znovu</label>
      <input type="password" id="r-pass2" placeholder="••••••••"></div>
    <button class="btn-login" id="btn-register" onclick="doRegister()">Zaregistrovat se</button>
    <div class="login-err" id="register-err"></div>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:#6b7a99">
      Máte účet? <a href="#" onclick="showLogin();return false" style="color:var(--blue);font-weight:600">Přihlásit se</a>
    </div>
  </div>
</div>

<!-- APP -->

<!-- ══ TECHNIK APP ════════════════════════════════════════════ -->
<div id="app-technik" style="display:none;flex-direction:column;min-height:100vh">
  <div id="offline-banner">📵 Offline režim — zakázka se odešle automaticky po připojení</div>
  <div id="topbar-accent" style="height:3px;background:#6abf3e;transition:background .3s"></div>
  <div class="topbar">
    <img src="data:image/jpeg;base64,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" alt="AC EURO">
    <div class="topbar-right">
      <span class="pending-badge" id="pending-badge" title="Čeká na odeslání">⏳ Offline fronta</span>
      <div class="user-badge">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-name"></span>
      </div>
      <button onclick="toggleCalendar()" id="cal-btn" title="Přehled na 14 dní"
        style="background:var(--blue);color:#fff;border:none;border-radius:7px;padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;font-family:inherit">
        📅 <span id="cal-badge" style="background:#6abf3e;color:#fff;border-radius:10px;padding:1px 5px;font-size:10px;display:none">0</span>
      </button>
      <button onclick="openMapaTechniku()" title="Mapa techniků" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:7px;padding:5px 10px;cursor:pointer;font-size:14px">🗺</button>
      <button id="dark-toggle" onclick="toggleDarkMode()" title="Přepnout tmavý režim">🌙</button>
      <div id="notif-bell" style="position:relative;cursor:pointer" onclick="toggleNotifPanel()" title="Notifikace">
        <span style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:7px;padding:5px 10px;font-size:14px;display:inline-block">🔔</span>
        <span id="notif-count" style="display:none;position:absolute;top:-4px;right:-4px;background:#ef4444;color:#fff;font-size:9px;font-weight:700;border-radius:50%;width:16px;height:16px;line-height:16px;text-align:center">0</span>
      </div>
      <div id="notif-panel" style="display:none;position:absolute;top:54px;right:120px;width:340px;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.18);z-index:500;max-height:420px;overflow-y:auto;border:1px solid var(--border)">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:13px;font-weight:700;color:var(--navy)">🔔 Notifikace</span>
          <button onclick="clearAllNotifs()" style="font-size:10px;color:var(--muted);background:none;border:none;cursor:pointer">Vymazat vše</button>
        </div>
        <div id="notif-list" style="padding:8px 0">
          <div style="padding:16px;text-align:center;color:var(--muted);font-size:12px">Žádné notifikace</div>
        </div>
      </div>
      <button class="btn-signout" onclick="doSignOut()">Odhlásit</button>
    </div>
  </div>
  <!-- 14-DENNÍ PŘEHLED -->
  <div id="calendar-strip" style="background:#fff;border-bottom:2px solid var(--border);padding:10px 16px 8px;display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <span style="font-size:11px;font-weight:700;color:var(--navy);letter-spacing:.05em;text-transform:uppercase">📅 Přehled — nejbližší 2 týdny</span>
      <button onclick="document.getElementById('calendar-strip').style.display='none'" style="background:none;border:none;font-size:15px;cursor:pointer;color:var(--muted);line-height:1">×</button>
    </div>
    <div id="cal-days" style="display:flex;gap:4px;overflow-x:auto;padding-bottom:4px"></div>
  </div>

  <div class="progress">
    <button class="stab active" onclick="goTo(0)" id="tab-0"><span class="snum">1</span><span class="slbl">Základní info</span><span class="schk">✓</span></button>
    <button class="stab" onclick="goTo(1)" id="tab-1"><span class="snum">2</span><span class="slbl">Servisní práce</span><span class="schk">✓</span></button>
    <button class="stab" onclick="goTo(2)" id="tab-2"><span class="snum">3</span><span class="slbl">Položky</span><span class="schk">✓</span></button>
    <button class="stab" onclick="goTo(3)" id="tab-3"><span class="snum">4</span><span class="slbl">Poznámky</span><span class="schk">✓</span></button>
    <button class="stab" onclick="goTo(4)" id="tab-4"><span class="snum">5</span><span class="slbl">Fotografie</span><span class="schk">✓</span></button>
    <button class="stab" onclick="goTo(5)" id="tab-5"><span class="snum">6</span><span class="slbl">Podpisy & PDF</span><span class="schk">✓</span></button>
    <button class="stab" onclick="goTo(6)" id="tab-6"><span class="snum">7</span><span class="slbl">Odeslat</span><span class="schk">✓</span></button>
  </div>
  <div class="main"><div class="card">

  <!-- STEP 1 -->
  <div class="panel active" id="step-0">
    <div class="ph"><div class="ph-icon">📋</div><div><h2>Základní informace</h2><p>Identifikace zakázky a zákazníka</p></div></div>
    <div class="pbody">
      <div id="assigned-info"></div>

      <!-- Zakázka ze seznamu nebo vlastní -->
      <div class="fg2" style="margin-bottom:4px">
        <label>Zakázka ze seznamu <span style="font-weight:400;color:var(--muted);text-transform:none;letter-spacing:0">(nebo zadejte vlastní níže)</span></label>
        <div style="display:flex;gap:8px">
          <select id="zakaz_select" style="flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:#fff;color:var(--text)" onchange="onZakazSelect(this.value)">
            <option value="">— Vyberte ze seznamu nebo zadejte vlastní —</option>
          </select>
          <button type="button" onclick="reloadZakazkyList()" style="padding:9px 11px;background:var(--blue2);border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px" title="Obnovit seznam">↻</button>
        </div>
      </div>

      <div class="two">
        <div class="fg2"><label>Název zakázky *</label>
          <input id="f_nazev" autocomplete="off" placeholder="např. Klimatizace Brno">
          <span class="ferr" id="e_nazev">Povinné pole</span></div>
        <div class="fg2"><label>Číslo servisu *</label>
          <input id="f_cislo" autocomplete="off" placeholder="2024-001">
          <span class="ferr" id="e_cislo">Povinné pole</span></div>
      </div>
      <!-- Volba firmy -->
      <div class="fg2" style="margin-bottom:8px">
        <label>Servis provádí *</label>
        <div style="display:flex;gap:8px">
          <button type="button" id="btn-firma-aceuro" onclick="setFirma('aceuro')"
            style="flex:1;padding:10px 8px;border-radius:9px;border:2px solid #6abf3e;background:#f0fff4;font-size:13px;font-weight:700;cursor:pointer;color:#0f1f3d;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s">
            <span style="width:10px;height:10px;border-radius:50%;background:#6abf3e;display:inline-block"></span>AC EURO a.s.
          </button>
          <button type="button" id="btn-firma-progres" onclick="setFirma('progres')"
            style="flex:1;padding:10px 8px;border-radius:9px;border:2px solid #d0d8e8;background:#fff;font-size:13px;font-weight:700;cursor:pointer;color:#6b7a99;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s">
            <span style="width:10px;height:10px;border-radius:50%;background:#1e90ff;display:inline-block"></span>Progresklima CZ
          </button>
        </div>
      </div>

      <!-- Zákazník s ARES -->
      <div class="two">
        <div class="fg2" style="position:relative">
          <label>Zákazník (IČO nebo název)</label>
          <input id="f_zakaznik" autocomplete="off" placeholder="Název firmy nebo IČO…" oninput="aresDebounce(this.value)">
          <div id="ares-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(15,31,61,.12);z-index:200;max-height:220px;overflow-y:auto;margin-top:2px"></div>
          <div id="ares-loading" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--muted)">🔍</div>
        </div>
        <div class="fg2"><label>Termín provedení</label>
          <input id="f_termin" type="date"></div>
        <div class="fg2"><label>Odpracováno (h)</label>
          <input id="f_hodiny" type="number" min="0" step="0.5" placeholder="0.0"></div>
        <div class="fg2"><label>Najetých km</label>
          <input id="f_km" type="number" min="0" step="1" placeholder="0"></div>
      </div>
      <!-- Adresa zákazníka -->
      <div class="fg2" style="margin-top:2px">
        <label>Adresa zákazníka <span style="font-weight:400;color:var(--muted);text-transform:none">(doplní se z ARESu)</span></label>
        <input id="f_adresa" autocomplete="off" placeholder="Ulice, město, PSČ">
      </div>
      <div class="fg2" style="margin-top:2px">
        <label>IČO / DIČ</label>
        <div style="display:flex;gap:8px">
          <input id="f_ico" autocomplete="off" placeholder="12345678" style="flex:1">
          <input id="f_dic" autocomplete="off" placeholder="CZ12345678" style="flex:1">
        </div>
      </div>

      <!-- Technici ze seznamu nebo vlastní -->
      <div class="fg2" style="margin-top:4px">
        <label>Technici <span style="font-weight:400;color:var(--muted);text-transform:none;letter-spacing:0">(lze přidat více)</span></label>
        <div id="technici-list" style="display:flex;flex-direction:column;gap:6px"></div>
        <button type="button" onclick="addTechRow()" style="margin-top:6px;padding:7px 12px;background:var(--blue2);border:1.5px solid var(--border);border-radius:7px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text);display:flex;align-items:center;gap:5px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Přidat dalšího technika
        </button>
      </div>

    </div>

      <!-- Přiřazené zakázky od kanceláře -->
      <div class="fg2" style="margin-top:16px">
        <label style="display:flex;align-items:center;justify-content:space-between">
          <span>Přiřazené zakázky od kanceláře</span>
          <button type="button" onclick="loadAssignedZakazky(window._currentUser)" style="padding:4px 10px;background:var(--blue2);border:1.5px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;color:var(--text)">↻ Obnovit</button>
          <button type="button" onclick="openQuickZakazka()" style="padding:4px 10px;background:var(--green);border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:700;color:#fff;margin-left:4px">+ Rychlá zakázka</button>
        </label>
        <div id="assigned-panel" style="margin-top:6px">
          <div style="font-size:12px;color:var(--muted);font-style:italic;text-align:center;padding:12px">Načítám...</div>
        </div>
      </div>

    </div>
    <div class="pfoot"><span class="pctr">Krok 1 z 7</span>
      <button class="btn btn-next" onclick="nextStep(0)">Pokračovat →</button>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="panel" id="step-1">
    <div class="ph"><div class="ph-icon">🔧</div><div><h2>Provedené servisní práce</h2><p>Popis všech provedených úkonů</p></div></div>
    <div class="pbody">
      <div class="fg2"><label>Popis prací</label>
        <div class="dotlines-wrap" id="prace-wrap"></div></div>
    </div>
    <div class="pfoot"><span class="pctr">Krok 2 z 7</span><div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="goTo(0)">← Zpět</button>
      <button class="btn btn-next" onclick="goTo(2)">Pokračovat →</button>
    </div></div>
  </div>

  <!-- STEP 3 -->
  <div class="panel" id="step-2">
    <div class="ph"><div class="ph-icon">💰</div><div><h2>Položky a ceny</h2><p>Materiál, práce — nebo přeskočte</p></div></div>
    <div class="pbody">
      <div style="background:#fffbf0;border:1.5px solid #f0d080;border-radius:8px;padding:12px 14px;display:flex;gap:10px;align-items:center">
        <div style="font-size:16px">💡</div>
        <div style="font-size:11px;color:#7a5500;flex:1">Ceny neznáte? Přeskočte — kancelář doplní.</div>
        <button onclick="skipPrices()" style="background:#f5c842;color:#5a3d00;border:none;border-radius:6px;padding:6px 13px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">Přeskočit →</button>
      </div>
      <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden">
        <table class="items-tbl"><thead><tr>
          <th style="text-align:left;width:44%;padding:7px 8px">Položka</th>
          <th style="width:13%">Počet ks</th><th style="width:18%">Cena Kč/ks</th><th style="width:18%">Celkem Kč</th>
        </tr></thead>
        <tbody id="items-tbody"></tbody>
        <tbody id="ext-tbody"><tr class="sep-row"><td colspan="4">Cestovní náklady</td></tr></tbody>
        </table>
        <div class="total-bar"><span>Cena bez DPH</span><strong id="cena_total">0,00 Kč</strong></div>
      </div>
      <div class="fg2"><label>Datum ukončení prací (DUZP)</label><input id="f_duzp" type="date"></div>
    </div>
    <div class="pfoot"><span class="pctr">Krok 3 z 7</span><div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="goTo(1)">← Zpět</button>
      <button class="btn btn-next" onclick="goTo(3)">Pokračovat →</button>
    </div></div>
  </div>

  <!-- STEP 4 -->
  <div class="panel" id="step-3">
    <div class="ph"><div class="ph-icon">📝</div><div><h2>Poznámky</h2><p>Doplňující informace nebo upozornění</p></div></div>
    <div class="pbody">
      <div class="fg2"><label>Poznámky <span style="font-size:11px;font-weight:400;color:var(--muted)">(zobrazí se zákazníkovi na servisním listu)</span></label>
        <div class="dotlines-wrap" id="pozn-wrap"></div></div>
      <div class="fg2" style="margin-top:14px">
        <label style="display:flex;align-items:center;gap:6px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span>Interní komentář <span style="font-size:11px;font-weight:400;color:#7c3aed">(pouze pro kancelář — nezobrazí se zákazníkovi)</span></span>
        </label>
        <textarea id="f_komentar" rows="3" style="width:100%;margin-top:6px;padding:10px 12px;border:1.5px solid #d0c0f0;border-radius:8px;font-size:13px;font-family:inherit;background:#faf7ff;resize:vertical;color:var(--text)" placeholder="Např.: zákazník reklamoval, domluvit opakovanou návštěvu, pozor na platbu..."></textarea>
      </div>
    </div>
    <div class="pfoot"><span class="pctr">Krok 4 z 7</span><div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="goTo(2)">← Zpět</button>
      <button class="btn btn-next" onclick="goTo(4)">Pokračovat →</button>
    </div></div>
  </div>

  <!-- STEP 5 -->
  <div class="panel" id="step-4">
    <div class="ph"><div class="ph-icon">📷</div><div><h2>Fotografie</h2><p>Fotodokumentace závady nebo prací</p></div></div>
    <div class="pbody">
      <div class="photo-grid" id="photo-grid">
        <label class="photo-add" for="photo-input">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
          Přidat foto
        </label>
      </div>
      <input type="file" id="photo-input" accept="image/*" multiple capture="environment" onchange="addPhotos(this)">
      <div class="upload-prog" id="upload-prog">
        <span id="upload-msg">Nahrávám fotografie...</span>
        <div class="bar"><div class="bar-fill" id="bar-fill"></div></div>
      </div>
      <div style="font-size:11px;color:var(--muted)">Fotografie se nahrají do cloudu. Offline: uloží se lokálně a nahrají automaticky po připojení.</div>
    </div>
    <div class="pfoot"><span class="pctr">Krok 5 z 7</span><div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="goTo(3)">← Zpět</button>
      <button class="btn btn-next" onclick="goTo(5)">Pokračovat →</button>
    </div></div>
  </div>

  <!-- STEP 6 -->
  <div class="panel" id="step-5">
    <div class="ph"><div class="ph-icon">✍️</div><div><h2>Podpisy a PDF pro zákazníka</h2><p>Klepněte na plochu — otevře se celá obrazovka</p></div></div>
    <div class="pbody">
      <div class="prev-wrap">
        <div class="prev-hdr">👁 Náhled servisního listu</div>
        <div class="prev-body" id="preview-body"></div>
      </div>
      <div class="sig-wrap">
        <div class="sig-bar">Za zhotovitele <button class="btn-sigclr" onclick="clearSig(1)">✕ Vymazat</button></div>
        <div class="sig-area" onclick="openSigFS(1)" title="Klepněte pro podpis přes celou obrazovku">
          <canvas id="sig1" style="display:none"></canvas>
          <div class="sig-hint" id="sh1">✏️ Klepněte pro podpis</div>
          <div class="sig-preview" id="sp1"></div>
        </div>
        <div class="sig-foot"><label>Datum:</label><input type="date" id="sd1"></div>
      </div>
      <div class="sig-wrap">
        <div class="sig-bar">Za objednatele <button class="btn-sigclr" onclick="clearSig(2)">✕ Vymazat</button></div>
        <div class="sig-area" onclick="openSigFS(2)" title="Klepněte pro podpis přes celou obrazovku">
          <canvas id="sig2" style="display:none"></canvas>
          <div class="sig-hint" id="sh2">✏️ Klepněte pro podpis</div>
          <div class="sig-preview" id="sp2"></div>
        </div>
        <div class="sig-foot">
          <label>Datum:</label><input type="date" id="sd2">
          <button onclick="openZakaznikSig()" style="margin-left:auto;background:var(--green);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-family:inherit;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Podepsat zákazníkem
          </button>
        </div>
      </div>
      <div class="status-box success">
        <div style="font-size:20px">🖨️</div>
        <div>
          <div style="font-size:13px;font-weight:700;color:#1a6b2a;margin-bottom:3px">Tisk pro zákazníka — bez cen</div>
          <div style="font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:10px">Zákazník obdrží servisní list s popisem prací a podpisy.</div>
          <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text);margin-bottom:10px;cursor:pointer">
            <input type="checkbox" id="print-photos-cb" style="width:15px;height:15px;accent-color:var(--green)">
            Zahrnout fotodokumentaci (přidá stránky za servisní list)
          </label>
          <button class="btn btn-green" onclick="printCustomer()">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Tisk / PDF pro zákazníka
          </button>
          <div class="status-line" id="print-status"></div>
        </div>
      </div>
    </div>
    <div class="pfoot"><span class="pctr">Krok 6 z 7</span><div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="goTo(4)">← Zpět</button>
      <button class="btn btn-next" onclick="goTo(6)">Pokračovat → Odeslat</button>
    </div></div>
  </div>

  <!-- STEP 7 -->
  <div class="panel" id="step-6">
    <div class="ph"><div class="ph-icon">☁️</div><div><h2>Odeslat zakázku</h2><p>Uložení do systému — kancelář uvidí ihned</p></div></div>
    <div class="pbody" id="submit-body">
      <div id="pre-submit">
        <div class="status-box info">
          <div style="font-size:20px">📋</div>
          <div id="submit-summary" style="font-size:12px;line-height:1.7;color:var(--text)"></div>
        </div>
        
        <button class="btn btn-green" id="btn-submit" onclick="submitZakazka()" style="width:100%;justify-content:center;padding:14px;font-size:15px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>
          Odeslat zakázku do kanceláře
        </button>
        <div class="status-line" id="submit-status"></div>
      </div>
      <div id="post-submit" style="display:none;text-align:center;padding:20px 0">
        <div style="font-size:52px;margin-bottom:12px">&#x2705;</div>
        <div style="font-size:18px;font-weight:700;color:#0f1f3d;margin-bottom:6px">Zakázka odeslána!</div>
        <div style="font-size:12px;color:#6b7a99;margin-bottom:24px">Kancelář ji vidí v systému.</div>
        <button class="btn btn-green" onclick="resetForm()" style="font-size:15px;padding:14px 32px">
          &#x2795; Nová zakázka
        </button>
      </div>
    </div>
    <div class="pfoot"><span class="pctr">Krok 7 z 7</span>
      <button class="btn btn-ghost" onclick="goTo(5)">← Zpět</button>
    </div>
  </div>

  </div></div><!-- /card /main -->
<!-- /app-screen -->

<!-- FULLSCREEN SIGNATURE OVERLAY -->
<!-- ══ MÍSTA & KLIMATIZACE PANEL ══════════════════════════════ -->
<div id="mista-overlay" style="position:fixed;inset:0;z-index:600;background:var(--bg);display:none;flex-direction:column;overflow:hidden">
  <!-- Header -->
  <div style="background:var(--navy);color:#fff;padding:0;flex-shrink:0">
    <div style="display:flex;align-items:center;gap:12px;padding:12px 16px">
      <button onclick="closeMistaPanel()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:13px;font-weight:600">← Zpět</button>
      <div style="flex:1;min-width:0">
        <div style="font-size:15px;font-weight:800" id="mista-zakaz-nazev">Místa &amp; Klimatizace</div>
        <div style="font-size:11px;color:rgba(255,255,255,.65)" id="mista-zakaz-sub"></div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button onclick="openAddMistoModal()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:8px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:600">+ Místo</button>
        <button onclick="openMistaImport()" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:8px;padding:6px 12px;cursor:pointer;font-size:12px">📥 Import CSV</button>
        <button onclick="copyMistaFromSablona()" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:8px;padding:6px 12px;cursor:pointer;font-size:12px">📋 Kopírovat</button>
      </div>
    </div>
    <!-- Progress bar -->
    <div style="padding:0 16px 10px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px">
        <span style="font-size:11px;color:rgba(255,255,255,.7)" id="mista-progress-label">0 / 0 klimatizací zkontrolováno</span>
        <span style="font-size:11px;color:rgba(255,255,255,.7)" id="mista-progress-pct">0%</span>
      </div>
      <div style="background:rgba(255,255,255,.15);border-radius:4px;height:6px;overflow:hidden">
        <div id="mista-progress-bar" style="height:100%;background:#4ade80;border-radius:4px;transition:width .4s;width:0%"></div>
      </div>
    </div>
    <!-- Search + filter -->
    <div style="padding:0 16px 10px;display:flex;gap:8px">
      <input id="mista-search" placeholder="🔍 Hledat místo…" oninput="renderMistaList()" style="flex:1;padding:7px 12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;border-radius:8px;font-size:13px;outline:none" autocomplete="off">
      <select id="mista-filter-stav" onchange="renderMistaList()" style="padding:7px 10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;border-radius:8px;font-size:12px">
        <option value="">Všechna místa</option>
        <option value="done">✅ Hotová</option>
        <option value="partial">⚠️ Částečná</option>
        <option value="new">🆕 Nezahájená</option>
      </select>
    </div>
  </div>

  <!-- Split layout: místa list | detail klimatizací -->
  <div style="display:flex;flex:1;overflow:hidden">
    <!-- Levý panel: seznam míst -->
    <div id="mista-list-panel" style="width:320px;flex-shrink:0;border-right:1px solid var(--border);overflow-y:auto;background:var(--card)">
      <div id="mista-list-inner" style="padding:8px"></div>
    </div>
    <!-- Pravý panel: klimatizace na vybraném místě -->
    <div id="klim-panel" style="flex:1;overflow-y:auto;background:var(--bg)">
      <div id="klim-empty" style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:13px;flex-direction:column;gap:8px">
        <span style="font-size:40px">🏢</span>
        <span>Vyberte místo ze seznamu vlevo</span>
      </div>
      <div id="klim-content" style="display:none;padding:16px">
        <div id="klim-header" style="margin-bottom:12px"></div>
        <div id="klim-list" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </div>
  </div>
</div>

<!-- PŘIDAT MÍSTO MODAL -->
<div class="modal-overlay" id="add-misto-modal">
  <div class="modal-box" style="max-width:420px">
    <h3 style="margin-bottom:14px">🏢 Přidat místo</h3>
    <input type="hidden" id="edit-misto-id">
    <div class="fg2" style="margin-bottom:10px">
      <label>Název místa *</label>
      <input id="misto-nazev-inp" placeholder="např. Budova A – 2. patro">
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Adresa / popis umístění</label>
      <input id="misto-adresa-inp" placeholder="Ulice 1, Praha">
    </div>
    <div class="fg2" style="margin-bottom:16px">
      <label>Poznámka</label>
      <textarea id="misto-pozn-inp" rows="2" style="resize:none" placeholder="Přístupový kód, kontakt…"></textarea>
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('add-misto-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveMisto()" class="btn btn-green">Uložit místo</button>
    </div>
  </div>
</div>

<!-- PŘIDAT / EDITOVAT KLIMATIZACI MODAL -->
<div class="modal-overlay" id="add-klim-modal">
  <div class="modal-box" style="max-width:540px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <h3 id="klim-modal-title">🌡 Klimatizace</h3>
      <button onclick="closeModal('add-klim-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <input type="hidden" id="edit-klim-id">
    <input type="hidden" id="edit-klim-misto-id">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2">
        <label>Model / typ *</label>
        <input id="klim-model-inp" placeholder="např. Daikin FTXM25M">
      </div>
      <div class="fg2">
        <label>Sériové číslo</label>
        <input id="klim-sn-inp" placeholder="SN123456">
      </div>
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Umístění (v rámci místa)</label>
      <input id="klim-umisteni-inp" placeholder="např. Kancelář 201, jižní stěna">
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Poznámka technika / výsledek kontroly</label>
      <textarea id="klim-pozn-inp" rows="3" style="resize:vertical" placeholder="Co bylo provedeno, co je závada…"></textarea>
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Stav po kontrole</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px" id="klim-stav-btns">
        <button type="button" onclick="setKlimStav('ok')" class="klim-stav-btn" data-stav="ok" style="padding:7px 14px;border-radius:20px;border:2px solid #16a34a;color:#16a34a;background:#f0fdf4;cursor:pointer;font-weight:700;font-size:12px">✅ OK</button>
        <button type="button" onclick="setKlimStav('zavada')" class="klim-stav-btn" data-stav="zavada" style="padding:7px 14px;border-radius:20px;border:2px solid #d97706;color:#d97706;background:#fffbeb;cursor:pointer;font-weight:700;font-size:12px">⚠️ Závada</button>
        <button type="button" onclick="setKlimStav('opraveno')" class="klim-stav-btn" data-stav="opraveno" style="padding:7px 14px;border-radius:20px;border:2px solid #2563eb;color:#2563eb;background:#eff6ff;cursor:pointer;font-weight:700;font-size:12px">🔧 Opraveno</button>
        <button type="button" onclick="setKlimStav('vyrazeno')" class="klim-stav-btn" data-stav="vyrazeno" style="padding:7px 14px;border-radius:20px;border:2px solid #dc2626;color:#dc2626;background:#fef2f2;cursor:pointer;font-weight:700;font-size:12px">❌ Vyřazeno</button>
      </div>
      <input type="hidden" id="klim-stav-val">
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Provedené práce / materiál</label>
      <textarea id="klim-prace-inp" rows="2" style="resize:none" placeholder="Vyčištění filtrů, doplnění chladiva…"></textarea>
    </div>
    <div class="fg2" style="margin-bottom:14px">
      <label>Foto (max 5)</label>
      <input type="file" id="klim-foto-inp" accept="image/*" multiple capture="environment" style="font-size:12px">
      <div id="klim-foto-preview" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"></div>
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('add-klim-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveKlimatizace()" id="save-klim-btn" class="btn btn-green">Uložit</button>
    </div>
  </div>
</div>

<!-- IMPORT CSV MODAL -->
<div class="modal-overlay" id="mista-import-modal">
  <div class="modal-box" style="max-width:560px">
    <h3 style="margin-bottom:8px">📥 Import míst a klimatizací z CSV</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">CSV musí mít záhlaví: <code>misto,model,seriove_cislo,umisteni,poznamka</code></p>
    <div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:10px;font-size:11px;font-family:monospace;margin-bottom:12px;color:#475569">
      misto,model,seriove_cislo,umisteni,poznamka<br>
      Budova A,Daikin FTXM25M,SN001,Kancelář 101,<br>
      Budova A,Mitsubishi MSZ-LN35,SN002,Kancelář 102,<br>
      Budova B,LG S09EQ,SN003,Recepce,Nefunguje chlazení
    </div>
    <div class="fg2" style="margin-bottom:12px">
      <label>Načíst soubor (.csv)</label>
      <input type="file" id="mista-csv-file" accept=".csv,.txt" style="font-size:12px">
    </div>
    <div class="fg2" style="margin-bottom:12px">
      <label>Nebo vložte CSV text přímo:</label>
      <textarea id="mista-csv-text" rows="6" style="font-family:monospace;font-size:11px;resize:vertical" placeholder="misto,model,seriove_cislo,umisteni,poznamka&#10;Budova A,Daikin FTXM25M,SN001,..."></textarea>
    </div>
    <div id="mista-csv-preview" style="margin-bottom:12px"></div>
    <div class="modal-foot">
      <button onclick="closeModal('mista-import-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="parseMistaCsv()" class="btn btn-primary">Načíst a zobrazit</button>
      <button onclick="importMistaCsv()" id="mista-import-btn" class="btn btn-green" style="display:none">✓ Importovat</button>
    </div>
  </div>
</div>

<!-- RYCHLÁ ZAKÁZKA MODAL (technik) -->
<div id="quick-zakaz-overlay" style="position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center">
  <div style="background:var(--card);border-radius:18px 18px 0 0;width:100%;max-width:520px;padding:20px;padding-bottom:calc(20px + env(safe-area-inset-bottom))">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 style="font-size:15px;font-weight:800;color:var(--navy)">⚡ Rychlá zakázka</h3>
      <button onclick="closeQuickZakazka()" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Název zakázky *</label>
      <input id="qz-nazev" placeholder="Co je potřeba udělat?" style="font-size:15px">
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Zákazník</label>
      <input id="qz-zakaznik" placeholder="Jméno nebo firma" list="qz-zak-list">
      <datalist id="qz-zak-list"></datalist>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2">
        <label>Termín</label>
        <input id="qz-termin" type="date">
      </div>
      <div class="fg2">
        <label>Adresa</label>
        <input id="qz-adresa" placeholder="Ulice, město">
      </div>
    </div>
    <div class="fg2" style="margin-bottom:16px">
      <label>Stručný popis (volitelné)</label>
      <textarea id="qz-popis" rows="2" placeholder="Co je závada, co vzít s sebou…" style="resize:none"></textarea>
    </div>
    <button onclick="saveQuickZakazka()" style="width:100%;padding:13px;background:var(--green);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit">
      ✓ Vytvořit zakázku
    </button>
  </div>
</div>

<!-- ZÁKAZNÍK PODPIS OVERLAY — celoobrazovkový, jen pro zákazníka -->
<div id="zakaznik-sig-overlay" style="position:fixed;inset:0;z-index:9000;display:none;flex-direction:column;background:#0f1f3d;touch-action:none">
  <!-- Instrukce nahoře -->
  <div style="padding:16px 20px;text-align:center;flex-shrink:0">
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:rgba(255,255,255,.5);margin-bottom:6px">Předání servisního zásahu</div>
    <div style="font-size:18px;font-weight:800;color:#fff" id="zak-sig-nazev"></div>
    <div style="font-size:13px;color:rgba(255,255,255,.7);margin-top:3px" id="zak-sig-prace"></div>
  </div>
  <!-- Shrnutí prací -->
  <div id="zak-sig-summary" style="margin:0 16px 10px;background:rgba(255,255,255,.08);border-radius:10px;padding:10px 14px;font-size:12px;color:rgba(255,255,255,.8);max-height:80px;overflow-y:auto;flex-shrink:0"></div>
  <!-- Výzva k podpisu -->
  <div style="text-align:center;font-size:13px;color:rgba(255,255,255,.6);margin-bottom:6px;flex-shrink:0">
    ✍️ Podepište níže pro potvrzení převzetí
  </div>
  <!-- Podpisová plocha -->
  <canvas id="zak-sig-canvas" style="flex:1;width:100%;background:#fff;cursor:crosshair;display:block;touch-action:none"></canvas>
  <!-- Tlačítka dole -->
  <div style="padding:14px 16px;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-shrink:0">
    <button onclick="clearZakaznikSig()" style="background:rgba(255,255,255,.15);border:none;border-radius:8px;color:#fff;padding:10px 18px;font-family:inherit;font-size:13px;cursor:pointer">
      ✕ Vymazat
    </button>
    <div style="display:flex;gap:10px">
      <button onclick="cancelZakaznikSig()" style="background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;color:rgba(255,255,255,.7);padding:10px 18px;font-family:inherit;font-size:13px;cursor:pointer">
        Zrušit
      </button>
      <button onclick="confirmZakaznikSig()" style="background:#6abf3e;border:none;border-radius:8px;color:#fff;padding:10px 24px;font-family:inherit;font-size:14px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Potvrdit podpis
      </button>
    </div>
  </div>
</div>

<div class="sig-fs-overlay" id="sig-fs">
  <div class="sig-fs-bar">
    <span id="sig-fs-title">Podpis</span>
    <button onclick="clearSigFS()" style="background:rgba(255,255,255,.15);border:none;border-radius:5px;color:#fff;padding:5px 12px;font-family:inherit;font-size:12px;cursor:pointer">✕ Vymazat</button>
  </div>
  <canvas id="sig-fs-canvas" class="sig-fs-canvas"></canvas>
  <div class="sig-fs-foot">
    <button onclick="closeSigFS(false)" class="btn btn-ghost" style="color:#fff;border-color:rgba(255,255,255,.3)">Zrušit</button>
    <button onclick="closeSigFS(true)" class="btn btn-green">✓ Potvrdit podpis</button>
  </div>
</div>
<!-- ══ SERVISNÍ LIST MODAL ══════════════════════════════════ -->
<div class="modal-overlay" id="sl-modal" style="align-items:flex-start;padding:0;overflow-y:auto">
  <div style="background:#fff;width:100%;max-width:780px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column">

    <!-- Header -->
    <div style="position:sticky;top:0;z-index:10;background:#0f1f3d;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;gap:12px" id="sl-header">
      <div style="display:flex;align-items:center;gap:10px">
        <div id="sl-brand-dot" style="width:10px;height:10px;border-radius:50%;background:#6abf3e;flex-shrink:0"></div>
        <span style="font-weight:700;font-size:14px;color:#fff" id="sl-nazev">Servisní list</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div style="display:flex;gap:4px" id="sl-steps-dots">
          <span class="sl-dot sl-dot-active" data-step="0">Základní info</span>
          <span class="sl-dot" data-step="1">Servisní práce</span>
          <span class="sl-dot" data-step="2">Položky</span>
          <span class="sl-dot" data-step="3">Poznámky</span>
          <span class="sl-dot" data-step="4">Fotografie</span>
          <span class="sl-dot" data-step="5">Podpisy</span>
          <span class="sl-dot" data-step="6">Odeslat & Tisk</span>
        </div>
        <button onclick="closeServiceListModal()" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:7px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:600">✕ Zavřít</button>
      </div>
    </div>

    <!-- Step panels -->
    <div style="flex:1;padding:20px" id="sl-body">

      <!-- STEP 0: Základní info -->
      <div class="sl-panel sl-active" id="sl-step-0">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
          <div class="fg2"><label>Název zakázky *</label>
            <input id="sl-nazev-inp" placeholder="např. Klimatizace Brno" autocomplete="off"></div>
          <div class="fg2"><label>Číslo servisu</label>
            <input id="sl-cislo" placeholder="2024-001" autocomplete="off"></div>
        </div>
        <!-- Volba firmy -->
        <div class="fg2" style="margin-bottom:10px">
          <label>Servis provádí *</label>
          <div style="display:flex;gap:8px">
            <button type="button" id="sl-btn-aceuro" onclick="slSetFirma('aceuro')"
              style="flex:1;padding:9px 8px;border-radius:8px;border:2px solid #6abf3e;background:#f0fff4;font-size:12px;font-weight:700;cursor:pointer;color:#0f1f3d;display:flex;align-items:center;justify-content:center;gap:5px">
              <span style="width:8px;height:8px;border-radius:50%;background:#6abf3e;display:inline-block"></span>AC EURO a.s.
            </button>
            <button type="button" id="sl-btn-progres" onclick="slSetFirma('progres')"
              style="flex:1;padding:9px 8px;border-radius:8px;border:2px solid #d0d8e8;background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:#6b7a99;display:flex;align-items:center;justify-content:center;gap:5px">
              <span style="width:8px;height:8px;border-radius:50%;background:#1e90ff;display:inline-block"></span>Progresklima CZ
            </button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
          <div class="fg2" style="position:relative">
            <label>Zákazník (IČO nebo název)</label>
            <input id="sl-zakaznik" autocomplete="off" placeholder="Název firmy nebo IČO…" oninput="slZakaznikInput(this.value)" onfocus="slZakaznikInput(this.value)">
            <div id="sl-ares-dd" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(15,31,61,.12);z-index:300;max-height:200px;overflow-y:auto;margin-top:2px"></div>
          </div>
          <div class="fg2"><label>Termín provedení</label>
            <input type="date" id="sl-termin"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:10px">
          <div class="fg2"><label>Adresa zákazníka</label>
            <input id="sl-adresa" autocomplete="off" placeholder="Ulice, město, PSČ"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px">
          <div class="fg2"><label>IČO</label><input id="sl-ico" placeholder="12345678"></div>
          <div class="fg2"><label>DIČ</label><input id="sl-dic" placeholder="CZ12345678"></div>
        </div>
        <div class="fg2" style="margin-bottom:10px;position:relative">
          <label>Technik</label>
          <input id="sl-technik" placeholder="Jméno technika" autocomplete="off"
            oninput="slTechnikInput(this.value)" onfocus="slTechnikInput(this.value)">
          <div id="sl-technik-dd" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(15,31,61,.12);z-index:300;max-height:200px;overflow-y:auto;margin-top:2px"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="fg2"><label>Datum zahájení (sd1)</label><input type="date" id="sl-sd1"></div>
          <div class="fg2"><label>Datum ukončení (sd2)</label><input type="date" id="sl-sd2"></div>
        </div>
      </div>

      <!-- STEP 1: Servisní práce -->
      <div class="sl-panel" id="sl-step-1">
        <div class="fg2">
          <label>Popis provedených servisních prací</label>
          <textarea id="sl-prace" rows="10" placeholder="Detailní popis všech provedených úkonů…" style="width:100%;resize:vertical"></textarea>
        </div>
      </div>

      <!-- STEP 2: Položky a ceny -->
      <div class="sl-panel" id="sl-step-2">
        <div style="border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:12px">
          <table style="width:100%;border-collapse:collapse" class="ceny-tbl">
            <thead><tr>
              <th style="text-align:left;padding:8px 10px;width:44%">Položka</th>
              <th style="width:13%;text-align:center">Počet</th>
              <th style="width:18%;text-align:center;color:#6abf3e">Cena/ks</th>
              <th style="width:18%;text-align:center">Celkem</th>
            </tr></thead>
            <tbody id="sl-rows">
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol1" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc1" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen1" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel1" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol2" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc2" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen2" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel2" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol3" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc3" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen3" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel3" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol4" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc4" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen4" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel4" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol5" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc5" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen5" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel5" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol6" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc6" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen6" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel6" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol7" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc7" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen7" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel7" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-pol8" placeholder="Položka..." oninput="slCalc()"></td>
                <td><input type="number" id="sl-poc8" min="0" step="1" oninput="slCalc()"></td>
                <td><input type="number" id="sl-cen8" min="0" step="0.01" oninput="slCalc()"></td>
                <td><input id="sl-cel8" readonly style="background:var(--locked)"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin:16px 0 6px">Cestovní náklady</div>
        <div style="border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:12px">
          <table style="width:100%;border-collapse:collapse" class="ceny-tbl">
            <tbody>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-elab1" style="font-style:italic" oninput="slCalc()"></td>
                <td><input type="number" id="sl-epoc1" min="0" step="0.5" oninput="slCalc()"></td>
                <td><input type="number" id="sl-ecen1" min="0" step="1" oninput="slCalc()"></td>
                <td><input id="sl-ecel1" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-elab2" style="font-style:italic" oninput="slCalc()"></td>
                <td><input type="number" id="sl-epoc2" min="0" step="0.5" oninput="slCalc()"></td>
                <td><input type="number" id="sl-ecen2" min="0" step="1" oninput="slCalc()"></td>
                <td><input id="sl-ecel2" readonly style="background:var(--locked)"></td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td><input type="text"   id="sl-elab3" style="font-style:italic" oninput="slCalc()"></td>
                <td><input type="number" id="sl-epoc3" min="0" step="0.5" oninput="slCalc()"></td>
                <td><input type="number" id="sl-ecen3" min="0" step="1" oninput="slCalc()"></td>
                <td><input id="sl-ecel3" readonly style="background:var(--locked)"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="total-bar"><span>Cena bez DPH</span><strong id="sl-total">—</strong></div>
        <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="fg2"><label>DUZP</label><input type="date" id="sl-duzp"></div>
        </div>
      </div>

      <!-- STEP 3: Poznámky -->
      <div class="sl-panel" id="sl-step-3">
        <div class="fg2" style="margin-bottom:12px">
          <label>Poznámky pro zákazníka</label>
          <textarea id="sl-pozn" rows="6" placeholder="Doporučení, upozornění…" style="width:100%;resize:vertical"></textarea>
        </div>
        <div class="fg2">
          <label>Interní komentář <span style="font-weight:400;color:var(--muted)">(pouze pro kancelář)</span></label>
          <textarea id="sl-komentar" rows="4" placeholder="Interní poznámky…" style="width:100%;resize:vertical"></textarea>
        </div>
      </div>

      <!-- STEP 4: Fotografie -->
      <div class="sl-panel" id="sl-step-4">
        <div style="border:2px dashed var(--border);border-radius:10px;padding:24px;text-align:center;cursor:pointer;margin-bottom:16px"
          onclick="document.getElementById('sl-foto-inp').click()"
          ondragover="event.preventDefault()" ondrop="slHandleDrop(event)">
          <div style="font-size:28px;margin-bottom:8px">📷</div>
          <div style="font-size:13px;font-weight:600;color:var(--navy)">Klikněte nebo přetáhněte fotografie</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">JPG, PNG — bez omezení počtu</div>
        </div>
        <input type="file" id="sl-foto-inp" multiple accept="image/*" capture="environment" style="display:none" onchange="slAddPhotos(this.files)">
        <div id="sl-photos-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px"></div>
      </div>

      <!-- STEP 5: Podpisy -->
      <div class="sl-panel" id="sl-step-5">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--navy);margin-bottom:8px">Podpis technika</div>
            <canvas id="sl-sig1" width="300" height="150"
              style="border:1.5px solid var(--border);border-radius:8px;background:#fafbfc;touch-action:none;width:100%;display:block"></canvas>
            <button onclick="slClearSig(1)" style="margin-top:6px;font-size:11px;color:var(--muted);background:none;border:none;cursor:pointer">✕ Vymazat</button>
          </div>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--navy);margin-bottom:8px">Podpis zákazníka</div>
            <canvas id="sl-sig2" width="300" height="150"
              style="border:1.5px solid var(--border);border-radius:8px;background:#fafbfc;touch-action:none;width:100%;display:block"></canvas>
            <button onclick="slClearSig(2)" style="margin-top:6px;font-size:11px;color:var(--muted);background:none;border:none;cursor:pointer">✕ Vymazat</button>
          </div>
        </div>
      </div>

      <!-- STEP 6: Odeslat & Tisk -->
      <div class="sl-panel" id="sl-step-6">
        <div id="sl-summary" style="background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:20px;font-size:13px;line-height:1.8"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px">
          <label style="display:flex;align-items:center;gap:7px;font-size:12px;cursor:pointer;padding:6px 10px;background:#f8fafc;border:1px solid var(--border);border-radius:7px">
            <input type="checkbox" id="sl-print-photos" style="width:14px;height:14px;accent-color:var(--blue)">
            Zahrnout fotodokumentaci
          </label>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="slPrint()" style="display:flex;align-items:center;gap:7px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Vytisknout servisní list
          </button>
          <button class="btn btn-green" onclick="slSaveAndPrint()" style="display:flex;align-items:center;gap:7px">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Uložit do zakázky & Tisk
          </button>
        </div>
        <div id="sl-save-status" style="font-size:12px;color:var(--muted);margin-top:8px"></div>
      </div>

    </div><!-- /sl-body -->

    <!-- Footer navigace -->
    <div style="position:sticky;bottom:0;background:#f8fafc;border-top:1px solid var(--border);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:12px">
      <button id="sl-btn-prev" onclick="slGoTo(window._slStep-1)"
        style="padding:9px 20px;border-radius:8px;border:1.5px solid var(--border);background:#fff;font-size:13px;font-weight:600;cursor:pointer;color:var(--text)">
        ← Zpět
      </button>
      <span id="sl-step-label" style="font-size:12px;color:var(--muted);font-weight:600">Krok 1 z 7</span>
      <button id="sl-btn-next" onclick="slGoTo(window._slStep+1)"
        style="padding:9px 20px;border-radius:8px;border:none;background:#6abf3e;font-size:13px;font-weight:700;cursor:pointer;color:#fff" id="sl-btn-next">
        Pokračovat →
      </button>
    </div>

  </div>
</div>


<div id="print-container"></div>

<!-- ══ KANCELÁŘ APP ═══════════════════════════════════════════ -->

<div id="app-kancelar" style="display:none;flex-direction:column;min-height:100vh">
  <div class="topbar">
    <img class="topbar-logo" src="data:image/jpeg;base64,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" alt="AC EURO">
    <div class="topbar-right">
      <span class="badge-admin">Kancelář</span>
      <span id="role-badge" style="font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;margin-right:6px"></span><div class="user-info">
        <div class="av" id="user-av">?</div>
        <span id="user-name"></span>
      </div>
      <button class="btn-out" onclick="doSignOut()">Odhlásit</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('orders')">📋 Zakázky</button>
    <button class="tab-btn" onclick="switchTab('dash')">📊 Přehled</button>
    <button class="tab-btn" onclick="switchTab('sklad')">📦 Sklad</button>
    <button class="tab-btn" onclick="switchTab('sablony')">📄 Šablony</button>
    <button class="tab-btn" onclick="switchTab('zakaznici')">👥 Zákazníci</button>
    <button class="tab-btn" onclick="switchTab('vykaz')">📋 Výkaz práce</button>
    <button class="tab-btn" onclick="switchTab('cenik')">💲 Ceník</button>
    <button class="tab-btn" onclick="switchTab('galerie')">📷 Galerie</button>
    <button class="tab-btn admin-only" onclick="switchTab('zakazky-typy')">📁 Typy zakázek</button>
    <button class="tab-btn admin-only" onclick="switchTab('users')">👤 Technici</button>
    <button class="tab-btn admin-only" onclick="switchTab('historie')">📈 Historie</button>
  </div>

  <!-- TAB: ORDERS -->
  <div class="tab-panel active" id="tab-orders">
    <div class="layout">
      <div class="list-panel">
        <div class="list-hdr">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px">
            <h2>Zakázky <span id="count-badge" style="font-size:11px;color:var(--muted);font-weight:400"></span></h2>
            <button onclick="openAddZakazkaModal()" style="padding:6px 12px;background:var(--green2);color:#fff;border:none;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Přidat
            </button>
            <button class="btn btn-ghost" onclick="document.getElementById('import-modal').classList.add('open')" style="font-size:11px;padding:5px 10px" title="Import ze CSV/Excel">📥</button>
            <button class="btn btn-ghost" onclick="document.getElementById('notif-settings-modal').classList.add('open')" style="font-size:11px;padding:5px 10px" title="Nastavení notifikací">🔔</button>
          </div>
          <div id="bulk-bar" style="display:none;padding:8px 12px;background:#eff6ff;border-bottom:1px solid #bfdbfe;align-items:center;gap:8px;flex-wrap:wrap">
          <span id="bulk-count" style="font-size:12px;font-weight:700;color:#1d4ed8">0 vybráno</span>
          <select id="bulk-stav-sel" class="filter-sel" style="font-size:11px;padding:4px 8px">
            <option value="">-- Změnit stav --</option>
            <option value="ke zpracování">👁 Ke zpracování</option>
            <option value="rozpracovaná">🔧 Rozpracované</option>
            <option value="na cestě">🚗 Na cestě</option>
            <option value="zpracovaná">✅ Zpracované</option>
            <option value="fakturovaná">🧾 Fakturované</option>
            <option value="zaplacena">💰 Zaplacené</option>
          </select>
          <button onclick="bulkChangeStav()" class="btn btn-primary" style="font-size:11px;padding:5px 12px">Použít</button>
          <button onclick="bulkSelectAll()" class="btn btn-ghost" style="font-size:11px;padding:5px 10px">Vybrat vše</button>
          <button onclick="bulkClear()" class="btn btn-ghost" style="font-size:11px;padding:5px 10px">Zrušit</button>
        </div>
        <div class="search-row">
            <input class="search-inp" id="search-inp" placeholder="🔍 Hledat..." oninput="renderList()">
            <select class="filter-sel" id="filter-stav" onchange="renderList()">
              <option value="">Vše</option>
              <option value="nová">🆕 Nové</option>
              <option value="ke zpracování">👁 Ke zpracování</option>
              <option value="rozpracovaná">🔧 Rozpracované</option>
              <option value="zpracovaná">✅ Zpracované</option>
              <option value="na cestě">🚗 Na cestě</option>
              <option value="fakturovaná">🧾 Fakturované</option>
              <option value="zaplacena">💰 Zaplacené</option>
            </select>
          </div>
          <div class="date-filter">
            <label>Od<input type="date" id="filter-od" onchange="renderList()"></label>
            <label>Do<input type="date" id="filter-do" onchange="renderList()"></label>
            <select class="filter-sel" id="filter-tech" onchange="renderList()" style="margin-top:auto;align-self:flex-end">
              <option value="">Vš. technici</option>
            </select>
          </div>
        </div>
        <div class="list-scroll" id="list-scroll">
          <div class="list-status" id="list-status">⏳ Načítám zakázky...</div>
        </div>
      </div>
      <div class="detail-panel" id="detail-panel">
        <div class="detail-empty" id="detail-empty">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <div>Vyberte zakázku ze seznamu</div>
        </div>
        <div class="detail-inner" id="detail-inner" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- TAB: DASHBOARD -->
  <div class="tab-panel" id="tab-dash">
    <div style="padding:20px;overflow-y:auto">
      <!-- KPI ROW — hlavní metriky -->
      <div class="stats-grid" id="stats-grid"></div>

      <!-- ALERT PANEL — zakázky po termínu, nezaplacené -->
      <div id="kpi-alerts" style="margin-bottom:16px;display:none">
        <div id="kpi-alerts-inner" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>

      <!-- REMINDERS -->
      <div id="reminders-panel" style="display:none;margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,#fff9f0,#fffbeb);border:1.5px solid #fde68a;border-radius:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <span style="font-size:13px;font-weight:700;color:#92400e">⏰ Blížící se termíny a připomínky</span>
          <span id="reminders-count" style="font-size:11px;color:#92400e;font-weight:600"></span>
        </div>
        <div id="reminders-list" style="display:flex;flex-direction:column;gap:6px"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px" id="charts-row">
        <div class="chart-wrap"><h3>Zakázky dle technika</h3><div class="chart-bar-list" id="chart-technici"></div></div>
        <div class="chart-wrap"><h3>Stav zakázek (tento měsíc)</h3><div class="chart-bar-list" id="chart-stavy"></div></div>
      </div>
      <div class="chart-wrap">
        <h3>Posledních 30 dní — počet zakázek</h3>
        <canvas id="trend-chart" height="80"></canvas>
      </div>
      <div class="chart-wrap" style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px">
          <h3 style="margin:0">📅 Měsíční obrat (posledních 12 měsíců)</h3>
          <div style="display:flex;gap:6px">
            <button onclick="setMonthlyFirma('all')" id="mf-all" style="font-size:11px;padding:4px 10px;border-radius:20px;border:1.5px solid var(--green);background:var(--green);color:#fff;cursor:pointer;font-weight:700">Vše</button>
            <button onclick="setMonthlyFirma('aceuro')" id="mf-aceuro" style="font-size:11px;padding:4px 10px;border-radius:20px;border:1.5px solid var(--border);background:#fff;color:var(--text);cursor:pointer;font-weight:600">AC EURO</button>
            <button onclick="setMonthlyFirma('progres')" id="mf-progres" style="font-size:11px;padding:4px 10px;border-radius:20px;border:1.5px solid var(--border);background:#fff;color:var(--text);cursor:pointer;font-weight:600">Progresklima</button>
          </div>
        </div>
        <canvas id="monthly-chart" height="80"></canvas>
        <div id="monthly-table" style="margin-top:10px;font-size:12px"></div>
      </div>
      <div class="chart-wrap" style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <h3 style="margin:0">💰 Neuhrazené zakázky</h3>
          <span id="unpaid-count" style="font-size:11px;color:var(--muted)"></span>
        </div>
        <div id="unpaid-list"></div>
      </div>
      <!-- VÝKONNOST TECHNIKŮ -->
      <div class="chart-wrap" style="margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <h3 style="margin:0">👥 Výkonnost techniků</h3>
          <select id="dash-tech-period" onchange="renderDashboard()" style="font-size:11px;padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:var(--card)">
            <option value="month">Tento měsíc</option>
            <option value="quarter">Kvartál</option>
            <option value="year">Rok</option>
          </select>
        </div>
        <div id="tech-performance-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px"></div>
      </div>

      <!-- PRŮMĚRNÁ DOBA + HODNOCENÍ -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
        <div class="chart-wrap">
          <h3 style="margin-bottom:10px">⏱ Průměrná doba zpracování</h3>
          <div id="avg-time-stats"></div>
        </div>
        <div class="chart-wrap">
          <h3 style="margin-bottom:10px">⭐ Průměrné hodnocení zákazníků</h3>
          <div id="avg-hodnoceni-stats"></div>
        </div>
      </div>

      <!-- PŘEHLED NEJNOVĚJŠÍCH -->
      <div class="chart-wrap" style="margin-top:16px">
        <h3>Nejnovější zakázky</h3>
        <table class="recent-tbl" id="recent-tbl">
          <thead><tr><th>Zakázka</th><th>Technik</th><th>Stav</th><th>Datum</th><th>Cena</th></tr></thead>
          <tbody id="recent-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB: USERS -->
  <div class="tab-panel" id="tab-zakazky-typy">
    <div style="padding:20px;overflow-y:auto;height:100%">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h2 style="font-size:16px;font-weight:700">Typy zakázek <span id="zt-count" style="font-size:11px;color:var(--muted);font-weight:400"></span></h2>
        <div style="font-size:11px;color:var(--muted)">Technici si vybírají z tohoto seznamu při zadávání nové zakázky</div>
      </div>

      <!-- Add new type form -->
      <div style="background:#f8fafc;border:1.5px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px">
        <div style="font-size:12px;font-weight:700;color:var(--n1);margin-bottom:10px">➕ Přidat typ zakázky</div>
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px;margin-bottom:8px">
          <input id="zt-nazev" placeholder="Název zakázky *" style="padding:9px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:inherit">
          <input id="zt-cislo" placeholder="Číslo servisu" style="padding:9px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:inherit">
          <input id="zt-zakaznik" placeholder="Zákazník" style="padding:9px 12px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-family:inherit">
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <button id="zt-add-btn" onclick="addZakazkaTyp()" style="padding:9px 18px;background:var(--blue);color:#fff;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer">Přidat</button>
          <div id="zt-status" style="font-size:12px"></div>
        </div>
      </div>

      <!-- List of types -->
      <div id="zt-list" style="display:flex;flex-direction:column;gap:6px">
        <div style="font-size:12px;color:var(--muted);padding:12px;text-align:center">Načítám…</div>
      </div>
    </div>
  </div>

  <div class="tab-panel" id="tab-users">
    <div style="padding:20px;overflow-y:auto">
      <div class="users-hdr" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <h2>Správa uživatelů a rolí</h2>
        <div style="display:flex;gap:8px">
          <select id="user-filter-role" class="filter-sel" onchange="reloadUserList()">
            <option value="">Všechny role</option>
            <option value="admin">👑 Admin</option>
            <option value="kancelar">🏢 Kancelář</option>
            <option value="dispatcher">📋 Dispečer</option>
            <option value="technik">🔧 Technik</option>
            <option value="pending">⏳ Čekající</option>
          </select>
        </div>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:12px;padding:8px 12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px">
        💡 <strong>Role:</strong> Admin = vše · Kancelář = správa zakázek · Dispečer = přiřazování + kontrola · Technik = terén
      </div>
      <div class="user-list" id="user-list"><div style="font-size:12px;color:var(--muted)">Načítám...</div></div>
      <div class="add-user-form">
        <h3>➕ Přidat nového technika</h3>
        <div class="form-row">
          <div class="form-inp"><label>Jméno a příjmení</label><input id="nu-name" placeholder="Jan Novák"></div>
          <div class="form-inp"><label>E-mail</label><input type="email" id="nu-email" placeholder="technik@aceuro.cz"></div>
        </div>
        <div class="form-row">
          <div class="form-inp">
            <label>Role uživatele</label>
            <select id="nu-role" class="filter-sel" style="width:100%">
              <option value="technik">🔧 Technik (terén)</option>
              <option value="kancelar">💼 Kancelář (základní)</option>
              <option value="dispatcher">📋 Dispečer (zadávání zakázek)</option>
              <option value="koordinator">🔄 Koordinátor (správa průběhu)</option>
              <option value="fakturant">🧾 Fakturant (fakturace a platby)</option>
              <option value="admin">👑 Admin (plný přístup)</option>
            </select>
          </div>
          <div class="form-inp">
            <label>Notifikace e-mailem</label>
            <input id="nu-notif-email" type="email" placeholder="jan@firma.cz (volitelné)">
          </div>
        </div>
        <div class="form-row">
          <div class="form-inp"><label>Heslo (min. 6 znaků)</label><input type="password" id="nu-pass" placeholder="••••••••"></div>
          <div class="form-inp"><label>Potvrdit heslo</label><input type="password" id="nu-pass2" placeholder="••••••••"></div>
        </div>
        <div class="fg" style="margin-bottom:8px"><label>Role</label><select id="nu-role" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;background:#fff"><option value="technik">Technik</option><option value="kancelar">Kancel&aacute;&rcaron;</option><option value="admin">Admin</option></select></div>
        <button id="nu-btn" class="btn btn-green" onclick="addUser()">Vytvo&rcaron;it &uacute;&ccaron;et</button>
        <div class="add-status" id="add-status"></div>
        <div id="users-list" style="margin-top:14px;border:1px solid #e8ecf2;border-radius:8px;overflow:hidden;background:#fff;min-height:4px"></div>
        <div id="pending-section" class="admin-only" style="display:none;margin-top:14px"><div style="font-size:13px;font-weight:700;color:#b45309;margin-bottom:8px">&#9203; Schvalte nov&eacute; registrace</div><div id="pending-list" style="border:1px solid #fcd34d;border-radius:8px;overflow:hidden;background:#fffbf0"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- TAB: HISTORIE TECHNIKŮ -->
<div class="tab-panel" id="tab-historie">
  <div style="padding:20px;height:100%;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
      <h2 style="font-size:16px;font-weight:700;color:var(--navy)">Historie techniků</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="hist-technik-sel" onchange="renderHistorie()" style="padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:#fff;min-width:180px">
          <option value="">— Všichni technici —</option>
        </select>
        <select id="hist-period-sel" onchange="renderHistorie()" style="padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:#fff">
          <option value="30">Posledních 30 dní</option>
          <option value="90">Posledních 90 dní</option>
          <option value="365">Poslední rok</option>
          <option value="0">Vše</option>
        </select>
      </div>
    </div>

    <!-- Stats cards -->
    <div id="hist-stats" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:20px"></div>

    <!-- Timeline -->
    <div id="hist-timeline"></div>
  </div>
</div>

  <!-- TAB: ZÁKAZNÍCI -->
  <div class="tab-panel" id="tab-zakaznici">
    <div style="display:flex;height:100%;min-height:0">
      <!-- Levý seznam -->
      <div style="width:320px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--card)">
        <div style="padding:14px 14px 8px;border-bottom:1px solid var(--border);flex-shrink:0">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
            <h2 style="font-size:14px;font-weight:700;color:var(--navy)">👥 Zákazníci</h2>
            <button onclick="openZakaznikModal()" class="btn btn-green" style="font-size:11px;padding:5px 12px">+ Přidat</button>
          </div>
          <input id="zak-search" class="search-inp" placeholder="🔍 Hledat zákazníka…" oninput="renderZakaznici()" style="width:100%;box-sizing:border-box">
          <div style="display:flex;gap:6px;margin-top:6px">
            <select id="zak-filter-typ" class="filter-sel" style="flex:1;font-size:11px" onchange="renderZakaznici()">
              <option value="">Všechny typy</option>
              <option value="firma">🏢 Firmy</option>
              <option value="fyzicka">👤 Fyzické osoby</option>
              <option value="vip">⭐ VIP</option>
            </select>
          </div>
          <div id="zak-count" style="font-size:10px;color:var(--muted);margin-top:6px"></div>
        </div>
        <div id="zak-list" style="overflow-y:auto;flex:1"></div>
      </div>
      <!-- Pravý detail -->
      <div style="flex:1;overflow-y:auto;background:var(--bg)">
        <div id="zak-detail-empty" style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:12px;color:var(--muted)">
          <div style="font-size:40px">👥</div>
          <div style="font-size:14px;font-weight:600">Vyberte zákazníka ze seznamu</div>
          <div style="font-size:12px">nebo přidejte nového tlačítkem +</div>
        </div>
        <div id="zak-detail" style="display:none;padding:20px"></div>
      </div>
    </div>
  </div>

  <!-- TAB: VÝKAZ PRÁCE -->
  <div class="tab-panel" id="tab-vykaz">
    <div style="padding:20px;overflow-y:auto;height:100%">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:16px;font-weight:700;color:var(--navy)">📋 Výkaz práce</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <select id="vykaz-technik" class="filter-sel" onchange="renderVykaz()">
            <option value="">Všichni technici</option>
          </select>
          <select id="vykaz-period" class="filter-sel" onchange="renderVykaz()">
            <option value="this-month">Tento měsíc</option>
            <option value="last-month">Minulý měsíc</option>
            <option value="this-week">Tento týden</option>
            <option value="last-week">Minulý týden</option>
            <option value="custom">Vlastní rozsah</option>
          </select>
          <div id="vykaz-custom-range" style="display:none;gap:6px;align-items:center;display:none">
            <input type="date" id="vykaz-od" class="filter-sel" style="padding:6px 8px">
            <span style="color:var(--muted)">—</span>
            <input type="date" id="vykaz-do" class="filter-sel" style="padding:6px 8px">
            <button onclick="renderVykaz()" class="btn btn-primary" style="font-size:11px;padding:5px 10px">Použít</button>
          </div>
          <button onclick="printVykaz()" class="btn btn-ghost" style="font-size:11px;display:flex;align-items:center;gap:5px">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            Tisk / PDF
          </button>
          <button onclick="exportVykazCSV()" class="btn btn-ghost" style="font-size:11px">Export CSV</button>
        </div>
      </div>
      <!-- Summary karty -->
      <div id="vykaz-summary" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:16px"></div>
      <!-- Tabulka -->
      <div id="vykaz-table-wrap" style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:12px" id="vykaz-tbl">
          <thead id="vykaz-thead"></thead>
          <tbody id="vykaz-tbody"></tbody>
        </table>
      </div>
      <div id="vykaz-empty" style="text-align:center;padding:40px;color:var(--muted);display:none">Žádné zakázky v tomto období</div>
      <!-- Schválení -->
      <div id="vykaz-approval" style="margin-top:16px;padding:14px;background:#f0fdf4;border:1.5px solid #86efac;border-radius:10px;display:none">
        <div style="font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px">Schválení výkazu</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="submitVykaz()" class="btn btn-green" style="font-size:12px">✅ Odeslat ke schválení</button>
          <button onclick="approveVykaz()" class="btn btn-primary" style="font-size:12px;display:none" id="vykaz-approve-btn">👑 Schválit výkaz</button>
        </div>
        <div id="vykaz-status" style="font-size:11px;color:var(--muted);margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- TAB: CENÍK -->
  <div class="tab-panel" id="tab-cenik">
    <div style="padding:20px;overflow-y:auto;height:100%">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:16px;font-weight:700;color:var(--navy)">💲 Ceník</h2>
        <div style="display:flex;gap:8px">
          <input id="cenik-search" class="search-inp" placeholder="🔍 Hledat položku..." style="max-width:220px" oninput="renderCenik()">
          <select id="cenik-kat" class="filter-sel" onchange="renderCenik()">
            <option value="">Všechny kategorie</option>
          </select>
          <button onclick="openCenikModal()" class="btn btn-green" style="font-size:12px">+ Přidat položku</button>
        </div>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:14px;padding:10px 14px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px">
        💡 Položky ceníku se automaticky nabízí jako autocomplete při vyplňování zakázky.
      </div>
      <div id="cenik-table-wrap" style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead><tr style="background:#f8fafc;border-bottom:2px solid var(--border)">
            <th style="text-align:left;padding:10px 12px;font-weight:700">Název položky</th>
            <th style="text-align:left;padding:10px 12px;font-weight:700">Kategorie</th>
            <th style="text-align:right;padding:10px 12px;font-weight:700;color:var(--green)">Cena Kč/ks</th>
            <th style="text-align:left;padding:10px 12px;font-weight:700">Jednotka</th>
            <th style="padding:10px 12px"></th>
          </tr></thead>
          <tbody id="cenik-tbody"></tbody>
        </table>
      </div>
      <div id="cenik-empty" style="text-align:center;padding:40px;color:var(--muted);display:none">Ceník je prázdný. Přidejte první položku.</div>
    </div>
  </div>

  <!-- TAB: GALERIE FOTEK -->
  <div class="tab-panel" id="tab-galerie">
    <div style="padding:20px;overflow-y:auto;height:100%">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:16px;font-weight:700;color:var(--navy)">📷 Galerie fotodokumentace</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="galerie-technik" class="filter-sel" onchange="renderGalerie()">
            <option value="">Všichni technici</option>
          </select>
          <input type="month" id="galerie-month" class="filter-sel" style="padding:6px 8px" onchange="renderGalerie()">
        </div>
      </div>
      <div id="galerie-stats" style="font-size:12px;color:var(--muted);margin-bottom:14px"></div>
      <div id="galerie-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px"></div>
      <div id="galerie-empty" style="text-align:center;padding:40px;color:var(--muted);display:none">Žádné fotografie v tomto období</div>
    </div>
  </div>

  <!-- TAB: SKLAD -->
  <div class="tab-panel" id="tab-sklad">
    <div style="padding:20px;overflow-y:auto;height:100%">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:16px;font-weight:700;color:var(--navy)">📦 Sklad materiálu</h2>
        <button onclick="openSkladModal()" class="btn btn-green" style="display:flex;align-items:center;gap:6px;font-size:12px">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Přidat položku
        </button>
      </div>
      <div style="margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="sklad-search" placeholder="🔍 Hledat položku..." class="search-inp" style="max-width:280px" oninput="renderSklad()">
        <select id="sklad-filter-cat" class="filter-sel" onchange="renderSklad()">
          <option value="">Všechny kategorie</option>
        </select>
      </div>
      <div id="sklad-table-wrap" style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead><tr style="background:#f8fafc;border-bottom:2px solid var(--border)">
            <th style="text-align:left;padding:10px 12px;font-weight:700;color:var(--navy)">Název</th>
            <th style="text-align:left;padding:10px 12px;font-weight:700;color:var(--navy)">Kategorie</th>
            <th style="text-align:center;padding:10px 12px;font-weight:700;color:var(--navy)">Skladem</th>
            <th style="text-align:center;padding:10px 12px;font-weight:700;color:var(--navy)">Min. zásoby</th>
            <th style="text-align:right;padding:10px 12px;font-weight:700;color:var(--green)">Cena/ks</th>
            <th style="padding:10px 12px"></th>
          </tr></thead>
          <tbody id="sklad-tbody"></tbody>
        </table>
      </div>
      <div id="sklad-empty" style="text-align:center;padding:40px;color:var(--muted);font-size:13px;display:none">
        Sklad je prázdný. Přidejte první položku.
      </div>
    </div>
  </div>

  <!-- TAB: ŠABLONY -->
  <div class="tab-panel" id="tab-sablony">
    <div style="padding:20px;overflow-y:auto;height:100%">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:16px;font-weight:700;color:var(--navy)">📄 Šablony zakázek</h2>
        <button onclick="openSablonaModal()" class="btn btn-green" style="display:flex;align-items:center;gap:6px;font-size:12px">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Nová šablona
        </button>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px;padding:10px 14px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px">
        💡 Šablony umožňují předvyplnit opakující se zakázky (servisní prohlídky, čistění filtrů apod.). Z šablony lze okamžitě vytvořit novou zakázku.
      </div>
      <div id="sablony-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px"></div>
      <div id="sablony-empty" style="text-align:center;padding:40px;color:var(--muted);font-size:13px;display:none">
        Žádné šablony. Vytvořte první šablonu.
      </div>
    </div>
  </div>


<!-- ══ SOUHRN ZAKÁZKY MODAL ══════════════════════ -->
<div class="modal-overlay" id="souhrn-modal" style="z-index:1050">
  <div class="modal-box" style="max-width:700px;max-height:92vh;display:flex;flex-direction:column;padding:0;overflow:hidden">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--navy)">
      <span style="font-size:14px;font-weight:700;color:#fff">📋 Souhrn zakázky</span>
      <div style="display:flex;gap:8px">
        <button onclick="printSouhrn()" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:7px;padding:5px 12px;cursor:pointer;font-size:12px;font-family:inherit">🖨 Tisk</button>
        <button onclick="closeModal('souhrn-modal')" style="background:none;border:none;color:rgba(255,255,255,.7);font-size:22px;cursor:pointer;line-height:1">×</button>
      </div>
    </div>
    <div id="souhrn-body" style="flex:1;overflow-y:auto;padding:20px;background:var(--bg)"></div>
  </div>
</div>

<!-- ══ FOTO ANOTAČNÍ MODAL ════════════════════════ -->
<div class="modal-overlay" id="annot-modal" style="z-index:1100">
  <div class="modal-box" style="max-width:820px;width:96vw;max-height:95vh;display:flex;flex-direction:column;padding:0;overflow:hidden">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--card)">
      <h3 style="font-size:14px;font-weight:700">✏️ Anotace fotografie</h3>
      <div style="display:flex;gap:6px;align-items:center">
        <!-- Nástroje -->
        <select id="annot-tool" style="font-size:11px;padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:#fff">
          <option value="pen">🖊 Pero</option>
          <option value="arrow">➡ Šipka</option>
          <option value="rect">⬜ Obdélník</option>
          <option value="circle">⭕ Kruh</option>
          <option value="text">🔤 Text</option>
          <option value="eraser">⬜ Guma</option>
        </select>
        <input type="color" id="annot-color" value="#ff0000" style="width:32px;height:28px;border:1px solid var(--border);border-radius:6px;cursor:pointer;padding:2px">
        <select id="annot-size" style="font-size:11px;padding:4px 8px;border:1px solid var(--border);border-radius:6px;background:#fff">
          <option value="2">Tenká</option>
          <option value="4" selected>Střední</option>
          <option value="8">Silná</option>
        </select>
        <button onclick="annotUndo()" style="font-size:11px;padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer" title="Zpět (Ctrl+Z)">↩ Zpět</button>
        <button onclick="annotClear()" style="font-size:11px;padding:4px 10px;border:1px solid #fecaca;border-radius:6px;background:#fff5f5;color:#dc2626;cursor:pointer">🗑 Vše</button>
        <button onclick="closeModal('annot-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);margin-left:4px">×</button>
      </div>
    </div>
    <!-- Canvas -->
    <div style="flex:1;overflow:hidden;background:#1a1a2e;display:flex;align-items:center;justify-content:center;min-height:300px">
      <canvas id="annot-canvas" style="max-width:100%;max-height:100%;cursor:crosshair;touch-action:none"></canvas>
    </div>
    <!-- Footer -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-top:1px solid var(--border);flex-shrink:0;background:var(--card)">
      <span style="font-size:11px;color:var(--muted)">Kreslete myší nebo prstem · Ctrl+Z = zpět</span>
      <div style="display:flex;gap:8px">
        <button onclick="closeModal('annot-modal')" class="btn btn-ghost">Zrušit</button>
        <button onclick="saveAnnotation()" class="btn btn-green" style="display:flex;align-items:center;gap:6px">
          💾 Uložit anotaci
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ══ ZÁKAZNÍCI MODAL (přidat/upravit) ═══════════════ -->
<div class="modal-overlay" id="zakaznik-modal">
  <div class="modal-box" style="max-width:520px;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="zakaznik-modal-title">Přidat zákazníka</h3>
      <button onclick="closeModal('zakaznik-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <input type="hidden" id="zakaznik-edit-id">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2" style="grid-column:1/-1"><label>Název / Jméno *</label><input id="zak-nazev" placeholder="Firma s.r.o. nebo Jan Novák"></div>
      <div class="fg2"><label>IČO</label><input id="zak-ico" placeholder="12345678" oninput="if(this.value.length===8)aresLookupZak()"></div>
      <div class="fg2"><label>DIČ</label><input id="zak-dic" placeholder="CZ12345678"></div>
      <div class="fg2" style="grid-column:1/-1"><label>Adresa</label><input id="zak-adresa" placeholder="Ulice 123, Praha 1"></div>
      <div class="fg2"><label>Telefon</label><input id="zak-tel" type="tel" placeholder="+420 777 888 999"></div>
      <div class="fg2"><label>E-mail</label><input id="zak-email" type="email" placeholder="info@firma.cz"></div>
      <div class="fg2"><label>Kontaktní osoba</label><input id="zak-kontakt" placeholder="Ing. Novák"></div>
      <div class="fg2"><label>Typ</label>
        <select id="zak-typ" class="filter-sel" style="width:100%">
          <option value="firma">🏢 Firma</option>
          <option value="fyzicka">👤 Fyzická osoba</option>
          <option value="vip">⭐ VIP</option>
        </select>
      </div>
      <div class="fg2" style="grid-column:1/-1"><label>Poznámky</label>
        <textarea id="zak-pozn" rows="2" style="width:100%;resize:vertical" placeholder="Specifické požadavky, přístupové informace…"></textarea>
      </div>
    </div>
    <div class="fg2" style="margin-bottom:12px">
      <label>📋 Protokol pro tohoto zákazníka</label>
      <select id="zak-protokol" style="width:100%;padding:8px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:var(--card)">
        <option value="">— Standardní (bez speciálního protokolu) —</option>
        <option value="kaufland_rocni">Kaufland — Roční revize (05A, březen/duben)</option>
        <option value="kaufland_pulrocni">Kaufland — Půlroční revize (05B, září/říjen)</option>
        <option value="minobr">Ministerstvo obrany — Zápis o údržbě KJ</option>
      </select>
    </div>
    <div id="zak-smlouva-row" class="fg2" style="margin-bottom:12px;display:none">
      <label id="zak-smlouva-label">Číslo smlouvy / rámcové dohody</label>
      <input id="zak-smlouva" placeholder="R-878-2745-2023-C nebo 25106000371">
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('zakaznik-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveZakaznik()" class="btn btn-green">Uložit zákazníka</button>
    </div>
  </div>
</div>

<!-- ══ HODNOCENÍ ZÁKAZNÍKA MODAL ══════════════════ -->
<div class="modal-overlay" id="hodnoceni-modal">
  <div class="modal-box" style="max-width:460px;text-align:center">
    <div style="font-size:36px;margin-bottom:8px">⭐</div>
    <h3 style="margin-bottom:4px" id="hodnoceni-nazev">Hodnocení zakázky</h3>
    <div style="font-size:12px;color:var(--muted);margin-bottom:20px" id="hodnoceni-sub">Jak jste spokojeni se servisním zásahem?</div>
    <input type="hidden" id="hodnoceni-id">
    <!-- Hvězdičky -->
    <div id="hvezdicky" style="display:flex;justify-content:center;gap:8px;margin-bottom:16px">
      <span id="hv1" onclick="setHvezda(1)" onmouseenter="hoverHvezda(1)" onmouseleave="hoverHvezda(0)" style="font-size:40px;cursor:pointer;transition:transform .15s;user-select:none">☆</span>
      <span id="hv2" onclick="setHvezda(2)" onmouseenter="hoverHvezda(2)" onmouseleave="hoverHvezda(0)" style="font-size:40px;cursor:pointer;transition:transform .15s;user-select:none">☆</span>
      <span id="hv3" onclick="setHvezda(3)" onmouseenter="hoverHvezda(3)" onmouseleave="hoverHvezda(0)" style="font-size:40px;cursor:pointer;transition:transform .15s;user-select:none">☆</span>
      <span id="hv4" onclick="setHvezda(4)" onmouseenter="hoverHvezda(4)" onmouseleave="hoverHvezda(0)" style="font-size:40px;cursor:pointer;transition:transform .15s;user-select:none">☆</span>
      <span id="hv5" onclick="setHvezda(5)" onmouseenter="hoverHvezda(5)" onmouseleave="hoverHvezda(0)" style="font-size:40px;cursor:pointer;transition:transform .15s;user-select:none">☆</span>
    </div>
    <div class="fg2" style="margin-bottom:12px;text-align:left">
      <label>Komentář (volitelné)</label>
      <textarea id="hodnoceni-text" rows="3" placeholder="Co se povedlo, co by šlo lépe…" style="resize:none"></textarea>
    </div>
    <div class="fg2" style="margin-bottom:16px;text-align:left">
      <label>Vaše jméno (volitelné)</label>
      <input id="hodnoceni-jmeno" placeholder="Jan Novák">
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('hodnoceni-modal')" class="btn btn-ghost">Přeskočit</button>
      <button onclick="saveHodnoceni()" class="btn btn-green">Odeslat hodnocení ⭐</button>
    </div>
  </div>
</div>

<!-- ══ QR KÓD MODAL ══════════════════════════════ -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal-box" style="max-width:340px;text-align:center">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="qr-modal-title">QR kód zakázky</h3>
      <button onclick="closeModal('qr-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div id="qr-canvas-wrap" style="display:flex;justify-content:center;margin-bottom:14px">
      <canvas id="qr-canvas" width="220" height="220" style="border:1px solid var(--border);border-radius:8px"></canvas>
    </div>
    <div id="qr-info" style="font-size:12px;color:var(--muted);margin-bottom:12px"></div>
    <div class="modal-foot">
      <button onclick="closeModal('qr-modal')" class="btn btn-ghost">Zavřít</button>
      <button onclick="downloadQR()" class="btn btn-primary">📥 Stáhnout PNG</button>
    </div>
  </div>
</div>

<!-- ══ FAKTURAČNÍ PODKLAD MODAL ═══════════════════ -->
<div class="modal-overlay" id="faktura-modal">
  <div class="modal-box" style="max-width:620px;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3>🧾 Fakturační podklad</h3>
      <button onclick="closeModal('faktura-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div id="faktura-preview" style="border:1px solid var(--border);border-radius:8px;padding:20px;background:#fff;font-family:serif"></div>
    <div class="modal-foot" style="margin-top:14px">
      <button onclick="closeModal('faktura-modal')" class="btn btn-ghost">Zavřít</button>
      <button onclick="printFaktura()" class="btn btn-primary" style="display:flex;align-items:center;gap:6px">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Tisknout / PDF
      </button>
    </div>
  </div>
</div>

<!-- ══ AUDIT LOG MODAL ════════════════════════════ -->
<div class="modal-overlay" id="audit-modal">
  <div class="modal-box" style="max-width:500px;max-height:85vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-shrink:0">
      <h3>📋 Log změn zakázky</h3>
      <button onclick="closeModal('audit-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div id="audit-list" style="overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:6px"></div>
  </div>
</div>

<!-- ══ SKLAD MODAL ═══════════════════════════════ -->
<div class="modal-overlay" id="sklad-modal">
  <div class="modal-box" style="max-width:460px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="sklad-modal-title">Přidat položku skladu</h3>
      <button onclick="closeModal('sklad-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <input type="hidden" id="sklad-edit-id">
    <div class="fg2" style="margin-bottom:10px"><label>Název položky *</label><input id="sklad-nazev" placeholder="např. Filtr vzduchový HEPA"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2"><label>Kategorie</label><input id="sklad-kat" placeholder="Filtry, Díly, Chladivo…" list="sklad-kat-list"><datalist id="sklad-kat-list"></datalist></div>
      <div class="fg2"><label>Výrobce / Kód</label><input id="sklad-kod" placeholder="Part no."></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2"><label>Skladem (ks)</label><input type="number" id="sklad-qty" min="0" step="1" value="0"></div>
      <div class="fg2"><label>Min. zásoby</label><input type="number" id="sklad-min" min="0" step="1" value="0"></div>
      <div class="fg2"><label>Cena/ks (Kč)</label><input type="number" id="sklad-cena" min="0" step="0.01"></div>
    </div>
    <div class="fg2" style="margin-bottom:16px"><label>Poznámka</label><input id="sklad-pozn" placeholder="Volitelný popis…"></div>
    <div class="modal-foot">
      <button onclick="closeModal('sklad-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveSkladItem()" class="btn btn-green">Uložit</button>
    </div>
  </div>
</div>

<!-- ══ ŠABLONA MODAL ═══════════════════════════════ -->
<div class="modal-overlay" id="sablona-modal">
  <div class="modal-box" style="max-width:540px;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="sablona-modal-title">Nová šablona zakázky</h3>
      <button onclick="closeModal('sablona-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <input type="hidden" id="sablona-edit-id">
    <div class="fg2" style="margin-bottom:10px"><label>Název šablony *</label><input id="sab-nazev" placeholder="např. Roční servisní prohlídka klimatizace"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2"><label>Typ zakázky</label><input id="sab-typ" placeholder="Servis, Montáž, Oprava…"></div>
      <div class="fg2"><label>Firma</label>
        <select id="sab-firma" class="filter-sel" style="width:100%">
          <option value="aceuro">AC EURO a.s.</option>
          <option value="progres">Progresklima CZ</option>
        </select>
      </div>
    </div>
    <div class="fg2" style="margin-bottom:10px"><label>Popis prací (předvyplní se)</label>
      <textarea id="sab-prace" rows="4" placeholder="Provedené servisní práce…" style="width:100%;resize:vertical"></textarea>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2"><label>Zadání pro technika</label><textarea id="sab-zadani" rows="2" style="width:100%;resize:vertical" placeholder="Instrukce…"></textarea></div>
      <div class="fg2"><label>Opakování (dny)</label><input type="number" id="sab-interval" min="1" placeholder="365 = ročně"></div>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:8px">Výchozí položky a ceny</div>
    <div style="border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:14px">
      <table style="width:100%;border-collapse:collapse" class="ceny-tbl">
        <thead><tr><th style="text-align:left;padding:7px 10px;width:50%">Položka</th><th style="width:15%">Počet</th><th style="width:20%">Cena/ks</th><th style="width:15%">Celkem</th></tr></thead>
        <tbody><tr style="border-bottom:1px solid var(--border)"><td><input type="text" id="sab-pol1" placeholder="Položka…" oninput="sabCalc()"></td><td><input type="number" id="sab-poc1" min="0" oninput="sabCalc()"></td><td><input type="number" id="sab-cen1" min="0" step="0.01" oninput="sabCalc()"></td><td><input id="sab-cel1" readonly style="background:var(--locked)"></td></tr><tr style="border-bottom:1px solid var(--border)"><td><input type="text" id="sab-pol2" placeholder="Položka…" oninput="sabCalc()"></td><td><input type="number" id="sab-poc2" min="0" oninput="sabCalc()"></td><td><input type="number" id="sab-cen2" min="0" step="0.01" oninput="sabCalc()"></td><td><input id="sab-cel2" readonly style="background:var(--locked)"></td></tr><tr style="border-bottom:1px solid var(--border)"><td><input type="text" id="sab-pol3" placeholder="Položka…" oninput="sabCalc()"></td><td><input type="number" id="sab-poc3" min="0" oninput="sabCalc()"></td><td><input type="number" id="sab-cen3" min="0" step="0.01" oninput="sabCalc()"></td><td><input id="sab-cel3" readonly style="background:var(--locked)"></td></tr><tr style="border-bottom:1px solid var(--border)"><td><input type="text" id="sab-pol4" placeholder="Položka…" oninput="sabCalc()"></td><td><input type="number" id="sab-poc4" min="0" oninput="sabCalc()"></td><td><input type="number" id="sab-cen4" min="0" step="0.01" oninput="sabCalc()"></td><td><input id="sab-cel4" readonly style="background:var(--locked)"></td></tr>
        </tbody>
      </table>
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('sablona-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveSablona()" class="btn btn-green">Uložit šablonu</button>
    </div>
  </div>
</div>


<!-- ══ CENÍK MODAL ════════════════════════════════ -->
<div class="modal-overlay" id="cenik-modal">
  <div class="modal-box" style="max-width:460px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="cenik-modal-title">Přidat položku ceníku</h3>
      <button onclick="closeModal('cenik-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <input type="hidden" id="cenik-edit-id">
    <div class="fg2" style="margin-bottom:10px"><label>Název položky *</label><input id="cenik-nazev" placeholder="např. Čistění výparníku"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2"><label>Kategorie</label><input id="cenik-kat-inp" placeholder="Práce, Díly, Doprava…" list="cenik-kat-list"><datalist id="cenik-kat-list"></datalist></div>
      <div class="fg2"><label>Jednotka</label><input id="cenik-jednotka" placeholder="ks, hod, km, m²…"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
      <div class="fg2"><label>Cena bez DPH (Kč)</label><input type="number" id="cenik-cena" min="0" step="0.01" placeholder="0.00"></div>
      <div class="fg2"><label>DPH %</label>
        <select id="cenik-dph" class="filter-sel" style="width:100%">
          <option value="21">21 %</option>
          <option value="12">12 %</option>
          <option value="0">0 %</option>
        </select>
      </div>
    </div>
    <div class="fg2" style="margin-bottom:16px"><label>Poznámka</label><input id="cenik-pozn" placeholder="Volitelný popis…"></div>
    <div class="modal-foot">
      <button onclick="closeModal('cenik-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveCenikItem()" class="btn btn-green">Uložit</button>
    </div>
  </div>
</div>

<!-- ══ SMS NASTAVENÍ MODAL ═════════════════════════ -->
<div class="modal-overlay" id="sms-settings-modal">
  <div class="modal-box" style="max-width:460px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <h3>📱 SMS notifikace zákazníkovi</h3>
      <button onclick="closeModal('sms-settings-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px;padding:10px 12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px">
      💡 Integrace s <strong>Twilio</strong> nebo <strong>BulkGate</strong> (česká SMS brána).
      Zákazník dostane SMS "Váš technik je na cestě" při změně stavu.
      <br><a href="https://www.bulkgate.com" target="_blank" style="color:#1d4ed8">bulkgate.com</a> — od 1 Kč/SMS.
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Poskytovatel SMS</label>
      <select id="sms-provider" class="filter-sel" style="width:100%" onchange="updateSmsProviderHelp()">
        <option value="bulkgate">BulkGate (CZ)</option>
        <option value="twilio">Twilio</option>
        <option value="none">Vypnuto</option>
      </select>
    </div>
    <div id="sms-fields">
      <div class="fg2" style="margin-bottom:10px"><label id="sms-key-label">Application ID</label><input id="sms-app-id" placeholder=""></div>
      <div class="fg2" style="margin-bottom:10px"><label id="sms-token-label">Application Token</label><input id="sms-token" placeholder="" type="password"></div>
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>Text SMS zprávy</label>
      <textarea id="sms-text" rows="3" style="width:100%;resize:vertical" placeholder="Váš technik {technik} je na cestě. Zakázka: {nazev}">${"Váš technik {technik} je na cestě. Zakázka: {nazev}"}</textarea>
      <div style="font-size:10px;color:var(--muted);margin-top:3px">Proměnné: {technik}, {nazev}, {cislo}, {termin}</div>
    </div>
    <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--muted);margin:12px 0 6px">Test SMS</div>
    <div class="fg2" style="margin-bottom:14px">
      <div style="display:flex;gap:8px">
        <input id="sms-test-tel" placeholder="+420 777 888 999" style="flex:1">
        <button onclick="testSms()" class="btn btn-primary" style="font-size:11px;flex-shrink:0">Odeslat test</button>
      </div>
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('sms-settings-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveSmsSettings()" class="btn btn-green">Uložit</button>
    </div>
  </div>
</div>

<!-- ══ MAPA TECHNIKŮ MODAL ═════════════════════════ -->
<div class="modal-overlay" id="mapa-modal" style="z-index:1000">
  <div class="modal-box" style="max-width:800px;width:95vw;max-height:90vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-shrink:0">
      <h3>🗺 Mapa techniků a zakázek</h3>
      <button onclick="closeModal('mapa-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div id="mapa-iframe-wrap" style="flex:1;border-radius:10px;overflow:hidden;min-height:400px;background:#f0f2f6;display:flex;align-items:center;justify-content:center">
      <div id="mapa-content" style="width:100%;height:100%"></div>
    </div>
    <div id="mapa-legend" style="margin-top:10px;flex-shrink:0;font-size:11px;color:var(--muted);display:flex;gap:14px;flex-wrap:wrap"></div>
  </div>
</div>

<!-- ══ IMPORT MODAL ══════════════════════════════ -->
<div class="modal-overlay" id="import-modal">
  <div class="modal-box" style="max-width:580px;max-height:88vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-shrink:0">
      <h3>📥 Import zakázek z CSV/Excel</h3>
      <button onclick="closeModal('import-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:12px;padding:10px 12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;flex-shrink:0">
      💡 Nahrajte CSV nebo XLSX soubor. Systém automaticky rozpozná sloupce.
      Povinné pole: <strong>Název</strong>. Volitelné: Zákazník, Technik, Termín (RRRR-MM-DD), Cena, Stav, IČO, Adresa, Popis prací.
    </div>
    <div id="import-dropzone" style="border:2px dashed var(--border);border-radius:10px;padding:30px;text-align:center;cursor:pointer;margin-bottom:12px;flex-shrink:0;transition:border-color .2s"
      onclick="document.getElementById('import-file-inp').click()"
      ondragover="event.preventDefault();this.style.borderColor='var(--green)'"
      ondragleave="this.style.borderColor='var(--border)'"
      ondrop="event.preventDefault();this.style.borderColor='var(--border)';handleImportDrop(event)">
      <div style="font-size:28px;margin-bottom:8px">📂</div>
      <div style="font-size:13px;font-weight:600;color:var(--navy)">Přetáhněte CSV nebo XLSX soubor sem</div>
      <div style="font-size:11px;color:var(--muted);margin-top:4px">nebo klikněte pro výběr souboru</div>
    </div>
    <input type="file" id="import-file-inp" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleImportFile(this)">
    <div id="import-preview" style="flex:1;overflow-y:auto;display:none">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:6px">
        Náhled importu — <span id="import-preview-count"></span>
      </div>
      <div id="import-preview-tbl" style="overflow-x:auto"></div>
    </div>
    <div class="modal-foot" style="flex-shrink:0;margin-top:12px">
      <button onclick="closeModal('import-modal')" class="btn btn-ghost">Zrušit</button>
      <button id="import-confirm-btn" onclick="confirmImport()" class="btn btn-green" style="display:none">
        📥 Importovat zakázky
      </button>
    </div>
  </div>
</div>

<!-- ══ EMAILJS / SMS NASTAVENÍ MODAL ══════════════ -->
<div class="modal-overlay" id="notif-settings-modal">
  <div class="modal-box" style="max-width:480px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <h3>📧 Nastavení notifikací</h3>
      <button onclick="closeModal('notif-settings-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:14px;padding:10px 12px;background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px">
      💡 Pro e-mailové notifikace zadejte EmailJS klíče. Technik dostane e-mail při přiřazení zakázky.
      <a href="https://emailjs.com" target="_blank" style="color:#1d4ed8">emailjs.com</a> (zdarma do 200 e-mailů/měsíc).
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>EmailJS Service ID</label>
      <input id="emailjs-service" placeholder="service_xxxxxxx" value="">
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>EmailJS Template ID</label>
      <input id="emailjs-template" placeholder="template_xxxxxxx" value="">
    </div>
    <div class="fg2" style="margin-bottom:10px">
      <label>EmailJS Public Key</label>
      <input id="emailjs-pubkey" placeholder="xxxxxxxxxxxxxxx" value="">
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;margin:12px 0 6px">Test notifikace</div>
    <div class="fg2" style="margin-bottom:14px">
      <label>Testovací e-mail</label>
      <div style="display:flex;gap:8px">
        <input id="emailjs-test-addr" placeholder="technik@firma.cz" style="flex:1">
        <button onclick="testEmailNotif()" class="btn btn-primary" style="font-size:11px;flex-shrink:0">Odeslat test</button>
      </div>
    </div>
    <div class="modal-foot">
      <button onclick="closeModal('notif-settings-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="saveNotifSettings()" class="btn btn-green">Uložit nastavení</button>
    </div>
  </div>
</div>


<!-- ══ PORTÁL ZÁKAZNÍKA ══════════════════════════════════ -->
<div id="app-portal" style="display:none;min-height:100vh;background:#eef1f7;font-family:'Inter',sans-serif">
  <!-- Hlavička portálu -->
  <div style="background:linear-gradient(135deg,var(--navy),var(--navy2));color:#fff;padding:16px 20px">
    <div style="display:flex;align-items:center;gap:12px;max-width:600px;margin:0 auto">
      <div id="portal-logo" style="font-size:22px;font-weight:800">🔧</div>
      <div>
        <div id="portal-firma-name" style="font-size:15px;font-weight:700">Servisní portál</div>
        <div style="font-size:11px;color:rgba(255,255,255,.6)">Sledování stavu zakázky</div>
      </div>
    </div>
  </div>

  <!-- Přihlášení portálu (přes token/kód) -->
  <div id="portal-login" style="max-width:400px;margin:40px auto;padding:0 20px">
    <div style="background:#fff;border-radius:14px;padding:28px;box-shadow:0 4px 24px rgba(0,0,0,.08)">
      <h2 style="font-size:18px;font-weight:700;color:var(--navy);margin:0 0 6px">Sledování zakázky</h2>
      <p style="font-size:13px;color:var(--muted);margin:0 0 20px">Zadejte číslo zakázky a přístupový kód který jste obdrželi od technika.</p>
      <div class="fg2" style="margin-bottom:12px">
        <label>Číslo zakázky</label>
        <input id="portal-cislo" placeholder="např. ZAK-2025-001" style="width:100%;box-sizing:border-box">
      </div>
      <div class="fg2" style="margin-bottom:16px">
        <label>Přístupový kód</label>
        <input id="portal-kod" placeholder="4místný kód" maxlength="6" style="width:100%;box-sizing:border-box;letter-spacing:4px;font-size:18px;text-align:center">
      </div>
      <button onclick="portalLogin()" class="btn btn-green" style="width:100%;justify-content:center">
        Zobrazit zakázku
      </button>
      <div id="portal-login-err" style="display:none;margin-top:10px;font-size:12px;color:var(--err);text-align:center"></div>
    </div>
  </div>

  <!-- Obsah portálu -->
  <div id="portal-content" style="display:none;max-width:600px;margin:0 auto;padding:20px">
    <!-- Stav zakázky -->
    <div style="background:#fff;border-radius:14px;padding:20px;margin-bottom:14px;box-shadow:0 2px 12px rgba(0,0,0,.06)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
        <div>
          <div id="portal-nazev" style="font-size:17px;font-weight:800;color:var(--navy)"></div>
          <div id="portal-meta" style="font-size:12px;color:var(--muted);margin-top:2px"></div>
        </div>
        <div id="portal-badge"></div>
      </div>
      <!-- Progress bar stavů -->
      <div id="portal-progress" style="margin-bottom:14px"></div>
      <!-- Detaily -->
      <div id="portal-details" style="font-size:13px;color:var(--text);line-height:1.8"></div>
    </div>
    <!-- Servisní práce -->
    <div id="portal-prace-wrap" style="display:none;background:#fff;border-radius:14px;padding:20px;margin-bottom:14px;box-shadow:0 2px 12px rgba(0,0,0,.06)">
      <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:8px">🔧 Provedené práce</div>
      <div id="portal-prace" style="font-size:13px;color:var(--text);white-space:pre-wrap"></div>
    </div>
    <!-- Fotodokumentace -->
    <div id="portal-foto-wrap" style="display:none;background:#fff;border-radius:14px;padding:20px;margin-bottom:14px;box-shadow:0 2px 12px rgba(0,0,0,.06)">
      <div style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:10px">📷 Fotodokumentace</div>
      <div id="portal-foto" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px"></div>
    </div>
    <!-- Kontakt -->
    <div style="background:#fff;border-radius:14px;padding:16px 20px;box-shadow:0 2px 12px rgba(0,0,0,.06);text-align:center">
      <div style="font-size:12px;color:var(--muted)">Dotazy ke zakázce?</div>
      <div id="portal-kontakt" style="font-size:13px;font-weight:600;color:var(--navy);margin-top:4px"></div>
    </div>
  </div>
</div>


<!-- LIGHTBOX -->
<div id="lightbox" onclick="closeLightbox()">
  <button id="lightbox-close" onclick="closeLightbox()">✕</button>
  <img id="lightbox-img" src="" alt="">
</div>

<!-- ASSIGN MODAL -->
<div class="modal-overlay" id="assign-modal">
  <div class="modal-box" style="max-width:480px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 style="margin:0">Přiřadit práci technikovi</h3>
      <button onclick="closeModal('assign-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div class="form-inp" style="margin-bottom:12px">
      <label>Technik *</label>
      <select id="assign-sel" class="filter-sel" style="width:100%;padding:9px 12px;font-size:13px"></select>
    </div>
    <div class="form-inp" style="margin-bottom:12px">
      <label>Termín provedení</label>
      <input type="date" id="assign-termin" style="width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
    </div>
    <div class="form-inp" style="margin-bottom:16px">
      <label>Zadání práce <span style="font-weight:400;color:var(--muted)">(instrukce pro technika)</span></label>
      <textarea id="assign-zadani" rows="5" placeholder="Popište co má technik provést, jaké nástroje vzít, na co si dát pozor…"
        style="width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:12.5px;font-family:inherit;resize:vertical;line-height:1.5;color:var(--text)"></textarea>
    </div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:14px;padding:8px 10px;background:var(--blue2);border-radius:6px">
      💡 Technik uvidí toto zadání na začátku vyplňování servisního listu.
    </div>
    <div class="modal-foot" style="justify-content:space-between">
      <button class="btn btn-ghost" onclick="closeModal('assign-modal')">Zrušit</button>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" onclick="downloadZakazkaSouhrn(_assignId)" style="display:flex;align-items:center;gap:5px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Souhrn pro technika
        </button>
        <button class="btn btn-green" onclick="doAssign()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
          Přiřadit
        </button>
      </div>
    </div>
  </div>
</div>

<div id="print-container"></div>

<script>


// ════════════════════════════════════════════════════════
//  SHARED HELPERS
// ════════════════════════════════════════════════════════
let _currentFirma = 'aceuro'; // 'aceuro' or 'progres'
const LOGO_DATA = "data:image/jpeg;base64,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";
const EXT_LABELS = ["Cestovní čas","Celkem ujeté km","Paušál cestovného"];
const EXT_STEPS  = [0.5, 1, 1];

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function fmt(n){return n.toLocaleString("cs-CZ",{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtD(v){if(!v)return"";if(v.includes("-")){const[y,m,d]=v.split("-");return d+"."+m+"."+y;}return v;}
function fmtTS(ts){if(!ts)return"—";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleDateString("cs-CZ")+" "+d.toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"});}

// ── AUTOCOMPLETE suggestions (built from saved zakázky) ──────
let _suggestions = [];
function updateSuggestions(zakazky){
  const freq = {};
  (zakazky||[]).forEach(z=>(z.rows||[]).forEach(r=>{
    if(r.pol&&r.pol.trim()){
      const k=r.pol.trim();
      if(!freq[k])freq[k]={label:k,cen:r.cen||"",count:0};
      freq[k].count++;
      if(r.cen)freq[k].cen=r.cen;
    }
  }));
  _suggestions=Object.values(freq).sort((a,b)=>b.count-a.count).slice(0,60);
}
function showAutocomplete(inp, priceFld){
  const q=(inp.value||"").toLowerCase().trim();
  let ac=document.getElementById("ac-list");
  if(!ac){ac=document.createElement("ul");ac.id="ac-list";ac.style.cssText="position:fixed;z-index:999;background:#fff;border:1.5px solid #d0d8e8;border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,.12);list-style:none;margin:0;padding:4px 0;font-size:12px;max-height:180px;overflow-y:auto;min-width:200px";document.body.appendChild(ac);}
  if(!q){ac.style.display="none";return;}
  const matches=_suggestions.filter(s=>s.label.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){ac.style.display="none";return;}
  const r=inp.getBoundingClientRect();
  ac.style.display="block";
  ac.style.left=r.left+"px";
  ac.style.top=(r.bottom+2)+"px";
  ac.style.width=Math.max(r.width,220)+"px";
  ac.innerHTML=matches.map((s,i)=>`<li data-i="${i}" style="padding:7px 13px;cursor:pointer;display:flex;justify-content:space-between;gap:10px"><span>${esc(s.label)}</span><span style="color:#6b7a99;font-family:'DM Mono',monospace">${s.cen?fmt(parseFloat(s.cen)||0)+" Kč/ks":""}</span></li>`).join("");
  ac.querySelectorAll("li").forEach(li=>{
    li.onmousedown=e=>{e.preventDefault();const s=matches[+li.dataset.i];inp.value=s.label;if(priceFld&&s.cen&&!priceFld.value)priceFld.value=s.cen;inp.dispatchEvent(new Event("input",{bubbles:true}));ac.style.display="none";};
    li.onmouseenter=()=>li.style.background="#f0f5ff";
    li.onmouseleave=()=>li.style.background="";
  });
}
document.addEventListener("click",()=>{const ac=document.getElementById("ac-list");if(ac)ac.style.display="none";});
document.addEventListener("scroll",()=>{const ac=document.getElementById("ac-list");if(ac)ac.style.display="none";},{passive:true});

// ════════════════════════════════════════════════════════
//  BUILD PRINT VIEW (shared A4 renderer)
// ════════════════════════════════════════════════════════
function buildPrintView(d){
  const LH=25;
  const fd = {...(FIRMA_DATA[d.firma||_currentFirma||'aceuro'])};
  fd.logo = (d.firma||_currentFirma) === 'progres' ? PROGRES_LOGO : LOGO_DATA;
  function dotLines(text,count){
    const lines=(text&&text!=='—')?text.split('\n'):[''];
    while(lines.length<count)lines.push('');
    return lines.slice(0,count).map(l=>`<div style="height:${LH}px;border-bottom:1.5px dotted #9aaac4;font-size:11px;line-height:${LH}px;padding:0 3px;font-family:'IBM Plex Sans',Arial,sans-serif;overflow:hidden;white-space:nowrap">${esc(l)}&nbsp;</div>`).join('');
  }
  function sectionHead(title){
    return `<div style="font-weight:700;font-size:12px;color:#0f1f3d;letter-spacing:.04em;margin:14px 0 6px;display:flex;align-items:center;gap:8px;font-family:'IBM Plex Sans',Arial,sans-serif">${title}<span style="flex:1;height:1px;background:#c8d2e0;display:inline-block;margin-left:6px"></span></div>`;
  }

  // Table rows
  let tblRows='';
  (d.rows||[]).forEach(r=>{
    if(!r.pol&&!r.poc&&!r.cel)return;
    tblRows+=`<div style="display:grid;grid-template-columns:2fr 70px 90px 100px;border-bottom:1px dotted #c8d2e0">
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Sans',Arial,sans-serif;color:#1a2540">${esc(r.pol||'')}</div>
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(r.poc||'')}</div>
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(r.cen||'')}</div>
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;font-weight:600;border-left:1px solid #e8ecf2;background:rgba(42,90,160,.04);color:#1a3a6b">${esc(r.cel||'')}</div>
    </div>`;
  });
  // Travel rows
  const hasExts=(d.exts||[]).some(e=>e.poc||e.cel);
  if(hasExts){
    tblRows+=`<div style="background:#f4f6fa;padding:4px 8px;font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#6b7a99;border-top:1.5px solid #c8d2e0;font-family:'IBM Plex Sans',Arial,sans-serif">Cestovní náklady</div>`;
    (d.exts||[]).forEach(e=>{
      if(!e.poc&&!e.cel)return;
      tblRows+=`<div style="display:grid;grid-template-columns:2fr 70px 90px 100px;border-bottom:1px dotted #c8d2e0">
        <div style="padding:4px 8px;font-size:10.5px;font-style:italic;color:#6b7a99;font-family:'IBM Plex Sans',Arial,sans-serif">${esc(e.label||'')}</div>
        <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(e.poc||'')}</div>
        <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(e.cen||'')}</div>
        <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;font-weight:600;border-left:1px solid #e8ecf2;background:rgba(42,90,160,.04);color:#1a3a6b">${esc(e.cel||'')}</div>
      </div>`;
    });
  }

  const pricesNote=d.pricesSkipped?`<div style="font-size:9px;font-style:italic;color:#7a5500;padding:4px 9px;background:#fffbf0;border:1px solid #f0d080;border-radius:2px;margin-top:3px;font-family:'IBM Plex Sans',Arial,sans-serif">Ceny budou doplněny před vystavením faktury.</div>`:'';
  const cena=d.cena||'Bude doplněno';

  const wrap=document.createElement('div');
  wrap.style.cssText="width:100%;background:#fff;font-family:'IBM Plex Sans',Arial,sans-serif";
  wrap.innerHTML=`
<div style="max-width:800px;margin:0 auto;background:#fff">

  <!-- HEADER -->
  <div style="padding:20px 32px 0;display:flex;align-items:flex-end;justify-content:space-between;gap:16px;border-bottom:3px solid #0f1f3d;padding-bottom:14px">
    <img src="${fd.logo||LOGO_DATA}" style="height:38px;width:auto">
    <div style="text-align:right;line-height:1.55">
      <div style="font-weight:700;font-size:12px;color:#0f1f3d;letter-spacing:.02em">${esc(fd.name)}</div>
      <div style="font-size:10px;color:#6b7a99">${esc(fd.addr)}</div>
      <div style="font-size:10px;color:#6b7a99">IČ: ${esc(fd.ic)}${fd.tel?' &nbsp;·&nbsp; Tel.: '+esc(fd.tel):''}${fd.web?' &nbsp;·&nbsp; '+esc(fd.web):''}</div>
    </div>
  </div>

  <!-- TITLE BAR -->
  <div style="background:${fd.dark};padding:11px 32px;display:flex;align-items:center;justify-content:space-between;-webkit-print-color-adjust:exact;print-color-adjust:exact">
    <span style="font-size:18px;font-weight:700;letter-spacing:.12em;color:#fff;text-transform:uppercase;font-family:'IBM Plex Sans',Arial,sans-serif">Servisní list</span>
    <span style="font-size:10px;color:rgba(255,255,255,.55);letter-spacing:.03em">${esc(d.cislo||'')}</span>
  </div>

  <!-- BODY -->
  <div style="padding:20px 32px 28px">

    <!-- Info rows -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px;margin-bottom:4px">
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Název zakázky:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(d.nazev||'—')}</span>
      </div>
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Číslo servisu:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(d.cislo||'—')}</span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px;margin-bottom:14px">
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Servisní technik:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(d.technik||'—')}</span>
      </div>
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Termín provedení:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(fmtD(d.termin)||d.termin||'—')}</span>
      </div>
    </div>

    <!-- Provedené práce -->
    ${sectionHead('Provedené servisní práce')}
    ${dotLines(d.prace,8)}

    <!-- Tabulka -->
    ${sectionHead('Spotřebovaný materiál a práce')}
    <div style="border:1px solid #c8d2e0;border-radius:3px;overflow:hidden">
      <div style="display:grid;grid-template-columns:2fr 70px 90px 100px;background:#0f1f3d;-webkit-print-color-adjust:exact;print-color-adjust:exact">
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;font-family:'IBM Plex Sans',Arial,sans-serif">Položka</div>
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;text-align:right">Počet</div>
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;text-align:right">Kč/ks</div>
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;text-align:right">Celkem</div>
      </div>
      ${tblRows}
    </div>
    ${pricesNote}

    <!-- Celková cena -->
    <div style="margin-top:10px;background:#0f1f3d;border-radius:3px;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;-webkit-print-color-adjust:exact;print-color-adjust:exact">
      <span style="font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:rgba(255,255,255,.75)">Cena bez DPH</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:17px;font-weight:700;color:#6abf3e">${esc(cena)}</span>
    </div>

    <!-- DUZP -->
    <div style="margin-top:12px;display:flex;align-items:baseline;gap:8px;border-bottom:1.5px dotted #9aaac4;padding-bottom:4px;max-width:280px">
      <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d">Datum ukončení prací (DUZP):</label>
      <span style="font-size:11.5px;color:#1a2540;padding:0 4px;flex:1">${esc(fmtD(d.duzp)||d.duzp||'')}</span>
    </div>

    <!-- Poznámky -->
    ${sectionHead('Poznámky')}
    ${dotLines(d.pozn,3)}

    <!-- Podpisy -->
    <div style="margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div style="border:1.5px solid #c8d2e0;border-radius:3px;overflow:hidden">
        <div style="background:#0f1f3d;color:#fff;font-size:9.5px;font-weight:700;padding:6px 12px;text-transform:uppercase;letter-spacing:.08em;-webkit-print-color-adjust:exact;print-color-adjust:exact">Za zhotovitele</div>
        <div style="height:64px;background:#fafbfd;display:flex;align-items:center;justify-content:center">
          ${d.sig1?`<img src="${esc(d.sig1)}" style="max-height:58px;max-width:100%;object-fit:contain">`:''}
        </div>
        <div style="padding:4px 12px;border-top:1px solid #e8ecf2;font-size:9.5px;color:#6b7a99">Datum: ${esc(d.sd1||'')}</div>
      </div>
      <div style="border:1.5px solid #c8d2e0;border-radius:3px;overflow:hidden">
        <div style="background:#0f1f3d;color:#fff;font-size:9.5px;font-weight:700;padding:6px 12px;text-transform:uppercase;letter-spacing:.08em;-webkit-print-color-adjust:exact;print-color-adjust:exact">Za objednatele</div>
        <div style="height:64px;background:#fafbfd;display:flex;align-items:center;justify-content:center">
          ${d.sig2?`<img src="${esc(d.sig2)}" style="max-height:58px;max-width:100%;object-fit:contain">`:''}
        </div>
        <div style="padding:4px 12px;border-top:1px solid #e8ecf2;font-size:9.5px;color:#6b7a99">Datum: ${esc(d.sd2||'')}</div>
      </div>
    </div>

    <!-- Footer -->
    <div style="margin-top:14px;padding-top:10px;border-top:1px solid #c8d2e0;font-size:8.5px;color:#9aaac4;line-height:1.6">
      Pokud je cena za jednotlivé úkony a materiál předem stanovena, bude tato následně doplněna při fakturaci.
      Přebírající osoba za objednatele stvrzuje svým podpisem, že činnosti popsané na tomto listě byly provedeny a je oprávněna tyto práce převzít.
    </div>

  </div>
</div>
`;

  // Photo pages — only if requested
  if(d.includePhotos && d.photos && d.photos.length){
    const PER_PAGE=6, PER_ROW=3, pages=[];
    for(let i=0;i<d.photos.length;i+=PER_PAGE) pages.push(d.photos.slice(i,i+PER_PAGE));
    pages.forEach((pp,pi)=>{
      let rows='';
      for(let r=0;r<pp.length;r+=PER_ROW){
        const trio=pp.slice(r,r+PER_ROW);
        while(trio.length<PER_ROW)trio.push(null);
        rows+=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">${
          trio.map((ph,ci)=>{
            const gi=pi*PER_PAGE+r+ci+1;
            return ph?`<div style="border:1px solid #d0d8e8;border-radius:5px;overflow:hidden;box-shadow:0 1px 4px rgba(15,31,61,.06)">
              <img src="${ph.cloudUrl||ph.dataUrl||''}" style="width:100%;aspect-ratio:4/3;object-fit:cover;display:block">
              <div style="padding:5px 8px;font-size:9px;color:#6b7a99;border-top:1px solid #e8ecf2;background:#fafbfc;font-family:'IBM Plex Sans',Arial,sans-serif">
                <span style="font-weight:600;color:#0f1f3d">Foto ${gi}</span>${ph.caption?' — '+esc(ph.caption):(ph.name?' — '+esc(ph.name.replace(/\.[^.]+$/,'')):'')}</div>
              </div>`:'<div></div>';
          }).join('')
        }</div>`;
      }
      const pg=document.createElement('div');
      pg.style.cssText='page-break-before:always;width:100%;background:#fff;font-family:\'IBM Plex Sans\',Arial,sans-serif';
      pg.innerHTML=`
<div style="max-width:800px;margin:0 auto;background:#fff">
  <div style="padding:14px 32px 0;display:flex;align-items:flex-end;justify-content:space-between;gap:16px;border-bottom:3px solid #0f1f3d;padding-bottom:10px">
    <img src="${LOGO_DATA}" style="height:30px;width:auto">
    <div style="text-align:right;font-size:9px;color:#6b7a99">Servisní list č. ${esc(d.cislo||'—')} — ${esc(d.nazev||'—')}</div>
  </div>
  <div style="background:#0f1f3d;padding:7px 32px;-webkit-print-color-adjust:exact;print-color-adjust:exact">
    <span style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.75)">Fotodokumentace${pages.length>1?' — strana '+(pi+2)+' / '+(pages.length+1):''}</span>
  </div>
  <div style="padding:16px 32px">${rows}</div>
  <div style="padding:6px 32px 10px;font-size:8px;color:#9aaac4;border-top:1px solid #e8ecf2;text-align:center">
    ${esc(d.nazev||'—')} | Technik: ${esc(d.technik||'—')} | ${esc(d.termin||'—')}
  </div>
</div>`;
      wrap.appendChild(pg);
    });
  }

  return wrap;
}



// ════════════════════════════════════════════════════════
//  STATE
// ════════════════════════════════════════════════════════
let step = 0;
let photos = []; // {dataUrl, cloudUrl, name}
let pricesSkipped = false;
let _sigFsIndex = 0;
let _sigData = {1: null, 2: null}; // base64 dataUrl
const LINE_H = 32;

// ════════════════════════════════════════════════════════
//  OFFLINE
// ════════════════════════════════════════════════════════
function showOfflineBanner(offline){
  document.getElementById('offline-banner').classList.toggle('show', offline);
}
window.addEventListener('online',  ()=>{ showOfflineBanner(false); syncPendingQueue(); });
window.addEventListener('offline', ()=>{ showOfflineBanner(true);  });

function getPendingQueue(){try{return JSON.parse(localStorage.getItem('aceuro_pending')||'[]');}catch{return [];}}
function savePendingQueue(q){try{localStorage.setItem('aceuro_pending',JSON.stringify(q));}catch{}}

async function syncPendingQueue(){
  const q=getPendingQueue();
  if(!q.length)return;
  const user=window._currentUser;
  if(!user)return;
  for(let i=q.length-1;i>=0;i--){
    try{
      await window._fb.addDoc(window._fb.collection(window._fb.db,'zakazky'),{...q[i],_offline:true});
      q.splice(i,1);
      savePendingQueue(q);
    }catch(e){break;}
  }
  updatePendingBadge();
}

function updatePendingBadge(){
  const q=getPendingQueue();
  const badge=document.getElementById('pending-badge');
  badge.classList.toggle('show',q.length>0);
  if(q.length) badge.textContent='⏳ '+q.length+' ve frontě';
}

async function checkPendingUploads(){
  updatePendingBadge();
  if(navigator.onLine)await syncPendingQueue();
}

// ════════════════════════════════════════════════════════
//  AUTH
// ════════════════════════════════════════════════════════

function showRegister(){
  document.getElementById('login-screen').querySelector('.login-card').style.display='none';
  document.getElementById('register-card').style.display='';
}
function showLogin(){
  document.getElementById('register-card').style.display='none';
  document.getElementById('login-screen').querySelector('.login-card').style.display='';
}

async function doRegister(){
  const name=document.getElementById('r-name').value.trim();
  const email=document.getElementById('r-email').value.trim();
  const pass=document.getElementById('r-pass').value;
  const pass2=document.getElementById('r-pass2').value;
  const err=document.getElementById('register-err');
  const btn=document.getElementById('btn-register');
  err.style.display='none';

  if(!name||!email||!pass){err.style.color='#b91c1c';err.textContent='Vyplňte všechna pole.';err.style.display='block';return;}
  if(pass!==pass2){err.style.color='#b91c1c';err.textContent='Hesla se neshodují.';err.style.display='block';return;}
  if(pass.length<6){err.style.color='#b91c1c';err.textContent='Heslo musí mít alespoň 6 znaků.';err.style.display='block';return;}

  btn.disabled=true; btn.textContent='Registruji...';
  try {
    const {createUserWithEmailAndPassword, updateProfile} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
    const cred = await createUserWithEmailAndPassword(window._fb.auth, email, pass);
    await updateProfile(cred.user, {displayName: name});
    // Save to Firestore with role=pending
    await window._fb.setDoc(
      window._fb.doc(window._fb.db, 'users', cred.user.uid),
      { name, email, role:'pending', registeredAt: window._fb.serverTimestamp() }
    );
    // Sign out — must wait for admin approval
    await window._fb.signOut(window._fb.auth);
    err.style.color='#16a34a';
    err.textContent='✓ Registrace proběhla. Vyčkejte na schválení adminem — pak se přihlaste.';
    err.style.display='block';
    btn.textContent='Hotovo';
    document.getElementById('r-name').value='';
    document.getElementById('r-email').value='';
    document.getElementById('r-pass').value='';
    document.getElementById('r-pass2').value='';
  } catch(e){
    const msgs={'auth/email-already-in-use':'Tento e-mail je již registrován.','auth/invalid-email':'Neplatný formát e-mailu.','auth/weak-password':'Heslo je příliš slabé.'};
    err.style.color='#b91c1c';
    err.textContent=msgs[e.code]||'Chyba: '+e.message;
    err.style.display='block';
    btn.disabled=false; btn.textContent='Zaregistrovat se';
  }
}

async function loginEmail(){
  const email=document.getElementById('l-email').value.trim();
  const pass=document.getElementById('l-pass').value;
  const btn=document.getElementById('btn-login');
  const err=document.getElementById('login-err');
  err.style.display='none';
  if(!email||!pass){showLoginErr('Vyplňte e-mail a heslo.');return;}
  btn.disabled=true;btn.textContent='Přihlašuji...';
  try{await window._fb.signInWithEmailAndPassword(window._fb.auth,email,pass);}
  catch(e){showLoginErr(authErrMsg(e.code));btn.disabled=false;btn.textContent='Přihlásit se';}
}
async function loginGoogle(){
  document.getElementById('login-err').style.display='none';
  try{
    await window._fb.signInWithPopup(window._fb.auth,window._fb.googleProvider);
  }catch(e){
    if(e.code==='auth/popup-blocked'){
      const tip=document.getElementById('popup-tip');
      if(tip)tip.style.display='block';
    }
    showLoginErr(authErrMsg(e.code));
  }
}
function authErrMsg(c){const m={'auth/invalid-credential':'Nesprávný e-mail nebo heslo.','auth/user-not-found':'Účet nenalezen.','auth/wrong-password':'Nesprávné heslo.','auth/too-many-requests':'Příliš mnoho pokusů.','auth/popup-closed-by-user':'Přihlášení zrušeno (zavřeli jste okno).','auth/popup-blocked':'Prohlížeč blokuje přihlašovací okno — viz tip níže.','auth/network-request-failed':'Chyba sítě.'};return m[c]||'Chyba: '+c;}
function showLoginErr(msg){const e=document.getElementById('login-err');e.textContent=msg;e.style.display='block';}
async function doSignOut(){if(!confirm('Odhlásit se?'))return;saveDraft();await window._fb.signOut(window._fb.auth);}

// ════════════════════════════════════════════════════════
//  NAVIGATION
// ════════════════════════════════════════════════════════
function goTo(n){
  document.querySelectorAll('.panel').forEach((p,i)=>p.classList.toggle('active',i===n));
  document.querySelectorAll('.stab').forEach((t,i)=>{
    t.classList.remove('active','done');
    if(i<n)t.classList.add('done');
    if(i===n)t.classList.add('active');
  });
  step=n;
  if(n===5){buildPreview();resizeSigPreviews();}
  if(n===6)buildSubmitSummary();
  window.scrollTo({top:0,behavior:'smooth'});
  saveDraft();
}
function nextStep(from){if(from===0&&!validate0())return;goTo(from+1);}
function validate0(){
  let ok=true;
  [['f_nazev','e_nazev'],['f_cislo','e_cislo']].forEach(([fi,ei])=>{
    const el=document.getElementById(fi);
    const empty=!el.value.trim();
    el.classList.toggle('err',empty);
    document.getElementById(ei).classList.toggle('show',empty);
    if(empty)ok=false;
    else el.addEventListener('input',()=>{el.classList.remove('err');document.getElementById(ei).classList.remove('show');},{once:true});
  });
  return ok;
}

// ════════════════════════════════════════════════════════
//  DOTTED LINES
// ════════════════════════════════════════════════════════
function buildDotLines(wrapId,taId,lines){
  const wrap=document.getElementById(wrapId);
  wrap.style.cssText='position:relative;height:'+(LINE_H*lines)+'px';
  for(let i=0;i<lines;i++){const d=document.createElement('div');d.className='dotline-row';wrap.appendChild(d);}
  const ta=document.createElement('textarea');
  ta.id=taId;ta.className='dotlines-ta';
  ta.style.cssText='height:'+(LINE_H*lines)+'px;width:100%';
  ta.spellcheck=false;
  ta.addEventListener('input',()=>{
    while(ta.scrollHeight>LINE_H*lines+6&&ta.value.length>0)ta.value=ta.value.slice(0,-1);
    saveDraft();
  });
  wrap.appendChild(ta);
}
buildDotLines('prace-wrap','f_prace',11);
buildDotLines('pozn-wrap','f_pozn',4);

// ════════════════════════════════════════════════════════
//  ITEMS TABLE + AUTOCOMPLETE
// ════════════════════════════════════════════════════════
function buildItemsTable(){
  const tb=document.getElementById('items-tbody');
  for(let i=1;i<=8;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=
      `<td><input type="text"   id="pol${i}" autocomplete="off" maxlength="60" oninput="showAutocomplete(this,document.getElementById('cen${i}'));saveDraft()"></td>`+
      `<td><input type="number" id="poc${i}" min="0" step="1"    oninput="calcRow(${i})" placeholder="0"></td>`+
      `<td><input type="number" id="cen${i}" min="0" step="0.01" oninput="calcRow(${i})" placeholder="0,00"></td>`+
      `<td class="cel"><input id="cel${i}" readonly tabindex="-1"></td>`;
    tb.appendChild(tr);
  }
  const etb=document.getElementById('ext-tbody');
  for(let i=1;i<=3;i++){
    const tr=document.createElement('tr');
    tr.innerHTML=
      `<td><input type="text" value="${esc(EXT_LABELS[i-1])}" readonly style="color:var(--lt)"></td>`+
      `<td><input type="number" id="epoc${i}" min="0" step="${EXT_STEPS[i-1]}" oninput="calcExt(${i})" placeholder="0"></td>`+
      `<td><input type="number" id="ecen${i}" min="0" step="1" oninput="calcExt(${i})" placeholder="0,00"></td>`+
      `<td class="cel"><input id="ecel${i}" readonly tabindex="-1"></td>`;
    etb.appendChild(tr);
  }
}
buildItemsTable();

function calcRow(i){const p=parseFloat(document.getElementById('poc'+i).value)||0,c=parseFloat(document.getElementById('cen'+i).value)||0;document.getElementById('cel'+i).value=p*c?fmt(p*c):'';calcTotal();saveDraft();}
function calcExt(i){const p=parseFloat(document.getElementById('epoc'+i).value)||0,c=parseFloat(document.getElementById('ecen'+i).value)||0;document.getElementById('ecel'+i).value=p*c?fmt(p*c):'';calcTotal();saveDraft();}
function calcTotal(){let t=0;for(let i=1;i<=8;i++)t+=parseFloat((document.getElementById('cel'+i).value||'0').replace(/\s/g,'').replace(',','.'))||0;for(let i=1;i<=3;i++)t+=parseFloat((document.getElementById('ecel'+i).value||'0').replace(/\s/g,'').replace(',','.'))||0;document.getElementById('cena_total').textContent=fmt(t)+' Kč';}
function skipPrices(){pricesSkipped=true;goTo(3);}

// ════════════════════════════════════════════════════════
//  PHOTOS
// ════════════════════════════════════════════════════════
// Komprese fotky před uložením
async function compressPhoto(file, maxW=1600, maxH=1200, quality=0.82) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        if(w > maxW || h > maxH) {
          const ratio = Math.min(maxW/w, maxH/h);
          w = Math.round(w*ratio); h = Math.round(h*ratio);
        }
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL('image/jpeg', quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function addPhotos(input){
  const files=Array.from(input.files);
  if(!files.length)return;
  const prog=document.getElementById('upload-prog');
  const bar=document.getElementById('bar-fill');
  const msg=document.getElementById('upload-msg');
  prog.style.display='block';bar.style.width='0%';
  let done=0;
  const total=files.length;
  files.forEach(file=>{
    (async()=>{
      try{
        msg.textContent='Komprimuji '+file.name+'...';
        const dataUrl = await compressPhoto(file);
        const origKB = Math.round(file.size/1024);
        const compKB = Math.round(dataUrl.length*0.75/1024);
        const photoObj={dataUrl,cloudUrl:'',name:file.name,caption:''};
        photos.push(photoObj);
        renderPhotos();
        if(navigator.onLine){
          try{
            const user=window._currentUser;
            const path='photos/'+user.uid+'/'+Date.now()+'_'+file.name.replace(/\.[^.]+$/,'.jpg');
            const storageRef=window._fb.ref(window._fb.storage,path);
            const resp=await fetch(dataUrl);
            const blob=await resp.blob();
            await window._fb.uploadBytes(storageRef,blob);
            photoObj.cloudUrl=await window._fb.getDownloadURL(storageRef);
            photoObj.dataUrl=await compressPhoto(file,400,300,0.6);
          }catch(err){console.warn('Upload failed:',err);}
        }
        done++;
        bar.style.width=Math.round(done/total*100)+'%';
        msg.textContent='Nahráno '+done+' z '+total+(compKB<origKB?' · ušetřeno '+(origKB-compKB)+'KB':'');
        if(done===total){setTimeout(()=>prog.style.display='none',2000);}
        saveDraft();
      }catch(err){
        console.error('Foto chyba:',err);
        done++;
        if(done===total){setTimeout(()=>prog.style.display='none',1500);}
      }
    })();
  });
  input.value='';
}
function renderPhotos(){
  const grid=document.getElementById('photo-grid');
  grid.innerHTML='';
  photos.forEach((ph,i)=>{
    const div=document.createElement('div');
    div.className='photo-thumb';
    div.style.cssText='position:relative;display:flex;flex-direction:column;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:#fff';
    const statusDot=ph.cloudUrl?'':'<div style="position:absolute;top:5px;left:5px;width:8px;height:8px;border-radius:50%;background:#f0a500;border:1.5px solid #fff" title="Čeká na upload"></div>';
    div.innerHTML=`
      <div style="position:relative">
        <img src="${ph.dataUrl||ph.cloudUrl}" style="width:100%;aspect-ratio:4/3;object-fit:cover;display:block">
        <button class="photo-del" onclick="removePhoto(${i})" style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center">✕</button>
        ${statusDot}
      </div>
      <div style="padding:4px 6px;background:#fafbfc">
        <input type="text" placeholder="Popis / anotace…" value="${(ph.caption||'').replace(/"/g,'&quot;')}"
const PROGRES_LOGO = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNDAgNzAiPjxyZWN0IHdpZHRoPSIyNDAiIGhlaWdodD0iNzAiIGZpbGw9IiMwYTNkOGYiIHJ4PSI2Ii8+PHRleHQgeD0iMTQiIHk9IjI2IiBmb250LWZhbWlseT0iQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNSIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iI2ZmZiI+UFJPR1JFU0tMSU1BPC90ZXh0Pjx0ZXh0IHg9IjE0IiB5PSI0OCIgZmlsbD0iIzdhYjNmZiIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiPkNaIHMuci5vLjwvdGV4dD48L3N2Zz4=";
          style="width:100%;border:none;outline:none;font-size:10.5px;font-family:inherit;background:transparent;color:var(--text);padding:1px 0"
          oninput="photos[${i}].caption=this.value;saveDraft()">
      </div>`;
    grid.appendChild(div);
  });
  const add=document.createElement('label');
  add.className='photo-add';add.htmlFor='photo-input';
  add.innerHTML='<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>Přidat foto';
  grid.appendChild(add);
}
function removePhoto(idx){photos.splice(idx,1);renderPhotos();saveDraft();}

// ════════════════════════════════════════════════════════
//  FULLSCREEN SIGNATURE
// ════════════════════════════════════════════════════════
let _fsCtx=null,_fsDrawing=false,_fsLx=0,_fsLy=0,_fsHasData=false;

function openSigFS(idx){
  _sigFsIndex=idx;
  const overlay=document.getElementById('sig-fs');
  const canvas=document.getElementById('sig-fs-canvas');
  document.getElementById('sig-fs-title').textContent=idx===1?'Podpis — za zhotovitele':'Podpis — za objednatele';
  overlay.classList.add('open');
  canvas.width=canvas.offsetWidth||window.innerWidth;
  canvas.height=canvas.offsetHeight||window.innerHeight-100;
  _fsCtx=canvas.getContext('2d');
  _fsCtx.clearRect(0,0,canvas.width,canvas.height);
  _fsHasData=false;
  // Pre-fill existing signature
  if(_sigData[idx]){
    const img=new Image();img.onload=()=>{_fsCtx.drawImage(img,0,0,canvas.width,canvas.height);_fsHasData=true;};img.src=_sigData[idx];
  }
  canvas.onmousedown=canvas.ontouchstart=e=>{e.preventDefault();_fsDrawing=true;const p=fsPos(e,canvas);_fsLx=p.x;_fsLy=p.y;_fsHasData=true;};
  canvas.onmousemove=canvas.ontouchmove=e=>{if(!_fsDrawing)return;e.preventDefault();const p=fsPos(e,canvas);_fsCtx.beginPath();_fsCtx.moveTo(_fsLx,_fsLy);_fsCtx.lineTo(p.x,p.y);_fsCtx.strokeStyle='#0f1f3d';_fsCtx.lineWidth=2.2;_fsCtx.lineCap='round';_fsCtx.stroke();_fsLx=p.x;_fsLy=p.y;};
  canvas.onmouseup=canvas.ontouchend=canvas.onmouseleave=()=>{_fsDrawing=false;};
}
function fsPos(e,canvas){
  const r=canvas.getBoundingClientRect(),sx=canvas.width/r.width,sy=canvas.height/r.height;
  if(e.touches)return{x:(e.touches[0].clientX-r.left)*sx,y:(e.touches[0].clientY-r.top)*sy};
  return{x:(e.clientX-r.left)*sx,y:(e.clientY-r.top)*sy};
}
function clearSigFS(){
  if(_fsCtx){const c=document.getElementById('sig-fs-canvas');_fsCtx.clearRect(0,0,c.width,c.height);}
  _fsHasData=false;
}
function closeSigFS(save){
  const overlay=document.getElementById('sig-fs');
  overlay.classList.remove('open');
  if(save&&_fsHasData){
    const canvas=document.getElementById('sig-fs-canvas');
    _sigData[_sigFsIndex]=canvas.toDataURL();
    updateSigPreview(_sigFsIndex);
  }
  saveDraft();
}
function updateSigPreview(idx){
  const sp=document.getElementById('sp'+idx);
  const sh=document.getElementById('sh'+idx);
  if(_sigData[idx]){
    sp.innerHTML=`<img src="${_sigData[idx]}" style="max-height:80px;max-width:95%;object-fit:contain">`;
    sh.classList.add('hidden');
  }else{
    sp.innerHTML='';sh.classList.remove('hidden');
  }
}
function clearSig(idx){_sigData[idx]=null;updateSigPreview(idx);saveDraft();}
function resizeSigPreviews(){[1,2].forEach(updateSigPreview);}
function getSig(idx){return _sigData[idx]||'';}

// ════════════════════════════════════════════════════════
//  PREVIEW
// ════════════════════════════════════════════════════════
function gv(id){return document.getElementById(id)?.value||'';}

function buildPreview(){
  document.getElementById('preview-body').innerHTML=
    `<div class="psec"><div class="psec-title">Zakázka</div>
      <div class="prow"><span class="pl">Název</span><span class="pv">${esc(gv('f_nazev'))}</span></div>
      <div class="prow"><span class="pl">Číslo</span><span class="pv">${esc(gv('f_cislo'))}</span></div>
      <div class="prow"><span class="pl">Zákazník</span><span class="pv">${esc(gv('f_zakaznik'))}</span></div>
      <div class="prow"><span class="pl">Termín</span><span class="pv">${fmtD(gv('f_termin'))||'—'}</span></div>
    </div>
    <div class="psec"><div class="psec-title">Servisní práce</div><div class="ptext">${esc(gv('f_prace')||'—')}</div></div>
    ${photos.length?`<div class="psec"><div class="psec-title">Fotografie (${photos.length} ks)</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(75px,1fr));gap:6px;margin-top:4px">
        ${photos.slice(0,6).map(p=>`<img src="${p.dataUrl}" style="width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:4px;border:1px solid var(--border)">`).join('')}
      </div></div>`:''}`;
}

// ════════════════════════════════════════════════════════
//  SUBMIT SUMMARY
// ════════════════════════════════════════════════════════
function buildSubmitSummary(){
  const cena=document.getElementById('cena_total').textContent;
  document.getElementById('submit-summary').innerHTML=
    `<strong>${esc(gv('f_nazev')||'—')}</strong> &nbsp;·&nbsp; ${esc(gv('f_cislo')||'—')}<br>`+
    `Zákazník: ${esc(gv('f_zakaznik')||'—')}<br>`+
    `Termín: ${fmtD(gv('f_termin'))||'—'}<br>`+
    `Fotografie: ${photos.length} ks<br>`+
    `Cena bez DPH: <strong>${cena}</strong>`+
    (pricesSkipped?`<br><span style="color:var(--warn)">⚠ Ceny přeskočeny — doplní kancelář</span>`:'');
}

// ════════════════════════════════════════════════════════
//  SUBMIT TO FIREBASE (with offline queue)
// ════════════════════════════════════════════════════════
async function submitZakazka(){
  const btn=document.getElementById('btn-submit');
  const status=document.getElementById('submit-status');
  const user=window._currentUser;
  if(!user){status.textContent='Nejste přihlášeni.';return;}

  btn.disabled=true;btn.innerHTML='⏳ Odesílám...';
  status.textContent='Připravuji data...';

  const rows=[];
  for(let i=1;i<=8;i++)rows.push({pol:gv('pol'+i),poc:gv('poc'+i),cen:gv('cen'+i),cel:gv('cel'+i)});
  const exts=[];
  for(let i=1;i<=3;i++)exts.push({label:EXT_LABELS[i-1],poc:gv('epoc'+i),cen:gv('ecen'+i),cel:gv('ecel'+i)});

  const data={
    nazev:gv('f_nazev')||'—',cislo:gv('f_cislo')||'—',
    zakaznik:gv('f_zakaznik')||'',
    adresa:gv('f_adresa')||'',ico:gv('f_ico')||'',dic:gv('f_dic')||'',
      hodiny:parseFloat(document.getElementById('f_hodiny')?.value)||0,
      km:parseInt(document.getElementById('f_km')?.value)||0,
    firma:window._currentFirma||'aceuro',
    technik:(()=>{
      // Collect all technik rows
      const rows=document.querySelectorAll('#technici-list .tech-row');
      if(!rows.length) return user.displayName||user.email;
      const names=[];
      rows.forEach(row=>{
        const sel=row.querySelector('select');
        const vlastni=row.querySelector('input[type=text]');
        if(sel.value==='vlastni'&&vlastni.value.trim()){
          names.push(vlastni.value.trim());
        } else if(sel.value&&sel.value!=='vlastni'){
          const opt=sel.options[sel.selectedIndex];
          if(opt)names.push(opt.text);
        } else {
          // first row empty = přihlášený technik
          names.push(user.displayName||user.email);
        }
      });
      return names.filter(Boolean).join(', ')||user.displayName||user.email;
    })(),
    technici:(()=>{
      // Array of {name, uid} for billing purposes
      const rows=document.querySelectorAll('#technici-list .tech-row');
      if(!rows.length) return [{name:user.displayName||user.email,uid:user.uid,email:user.email}];
      const list=[];
      rows.forEach(row=>{
        const sel=row.querySelector('select');
        const vlastni=row.querySelector('input[type=text]');
        if(sel.value==='vlastni'){
          if(vlastni.value.trim()) list.push({name:vlastni.value.trim(),uid:'',email:''});
        } else if(sel.value){
          const tech=(_techList||[]).find(x=>x.uid===sel.value);
          if(tech) list.push({name:tech.name||tech.email||sel.value,uid:tech.uid,email:tech.email||''});
        } else {
          list.push({name:user.displayName||user.email,uid:user.uid,email:user.email});
        }
      });
      return list.filter(x=>x.name);
    })(),
    technikUid:user.uid,technikEmail:user.email,
    termin:gv('f_termin')||'',
    prace:gv('f_prace')||'',pozn:gv('f_pozn')||'',komentar:gv('f_komentar')||'',
    duzp:gv('f_duzp')||'',pricesSkipped,rows,exts,
    cena:document.getElementById('cena_total').textContent,
    sig1:getSig(1),sig2:getSig(2),sd1:gv('sd1'),sd2:gv('sd2'),
    photos:photos.map(p=>({cloudUrl:p.cloudUrl,name:p.name,caption:p.caption||'',dataUrl:p.cloudUrl?'':p.dataUrl})),
    stav:'nová',updatedAt:new Date().toISOString(),
  };

  if(!navigator.onLine){
    // Save to pending queue
    const q=getPendingQueue();
    q.push(data);
    savePendingQueue(q);
    updatePendingBadge();
    status.textContent='📵 Uloženo offline — odešle se po připojení.';
    status.style.color='var(--warn)';
    btn.innerHTML='➕ Začít novou zakázku';
    btn.style.background='var(--warn)';
    btn.onclick=resetForm;
    localStorage.removeItem('aceuro_draft_'+user.uid);
    return;
  }

  try{
    status.textContent='Ukládám do databáze...';
    const docRef=await window._fb.addDoc(
      window._fb.collection(window._fb.db,'zakazky'),
      {...data,createdAt:window._fb.serverTimestamp(),updatedAt:window._fb.serverTimestamp()}
    );
    document.getElementById('pre-submit').style.display='none';
    document.getElementById('post-submit').style.display='block';
    localStorage.removeItem('aceuro_draft_'+user.uid);
  }catch(err){
    console.error('Submit error:',err);
    let msg='⚠ Chyba: '+err.message;
    if(err.code==='permission-denied'||err.message.includes('permission')){
      msg='⚠ Chyba oprávnění — zkontrolujte Firestore pravidla (viz SETUP.md krok 3)';
    }
    status.textContent=msg;
    status.style.color='var(--err)';
    btn.disabled=false;btn.innerHTML='Zkusit znovu';
  }
}

// ════════════════════════════════════════════════════════
//  PRINT
// ════════════════════════════════════════════════════════
function printCustomer(){
  const status=document.getElementById('print-status');
  status.textContent='Připravuji...';
  const inclPhotos=document.getElementById('print-photos-cb')?.checked||false;
  const d={
    nazev:gv('f_nazev')||'—',cislo:gv('f_cislo')||'—',
    technik:window._currentUser?.displayName||window._currentUser?.email||'',
    zakaznik:gv('f_zakaznik')||'',termin:gv('f_termin'),
    prace:gv('f_prace')||'—',pozn:gv('f_pozn')||'',duzp:'',
    cena:'',pricesSkipped:true,
    rows:[],exts:EXT_LABELS.map(l=>({label:l,poc:'',cen:'',cel:''})),
    sd1:fmtD(gv('sd1')),sd2:fmtD(gv('sd2')),
    sig1:getSig(1),sig2:getSig(2),
    photos:inclPhotos?photos:[],
    includePhotos:inclPhotos,
  };
  const pv=buildPrintView(d);
  const pc=document.getElementById('print-container');
  pc.innerHTML='';pc.appendChild(pv);
  setTimeout(()=>{window.print();status.textContent='✓ PDF uloženo.';},300);
}

// ════════════════════════════════════════════════════════
//  DRAFT
// ════════════════════════════════════════════════════════
function saveDraft(){
  const user=window._currentUser;if(!user)return;
  const ids=['f_nazev','f_cislo','f_zakaznik','f_adresa','f_ico','f_dic','f_termin','f_prace','f_pozn','f_duzp','sd1','sd2','f_technik_vlastni','f_komentar'];
  for(let i=1;i<=8;i++)ids.push('pol'+i,'poc'+i,'cen'+i,'cel'+i);
  for(let i=1;i<=3;i++)ids.push('epoc'+i,'ecen'+i,'ecel'+i);
  const d={pricesSkipped,sigs:_sigData};
  ids.forEach(id=>{const el=document.getElementById(id);if(el)d[id]=el.value;});
  d._photos=photos.map(p=>({dataUrl:p.dataUrl,cloudUrl:p.cloudUrl,name:p.name}));
  try{d.f_firma=_currentFirma;
  localStorage.setItem('aceuro_draft_'+user.uid,JSON.stringify(d));}catch(e){}
}

function loadDraft(){
  const user=window._currentUser;if(!user)return;
  const raw=localStorage.getItem('aceuro_draft_'+user.uid);
  if(!raw){setDefaultDates();return;}
  const d=JSON.parse(raw);
  pricesSkipped=d.pricesSkipped||false;
  if(d.sigs){_sigData=d.sigs;[1,2].forEach(updateSigPreview);}
  Object.keys(d).forEach(k=>{if(['pricesSkipped','_photos','sigs'].includes(k))return;const el=document.getElementById(k);if(el)el.value=d[k];});
  if(d._photos&&Array.isArray(d._photos)){photos=d._photos;renderPhotos();}
  calcTotal();
  setDefaultDates();
}

function setDefaultDates(){
  const today=new Date().toISOString().slice(0,10);
  const t=document.getElementById('f_termin');if(t&&!t.value)t.value=today;
  ['sd1','sd2'].forEach(id=>{const el=document.getElementById(id);if(el&&!el.value)el.value=today;});
}

function resetForm(){
  const user=window._currentUser;
  localStorage.removeItem('aceuro_draft_'+(user?.uid||''));
  photos=[];pricesSkipped=false;_sigData={1:null,2:null};
  ['f_nazev','f_cislo','f_zakaznik','f_termin','f_prace','f_pozn','f_duzp','sd1','sd2','f_technik_vlastni','f_komentar'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  for(let i=1;i<=8;i++){['pol','poc','cen','cel'].forEach(p=>{const el=document.getElementById(p+i);if(el)el.value='';});}
  for(let i=1;i<=3;i++){['epoc','ecen','ecel'].forEach(p=>{const el=document.getElementById(p+i);if(el)el.value='';});}
  [1,2].forEach(updateSigPreview);
  renderPhotos();calcTotal();
  document.getElementById('pre-submit').style.display='block';
  document.getElementById('post-submit').style.display='none';
  document.getElementById('btn-submit').disabled=false;
  document.getElementById('submit-status').textContent='';
  goTo(0);setDefaultDates();
}

document.addEventListener('input',e=>{if(!e.target.closest('#print-container')&&!e.target.closest('#sig-fs'))saveDraft();});

// ═══════════════════════════════════════════════════════════════════
//  ZAKÁZKY ZE SEZNAMU + TECHNICI ZE SEZNAMU
// ═══════════════════════════════════════════════════════════════════

let _zakazkyList = [];   // {id, nazev, cislo, zakaznik}
let _techList    = [];   // {uid, name, email}
let _assignedZakazky = []; // zakazky assigned to this technik from kancelář

async function loadZakazkyList() {
  try {
    const snap = await window._fb.getDocs(
      window._fb.query(window._fb.collection(window._fb.db,'zakazky_typy'),
        window._fb.orderBy('nazev','asc'))
    );
    _zakazkyList = snap.docs.map(d=>({id:d.id,...d.data()}));
  } catch(e) {
    // Fallback: load from zakazky collection as unique names
    try {
      const snap2 = await window._fb.getDocs(
        window._fb.query(window._fb.collection(window._fb.db,'zakazky'),
          window._fb.orderBy('createdAt','desc'))
      );
      const seen = new Set();
      _zakazkyList = [];
      snap2.docs.forEach(d => {
        const z = d.data();
        const key = (z.nazev||'').trim();
        if (key && !seen.has(key)) {
          seen.add(key);
          _zakazkyList.push({id: d.id, nazev: z.nazev, cislo: z.cislo||'', zakaznik: z.zakaznik||''});
        }
      });
    } catch(e2) {}
  }
  renderZakazkyDropdown();
}

function renderZakazkyDropdown() {
  const sel = document.getElementById('zakaz_select');
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">— Vyberte ze seznamu nebo zadejte vlastní —</option>' +
    '<option value="vlastni">✏ Vlastní (jednorázová) zakázka</option>' +
    (_zakazkyList.length ? '<optgroup label="──────────────────">' : '') +
    _zakazkyList.map(z =>
      `<option value="${esc(z.id)}">${esc(z.nazev||'—')}${z.zakaznik?' ('+esc(z.zakaznik)+')':''}</option>`
    ).join('') +
    (_zakazkyList.length ? '</optgroup>' : '');
  if (cur) sel.value = cur;
}

function onZakazSelect(val) {
  const infoDiv = document.getElementById('assigned-info');
  if (!val || val === 'vlastni') {
    document.getElementById('f_nazev').value = '';
    document.getElementById('f_cislo').value = '';
    document.getElementById('f_zakaznik').value = '';
    if(infoDiv) infoDiv.innerHTML = '';
    document.getElementById('f_nazev').focus();
    return;
  }
  const z = _zakazkyList.find(x => x.id === val) || _assignedZakazky.find(x => x.id === val);
  if (!z) return;
  if (z.nazev)     document.getElementById('f_nazev').value    = z.nazev;
  if (z.cislo)     document.getElementById('f_cislo').value    = z.cislo;
  if (z.zakaznik)  document.getElementById('f_zakaznik').value = z.zakaznik;
  if (z.termin)    document.getElementById('f_termin').value   = z.termin;
  // Show zadani (assigned work instructions)
  if(infoDiv){
    if(z.zadani){
      infoDiv.innerHTML = `
        <div style="margin-bottom:14px;padding:14px 16px;background:#eff6ff;border:1.5px solid #93c5fd;border-radius:10px">
          <div style="font-size:11px;font-weight:700;color:#1d4ed8;letter-spacing:.05em;text-transform:uppercase;margin-bottom:6px">
            📋 Zadání od kanceláře
          </div>
          <div style="font-size:13px;color:#1e3a5f;line-height:1.55;white-space:pre-wrap">${esc(z.zadani)}</div>
          ${z.termin?`<div style="margin-top:8px;font-size:11px;color:#2d5fa6;font-weight:600">📅 Termín: ${esc(fmtDate(z.termin))}</div>`:''}
        </div>`;
    } else {
      infoDiv.innerHTML = '';
    }
  }
}

async function reloadZakazkyList() {
  const btn = document.querySelector('[onclick="reloadZakazkyList()"]');
  if (btn) { btn.textContent = '⟳'; btn.disabled = true; }
  await loadZakazkyList();
  if (btn) { btn.textContent = '↻'; btn.disabled = false; }
}

// ── TECHNICI ──────────────────────────────────────────────────────

async function loadTechList() {
  try {
    const snap = await window._fb.getDocs(
      window._fb.collection(window._fb.db,'users')
    );
    _techList = snap.docs
      .map(d => ({uid: d.id, ...d.data()}))
      .filter(u => u.role === 'technik' || u.role === 'admin')
      .sort((a,b) => (a.name||'').localeCompare(b.name||''));
  } catch(e) { _techList = []; }
  if (document.getElementById('technici-list')) initTechRows();
  else renderTechDropdown();
}

function renderTechDropdown() {
  // Build all technik rows (called after _techList loaded)
  const container = document.getElementById('technici-list');
  if (!container) return;
  const rows = container.querySelectorAll('.tech-row');
  rows.forEach(row => {
    const sel = row.querySelector('select');
    if (!sel) return;
    const cur = sel.value;
    rebuildTechSelect(sel);
    if (cur) sel.value = cur;
  });
  // If no rows yet, init first row
  if (rows.length === 0) initTechRows();
}

function buildTechSelectOptions(excludeUids=[]) {
  const me = window._currentUser;
  return `<option value="">— ${esc(me?.displayName||me?.email||'Přihlášený technik')} (já) —</option>` +
    '<option value="vlastni">✏ Jiný / brigádník (zadat ručně)</option>' +
    (_techList.length ? '<optgroup label="──────────────────">' : '') +
    _techList
      .filter(u => u.uid !== me?.uid && !excludeUids.includes(u.uid))
      .map(u => `<option value="${esc(u.uid)}">${esc(u.name||u.email||u.uid)}</option>`)
      .join('') +
    (_techList.length ? '</optgroup>' : '');
}

function rebuildTechSelect(sel) {
  const cur = sel.value;
  // exclude UIDs already selected in other rows
  const allSels = document.querySelectorAll('.tech-row select');
  const taken = [];
  allSels.forEach(s => { if (s !== sel && s.value && s.value !== 'vlastni') taken.push(s.value); });
  sel.innerHTML = buildTechSelectOptions(taken);
  if (cur) sel.value = cur;
}

function initTechRows() {
  const container = document.getElementById('technici-list');
  if (!container) return;
  container.innerHTML = '';
  addTechRow();
}

function addTechRow() {
  const container = document.getElementById('technici-list');
  if (!container) return;
  const idx = container.querySelectorAll('.tech-row').length;
  const row = document.createElement('div');
  row.className = 'tech-row';
  row.style.cssText = 'display:flex;gap:6px;align-items:start';

  const sel = document.createElement('select');
  sel.style.cssText = 'flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:#fff;color:var(--text)';
  rebuildTechSelect(sel);
  sel.addEventListener('change', () => onTechRowChange(row, sel));

  const vlastniInput = document.createElement('input');
  vlastniInput.type = 'text';
  vlastniInput.placeholder = 'Jméno brigádníka / externího technika';
  vlastniInput.style.cssText = 'flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;width:100%;display:none;margin-top:4px';

  const removeBtn = document.createElement('button');
  removeBtn.type = 'button';
  removeBtn.innerHTML = '✕';
  removeBtn.title = 'Odebrat';
  removeBtn.style.cssText = 'padding:9px 10px;background:transparent;border:1.5px solid #d0d8e8;border-radius:7px;cursor:pointer;font-size:12px;color:#6b7a99;flex-shrink:0';
  removeBtn.style.display = idx === 0 ? 'none' : 'flex';
  removeBtn.addEventListener('click', () => { row.remove(); });

  const wrap = document.createElement('div');
  wrap.style.cssText = 'flex:1;display:flex;flex-direction:column';
  wrap.appendChild(sel);
  wrap.appendChild(vlastniInput);

  row.appendChild(wrap);
  row.appendChild(removeBtn);
  container.appendChild(row);
}

function onTechRowChange(row, sel) {
  const vlastni = row.querySelector('input[type=text]');
  if (sel.value === 'vlastni') {
    vlastni.style.display = 'block'; vlastni.focus();
  } else {
    vlastni.style.display = 'none'; vlastni.value = '';
  }
}

async function reloadTechList() {
  const btn = document.querySelector('[onclick="reloadTechList()"]');
  if (btn) { btn.textContent = '⟳'; btn.disabled = true; }
  await loadTechList();
  if (btn) { btn.textContent = '↻'; btn.disabled = false; }
}

function onTechSelect(val) {
  // legacy - no-op (kept for compatibility)
}





// ══ ZADÁNÍ A HISTORIE ═══════════════════════════════════════════════
function fmtDate(v){return fmtD(v);}  // alias

async function loadAssignedZakazky(user) {
  try {
    const db = window._fb.db;
    const col = window._fb.collection;
    const q = window._fb.collection;
    // Load zakazky where this user is the assignee or technik
    const email = user.email;
    const name = user.displayName || '';
    const snap = await window._fb.getDocs(
      window._fb.query(
        window._fb.collection(db, 'zakazky'),
        window._fb.orderBy('createdAt', 'desc'),
        window._fb.limit(50)
      )
    );
    _assignedZakazky = [];
    snap.docs.forEach(d => {
      const z = {id: d.id, ...d.data()};
      const isMe = z.assignedTo === name || z.assignedTo === email ||
                   z.technik === name || z.technik === email ||
                   (z.technikEmail && z.technikEmail === email);
      if(isMe) _assignedZakazky.push(z);
    });
    renderAssignedPanel();
  } catch(e) {
    console.warn('loadAssignedZakazky failed:', e.message);
  }
}

// ══ FIRMA SWITCHER ══════════════════════════════════════════════════
const FIRMA_DATA = {
  aceuro: {
    name: 'AC EURO a.s.',
    addr: 'Houbalova 2553/4, 628 00 Brno',
    ic: '28264347', dic: 'CZ28264347',
    tel: '544 234 330', web: 'www.aceuro.cz',
    color: '#6abf3e', dark: '#0f1f3d', logo: null, // logo set after LOGO_DATA
    class: 'brand-aceuro'
  },
  progres: {
    name: 'Progresklima CZ s.r.o.',
    addr: 'Brno',
    ic: '', dic: '',
    tel: '', web: 'www.progresklima.cz',
    color: '#1e90ff', dark: '#0a3d8f', logo: null, // logo set after PROGRES_LOGO
    class: 'brand-progres'
  }
};

function setFirma(firma) {
  _currentFirma = firma;
  const fd = FIRMA_DATA[firma];
  // Body class
  document.body.classList.remove('brand-aceuro','brand-progres');
  document.body.classList.add(fd.class);
  // Buttons
  const btnAC = document.getElementById('btn-firma-aceuro');
  const btnPR = document.getElementById('btn-firma-progres');
  if(btnAC){
    const isAC = firma === 'aceuro';
    btnAC.style.border = isAC ? '2px solid #6abf3e' : '2px solid #d0d8e8';
    btnAC.style.background = isAC ? '#f0fff4' : '#fff';
    btnAC.style.color = isAC ? '#0f1f3d' : '#6b7a99';
    btnPR.style.border = !isAC ? '2px solid #1e90ff' : '2px solid #d0d8e8';
    btnPR.style.background = !isAC ? '#eff6ff' : '#fff';
    btnPR.style.color = !isAC ? '#0a3d8f' : '#6b7a99';
  }
  // Update topbar accent line color
  const topbarLine = document.getElementById('topbar-accent');
  if(topbarLine) topbarLine.style.background = fd.color;
  // Store in draft
  saveDraft && saveDraft();
}

// ══ ARES NAŠEPTÁVAČ ══════════════════════════════════════════════════
let _aresTimer = null;
let _aresActive = false;

function aresDebounce(val) {
  clearTimeout(_aresTimer);
  const dropdown = document.getElementById('ares-dropdown');
  const loading = document.getElementById('ares-loading');
  if (!val || val.length < 2) {
    if(dropdown) dropdown.style.display = 'none';
    return;
  }
  if(loading) loading.style.display = 'block';
  _aresTimer = setTimeout(() => aresSearch(val), 500);
}

async function aresSearch(query) {
  const dropdown = document.getElementById('ares-dropdown');
  const loading = document.getElementById('ares-loading');
  if (!dropdown) return;
  try {
    // ARES API — ekonomické subjekty
    const isICO = /^\d{6,8}$/.test(query.trim());
    let url;
    if (isICO) {
      url = `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${query.trim()}`;
    } else {
      url = `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty-vr?nazev=${encodeURIComponent(query)}&pocet=8&razeni=NAZEV`;
    }
    const res = await fetch(url);
    if (!res.ok) throw new Error('ARES error');
    const data = await res.json();
    
    let items = [];
    if (isICO && data.ico) {
      items = [data];
    } else if (data.ekonomickeSubjekty) {
      items = data.ekonomickeSubjekty;
    }
    
    if (!items.length) {
      dropdown.innerHTML = '<div style="padding:10px 12px;font-size:12px;color:var(--muted)">Nic nenalezeno v ARESu</div>';
      dropdown.style.display = 'block';
    } else {
      dropdown.innerHTML = items.map(s => {
        const ico = s.ico || '';
        const nazev = s.obchodniJmeno || s.nazev || '';
        const adresa = formatAresAddr(s);
        return `<div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7;font-family:inherit"
          onmouseenter="this.style.background='#eff6ff'"
          onmouseleave="this.style.background=''"
          onclick='aresSelect(${JSON.stringify({ico,nazev,adresa,dic:s.dic||""})})'>
          <div style="font-size:13px;font-weight:600;color:var(--text)">${esc(nazev)}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:1px">IČO: ${ico} ${adresa?'· '+adresa:''}</div>
        </div>`;
      }).join('');
      dropdown.style.display = 'block';
    }
  } catch(e) {
    dropdown.innerHTML = `<div style="padding:10px 12px;font-size:12px;color:var(--muted)">ARES nedostupný — zadejte ručně</div>`;
    dropdown.style.display = 'block';
  }
  if(loading) loading.style.display = 'none';
}

function formatAresAddr(s) {
  if (!s.sidlo) return '';
  const sid = s.sidlo;
  const parts = [
    sid.nazevUlice ? (sid.nazevUlice + (sid.cisloDomovni?' '+sid.cisloDomovni:'') + (sid.cisloOrientacni?'/'+sid.cisloOrientacni:'')) : '',
    sid.nazevObce||'',
    sid.psc ? String(sid.psc).replace(/(\d{3})(\d{2})/,'$1 $2') : ''
  ].filter(Boolean);
  return parts.join(', ');
}

function aresSelect(s) {
  const inp = document.getElementById('f_zakaznik');
  if(inp) inp.value = s.nazev;
  const addr = document.getElementById('f_adresa');
  if(addr) addr.value = s.adresa;
  const ico = document.getElementById('f_ico');
  if(ico) ico.value = s.ico;
  const dic = document.getElementById('f_dic');
  if(dic) dic.value = s.dic;
  const dropdown = document.getElementById('ares-dropdown');
  if(dropdown) dropdown.style.display = 'none';
  saveDraft && saveDraft();
}

// Close ARES dropdown on outside click
document.addEventListener('click', e => {
  if(!e.target.closest('#ares-dropdown') && !e.target.matches('#f_zakaznik')){
    const d = document.getElementById('ares-dropdown');
    if(d) d.style.display = 'none';
  }
});

function toggleCalendar() {
  const strip = document.getElementById('calendar-strip');
  if (!strip) return;
  const visible = strip.style.display !== 'none';
  strip.style.display = visible ? 'none' : 'block';
  if (!visible) renderCalendarStrip();
  updateCalBadge();
}

function updateCalBadge() {
  const badge = document.getElementById('cal-badge');
  if (!badge) return;
  const today = new Date(); today.setHours(0,0,0,0);
  const future = new Date(today.getTime() + 14*86400000);
  const count = (_assignedZakazky||[]).filter(z => {
    if (!z.termin) return false;
    const d = new Date(z.termin);
    return d >= today && d < future && !['zpracovaná','fakturovaná'].includes(z.stav||'');
  }).length;
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline' : 'none';
}

function renderCalendarStrip() {
  const strip = document.getElementById('calendar-strip');
  const calDays = document.getElementById('cal-days');
  if (!strip || !calDays) return;

  const today = new Date();
  today.setHours(0,0,0,0);
  const DAYS = 14;
  const dayNames = ['Ne','Po','Út','St','Čt','Pá','So'];
  const monthNames = ['led','úno','bře','dub','kvě','čvn','čvc','srp','zář','říj','lis','pro'];

  // Sestavit mapu termin -> [zakazky]
  const byDate = {};
  (_assignedZakazky || []).forEach(z => {
    if (!z.termin) return;
    const key = z.termin.substring(0,10); // YYYY-MM-DD
    if (!byDate[key]) byDate[key] = [];
    byDate[key].push(z);
  });

  const hasSomething = Object.keys(byDate).some(k => {
    const d = new Date(k);
    return d >= today && d < new Date(today.getTime() + DAYS*86400000);
  });

  strip.style.display = 'block';

  let html = '';
  for (let i = 0; i < DAYS; i++) {
    const d = new Date(today.getTime() + i*86400000);
    const key = d.toISOString().substring(0,10);
    const items = byDate[key] || [];
    const isToday = i === 0;
    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
    const bg = isToday ? '#0f1f3d' : isWeekend ? '#f4f6fa' : '#fff';
    const col = isToday ? '#fff' : isWeekend ? '#9aaac4' : '#1a2540';
    const border = items.length ? '#2d5fa6' : (isToday ? 'transparent' : 'var(--border)');

    html += `<div style="flex:0 0 52px;min-width:52px;border:1.5px solid ${border};border-radius:8px;background:${bg};padding:5px 4px;text-align:center;cursor:${items.length?'pointer':'default'}"
      ${items.length ? `onclick="calDayClick('${key}')"
        onmouseenter="this.style.background='#eff6ff';this.style.borderColor='#93c5fd'"
        onmouseleave="this.style.background='${bg}';this.style.borderColor='${border}'"` : ''}>
      <div style="font-size:9px;font-weight:700;color:${isToday?'rgba(255,255,255,.65)':isWeekend?'#b0bdd4':'#6b7a99'};text-transform:uppercase;letter-spacing:.04em">${dayNames[d.getDay()]}</div>
      <div style="font-size:17px;font-weight:700;color:${col};line-height:1.2;margin:2px 0">${d.getDate()}</div>
      <div style="font-size:8px;color:${isToday?'rgba(255,255,255,.5)':isWeekend?'#b0bdd4':'#9aaac4'};margin-bottom:4px">${monthNames[d.getMonth()]}</div>
      ${items.length ? `<div style="display:flex;justify-content:center;gap:2px;flex-wrap:wrap">
        ${items.slice(0,3).map(z => `<div style="width:6px;height:6px;border-radius:50%;background:${isToday?'#6abf3e':'#2d5fa6'}" title="${esc(z.nazev)}"></div>`).join('')}
        ${items.length > 3 ? `<div style="font-size:8px;color:${isToday?'#a0e070':'#2d5fa6'};font-weight:700">+${items.length-3}</div>` : ''}
      </div>` : `<div style="font-size:8px;color:${isToday?'rgba(255,255,255,.3)':'#d0d8e8'}">—</div>`}
    </div>`;
  }
  calDays.innerHTML = html;
}

function calDayClick(dateKey) {
  // Najít zakázky pro tento den a nabídnout výběr
  const items = (_assignedZakazky || []).filter(z => (z.termin||'').substring(0,10) === dateKey);
  if (!items.length) return;
  if (items.length === 1) {
    selectAssignedZakazka(items[0].id);
    return;
  }
  // Více zakázek — zobrazit v assigned-panel filtrovane na tento den
  const panel = document.getElementById('assigned-panel');
  if (!panel) return;
  // Scroll to step 0
  goTo(0);
  // Highlight the day's zakazky at top
  const stavIcon = {'nová':'🆕','ke zpracování':'👁','rozpracovaná':'🔧','na cestě':'🚗','zpracovaná':'✅','fakturovaná':'🧾','zaplacena':'💰'};
  const stavColor = {'nová':'#f0a500','ke zpracování':'#2d5fa6','rozpracovaná':'#d97706','na cestě':'#b45309','zpracovaná':'#16a34a','fakturovaná':'#7c3aed','zaplacena':'#059669'};
  const d = new Date(dateKey);
  const dayStr = d.toLocaleDateString('cs-CZ',{weekday:'long',day:'numeric',month:'long'});
  panel.innerHTML = `<div style="font-size:11px;font-weight:700;color:#1d4ed8;margin-bottom:6px">📅 ${dayStr}</div>` +
    items.map(z => {
      const stav = z.stav||'nová';
      const col = stavColor[stav]||'#6b7a99';
      return `<div style="padding:10px 12px;background:#fff;border:1.5px solid #93c5fd;border-radius:8px;margin-bottom:6px;cursor:pointer;display:flex;gap:10px;align-items:flex-start"
        onclick="selectAssignedZakazka('${z.id}')"
        onmouseenter="this.style.background='#f0f7ff'"
        onmouseleave="this.style.background='#fff'">
        <div style="font-size:18px">${stavIcon[stav]||'📋'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:13px;color:var(--navy)">${esc(z.nazev||'—')}</div>
          <div style="font-size:11px;color:var(--muted)">${esc(z.cislo||'')}</div>
          ${z.zadani ? `<div style="font-size:11px;color:#1d4ed8;margin-top:3px;font-style:italic">${esc(z.zadani.substring(0,80))}${z.zadani.length>80?'…':''}</div>` : ''}
        </div>
        <div style="font-size:10px;font-weight:600;color:${col};background:${col}18;padding:2px 7px;border-radius:20px;white-space:nowrap">${stav}</div>
      </div>`;
    }).join('');
}

function renderAssignedPanel() {
  const container = document.getElementById('assigned-panel');
  if(!container) return;
  const open = _assignedZakazky.filter(z => !['zpracovaná','fakturovaná','zaplacena'].includes(z.stav||'nová'));
  if(!open.length){
    container.innerHTML = '<div style="font-size:12px;color:var(--muted);font-style:italic;text-align:center;padding:12px">Žádné přiřazené zakázky</div>';
    return;
  }
  const stavIcon = {'nová':'🆕','ke zpracování':'👁','rozpracovaná':'🔧','zpracovaná':'✅','fakturovaná':'🧾'};
  const stavColor = {'nová':'#f0a500','ke zpracování':'#2d5fa6','rozpracovaná':'#d97706','zpracovaná':'#16a34a','fakturovaná':'#7c3aed'};
  container.innerHTML = open.map(z => {
    const stav = z.stav||'nová';
    const col = stavColor[stav]||'#6b7a99';
    return `<div style="padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;gap:10px;align-items:flex-start"
      onclick="selectAssignedZakazka('${z.id}')"
      onmouseenter="this.style.borderColor='#93c5fd';this.style.background='#f0f7ff'"
      onmouseleave="this.style.borderColor='var(--border)';this.style.background='#fff'">
      <div style="font-size:18px;flex-shrink:0">${stavIcon[stav]||'📋'}</div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px;color:var(--navy);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(z.nazev||'—')}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:1px">${esc(z.cislo||'')}${z.termin?' · 📅 '+fmtD(z.termin):''}</div>
        ${z.zadani?`<div style="font-size:11px;color:#1d4ed8;margin-top:3px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">📋 ${esc(z.zadani.substring(0,50))}${z.zadani.length>50?'…':''}</div>`:''}
        ${z.adresa?`<a href="https://maps.google.com/?q=${encodeURIComponent(z.adresa)}" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="font-size:11px;color:#059669;margin-top:2px;display:inline-flex;align-items:center;gap:3px;text-decoration:none;font-weight:600">📍 ${esc(z.adresa.substring(0,40))}</a>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0">
        <div style="font-size:10px;font-weight:600;color:${col};background:${col}18;padding:2px 7px;border-radius:20px;white-space:nowrap">${stav}</div>
        <button onclick="event.stopPropagation();downloadZakazkaSouhrn('${z.id}')" style="font-size:10px;padding:2px 8px;border-radius:6px;border:1px solid #93c5fd;background:#eff6ff;cursor:pointer;color:#1d4ed8;white-space:nowrap">
          📄 Souhrn
        </button>
        ${stav!=='zpracovaná'&&stav!=='zaplacena'?`<button onclick="event.stopPropagation();techUpdateStav('${z.id}','${stav}')" style="font-size:10px;padding:2px 8px;border-radius:6px;border:1px solid var(--border);background:#fff;cursor:pointer;color:var(--text);white-space:nowrap">
          ${stav==='na cestě'?'✅ Dokončit':'🚗 Na cestě'}
        </button>`:''}
      </div>
    </div>`;
  }).join('');
}
  renderCalendarStrip();


function selectAssignedZakazka(id) {
  const z = _assignedZakazky.find(x => x.id === id);
  if(!z) return;
  // Pre-fill step-0 form
  document.getElementById('f_nazev').value = z.nazev||'';
  document.getElementById('f_cislo').value = z.cislo||'';
  document.getElementById('f_zakaznik').value = z.zakaznik||'';
  if(z.termin) document.getElementById('f_termin').value = z.termin;
  // Show zadani
  const infoDiv = document.getElementById('assigned-info');
  if(infoDiv){
    if(z.zadani){
      infoDiv.innerHTML = `
        <div style="margin-bottom:14px;padding:14px 16px;background:#eff6ff;border:1.5px solid #93c5fd;border-radius:10px">
          <div style="font-size:11px;font-weight:700;color:#1d4ed8;letter-spacing:.05em;text-transform:uppercase;margin-bottom:6px">
            📋 Zadání od kanceláře
          </div>
          <div style="font-size:13px;color:#1e3a5f;line-height:1.55;white-space:pre-wrap">${esc(z.zadani)}</div>
          ${z.termin?`<div style="margin-top:8px;font-size:11px;color:#2d5fa6;font-weight:600">📅 Termín: ${esc(fmtD(z.termin))}</div>`:''}
        </div>`;
    } else {
      infoDiv.innerHTML = '';
    }
  }
  // Scroll to step 0 / go to step 0
  goTo(0);
}


</script>
<script>

// ════════════════════════════════════════════════════════
//  SHARED HELPERS
// ════════════════════════════════════════════════════════

function esc(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function fmt(n){return n.toLocaleString("cs-CZ",{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtD(v){if(!v)return"";if(v.includes("-")){const[y,m,d]=v.split("-");return d+"."+m+"."+y;}return v;}
function fmtTS(ts){if(!ts)return"—";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleDateString("cs-CZ")+" "+d.toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"});}

// ── AUTOCOMPLETE suggestions (built from saved zakázky) ──────
function showAutocomplete(inp, priceFld){
  const q=(inp.value||"").toLowerCase().trim();
  let ac=document.getElementById("ac-list");
  if(!ac){ac=document.createElement("ul");ac.id="ac-list";ac.style.cssText="position:fixed;z-index:999;background:#fff;border:1.5px solid #d0d8e8;border-radius:6px;box-shadow:0 8px 24px rgba(0,0,0,.12);list-style:none;margin:0;padding:4px 0;font-size:12px;max-height:180px;overflow-y:auto;min-width:200px";document.body.appendChild(ac);}
  if(!q){ac.style.display="none";return;}
  const matches=_suggestions.filter(s=>s.label.toLowerCase().includes(q)).slice(0,8);
  if(!matches.length){ac.style.display="none";return;}
  const r=inp.getBoundingClientRect();
  ac.style.display="block";
  ac.style.left=r.left+"px";
  ac.style.top=(r.bottom+2)+"px";
  ac.style.width=Math.max(r.width,220)+"px";
  ac.innerHTML=matches.map((s,i)=>`<li data-i="${i}" style="padding:7px 13px;cursor:pointer;display:flex;justify-content:space-between;gap:10px"><span>${esc(s.label)}</span><span style="color:#6b7a99;font-family:'DM Mono',monospace">${s.cen?fmt(parseFloat(s.cen)||0)+" Kč/ks":""}</span></li>`).join("");
  ac.querySelectorAll("li").forEach(li=>{
    li.onmousedown=e=>{e.preventDefault();const s=matches[+li.dataset.i];inp.value=s.label;if(priceFld&&s.cen&&!priceFld.value)priceFld.value=s.cen;inp.dispatchEvent(new Event("input",{bubbles:true}));ac.style.display="none";};
    li.onmouseenter=()=>li.style.background="#f0f5ff";
    li.onmouseleave=()=>li.style.background="";
  });
}
document.addEventListener("click",()=>{const ac=document.getElementById("ac-list");if(ac)ac.style.display="none";});
document.addEventListener("scroll",()=>{const ac=document.getElementById("ac-list");if(ac)ac.style.display="none";},{passive:true});

// ════════════════════════════════════════════════════════
//  BUILD PRINT VIEW (shared A4 renderer)
// ════════════════════════════════════════════════════════
function buildPrintView(d){
  const LH=25;
  function dotLines(text,count){
    const lines=(text&&text!=='—')?text.split('\n'):[''];
    while(lines.length<count)lines.push('');
    return lines.slice(0,count).map(l=>`<div style="height:${LH}px;border-bottom:1.5px dotted #9aaac4;font-size:11px;line-height:${LH}px;padding:0 3px;font-family:'IBM Plex Sans',Arial,sans-serif;overflow:hidden;white-space:nowrap">${esc(l)}&nbsp;</div>`).join('');
  }
  function sectionHead(title){
    return `<div style="font-weight:700;font-size:12px;color:#0f1f3d;letter-spacing:.04em;margin:14px 0 6px;display:flex;align-items:center;gap:8px;font-family:'IBM Plex Sans',Arial,sans-serif">${title}<span style="flex:1;height:1px;background:#c8d2e0;display:inline-block;margin-left:6px"></span></div>`;
  }

  // Table rows
  let tblRows='';
  (d.rows||[]).forEach(r=>{
    if(!r.pol&&!r.poc&&!r.cel)return;
    tblRows+=`<div style="display:grid;grid-template-columns:2fr 70px 90px 100px;border-bottom:1px dotted #c8d2e0">
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Sans',Arial,sans-serif;color:#1a2540">${esc(r.pol||'')}</div>
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(r.poc||'')}</div>
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(r.cen||'')}</div>
      <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;font-weight:600;border-left:1px solid #e8ecf2;background:rgba(42,90,160,.04);color:#1a3a6b">${esc(r.cel||'')}</div>
    </div>`;
  });
  // Travel rows
  const hasExts=(d.exts||[]).some(e=>e.poc||e.cel);
  if(hasExts){
    tblRows+=`<div style="background:#f4f6fa;padding:4px 8px;font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#6b7a99;border-top:1.5px solid #c8d2e0;font-family:'IBM Plex Sans',Arial,sans-serif">Cestovní náklady</div>`;
    (d.exts||[]).forEach(e=>{
      if(!e.poc&&!e.cel)return;
      tblRows+=`<div style="display:grid;grid-template-columns:2fr 70px 90px 100px;border-bottom:1px dotted #c8d2e0">
        <div style="padding:4px 8px;font-size:10.5px;font-style:italic;color:#6b7a99;font-family:'IBM Plex Sans',Arial,sans-serif">${esc(e.label||'')}</div>
        <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(e.poc||'')}</div>
        <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;border-left:1px solid #e8ecf2;color:#1a2540">${esc(e.cen||'')}</div>
        <div style="padding:4px 8px;font-size:10.5px;font-family:'IBM Plex Mono',monospace;text-align:right;font-weight:600;border-left:1px solid #e8ecf2;background:rgba(42,90,160,.04);color:#1a3a6b">${esc(e.cel||'')}</div>
      </div>`;
    });
  }

  const pricesNote=d.pricesSkipped?`<div style="font-size:9px;font-style:italic;color:#7a5500;padding:4px 9px;background:#fffbf0;border:1px solid #f0d080;border-radius:2px;margin-top:3px;font-family:'IBM Plex Sans',Arial,sans-serif">Ceny budou doplněny před vystavením faktury.</div>`:'';
  const cena=d.cena||'Bude doplněno';

  const wrap=document.createElement('div');
  wrap.style.cssText="width:100%;background:#fff;font-family:'IBM Plex Sans',Arial,sans-serif";
  wrap.innerHTML=`
<div style="max-width:800px;margin:0 auto;background:#fff">

  <!-- HEADER -->
  <div style="padding:20px 32px 0;display:flex;align-items:flex-end;justify-content:space-between;gap:16px;border-bottom:3px solid #0f1f3d;padding-bottom:14px">
    <img src="${LOGO_DATA}" style="height:38px;width:auto">
    <div style="text-align:right;line-height:1.55">
      <div style="font-weight:700;font-size:12px;color:#0f1f3d;letter-spacing:.02em">AC EURO a.s.</div>
      <div style="font-size:10px;color:#6b7a99">Houbalova 2553/4, 628 00 Brno</div>
      <div style="font-size:10px;color:#6b7a99">IČ: 28282591 &nbsp;·&nbsp; Tel.: 544 234 330 &nbsp;·&nbsp; www.aceuro.cz</div>
    </div>
  </div>

  <!-- TITLE BAR -->
  <div style="background:#0f1f3d;padding:11px 32px;display:flex;align-items:center;justify-content:space-between;-webkit-print-color-adjust:exact;print-color-adjust:exact">
    <span style="font-size:18px;font-weight:700;letter-spacing:.12em;color:#fff;text-transform:uppercase;font-family:'IBM Plex Sans',Arial,sans-serif">Servisní list</span>
    <span style="font-size:10px;color:rgba(255,255,255,.55);letter-spacing:.03em">${esc(d.cislo||'')}</span>
  </div>

  <!-- BODY -->
  <div style="padding:20px 32px 28px">

    <!-- Info rows -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px;margin-bottom:4px">
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Název zakázky:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(d.nazev||'—')}</span>
      </div>
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Číslo servisu:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(d.cislo||'—')}</span>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0 24px;margin-bottom:14px">
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Servisní technik:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(d.technik||'—')}</span>
      </div>
      <div style="display:flex;align-items:baseline;gap:0;margin-bottom:8px;border-bottom:1.5px dotted #9aaac4">
        <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d;padding-right:6px;flex-shrink:0">Termín provedení:</label>
        <span style="font-size:11.5px;color:#1a2540;padding:2px 4px 4px;flex:1">${esc(fmtD(d.termin)||d.termin||'—')}</span>
      </div>
    </div>

    <!-- Provedené práce -->
    ${sectionHead('Provedené servisní práce')}
    ${dotLines(d.prace,8)}

    <!-- Tabulka -->
    ${sectionHead('Spotřebovaný materiál a práce')}
    <div style="border:1px solid #c8d2e0;border-radius:3px;overflow:hidden">
      <div style="display:grid;grid-template-columns:2fr 70px 90px 100px;background:#0f1f3d;-webkit-print-color-adjust:exact;print-color-adjust:exact">
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;font-family:'IBM Plex Sans',Arial,sans-serif">Položka</div>
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;text-align:right">Počet</div>
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;text-align:right">Kč/ks</div>
        <div style="padding:7px 8px;font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:#fff;text-align:right">Celkem</div>
      </div>
      ${tblRows}
    </div>
    ${pricesNote}

    <!-- Celková cena -->
    <div style="margin-top:10px;background:#0f1f3d;border-radius:3px;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;-webkit-print-color-adjust:exact;print-color-adjust:exact">
      <span style="font-size:12px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:rgba(255,255,255,.75)">Cena bez DPH</span>
      <span style="font-family:'IBM Plex Mono',monospace;font-size:17px;font-weight:700;color:#6abf3e">${esc(cena)}</span>
    </div>

    <!-- DUZP -->
    <div style="margin-top:12px;display:flex;align-items:baseline;gap:8px;border-bottom:1.5px dotted #9aaac4;padding-bottom:4px;max-width:280px">
      <label style="font-weight:700;font-size:11px;white-space:nowrap;color:#0f1f3d">Datum ukončení prací (DUZP):</label>
      <span style="font-size:11.5px;color:#1a2540;padding:0 4px;flex:1">${esc(fmtD(d.duzp)||d.duzp||'')}</span>
    </div>

    <!-- Poznámky -->
    ${sectionHead('Poznámky')}
    ${dotLines(d.pozn,3)}

    <!-- Podpisy -->
    <div style="margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div style="border:1.5px solid #c8d2e0;border-radius:3px;overflow:hidden">
        <div style="background:#0f1f3d;color:#fff;font-size:9.5px;font-weight:700;padding:6px 12px;text-transform:uppercase;letter-spacing:.08em;-webkit-print-color-adjust:exact;print-color-adjust:exact">Za zhotovitele</div>
        <div style="height:64px;background:#fafbfd;display:flex;align-items:center;justify-content:center">
          ${d.sig1?`<img src="${esc(d.sig1)}" style="max-height:58px;max-width:100%;object-fit:contain">`:''}
        </div>
        <div style="padding:4px 12px;border-top:1px solid #e8ecf2;font-size:9.5px;color:#6b7a99">Datum: ${esc(d.sd1||'')}</div>
      </div>
      <div style="border:1.5px solid #c8d2e0;border-radius:3px;overflow:hidden">
        <div style="background:#0f1f3d;color:#fff;font-size:9.5px;font-weight:700;padding:6px 12px;text-transform:uppercase;letter-spacing:.08em;-webkit-print-color-adjust:exact;print-color-adjust:exact">Za objednatele</div>
        <div style="height:64px;background:#fafbfd;display:flex;align-items:center;justify-content:center">
          ${d.sig2?`<img src="${esc(d.sig2)}" style="max-height:58px;max-width:100%;object-fit:contain">`:''}
        </div>
        <div style="padding:4px 12px;border-top:1px solid #e8ecf2;font-size:9.5px;color:#6b7a99">Datum: ${esc(d.sd2||'')}</div>
      </div>
    </div>

    <!-- Footer -->
    <div style="margin-top:14px;padding-top:10px;border-top:1px solid #c8d2e0;font-size:8.5px;color:#9aaac4;line-height:1.6">
      Pokud je cena za jednotlivé úkony a materiál předem stanovena, bude tato následně doplněna při fakturaci.
      Přebírající osoba za objednatele stvrzuje svým podpisem, že činnosti popsané na tomto listě byly provedeny a je oprávněna tyto práce převzít.
    </div>

  </div>
</div>
`;

  // Photo pages — only if requested
  if(d.includePhotos && d.photos && d.photos.length){
    const PER_PAGE=6, PER_ROW=3, pages=[];
    for(let i=0;i<d.photos.length;i+=PER_PAGE) pages.push(d.photos.slice(i,i+PER_PAGE));
    pages.forEach((pp,pi)=>{
      let rows='';
      for(let r=0;r<pp.length;r+=PER_ROW){
        const trio=pp.slice(r,r+PER_ROW);
        while(trio.length<PER_ROW)trio.push(null);
        rows+=`<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">${
          trio.map((ph,ci)=>{
            const gi=pi*PER_PAGE+r+ci+1;
            return ph?`<div style="border:1px solid #d0d8e8;border-radius:5px;overflow:hidden;box-shadow:0 1px 4px rgba(15,31,61,.06)">
              <img src="${ph.cloudUrl||ph.dataUrl||''}" style="width:100%;aspect-ratio:4/3;object-fit:cover;display:block">
              <div style="padding:5px 8px;font-size:9px;color:#6b7a99;border-top:1px solid #e8ecf2;background:#fafbfc;font-family:'IBM Plex Sans',Arial,sans-serif">
                <span style="font-weight:600;color:#0f1f3d">Foto ${gi}</span>${ph.caption?' — '+esc(ph.caption):(ph.name?' — '+esc(ph.name.replace(/\.[^.]+$/,'')):'')}</div>
              </div>`:'<div></div>';
          }).join('')
        }</div>`;
      }
      const pg=document.createElement('div');
      pg.style.cssText='page-break-before:always;width:100%;background:#fff;font-family:\'IBM Plex Sans\',Arial,sans-serif';
      pg.innerHTML=`
<div style="max-width:800px;margin:0 auto;background:#fff">
  <div style="padding:14px 32px 0;display:flex;align-items:flex-end;justify-content:space-between;gap:16px;border-bottom:3px solid #0f1f3d;padding-bottom:10px">
    <img src="${LOGO_DATA}" style="height:30px;width:auto">
    <div style="text-align:right;font-size:9px;color:#6b7a99">Servisní list č. ${esc(d.cislo||'—')} — ${esc(d.nazev||'—')}</div>
  </div>
  <div style="background:#0f1f3d;padding:7px 32px;-webkit-print-color-adjust:exact;print-color-adjust:exact">
    <span style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.75)">Fotodokumentace${pages.length>1?' — strana '+(pi+2)+' / '+(pages.length+1):''}</span>
  </div>
  <div style="padding:16px 32px">${rows}</div>
  <div style="padding:6px 32px 10px;font-size:8px;color:#9aaac4;border-top:1px solid #e8ecf2;text-align:center">
    ${esc(d.nazev||'—')} | Technik: ${esc(d.technik||'—')} | ${esc(d.termin||'—')}
  </div>
</div>`;
      wrap.appendChild(pg);
    });
  }

  return wrap;
}






// ── AUTH ─────────────────────────────────────────────

// ── LIST RENDER ───────────────────────────────────────
let activeId = null;
function renderList(){
  const q=(document.getElementById('search-inp')?.value||'').toLowerCase().trim();
  const fs=document.getElementById('filter-stav')?.value||'';
  const ft=document.getElementById('filter-tech')?.value||'';
  const od=document.getElementById('filter-od')?.value||'';
  const doo=document.getElementById('filter-do')?.value||'';
  const all=window._zakazky||[];

  // Update technik filter options
  const techSel=document.getElementById('filter-tech');
  if(techSel){
    const techs=[...new Set(all.map(z=>z.technik||'').filter(Boolean))].sort();
    const cur=techSel.value;
    techSel.innerHTML='<option value="">Vš. technici</option>'+techs.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');
    techSel.value=cur;
  }

  const filtered=all.filter(z=>{
    if(fs&&(z.stav||'nová')!==fs)return false;
    if(ft&&z.technik!==ft)return false;
    if(od&&z.termin&&z.termin<od)return false;
    if(doo&&z.termin&&z.termin>doo)return false;
    if(!q)return true;
    return(z.nazev||'').toLowerCase().includes(q)||
           (z.cislo||'').toLowerCase().includes(q)||
           (z.technik||'').toLowerCase().includes(q)||
           (z.zakaznik||'').toLowerCase().includes(q)||
           (z.prace||'').toLowerCase().includes(q)||
           (z.adresa||'').toLowerCase().includes(q)||
           (z.pozn||'').toLowerCase().includes(q)||
           (z.ico||'').toLowerCase().includes(q)||
           (z.zadani||'').toLowerCase().includes(q);
  });

  document.getElementById('count-badge').textContent='('+filtered.length+')';
  const scroll=document.getElementById('list-scroll');
  if(!filtered.length){scroll.innerHTML='<div class="list-status">Žádné zakázky</div>';return;}
  scroll.innerHTML=filtered.map(z=>`
    <div class="zcard${z.id===activeId?' active':''}" onclick="openDetail('${z.id}')">
      <div class="zcard-top">
        <input type="checkbox" class="bulk-cb" data-id="${z.id}"
          onclick="event.stopPropagation();toggleBulkSelect('${z.id}',this.checked)"
          style="width:15px;height:15px;margin-right:6px;flex-shrink:0;cursor:pointer;accent-color:var(--blue)"
          ${window._bulkSelected&&window._bulkSelected.has('${z.id}')?'checked':''}>
        <div class="zcard-title" style="flex:1">${esc(z.nazev||'—')}${z._offline?'<span class="offline-dot" title="Offline zakázka"></span>':''}</div>
        ${stavBadge(z.stav||'nová')}
      </div>
      <div class="zcard-meta">
        <span>📋 ${esc(z.cislo||'—')}</span>
        <span>👤 ${z.technici&&z.technici.length>1
          ? z.technici.map(u=>esc(u.name||u.uid)).join(', ')
          : esc(z.technik||'—')}</span>
        ${z.termin?`<span>📅 ${fmtD(z.termin)}</span>`:''}
        ${z.photos&&z.photos.length?`<span>📷 ${z.photos.length}</span>`:''}
      </div>
      ${!z.pricesSkipped&&z.cena?`<div class="zcard-cena">${esc(z.cena)}</div>`:''}
    </div>`).join('');
}

function stavBadge(stav){
  const c={
    'nová':             'stav-nova',
    'ke zpracování':    'stav-kezprac',
    'rozpracovaná':     'stav-rozprac',
    'na cestě':         'stav-naceste',
    'zpracovaná':       'stav-zpracovana',
    'fakturovaná':      'stav-fakturovana',
    'zaplacena':        'stav-zaplacena',
  };
  const icons={
    'nová':'🆕','ke zpracování':'👁','rozpracovaná':'🔧',
    'na cestě':'🚗','zpracovaná':'✅','fakturovaná':'🧾','zaplacena':'💰'
  };
  return `<span class="stav-badge ${c[stav]||'stav-nova'}">${icons[stav]||''} ${esc(stav||'nová')}</span>`;
}

// ── DETAIL ────────────────────────────────────────────
function openDetail(id){
  activeId=id;renderList();
  const z=(window._zakazky||[]).find(x=>x.id===id);
  if(!z)return;
  // Auto-transition: nová → ke zpracování when opened
  if((z.stav||'nová')==='nová'){
    z.stav='ke zpracování';
    window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id),
      {stav:'ke zpracování',updatedAt:window._fb.serverTimestamp()}).catch(()=>{});
  }
  document.getElementById('detail-empty').style.display='none';
  const di=document.getElementById('detail-inner');
  di.style.display='block';

  let tblRows='';
  (z.rows||[]).forEach((r,i)=>{const n=i+1;tblRows+=`<tr style="border-bottom:1px solid var(--border)">
    <td><input type="text"   id="dp${n}"  value="${esc(r.pol||'')}" oninput="dCalc()" placeholder="Položka..."></td>
    <td><input type="number" id="dq${n}"  value="${esc(r.poc||'')}" oninput="dCalc()" min="0" step="1"></td>
    <td><input type="number" id="dc${n}"  value="${esc(r.cen||'')}" oninput="dCalc()" min="0" step="0.01"></td>
    <td class="cel-col"><input id="dcel${n}" readonly tabindex="-1" value="${esc(r.cel||'')}"></td>
  </tr>`;});
  tblRows+=`<tr class="sep-tr"><td colspan="4">Cestovní náklady</td></tr>`;
  (z.exts||[]).forEach((e,i)=>{const n=i+1;tblRows+=`<tr style="border-bottom:1px solid var(--border)">
    <td><input type="text"   id="den${n}" value="${esc(e.label||EXT_LABELS[i]||'')}" oninput="dCalc()" style="font-style:italic"></td>
    <td><input type="number" id="deq${n}" value="${esc(e.poc||'')}" oninput="dCalc()" min="0" step="${EXT_STEPS[i]||1}"></td>
    <td><input type="number" id="dec${n}" value="${esc(e.cen||'')}" oninput="dCalc()" min="0" step="1"></td>
    <td class="cel-col"><input id="decel${n}" readonly tabindex="-1" value="${esc(e.cel||'')}"></td>
  </tr>`;});

  const photosHtml=z.photos&&z.photos.length
    ?`<div class="photo-grid-detail">`+z.photos.map((p,i)=>`
        <div style="border-radius:7px;overflow:hidden;border:1.5px solid var(--border);background:#fff;display:flex;flex-direction:column">
          <div style="position:relative;aspect-ratio:4/3;overflow:hidden;background:#f0f2f6">
            <img src="${p.cloudUrl||p.dataUrl}" loading="lazy"
              style="width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in"
              onclick="openLightbox('${p.cloudUrl||p.dataUrl}')">
            <!-- Akční tlačítka přes obrázek -->
            <div style="position:absolute;top:5px;right:5px;display:flex;gap:4px">
              <button title="Anotovat" onclick="openPhotoAnnot('${activeId}',${i})"
                style="background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:6px;width:26px;height:26px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center">✏️</button>
              <button title="Smazat fotku" onclick="deleteKancelPhoto('${activeId}',${i})"
                style="background:rgba(220,38,38,.8);color:#fff;border:none;border-radius:6px;width:26px;height:26px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center">✕</button>
            </div>
            <!-- Upload status dot -->
            ${!p.cloudUrl?'<div style="position:absolute;bottom:5px;left:5px;background:#f0a500;color:#fff;font-size:9px;padding:1px 5px;border-radius:4px;font-weight:700">lokální</div>':''}
          </div>
          <div style="padding:5px 7px;background:#fafbfc;border-top:1px solid #f0f2f6;flex:1">
            <input type="text" value="${esc(p.caption||p.name||'')}"
              placeholder="Popis fotografie…"
              style="width:100%;border:none;outline:none;font-size:10.5px;font-family:inherit;background:transparent;color:var(--text)"
              onchange="savePhotoCaption('${activeId}',${i},this.value)">
          </div>
        </div>`).join('')+`</div>`
    :`<div style="font-size:12px;color:var(--muted);font-style:italic">Žádné fotografie</div>`;

  const assignedTo=z.assignedTo?`<div style="font-size:11px;color:rgba(255,255,255,.65)">Přiřazeno: <strong style="color:#a0e070">${esc(z.assignedTo)}</strong></div>`:'';

  di.innerHTML=`
    <div class="detail-hdr">
      <div class="detail-hdr-left">
        <h2>${esc(z.nazev||'—')}</h2>
        <div class="meta">
          Číslo: <strong style="color:#fff">${esc(z.cislo||'—')}</strong> &nbsp;·&nbsp;
          Zákazník: ${esc(z.zakaznik||'—')}<br>
          Technik: ${z.technici&&z.technici.length>1
            ? z.technici.map(u=>`<span style="display:inline-flex;align-items:center;gap:3px;background:rgba(255,255,255,.15);border-radius:4px;padding:1px 6px;margin:0 2px;font-size:11px">${esc(u.name||u.uid)}</span>`).join('')
            : esc(z.technik||'—')} &nbsp;·&nbsp;
          Termín: ${fmtD(z.termin)||'—'} &nbsp;·&nbsp;
          Přijato: ${fmtTS(z.createdAt)}
        </div>
        ${assignedTo}
      </div>
      <div class="detail-hdr-right">
        ${stavBadge(z.stav||'nová')}
        <select class="stav-sel" id="stav-sel" onchange="changeStav('${id}',this.value)">
          <option value="nová" ${(z.stav||'nová')==='nová'?'selected':''}>🆕 Nová</option>
          <option value="ke zpracování" ${z.stav==='ke zpracování'?'selected':''}>👁 Ke zpracování</option>
          <option value="rozpracovaná" ${z.stav==='rozpracovaná'?'selected':''}>🔧 Rozpracovaná</option>
          <option value="zpracovaná" ${z.stav==='zpracovaná'?'selected':''}>✅ Zpracovaná</option>
          <option value="čeká na díly" ${z.stav==='čeká na díly'?'selected':''}>🔩 Čeká na díly</option>
          <option value="ke kontrole" ${z.stav==='ke kontrole'?'selected':''}>🔍 Ke kontrole</option>
          <option value="ke fakturaci" ${z.stav==='ke fakturaci'?'selected':''}>📤 Ke fakturaci</option>
          <option value="vrácena" ${z.stav==='vrácena'?'selected':''}>↩ Vrácena k doplnění</option>
          <option value="fakturovaná" ${z.stav==='fakturovaná'?'selected':''}>🧾 Fakturovaná</option>
          <option value="zaplacena" ${z.stav==='zaplacena'?'selected':''}>💚 Zaplacena</option>
          <option value="stornována" ${z.stav==='stornována'?'selected':''}>🚫 Stornována</option>
        </select>
        <button class="btn btn-ghost" style="font-size:11px;padding:5px 10px" onclick="openAssignModal('${id}')">Přiřadit →</button>
      </div>
    </div>

    ${(z.zakaznik||z.adresa||z.ico)?`
    <div class="dsec">
      <div class="dsec-hdr" style="justify-content:space-between">
        <span>🏢 Zákazník</span>
        ${z.adresa?`<a href="https://maps.google.com/?q=${encodeURIComponent(z.adresa)}" target="_blank" rel="noopener"
          style="font-size:11px;color:#1d4ed8;text-decoration:none;font-weight:600;display:flex;align-items:center;gap:4px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Navigovat
        </a>`:''}
      </div>
      <div class="dsec-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px 16px">
        ${z.zakaznik?`<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Název</div><div style="font-size:13px;font-weight:600">${esc(z.zakaznik)}</div></div>`:''}
        ${z.adresa?`<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Adresa</div><div style="font-size:13px">${esc(z.adresa)}</div></div>`:''}
        ${z.ico?`<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:2px">IČO</div><div style="font-size:13px;font-family:'DM Mono',monospace">${esc(z.ico)}</div></div>`:''}
        ${z.dic?`<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:2px">DIČ</div><div style="font-size:13px;font-family:'DM Mono',monospace">${esc(z.dic)}</div></div>`:''}
        ${z.adresa?`<div style="grid-column:1/-1"><a href="https://maps.google.com/?q=${encodeURIComponent(z.adresa)}" target="_blank" rel="noopener"
          style="display:inline-flex;align-items:center;gap:5px;font-size:12px;color:#1d4ed8;background:#eff6ff;border:1px solid #bfdbfe;border-radius:7px;padding:5px 10px;text-decoration:none;font-weight:600">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Otevřít v Google Mapách
        </a></div>`:''}
      </div>
    </div>`:''}

    <!-- WORKFLOW PANEL -->
    <div class="dsec" style="border:1.5px solid #e0e7ff;margin-bottom:0">
      <div class="dsec-hdr" style="background:rgba(99,102,241,.06);justify-content:space-between">
        <span>🔄 Průběh zakázky</span>
        <span id="workflow-role-badge-${id}" style="font-size:10px;padding:2px 8px;border-radius:10px;background:#e0e7ff;color:#4338ca;font-weight:700"></span>
      </div>
      <div class="dsec-body" style="padding:12px 14px">
        <div id="workflow-steps-${id}" style="display:flex;align-items:center;gap:0;overflow-x:auto;padding:4px 0;margin-bottom:10px"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button onclick="workflowNext('${id}')" id="wf-next-${id}"
            style="font-size:12px;padding:6px 14px;background:var(--green);color:#fff;border:none;border-radius:7px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px">
            ✅ Předat dál
          </button>
          <button onclick="workflowBack('${id}')" id="wf-back-${id}"
            style="font-size:12px;padding:6px 14px;background:#fff;border:1.5px solid var(--warn);color:#92400e;border-radius:7px;cursor:pointer;font-weight:600">
            ↩ Vrátit zpět
          </button>
          <input id="wf-note-${id}" placeholder="Poznámka k předání…"
            style="flex:1;min-width:160px;font-size:11px;padding:6px 10px;border:1px solid var(--border);border-radius:7px;font-family:inherit">
        </div>
      </div>
    </div>

    ${z.zadani?`
    <div class="dsec" style="border:1.5px solid #bfdbfe">
      <div class="dsec-hdr" style="background:rgba(59,130,246,.07);justify-content:space-between">
        <span>📋 Zadání od kanceláře</span>
        <button onclick="openAssignModal('${id}')" style="padding:3px 10px;font-size:11px;font-weight:600;background:#fff;border:1.5px solid #93c5fd;border-radius:6px;cursor:pointer;color:#1d4ed8">✏ Upravit</button>
      </div>
      <div class="dsec-body">
        <div class="prace-text" style="color:#1e40af;white-space:pre-wrap">${esc(z.zadani)}</div>
        ${z.termin?`<div style="margin-top:8px;font-size:11px;color:var(--muted)">📅 Termín: <strong style="color:var(--text)">${fmtD(z.termin)}</strong></div>`:''}
      </div>
    </div>`:''}

    ${z.termin?`<div class="dsec" id="weather-dsec-${id}" style="border:1px dashed var(--border)">
      <div class="dsec-hdr" style="background:transparent;justify-content:space-between">
        <span>🌤 Počasí v den termínu</span>
        <span style="font-size:10px;color:var(--muted)">${fmtD(z.termin)}</span>
      </div>
      <div class="dsec-body" id="weather-body-${id}" style="font-size:12px;color:var(--muted);font-style:italic">Načítám předpověď…</div>
    </div>`:''}

    <div class="dsec">
      <div class="dsec-hdr" style="justify-content:space-between">
        <span>🔧 Provedené servisní práce</span>
        <div id="timer-display-${id}" style="display:flex;align-items:center;gap:8px;font-size:11px">
          <span id="timer-val-${id}" style="font-family:'DM Mono',monospace;font-weight:700;color:var(--navy);min-width:48px">
            ${z.casNaZakazce?formatDuration(z.casNaZakazce):'00:00:00'}
          </span>
          <button id="timer-btn-${id}" onclick="toggleTimer('${id}')"
            style="padding:3px 10px;border-radius:6px;border:1.5px solid var(--border);background:#fff;font-size:11px;font-weight:700;cursor:pointer;color:var(--text)">
            ${z.timerRunning?'⏸ Pauza':'▶ Spustit čas'}
          </button>
        </div>
      </div>
      <div class="dsec-body"><div class="prace-text">${esc(z.prace||'—')}</div></div>
    </div>

    <div class="dsec" id="dsec-ceny">
      <div class="dsec-hdr" style="justify-content:space-between">
        <span>💰 Položky a ceny</span>
        ${(!z.pricesSkipped&&z.cena)
          ?`<span style="font-size:10px;font-weight:600;padding:2px 9px;border-radius:20px;background:#fef3c7;color:#b45309;display:flex;align-items:center;gap:4px">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              Uzamčeno
            </span>`
          :`<span style="font-size:10px;opacity:.55;font-weight:400">✎ editovatelné</span>`
        }
      </div>
      ${(!z.pricesSkipped&&z.cena)?`
      <div id="ceny-locked-bar" style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:#fffbf0;border-bottom:1px solid #fde68a">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#b45309" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span style="font-size:12px;color:#92400e;flex:1">Ceny jsou uloženy. Pro editaci klikněte na <strong>Odemknout</strong>.</span>
        <button onclick="unlockPrices('${id}')" style="padding:5px 13px;background:#fff;color:#b45309;border:1.5px solid #fcd34d;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:5px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
          Odemknout
        </button>
      </div>`:``}
      <div class="dsec-body" style="padding:0">
        <div style="border:1px solid var(--border);border-radius:6px;overflow:hidden;margin:14px">
          <table class="ceny-tbl" id="ceny-tbl">
            <thead><tr>
              <th style="text-align:left;width:44%;padding:7px 9px">Položka</th>
              <th style="width:13%">Počet ks</th>
              <th style="width:18%;color:#6abf3e">Cena Kč/ks</th>
              <th style="width:18%">Celkem Kč</th>
            </tr></thead>
            <tbody id="ceny-tbody">${tblRows}</tbody>
          </table>
          <div class="total-bar"><span>Cena bez DPH</span><strong id="d-total">—</strong></div>
        </div>
        <div style="padding:0 14px 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
          <div class="duzp-row">
            <label>DUZP:</label>
            <input type="date" id="d-duzp" value="${z.duzp||''}" oninput="markDirty()">
          </div>
          <div class="duzp-row" style="gap:6px">
            <label>Hodiny:</label>
            <input type="number" id="d-hodiny" min="0" step="0.5" value="${z.hodiny||''}" 
              oninput="markDirty()" style="width:70px" placeholder="0">
            <label style="margin-left:8px">Km:</label>
            <input type="number" id="d-km" min="0" step="1" value="${z.km||''}" 
              oninput="markDirty()" style="width:70px" placeholder="0">
            <label style="margin-left:8px">Sazba km:</label>
            <input type="number" id="d-km-sazba" min="0" step="0.5" value="${z.kmSazba||window._kmSazba||5.60}" 
              oninput="markDirty()" style="width:65px" placeholder="5.60">
          </div>
          <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
            <button class="btn btn-green" id="btn-save" onclick="saveDetail('${id}')">
              ✓ Uložit ceny
            </button>
            <div class="save-status" id="save-status"></div>
          </div>
        </div>
      </div>
    </div>

    ${z.pozn?`<div class="dsec"><div class="dsec-hdr">📝 Poznámky</div><div class="dsec-body"><div class="prace-text">${esc(z.pozn)}</div></div></div>`:''}

    ${z.komentar?`<div class="dsec" style="border:1.5px solid #d0c0f0"><div class="dsec-hdr" style="background:rgba(124,58,237,.08)">💬 Interní komentář <span style="font-size:10px;font-weight:400;color:#7c3aed;margin-left:6px">pouze pro kancelář</span></div><div class="dsec-body"><div class="prace-text" style="color:#5b21b6">${esc(z.komentar)}</div></div></div>`:''}

    <div class="dsec" style="border:1.5px solid #bfdbfe">
      <div class="dsec-hdr" style="background:rgba(59,130,246,.06);justify-content:space-between">
        <span>💬 Komentáře a komunikace</span>
        <span style="font-size:10px;font-weight:400;color:var(--muted)">viditelné technikovi i kanceláři</span>
      </div>
      <div class="dsec-body" style="padding:0">
        <div id="chat-messages-${id}" style="max-height:240px;overflow-y:auto;padding:10px 14px;display:flex;flex-direction:column;gap:8px"></div>
        <div style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end">
          <textarea id="chat-inp-${id}" rows="2" placeholder="Napište zprávu…"
            style="flex:1;resize:none;border:1.5px solid var(--border);border-radius:8px;padding:8px 10px;font-size:12px;font-family:inherit;outline:none"
            onkeydown="if(event.ctrlKey&&event.key==='Enter')sendChatMsg('${id}')"></textarea>
          <button onclick="sendChatMsg('${id}')" class="btn btn-primary" style="padding:8px 14px;height:fit-content">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="dsec">
      <div class="dsec-hdr" style="justify-content:space-between">
        <span>📷 Fotodokumentace</span>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:var(--navy);cursor:pointer;background:#f0f9ff;border:1px solid #bae6fd;border-radius:7px;padding:4px 10px">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Přidat foto
          <input type="file" accept="image/*" multiple capture="environment" style="display:none"
            onchange="addKancelPhoto(this,'${activeId}')">
        </label>
      </div>
      <div class="dsec-body">${photosHtml}</div>
      <div id="kphoto-prog-${activeId}" style="display:none;padding:6px 14px;font-size:11px;color:var(--muted)">⏳ Nahrávám...</div>
    </div>

    <div class="dsec">
      <div class="dsec-hdr" style="justify-content:space-between">
        <span>🖨️ Export a tisk</span>
        <button onclick="openZakazkaSouhrn('${id}')" style="font-size:11px;padding:3px 10px;background:#fff;border:1.5px solid var(--navy);border-radius:6px;cursor:pointer;color:var(--navy);font-weight:600">
          👁 Souhrn zakázky
        </button>
      </div>
      <div class="dsec-body" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <label style="display:flex;align-items:center;gap:7px;font-size:12px;color:var(--text);cursor:pointer;padding:6px 10px;background:#f8fafc;border:1px solid var(--border);border-radius:7px">
          <input type="checkbox" id="print-photos-cb" style="width:14px;height:14px;accent-color:var(--blue)">
          Zahrnout fotodokumentaci
        </label>
        <button class="btn btn-green" onclick="openServiceListModal('${id}')" style="display:flex;align-items:center;gap:6px">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Vytvořit servisní list
        </button>
        <button class="btn btn-primary" onclick="printDetail('${id}')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Tisk s cenami
        </button>
        <button class="btn btn-ghost" onclick="exportHTML('${id}')">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Stáhnout HTML
        </button>
        <button class="btn btn-ghost" onclick="exportCSV('${id}')" style="font-size:11px">CSV</button>
        <button class="btn btn-ghost" onclick="exportXLSX('${id}')" style="font-size:11px;display:flex;align-items:center;gap:4px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          XLSX
        </button>
        <button class="btn btn-ghost" onclick="showQR('${id}')" style="font-size:11px;display:flex;align-items:center;gap:4px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/></svg>
          QR
        </button>
        <button class="btn btn-ghost" onclick="exportFaktura('${id}')" style="font-size:11px;display:flex;align-items:center;gap:4px">
          🧾 Fakturační podklad
        </button>
        <button class="btn btn-ghost" onclick="showAuditLog('${id}')" style="font-size:11px">📋 Log změn</button>
        <button onclick="generatePortalLink('${id}')" class="btn btn-ghost" style="font-size:11px;background:#f0fdf4;border-color:#86efac;color:#15803d">🔗 Sdílet</button>
        <button onclick="openMistaPanel('${id}')" class="btn" style="background:#eff6ff;color:#1d4ed8;border:1px solid #93c5fd;font-size:11px;font-weight:700">🏢 Místa & Klimatizace</button>
        <button onclick="openProtocolWizard('${id}')" class="btn" style="background:#f0fdf4;color:#15803d;border:1px solid #86efac;font-size:11px;font-weight:700">📋 Protokol</button>
        <button class="btn" style="background:#fef2f2;color:var(--err);border:1px solid #fecaca;font-size:11px" onclick="deleteZakazka('${id}')">🗑 Smazat</button>
      </div>
    </div>`;

  // Apply lock if prices already saved
  const _locked = !z.pricesSkipped && !!z.cena;
  applyPriceLock(_locked);
  _calcTotals(); // silent calc on load — no dirty flag
}

function applyPriceLock(lock) {
  // Lock/unlock all editable cells in price table
  const sel = lock
    ? '#ceny-tbody input:not([readonly]), #d-duzp'
    : '#ceny-tbody input:not([readonly]), #d-duzp';

  // All inputs in ceny-tbody + duzp
  document.querySelectorAll('#ceny-tbody input, #d-duzp').forEach(inp => {
    if (inp.id && inp.id.startsWith('dcel')) return; // always readonly
    inp.readOnly = lock;
    inp.style.cursor = lock ? 'not-allowed' : '';
    inp.style.background = lock ? 'rgba(250,250,252,.7)' : '';
    inp.style.color = lock ? '#9aaac4' : '';
    inp.oninput = lock ? null : inp.oninput || null;
    // Remove/restore event listeners via class
    inp.classList.toggle('price-locked', lock);
  });

  // Save button
  const btn = document.getElementById('btn-save');
  if (btn) {
    btn.style.display = lock ? 'none' : '';
  }

  // DUZP
  const duzp = document.getElementById('d-duzp');
  if (duzp) {
    duzp.readOnly = lock;
    duzp.style.cursor = lock ? 'not-allowed' : '';
    duzp.style.background = lock ? 'rgba(250,250,252,.7)' : '';
  }

  // Locked bar visibility
  const bar = document.getElementById('ceny-locked-bar');
  if (bar) bar.style.display = lock ? 'flex' : 'none';

  if (!lock) {
    // Re-attach focus highlight for unlocked inputs
    document.querySelectorAll('.ceny-tbl input:not([readonly]):not(.price-locked)').forEach(inp => {
      inp.addEventListener('focus', () => { inp.style.background = 'var(--blue2)'; inp.style.borderLeftColor = 'var(--blue)'; });
      inp.addEventListener('blur', () => { inp.style.background = ''; inp.style.borderLeftColor = ''; });
    });
  }
}

function unlockPrices(id) {
  applyPriceLock(false);
  // Show unlock warning
  const bar = document.getElementById('ceny-locked-bar');
  if (bar) {
    bar.style.background = '#fff7ed';
    bar.style.borderColor = '#fed7aa';
    bar.innerHTML = `
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#c2410c" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      <span style="font-size:12px;color:#c2410c;flex:1"><strong>Editace odemčena.</strong> Po dokončení klikněte na <strong>Uložit ceny</strong>.</span>
      <button onclick="document.getElementById('ceny-locked-bar').style.display='none'"
        style="padding:4px 10px;background:none;border:none;font-size:18px;cursor:pointer;color:#c2410c;line-height:1">×</button>
    `;
    bar.style.display = 'flex';
  }
}

// ── DETAIL CALC ───────────────────────────────────────
function _calcTotals(){
  // Calc only — no side effects, safe to call on load
  let total=0;
  for(let i=1;i<=8;i++){const p=parseFloat(document.getElementById('dq'+i)?.value)||0,c=parseFloat(document.getElementById('dc'+i)?.value)||0;const cel=p*c?fmt(p*c):'';const el=document.getElementById('dcel'+i);if(el)el.value=cel;total+=p*c;}
  for(let i=1;i<=3;i++){const p=parseFloat(document.getElementById('deq'+i)?.value)||0,c=parseFloat(document.getElementById('dec'+i)?.value)||0;const cel=p*c?fmt(p*c):'';const el=document.getElementById('decel'+i);if(el)el.value=cel;total+=p*c;}
  const el=document.getElementById('d-total');if(el)el.textContent=fmt(total)+' Kč';
}
function dCalc(){
  // Called from user input — calc + mark dirty
  _calcTotals();
  markDirty();
}
function markDirty(){
  const s=document.getElementById('save-status');
  if(s){s.textContent='● Neuložené změny';s.style.color='var(--warn,#b45309)';}
  // Auto-transition to rozpracovaná when anything changes
  if(activeId){
    const z=(window._zakazky||[]).find(x=>x.id===activeId);
    if(z&&['nová','ke zpracování'].includes(z.stav||'nová')){
      z.stav='rozpracovaná';
      window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',activeId),
        {stav:'rozpracovaná',updatedAt:window._fb.serverTimestamp()}).catch(()=>{});
      const sel=document.getElementById('stav-sel');
      if(sel)sel.value='rozpracovaná';
    }
  }
}

// ── SAVE DETAIL ───────────────────────────────────────
async function saveDetail(id){
  const btn=document.getElementById('btn-save');
  const status=document.getElementById('save-status');
  if(btn)btn.disabled=true;
  const rows=[];for(let i=1;i<=8;i++)rows.push({pol:document.getElementById('dp'+i)?.value||'',poc:document.getElementById('dq'+i)?.value||'',cen:document.getElementById('dc'+i)?.value||'',cel:document.getElementById('dcel'+i)?.value||''});
  const exts=[];for(let i=1;i<=3;i++)exts.push({label:document.getElementById('den'+i)?.value||EXT_LABELS[i-1],poc:document.getElementById('deq'+i)?.value||'',cen:document.getElementById('dec'+i)?.value||'',cel:document.getElementById('decel'+i)?.value||''});
  const total=document.getElementById('d-total')?.textContent||'';
  // Auto-transition to rozpracovaná when prices are saved
  const z=(window._zakazky||[]).find(x=>x.id===id);
  const currentStav=z?.stav||'nová';
  const newStav=['nová','ke zpracování'].includes(currentStav)?'rozpracovaná':currentStav;
  try{
    await window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id),{
      rows,exts,cena:total,duzp:document.getElementById('d-duzp')?.value||'',
      hodiny:parseFloat(document.getElementById('d-hodiny')?.value)||0,
      km:parseInt(document.getElementById('d-km')?.value)||0,
      kmSazba:parseFloat(document.getElementById('d-km-sazba')?.value)||5.60,
      pricesSkipped:false,stav:newStav,updatedAt:window._fb.serverTimestamp()
    });
    if(status){status.textContent='✓ Uloženo';status.style.color='var(--green)';}
    if(btn){btn.disabled=false;}
    // Lock prices after save
    applyPriceLock(true);
    // Show locked bar
    const lockedBar = document.getElementById('ceny-locked-bar');
    if(lockedBar){
      lockedBar.style.background='#fffbf0';
      lockedBar.style.borderColor='#fde68a';
      lockedBar.innerHTML=`
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#b45309" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <span style="font-size:12px;color:#92400e;flex:1">Ceny jsou uloženy. Pro editaci klikněte na <strong>Odemknout</strong>.</span>
        <button onclick="unlockPrices('${id}')" style="padding:5px 13px;background:#fff;color:#b45309;border:1.5px solid #fcd34d;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;display:flex;align-items:center;gap:5px">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
          Odemknout
        </button>
      `;
      lockedBar.style.display='flex';
    }
    // Update stav select if state changed
    if(newStav!==currentStav){
      const sel=document.getElementById('stav-sel');
      if(sel)sel.value=newStav;
      const badge=document.querySelector('.detail-hdr-right .stav-badge');
      if(badge)badge.outerHTML=stavBadge(newStav);
    }
  }catch(e){if(status){status.textContent='Chyba: '+e.message;status.style.color='var(--err)';}if(btn)btn.disabled=false;}
}

// ── CHANGE STAV ───────────────────────────────────────
async function changeStav(id,stav){
  try{
    await window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id),{stav,updatedAt:window._fb.serverTimestamp()});
    saveAuditLog(id,'stav_zmena',stav);
  }
  catch(e){alert('Chyba: '+e.message);}
}

// ── DELETE ────────────────────────────────────────────
async function deleteZakazka(id){
  const z=(window._zakazky||[]).find(x=>x.id===id);
  if(!confirm('Smazat zakázku "'+((z&&z.nazev)||id)+'"? Tato akce je nevratná.'))return;
  try{
    await window._fb.deleteDoc(window._fb.doc(window._fb.db,'zakazky',id));
    document.getElementById('detail-empty').style.display='flex';
    document.getElementById('detail-inner').style.display='none';
    activeId=null;
  }catch(e){alert('Chyba mazání: '+e.message);}
}

// ── ASSIGN MODAL ──────────────────────────────────────
let _assignId=null;
async function openAssignModal(id){
  _assignId=id;
  // Load users with role technik/admin from Firestore
  const sel=document.getElementById('assign-sel');
  sel.innerHTML='<option value="">Načítám...</option>';
  try{
    const snap=await window._fb.getDocs(window._fb.collection(window._fb.db,'users'));
    const users=[];
    snap.forEach(d=>{const u={id:d.id,...d.data()};if(u.role==='technik'||u.role==='admin')users.push(u);});
    users.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    // Also add any technik names from zakazky not in users
    const fromZak=[...new Set((window._zakazky||[]).map(z=>z.technik||'').filter(Boolean))];
    const userNames=users.map(u=>u.name||u.email);
    const extra=fromZak.filter(n=>!userNames.includes(n));
    sel.innerHTML=
      users.map(u=>`<option value="${esc(u.name||u.email)}">${esc(u.name||u.email)}</option>`).join('')+
      (extra.length?'<optgroup label="— ostatní —">'+extra.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('')+'</optgroup>':'');
  }catch(e){
    // Fallback: names from existing zakazky
    const techs=[...new Set((window._zakazky||[]).map(z=>z.technik||'').filter(Boolean))].sort();
    sel.innerHTML=techs.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');
  }
  // Pre-fill from existing zakazka
  const z=(window._zakazky||[]).find(x=>x.id===id);
  if(z){
    if(z.technik)sel.value=z.technik;
    document.getElementById('assign-termin').value=z.termin||'';
    document.getElementById('assign-zadani').value=z.zadani||'';
  }else{
    document.getElementById('assign-termin').value='';
    document.getElementById('assign-zadani').value='';
  }
  document.getElementById('assign-modal').classList.add('open');
}
async function doAssign(){
  const tech=document.getElementById('assign-sel').value;
  const termin=document.getElementById('assign-termin').value;
  const zadani=document.getElementById('assign-zadani').value.trim();
  if(!tech||!_assignId)return;
  try{
    await window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',_assignId),{
      assignedTo:tech,
      termin:termin||'',
      zadani:zadani||'',
      updatedAt:window._fb.serverTimestamp()
    });
    // Update local cache
    const z=(window._zakazky||[]).find(x=>x.id===_assignId);
    if(z){z.assignedTo=tech;z.termin=termin;z.zadani=zadani;}
    closeModal('assign-modal');
    // Show confirmation in the detail view if open
    const badge=document.getElementById('assign-badge');
    if(badge)badge.textContent='✓ Přiřazeno: '+tech;
  }catch(e){alert('Chyba: '+e.message);}
}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// ── LIGHTBOX ──────────────────────────────────────────
function openLightbox(src){document.getElementById('lightbox-img').src=src;document.getElementById('lightbox').classList.add('open');}
function closeLightbox(){document.getElementById('lightbox').classList.remove('open');}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeLightbox();closeModal('assign-modal');}});

// ── EXPORT ────────────────────────────────────────────
function getDetailData(id){
  const z=(window._zakazky||[]).find(x=>x.id===id);if(!z)return null;
  const rows=[];for(let i=1;i<=8;i++)rows.push({pol:document.getElementById('dp'+i)?.value||'',poc:document.getElementById('dq'+i)?.value||'',cen:document.getElementById('dc'+i)?.value||'',cel:document.getElementById('dcel'+i)?.value||''});
  const exts=[];for(let i=1;i<=3;i++)exts.push({label:document.getElementById('den'+i)?.value||EXT_LABELS[i-1],poc:document.getElementById('deq'+i)?.value||'',cen:document.getElementById('dec'+i)?.value||'',cel:document.getElementById('decel'+i)?.value||''});
  return{...z,rows,exts,cena:document.getElementById('d-total')?.textContent||z.cena||'',duzp:document.getElementById('d-duzp')?.value||z.duzp||''};
}

function printDetail(id){
  const d=getDetailData(id);if(!d)return;
  const inclPhotos=document.getElementById('print-photos-cb')?.checked||false;
  const pv=buildPrintView({...d,sd1:fmtD(d.sd1),sd2:fmtD(d.sd2),termin:d.termin,showPrices:true,includePhotos:inclPhotos});
  const pc=document.getElementById('print-container');pc.innerHTML='';pc.appendChild(pv);
  setTimeout(()=>window.print(),300);
}

function exportHTML(id){
  const d=getDetailData(id);if(!d)return;
  const pv=buildPrintView({...d,sd1:fmtD(d.sd1),sd2:fmtD(d.sd2),termin:d.termin,showPrices:true,includePhotos:document.getElementById('print-photos-cb')?.checked||false});
  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Servisní list ${esc(d.cislo)}</title><style>@page{size:A4;margin:0}body{margin:0;background:#fff}</style></head><body>${pv.outerHTML}
<!-- ══ ADD ZAKÁZKA MODAL ══════════════════════════════ -->
<div id="modal-add-zakaz" style="display:none;position:fixed;inset:0;background:rgba(15,31,61,.55);z-index:1000;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:12px;padding:24px 28px;width:460px;max-width:95vw;box-shadow:0 20px 60px rgba(15,31,61,.3)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <h3 style="font-size:16px;font-weight:700;color:var(--n1)">Přidat zakázku</h3>
      <button onclick="closeAddZakazkaModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div>
        <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Název zakázky *</label>
        <input id="az-nazev" placeholder="např. Klimatizace Brno — kancelář" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Číslo servisu</label>
          <input id="az-cislo" placeholder="2024-001" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit">
        </div>
        <div>
          <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Zákazník (IČO nebo název)</label>
          <div style="position:relative">
            <input id="az-zakaznik" placeholder="Název firmy nebo IČO…" autocomplete="off"
              style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;font-family:inherit"
              oninput="kAresDebounce(this.value)">
            <div id="az-ares-loading" style="display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;color:var(--muted)">🔍</div>
            <div id="az-ares-dropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid var(--border);border-radius:8px;box-shadow:0 4px 16px rgba(15,31,61,.12);z-index:300;max-height:220px;overflow-y:auto;margin-top:2px"></div>
          </div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
        <div>
          <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Adresa zákazníka</label>
          <input id="az-adresa" placeholder="Ulice, město, PSČ" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
        </div>
        <div>
          <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">IČO / DIČ</label>
          <div style="display:flex;gap:6px">
            <input id="az-ico" placeholder="IČO" style="flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
            <input id="az-dic" placeholder="DIČ" style="flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit">
          </div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px">Servis provádí</label>
        <div style="display:flex;gap:8px">
          <button type="button" id="kaz-btn-aceuro" onclick="kSetFirma('aceuro')"
            style="flex:1;padding:9px 8px;border-radius:8px;border:2px solid #6abf3e;background:#f0fff4;font-size:12px;font-weight:700;cursor:pointer;color:#0f1f3d;display:flex;align-items:center;justify-content:center;gap:5px">
            <span style="width:8px;height:8px;border-radius:50%;background:#6abf3e;display:inline-block"></span>AC EURO a.s.
          </button>
          <button type="button" id="kaz-btn-progres" onclick="kSetFirma('progres')"
            style="flex:1;padding:9px 8px;border-radius:8px;border:2px solid #d0d8e8;background:#fff;font-size:12px;font-weight:700;cursor:pointer;color:#6b7a99;display:flex;align-items:center;justify-content:center;gap:5px">
            <span style="width:8px;height:8px;border-radius:50%;background:#1e90ff;display:inline-block"></span>Progresklima CZ
          </button>
        </div>
      </div>
      <div>
        <label style="font-size:11px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px">Uložit do seznamu zakázek</label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="az-save-template" checked style="width:16px;height:16px;accent-color:var(--blue)">
          <span>Přidat tuto zakázku do výběru pro techniky</span>
        </label>
      </div>
      <div id="az-err" style="display:none;font-size:12px;color:#b91c1c;background:#fef2f2;padding:8px 12px;border-radius:6px"></div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
      <button onclick="closeAddZakazkaModal()" style="padding:10px 18px;background:#f4f6fa;color:var(--n1);border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">Zrušit</button>
      <button id="az-btn" onclick="submitAddZakazka()" style="padding:10px 22px;background:var(--green2);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer">Vytvořit zakázku</button>
    </div>
  </div>
</div>

</body></html>`;
  const blob=new Blob([html],{type:'text/html;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='Servisni_list_'+((d.cislo||'export').replace(/[^a-z0-9_-]/gi,'_'))+'.html';
  a.click();URL.revokeObjectURL(a.href);
}

function exportCSV(id){
  const d=getDetailData(id);if(!d)return;
  const rows=[['Položka','Počet ks','Cena Kč/ks','Celkem Kč']];
  (d.rows||[]).forEach(r=>{if(r.pol||r.poc)rows.push([r.pol,r.poc,r.cen,r.cel]);});
  rows.push(['--- Cestovní náklady ---','','','']);
  (d.exts||[]).forEach(e=>{if(e.poc)rows.push([e.label,e.poc,e.cen,e.cel]);});
  rows.push(['','','Celkem bez DPH:',d.cena||'']);
  const csv=rows.map(r=>r.map(v=>'"'+(v||'').replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='Cenik_'+((d.cislo||'export').replace(/[^a-z0-9_-]/gi,'_'))+'.csv';
  a.click();URL.revokeObjectURL(a.href);
}

// ── DASHBOARD ─────────────────────────────────────────
function renderDashboard(){
  const all=window._zakazky||[];
  const now=new Date();
  const thisMonth=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
  const lastMonth=new Date(now.getFullYear(),now.getMonth()-1,1);
  const lm=lastMonth.getFullYear()+'-'+String(lastMonth.getMonth()+1).padStart(2,'0');

  const total=all.length;
  const nova=all.filter(z=>(z.stav||'nová')==='nová').length;
  const thisMonthZ=all.filter(z=>z.termin&&z.termin.startsWith(thisMonth));
  const lastMonthZ=all.filter(z=>z.termin&&z.termin.startsWith(lm));

  // Revenue
  function parseCena(c){return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0;}
  const revThis=thisMonthZ.reduce((s,z)=>s+parseCena(z.cena),0);
  const revLast=lastMonthZ.reduce((s,z)=>s+parseCena(z.cena),0);
  const revDiff=revLast?Math.round((revThis-revLast)/revLast*100):0;

  document.getElementById('stats-grid').innerHTML=`
    <div class="stat-card"><div class="val">${total}</div><div class="lbl">Celkem zakázek</div></div>
    <div class="stat-card warn"><div class="val">${nova}</div><div class="lbl">Ke zpracování</div></div>
    <div class="stat-card blue"><div class="val">${thisMonthZ.length}</div><div class="lbl">Tento měsíc</div><div class="sub">Minulý: ${lastMonthZ.length}</div></div>
    <div class="stat-card green"><div class="val">${fmt(revThis)} Kč</div><div class="lbl">Obrat tento měsíc</div><div class="sub">${revDiff>=0?'+':''}${revDiff}% vs. minulý</div></div>
  `;

  // By technik
  const byTech={};
  all.forEach(z=>{
    // Count each technik individually for multi-technik zakázky
    const techList=z.technici&&z.technici.length
      ? z.technici
      : [{name:z.technik||'Neznámý'}];
    techList.forEach(u=>{const t=u.name||'Neznámý';byTech[t]=(byTech[t]||0)+1;});
  });
  const techEntries=Object.entries(byTech).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const maxT=techEntries[0]?techEntries[0][1]:1;
  document.getElementById('chart-technici').innerHTML=techEntries.map(([t,c])=>`
    <div class="cbl-row">
      <div class="cbl-lbl">${esc(t)}</div>
      <div class="cbl-bar-wrap"><div class="cbl-bar" style="width:${Math.round(c/maxT*100)}%"></div></div>
      <div class="cbl-val">${c} zakázek</div>
    </div>`).join('');

  // By stav (this month)
  const byStav={nová:0,zpracovaná:0,fakturovaná:0};
  thisMonthZ.forEach(z=>{const s=z.stav||'nová';if(byStav[s]!==undefined)byStav[s]++;});
  const maxS=Math.max(...Object.values(byStav))||1;
  const stavColors={'nová':'#f0a500','zpracovaná':'#6abf3e','fakturovaná':'#2d5fa6'};
  document.getElementById('chart-stavy').innerHTML=Object.entries(byStav).map(([s,c])=>`
    <div class="cbl-row">
      <div class="cbl-lbl" style="text-transform:capitalize">${s}</div>
      <div class="cbl-bar-wrap"><div class="cbl-bar" style="width:${Math.round(c/maxS*100)}%;background:${stavColors[s]}"></div></div>
      <div class="cbl-val">${c}</div>
    </div>`).join('');

  // 30-day trend (simple canvas bar chart)
  const days=[];
  for(let i=29;i>=0;i--){const d=new Date(now);d.setDate(d.getDate()-i);days.push(d.toISOString().slice(0,10));}
  const counts={};days.forEach(d=>counts[d]=0);
  all.forEach(z=>{if(z.termin&&counts[z.termin]!==undefined)counts[z.termin]++;});
  drawTrendChart(days,days.map(d=>counts[d]));

  // Recent table
  document.getElementById('recent-tbody').innerHTML=all.slice(0,10).map(z=>`
    <tr onclick="switchTab('orders');setTimeout(()=>openDetail('${z.id}'),50)">
      <td><strong>${esc(z.nazev||'—')}</strong><br><span style="font-size:10px;color:var(--muted)">${esc(z.cislo||'')}</span></td>
      <td>${esc(z.technik||'—')}</td>
      <td>${stavBadge(z.stav||'nová')}</td>
      <td>${fmtD(z.termin)||'—'}</td>
      <td style="font-family:'DM Mono',monospace;white-space:nowrap">${z.cena||'—'}</td>
    </tr>`).join('');
}

function drawTrendChart(labels,data){
  const canvas=document.getElementById('trend-chart');
  if(!canvas)return;
  const dpr=window.devicePixelRatio||1;
  const W=canvas.parentElement.clientWidth-36;
  const H=80;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');
  ctx.scale(dpr,dpr);
  const max=Math.max(...data)||1;
  const bw=(W-20)/data.length;
  data.forEach((v,i)=>{
    const bh=Math.max(2,Math.round(v/max*(H-20)));
    const x=10+i*bw+1;const y=H-10-bh;
    ctx.fillStyle=v?'#2d5fa6':'#d0d8e8';
    ctx.fillRect(x,y,bw-2,bh);
  });
  ctx.fillStyle='#6b7a99';ctx.font='9px DM Sans,sans-serif';
  [labels[0],labels[7],labels[14],labels[21],labels[29]].forEach((d,i)=>{
    const idx=[0,7,14,21,29][i];
    const x=10+idx*bw;
    ctx.fillText(d.slice(5),x,H-1);
  });
}

// ── USERS (add new technician) ────────────────────────
function renderUsers(){
  const all=window._zakazky||[];
  const byTech={};
  all.forEach(z=>{
    const techList=z.technici&&z.technici.length
      ? z.technici
      : [{name:z.technik||'',email:z.technikEmail||z.technik||'?',uid:''}];
    techList.forEach(u=>{
      const t=u.email||u.name||u.uid||'?';
      if(!byTech[t])byTech[t]={name:u.name||z.technik||'',email:t,count:0,lastZ:''};
      byTech[t].count++;
      if(!byTech[t].lastZ||z.termin>byTech[t].lastZ)byTech[t].lastZ=z.termin;
    });
  });
  const entries=Object.values(byTech).sort((a,b)=>b.count-a.count);
  document.getElementById('user-list').innerHTML=entries.length
    ?entries.map(u=>`
      <div class="user-row">
        <div class="user-av">${(u.name||u.email||'?')[0].toUpperCase()}</div>
        <div class="user-info-cell">
          <div class="nm">${esc(u.name||u.email)}</div>
          <div class="em">${esc(u.email)}</div>
        </div>
        <div class="user-stats">
          <div style="font-size:13px;font-weight:700;color:var(--navy)">${u.count} zakázek</div>
          ${u.lastZ?`<div style="font-size:10px;color:var(--muted)">Naposledy: ${fmtD(u.lastZ)}</div>`:''}
        </div>
      </div>`).join('')
    :'<div style="font-size:12px;color:var(--muted)">Zatím žádné zakázky.</div>';
}

async function addUser(){
  const name=document.getElementById('nu-name').value.trim();
  const email=document.getElementById('nu-email').value.trim();
  const pass=document.getElementById('nu-pass').value;
  const pass2=document.getElementById('nu-pass2').value;
  const status=document.getElementById('add-status');
  status.style.color='var(--muted)';status.textContent='';
  if(!name||!email||!pass){status.textContent='Vyplňte všechna pole.';status.style.color='var(--err)';return;}
  if(pass!==pass2){status.textContent='Hesla se neshodují.';status.style.color='var(--err)';return;}
  if(pass.length<6){status.textContent='Heslo musí mít alespoň 6 znaků.';status.style.color='var(--err)';return;}
  status.textContent='Vytvářím účet...';
  try{
    // Create account using secondary auth instance to avoid logging out current admin
    const {initializeApp,getApps} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");
    const {getAuth,createUserWithEmailAndPassword,updateProfile} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
    const cfg=window._fb.auth.app.options;
    const existingApps=getApps();
    const tmpApp=existingApps.find(a=>a.name==='tmp-create')||(await (async()=>{const {initializeApp}=await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js");return initializeApp(cfg,'tmp-create');})());
    const tmpAuth=getAuth(tmpApp);
    const cred=await createUserWithEmailAndPassword(tmpAuth,email,pass);
    await updateProfile(cred.user,{displayName:name});
    await tmpAuth.signOut();
    status.textContent='✓ Účet technika vytvořen! E-mail: '+email;status.style.color='var(--green)';
    document.getElementById('nu-name').value='';
    document.getElementById('nu-email').value='';
    document.getElementById('nu-pass').value='';
    document.getElementById('nu-pass2').value='';
    renderUsers();
  }catch(e){
    const m={'auth/email-already-in-use':'Tento e-mail je již registrován.','auth/invalid-email':'Neplatný e-mail.','auth/weak-password':'Heslo je příliš slabé.'};
    status.textContent=m[e.code]||'Chyba: '+e.message;status.style.color='var(--err)';
  }
}

// ── BUILD PRINT VIEW ─────────────────────────────────



// ══════════════════════════════════════════════════════════════════════
//  PŘIDAT ZAKÁZKU — modal
// ══════════════════════════════════════════════════════════════════════

function openAddZakazkaModal() {
  const m = document.getElementById('modal-add-zakaz');
  if (!m) return;
  // Reset form
  ['az-nazev','az-cislo','az-zakaznik'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const cb = document.getElementById('az-save-template');
  if (cb) cb.checked = true;
  const err = document.getElementById('az-err');
  if (err) err.style.display = 'none';
  const btn = document.getElementById('az-btn');
  if (btn) { btn.disabled = false; btn.textContent = 'Vytvořit zakázku'; }
  m.style.display = 'flex';
  setTimeout(() => document.getElementById('az-nazev')?.focus(), 80);
}

function closeAddZakazkaModal() {
  const m = document.getElementById('modal-add-zakaz');
  if (m) m.style.display = 'none';
}

// Close on backdrop click
document.addEventListener('click', e => {
  const m = document.getElementById('modal-add-zakaz');
  if (m && e.target === m) closeAddZakazkaModal();
});

async function submitAddZakazka() {
  const nazev = document.getElementById('az-nazev')?.value.trim();
  const cislo = document.getElementById('az-cislo')?.value.trim() || '';
  const zakaznik = document.getElementById('az-zakaznik')?.value.trim() || '';
  const saveTemplate = document.getElementById('az-save-template')?.checked;
  const err = document.getElementById('az-err');
  const btn = document.getElementById('az-btn');

  if (!nazev) {
    err.textContent = 'Zadejte název zakázky.';
    err.style.display = 'block';
    document.getElementById('az-nazev')?.focus();
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Ukládám…';
  err.style.display = 'none';

  try {
    // Create actual zakázka document
    const me = window._me;
    const adresa = document.getElementById('az-adresa')?.value.trim() || '';
    const ico = document.getElementById('az-ico')?.value.trim() || '';
    const dic = document.getElementById('az-dic')?.value.trim() || '';
    const firma = window._kCurrentFirma || 'aceuro';
    const data = {
      nazev, cislo, zakaznik, adresa, ico, dic, firma,
      technik: me?.displayName || me?.email || '—',
      technikUid: me?.uid || '',
      technikEmail: me?.email || '',
      termin: '', prace: '', pozn: '', komentar: '',
      duzp: '', pricesSkipped: true,
      rows: Array.from({length:8}, () => ({pol:'',poc:'',cen:'',cel:''})),
      exts: [
        {label:'Cestovní čas',poc:'',cen:'',cel:''},
        {label:'Celkem ujeté km',poc:'',cen:'',cel:''},
        {label:'Paušál cestovného',poc:'',cen:'',cel:''},
      ],
      cena: '',
      sig1: '', sig2: '', sd1: '', sd2: '',
      photos: [],
      stav: 'nová',
      createdAt: window._fb.serverTimestamp(),
      updatedAt: window._fb.serverTimestamp(),
      source: 'kancelar',
    };

    await window._fb.addDoc(
      window._fb.collection(window._fb.db, 'zakazky'), data
    );

    // Optionally also save to zakazky_typy (for technik dropdown)
    if (saveTemplate) {
      await window._fb.setDoc(
        window._fb.doc(window._fb.db, 'zakazky_typy',
          nazev.toLowerCase().replace(/[^a-z0-9]/g,'_').slice(0,40) + '_' + Date.now()),
        { nazev, cislo, zakaznik, createdAt: window._fb.serverTimestamp() }
      );
    }

    closeAddZakazkaModal();
  } catch(e) {
    err.textContent = 'Chyba: ' + e.message;
    err.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'Vytvořit zakázku';
  }
}



// ══════════════════════════════════════════════════════════════════════
//  TYPY ZAKÁZEK — správa seznamu pro techniky
// ══════════════════════════════════════════════════════════════════════

let _zakazkyTypy = [];

async function loadZakazkyTypy() {
  const list = document.getElementById('zt-list');
  const count = document.getElementById('zt-count');
  if (!list) return;
  list.innerHTML = '<div style="font-size:12px;color:var(--muted);padding:12px;text-align:center">Načítám…</div>';
  try {
    const snap = await window._fb.getDocs(
      window._fb.query(
        window._fb.collection(window._fb.db, 'zakazky_typy'),
        window._fb.orderBy('nazev', 'asc')
      )
    );
    _zakazkyTypy = snap.docs.map(d => ({id: d.id, ...d.data()}));
    if (count) count.textContent = '(' + _zakazkyTypy.length + ')';
    renderZakazkyTypyList();
  } catch(e) {
    list.innerHTML = '<div style="color:#b91c1c;font-size:12px;padding:12px">Chyba: ' + e.message + '</div>';
  }
}

function renderZakazkyTypyList() {
  const list = document.getElementById('zt-list');
  if (!list) return;
  if (!_zakazkyTypy.length) {
    list.innerHTML = '<div style="font-size:12px;color:var(--muted);padding:20px;text-align:center">Žádné typy zakázek. Přidejte první.</div>';
    return;
  }
  list.innerHTML = _zakazkyTypy.map(z => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#fff;border:1px solid var(--border);border-radius:8px">
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px;color:var(--n1)">${esc(z.nazev||'—')}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:1px">
          ${z.cislo?`<span>č. ${esc(z.cislo)}</span> · `:''}
          ${z.zakaznik?`<span>${esc(z.zakaznik)}</span>`:'<em>bez zákazníka</em>'}
        </div>
      </div>
      <button onclick="deleteZakazkaTyp('${z.id}')"
        style="padding:5px 10px;background:#fef2f2;color:#b91c1c;border:1px solid #fecaca;border-radius:6px;font-size:11px;cursor:pointer;flex-shrink:0">
        🗑 Smazat
      </button>
    </div>
  `).join('');
}

async function addZakazkaTyp() {
  const nazev = document.getElementById('zt-nazev')?.value.trim();
  const cislo = document.getElementById('zt-cislo')?.value.trim() || '';
  const zakaznik = document.getElementById('zt-zakaznik')?.value.trim() || '';
  const btn = document.getElementById('zt-add-btn');
  const status = document.getElementById('zt-status');

  if (!nazev) {
    status.textContent = '⚠ Zadejte název';
    status.style.color = '#b91c1c';
    document.getElementById('zt-nazev')?.focus();
    return;
  }

  btn.disabled = true; btn.textContent = 'Přidávám…';
  status.textContent = '';

  try {
    const docId = nazev.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').slice(0,40) + '-' + Date.now();
    await window._fb.setDoc(
      window._fb.doc(window._fb.db, 'zakazky_typy', docId),
      { nazev, cislo, zakaznik, createdAt: window._fb.serverTimestamp() }
    );
    ['zt-nazev','zt-cislo','zt-zakaznik'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    status.textContent = '✓ Přidáno';
    status.style.color = 'var(--green)';
    setTimeout(() => { status.textContent = ''; }, 2500);
    await loadZakazkyTypy();
  } catch(e) {
    status.textContent = 'Chyba: ' + e.message;
    status.style.color = '#b91c1c';
  } finally {
    btn.disabled = false; btn.textContent = 'Přidat';
  }
}

async function deleteZakazkaTyp(id) {
  if (!confirm('Smazat tento typ zakázky ze seznamu?')) return;
  try {
    await window._fb.deleteDoc(window._fb.doc(window._fb.db, 'zakazky_typy', id));
    await loadZakazkyTypy();
  } catch(e) {
    alert('Chyba: ' + e.message);
  }
}



// ══ TECHNIK HISTORY ═════════════════════════════════════════════════
// ══ KANCELÁŘ FIRMA + ARES ═══════════════════════════════════════════
let _kCurrentFirma = 'aceuro';

function kSetFirma(firma) {
  _kCurrentFirma = firma;
  const btnAC = document.getElementById('kaz-btn-aceuro');
  const btnPR = document.getElementById('kaz-btn-progres');
  if(btnAC){
    const isAC = firma === 'aceuro';
    btnAC.style.border = isAC ? '2px solid #6abf3e' : '2px solid #d0d8e8';
    btnAC.style.background = isAC ? '#f0fff4' : '#fff';
    btnAC.style.color = isAC ? '#0f1f3d' : '#6b7a99';
    btnPR.style.border = !isAC ? '2px solid #1e90ff' : '2px solid #d0d8e8';
    btnPR.style.background = !isAC ? '#eff6ff' : '#fff';
    btnPR.style.color = !isAC ? '#0a3d8f' : '#6b7a99';
  }
}

let _kAresTimer = null;
function kAresDebounce(val) {
  clearTimeout(_kAresTimer);
  const dd = document.getElementById('az-ares-dropdown');
  const ld = document.getElementById('az-ares-loading');
  if (!val || val.length < 2) { if(dd)dd.style.display='none'; return; }
  if(ld)ld.style.display='block';
  _kAresTimer = setTimeout(() => kAresSearch(val,'az'), 500);
}

async function kAresSearch(query, prefix) {
  const dropdown = document.getElementById(prefix+'-ares-dropdown');
  const loading = document.getElementById(prefix+'-ares-loading');
  if(!dropdown) return;
  try {
    const isICO = /^\d{6,8}$/.test(query.trim());
    const url = isICO
      ? `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${query.trim()}`
      : `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty-vr?nazev=${encodeURIComponent(query)}&pocet=8&razeni=NAZEV`;
    const res = await fetch(url);
    if(!res.ok) throw new Error();
    const data = await res.json();
    let items = isICO && data.ico ? [data] : (data.ekonomickeSubjekty || []);
    if(!items.length){
      dropdown.innerHTML='<div style="padding:10px 12px;font-size:12px;color:#6b7a99">Nic nenalezeno</div>';
    } else {
      dropdown.innerHTML = items.map(s => {
        const ico=s.ico||'',nazev=s.obchodniJmeno||s.nazev||'';
        const adresa=kFormatAresAddr(s);
        return `<div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7;font-family:inherit"
          onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background=''"
          onclick='kAresSelect(${JSON.stringify({ico,nazev,adresa,dic:s.dic||""})}, "${prefix}")'>
          <div style="font-size:13px;font-weight:600;color:#1a2540">${esc(nazev)}</div>
          <div style="font-size:11px;color:#6b7a99">IČO: ${ico}${adresa?' · '+adresa:''}</div>
        </div>`;
      }).join('');
    }
    dropdown.style.display='block';
  } catch(e) {
    dropdown.innerHTML='<div style="padding:10px 12px;font-size:12px;color:#6b7a99">ARES nedostupný</div>';
    dropdown.style.display='block';
  }
  if(loading)loading.style.display='none';
}

function kFormatAresAddr(s) {
  if(!s.sidlo) return '';
  const sid=s.sidlo;
  return [
    sid.nazevUlice?(sid.nazevUlice+(sid.cisloDomovni?' '+sid.cisloDomovni:'')+(sid.cisloOrientacni?'/'+sid.cisloOrientacni:'')):'',
    sid.nazevObce||'',
    sid.psc?String(sid.psc).replace(/(\d{3})(\d{2})/,'$1 $2'):''
  ].filter(Boolean).join(', ');
}

function kAresSelect(s, prefix) {
  const setV=(id,v)=>{const el=document.getElementById(prefix+'-'+id);if(el)el.value=v;};
  setV('zakaznik',s.nazev);
  setV('adresa',s.adresa);
  setV('ico',s.ico);
  setV('dic',s.dic);
  const dd=document.getElementById(prefix+'-ares-dropdown');
  if(dd)dd.style.display='none';
}

document.addEventListener('click', e => {
  if(!e.target.closest('#az-ares-dropdown')&&!e.target.matches('#az-zakaznik')){
    const d=document.getElementById('az-ares-dropdown');
    if(d)d.style.display='none';
  }
});

function loadHistorie(){
  const zakazky = window._zakazky || [];
  // Build technik list
  const techSet = new Set();
  zakazky.forEach(z => {
    if(z.technik) techSet.add(z.technik);
    if(z.assignedTo) techSet.add(z.assignedTo);
  });
  const sel = document.getElementById('hist-technik-sel');
  const cur = sel.value;
  sel.innerHTML = '<option value="">— Všichni technici —</option>' +
    [...techSet].sort().map(t => `<option value="${esc(t)}"${cur===t?' selected':''}>${esc(t)}</option>`).join('');
  renderHistorie();
}

function renderHistorie(){
  const zakazky = window._zakazky || [];
  const techFilter = document.getElementById('hist-technik-sel')?.value || '';
  const days = parseInt(document.getElementById('hist-period-sel')?.value || '0');
  const now = Date.now();
  const cutoff = days > 0 ? now - days * 86400000 : 0;

  // Filter
  let filtered = zakazky.filter(z => {
    const matchTech = !techFilter || z.technik === techFilter || z.assignedTo === techFilter;
    const ts = z.createdAt?.toDate ? z.createdAt.toDate().getTime() :
                z.createdAt ? new Date(z.createdAt).getTime() : 0;
    const matchTime = cutoff === 0 || ts >= cutoff;
    return matchTech && matchTime;
  });

  // Sort newest first
  filtered.sort((a,b) => {
    const ta = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt||0);
    const tb = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt||0);
    return tb - ta;
  });

  // ── Stats cards ───────────────────────────────────────────────────
  const stavCounts = {};
  filtered.forEach(z => { const s = z.stav||'nová'; stavCounts[s] = (stavCounts[s]||0)+1; });
  const totalCena = filtered.reduce((sum,z) => {
    const v = parseFloat((z.cena||'').replace(/[^\d,.]/g,'').replace(',','.')) || 0;
    return sum + v;
  }, 0);

  const stavColors = {
    'nová':'#f0a500','ke zpracování':'#2d5fa6','rozpracovaná':'#d97706',
    'zpracovaná':'#16a34a','fakturovaná':'#7c3aed'
  };
  const cards = [
    {label:'Celkem zakázek', value:filtered.length, icon:'📋', color:'#2d5fa6'},
    {label:'Zpracovaných', value:(stavCounts['zpracovaná']||0)+(stavCounts['fakturovaná']||0), icon:'✅', color:'#16a34a'},
    {label:'Rozpracovaných', value:stavCounts['rozpracovaná']||0, icon:'🔧', color:'#d97706'},
    {label:'Fakturováno', value:stavCounts['fakturovaná']||0, icon:'🧾', color:'#7c3aed'},
    {label:'Tržby (bez DPH)', value:totalCena>0?fmt(totalCena)+' Kč':'—', icon:'💰', color:'#16a34a', wide:true},
  ];

  document.getElementById('hist-stats').innerHTML = cards.map(c => `
    <div style="background:#fff;border:1.5px solid var(--border);border-radius:10px;padding:14px 16px;${c.wide?'grid-column:span 2;':''}">
      <div style="font-size:18px;margin-bottom:4px">${c.icon}</div>
      <div style="font-size:22px;font-weight:700;color:${c.color}">${c.value}</div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">${c.label}</div>
    </div>`).join('');

  // ── Timeline ──────────────────────────────────────────────────────
  if(!filtered.length){
    document.getElementById('hist-timeline').innerHTML =
      '<div style="text-align:center;padding:40px;color:var(--muted);font-size:13px">Žádné zakázky v tomto období</div>';
    return;
  }

  // Group by month
  const byMonth = {};
  filtered.forEach(z => {
    const d = z.createdAt?.toDate ? z.createdAt.toDate() : new Date(z.createdAt||Date.now());
    const key = d.getFullYear()+'-'+(d.getMonth()+1).toString().padStart(2,'0');
    const label = d.toLocaleDateString('cs-CZ',{month:'long',year:'numeric'});
    if(!byMonth[key]) byMonth[key] = {label, items:[]};
    byMonth[key].items.push({...z, _date:d});
  });

  const stavIcon = {'nová':'🆕','ke zpracování':'👁','rozpracovaná':'🔧','zpracovaná':'✅','fakturovaná':'🧾'};

  let html = '';
  Object.keys(byMonth).sort().reverse().forEach(key => {
    const {label, items} = byMonth[key];
    html += `<div style="margin-bottom:24px">
      <div style="font-size:12px;font-weight:700;color:var(--navy);letter-spacing:.05em;text-transform:uppercase;padding:6px 0;border-bottom:2px solid var(--border);margin-bottom:10px">${label} <span style="font-weight:400;color:var(--muted)">(${items.length})</span></div>
      ${items.map(z => {
        const stav = z.stav||'nová';
        const col = stavColors[stav] || '#6b7a99';
        const dateStr = z._date.toLocaleDateString('cs-CZ',{day:'2-digit',month:'2-digit',year:'numeric'});
        return `<div style="display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:box-shadow .15s"
          onclick="openDetail('${z.id}')"
          onmouseenter="this.style.boxShadow='0 2px 8px rgba(15,31,61,.1)'"
          onmouseleave="this.style.boxShadow=''">
          <div style="width:34px;height:34px;border-radius:8px;background:${col}20;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0">${stavIcon[stav]||'📋'}</div>
          <div style="flex:1;min-width:0">
            <div style="font-weight:600;font-size:13px;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(z.nazev||'—')}</div>
            <div style="font-size:11px;color:var(--muted);margin-top:2px">
              ${esc(z.cislo||'')}${z.cislo&&z.zakaznik?' · ':''}${esc(z.zakaznik||'')}
            </div>
            ${z.zadani?`<div style="font-size:11px;color:#1d4ed8;margin-top:3px;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">📋 ${esc(z.zadani.substring(0,60))}${z.zadani.length>60?'…':''}</div>`:''}
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:11px;font-weight:600;color:${col};background:${col}15;padding:2px 8px;border-radius:20px;white-space:nowrap">${stav}</div>
            <div style="font-size:10px;color:var(--muted);margin-top:4px">${dateStr}</div>
            ${z.cena?`<div style="font-size:11px;font-weight:600;color:var(--navy);margin-top:2px">${esc(z.cena)}</div>`:''}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  });

  document.getElementById('hist-timeline').innerHTML = html;
}

// ══ PHOTO CAPTION SAVE ══════════════════════════════════════════════
async function savePhotoCaption(zakazkaId, photoIndex, caption) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if (!z || !z.photos) return;
  // Update local cache
  z.photos[photoIndex].caption = caption;
  // Save to Firestore
  try {
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', zakazkaId),
      { photos: z.photos, updatedAt: window._fb.serverTimestamp() }
    );
  } catch(e) {
    console.warn('Caption save failed:', e.message);
  }
}



// ── Registrace ARES outside-click ──────────────────────────────
document.addEventListener('click', e => {
  if(!e.target.closest('#az-ares-dropdown')&&!e.target.matches('#az-zakaznik')){
    const dd=document.getElementById('az-ares-dropdown');
    if(dd)dd.style.display='none';
  }
});

</script>
<script>

const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyAbpCwz9SLSkzBvAMgBPvYrsOj6zOQoPiE",
  authDomain:        "servis-3213b.firebaseapp.com",
  projectId:         "servis-3213b",
  storageBucket:     "servis-3213b.firebasestorage.app",
  messagingSenderId: "496921476233",
  appId:             "1:496921476283:web:724b6b8d985341c490fd9e"
};

firebase.initializeApp(FIREBASE_CONFIG);
const _auth = firebase.auth();
const _db   = firebase.firestore();
const _stor = firebase.storage();
const _gp   = new firebase.auth.GoogleAuthProvider();

window._fb = {
  auth: _auth, db: _db, storage: _stor,
  googleProvider: _gp, gp: _gp,
  signInWithEmailAndPassword: (_a,e,p) => _auth.signInWithEmailAndPassword(e,p),
  signInWithPopup: (_a,prov) => _auth.signInWithPopup(prov),
  signOut: (_a) => _auth.signOut(),
  createUserWithEmailAndPassword: (_a,e,p) => _auth.createUserWithEmailAndPassword(e,p),
  updateProfile: (u,data) => u.updateProfile(data),
  collection: (db,col) => db.collection(col),
  doc: (db,col,id) => db.collection(col).doc(id),
  orderBy: (f,d) => q => q.orderBy(f,d||'asc'),
  limit:   (n)   => q => q.limit(n),
  where:   (f,op,v) => q => q.where(f,op,v),
  query: (base,...fns) => { let q=base; fns.forEach(fn=>{ if(typeof fn==='function') q=fn(q); }); return q; },
  addDoc:    (col,data)      => col.add(data),
  setDoc:    (ref,data,opts) => opts ? ref.set(data,opts) : ref.set(data),
  updateDoc: (ref,data)      => ref.update(data),
  deleteDoc: (ref)           => ref.delete(),
  getDoc:    (ref)           => ref.get(),
  getDocs:   (q)             => q.get(),
  onSnapshot:(q,cb)          => q.onSnapshot(cb),
  serverTimestamp: () => firebase.firestore.FieldValue.serverTimestamp(),
  ref:           (_s,path)   => _stor.ref(path),
  uploadBytes:   (ref,bytes) => ref.put(bytes),
  getDownloadURL:(ref)       => ref.getDownloadURL(),
};

// ── LOGO DATA ─────────────────────────────────────────
const LOGO_DATA = "data:image/jpeg;base64,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";
const PROGRES_LOGO = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNDAgNzAiPjxyZWN0IHdpZHRoPSIyNDAiIGhlaWdodD0iNzAiIGZpbGw9IiMwYTNkOGYiIHJ4PSI2Ii8+PHRleHQgeD0iMTQiIHk9IjI2IiBmb250LWZhbWlseT0iQXJpYWwsc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNSIgZm9udC13ZWlnaHQ9IjcwMCIgZmlsbD0iI2ZmZiI+UFJPR1JFU0tMSU1BPC90ZXh0Pjx0ZXh0IHg9IjE0IiB5PSI0OCIgZmlsbD0iIzdhYjNmZiIgZm9udC1mYW1pbHk9IkFyaWFsLHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTEiPkNaIHMuci5vLjwvdGV4dD48L3N2Zz4=";

// Firma data
const FIRMA_DATA = {
  aceuro: { name:'AC EURO a.s.', addr:'Houbalova 2553/4, 628 00 Brno',
    ic:'28264347', dic:'CZ28264347', tel:'544 234 330', web:'www.aceuro.cz',
    color:'#6abf3e', dark:'#0f1f3d', class:'brand-aceuro' },
  progres: { name:'Progresklima CZ s.r.o.', addr:'Brno',
    ic:'', dic:'', tel:'', web:'www.progresklima.cz',
    color:'#1e90ff', dark:'#0a3d8f', class:'brand-progres' }
};
let _currentFirma = 'aceuro';

// ── ROLE ROUTING ──────────────────────────────────────
let _kUnsubscribe = null;

firebase.auth().onAuthStateChanged(async user => {
  if (!user) {
    showScreen('login');
    if (_kUnsubscribe) { _kUnsubscribe(); _kUnsubscribe = null; }
    return;
  }
  let role = 'technik';
  try {
    const snap = await _db.collection('users').doc(user.uid).get();
    if (snap.exists) role = snap.data().role || 'technik';
  } catch(e) {}
  if (role === 'pending') {
    const err = document.getElementById('login-err');
    if (err) { err.textContent='⏳ Čeká na schválení.'; err.style.display='block'; }
    await _auth.signOut(); return;
  }
  window._currentUser = user;
  window._currentRole = role;
  if (role === 'admin' || role === 'kancelar') {
    showScreen('kancelar'); initKancelar(user, role);
  } else {
    showScreen('technik'); initTechnik(user);
  }
});

function showScreen(which) {
  document.getElementById('login-screen').style.display  = which==='login'    ? 'flex' : 'none';
  document.getElementById('app-technik').style.display   = which==='technik'  ? 'block' : 'none';
  document.getElementById('app-kancelar').style.display  = which==='kancelar' ? 'flex' : 'none';
}

function initKancelar(user, role) {
  const n=document.getElementById('user-name'); if(n) n.textContent=user.displayName||user.email;
  const a=document.getElementById('user-av');   if(a) a.textContent=(user.displayName||user.email||'?')[0].toUpperCase();
  const r=document.getElementById('role-badge');if(r) r.textContent=role==='admin'?'Admin':'Kancelář';
  startKancelarLive();
}

function initTechnik(user) {
  window._currentUser = user;
  const n=document.getElementById('user-name');    if(n) n.textContent=user.displayName||user.email;
  const a=document.getElementById('user-avatar');  if(a) a.textContent=(user.displayName||user.email||'?')[0].toUpperCase();
  try { _db.collection('zakazky').orderBy('createdAt','desc').get()
    .then(s=>updateSuggestions(s.docs.map(d=>d.data()))).catch(()=>{}); } catch(e) {}
  loadDraft();
  checkPendingUploads && checkPendingUploads();
  showOfflineBanner(!navigator.onLine);
  loadZakazkyList(); loadTechList();
  loadAssignedZakazky(user);
  setFirma('aceuro');
}

function startKancelarLive() {
  _kUnsubscribe = _db.collection('zakazky').orderBy('createdAt','desc')
    .onSnapshot(snap => {
      window._zakazky = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderList && renderList();
      renderDashboard && renderDashboard();
      updateSuggestions && updateSuggestions(window._zakazky);
    });
}

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  SERVISNÍ LIST Z KANCELÁŘE  — kompletní logika
// ════════════════════════════════════════════════════════════════

// --- stav modalu ---
window._slStep    = 0;
window._slId      = null;   // id zakázky, ze které vycházíme (může být null)
window._slFirma   = 'aceuro';
window._slPhotos  = [];     // [{dataUrl, name, caption, printInclude}]
window._slSigData = {1: null, 2: null};
let _slCtx = null, _slDrawing = false, _slLx = 0, _slLy = 0, _slActiveSig = null;
let _slAresTimer = null;

// --- pomocné ---
function slGv(id){ return document.getElementById(id)?.value || ''; }
function slSv(id, v){ const el = document.getElementById(id); if(el) el.value = v; }

// ── Otevřít modal ──────────────────────────────────────────────
function openServiceListModal(id) {
  window._slId = id || null;
  window._slPhotos  = [];
  window._slSigData = {1: null, 2: null};

  // Předvyplň z existující zakázky
  if(id) {
    const z = (window._zakazky || []).find(x => x.id === id);
    if(z) {
      slSv('sl-nazev-inp', z.nazev || '');
      slSv('sl-cislo',     z.cislo || '');
      slSv('sl-zakaznik',  z.zakaznik || '');
      slSv('sl-adresa',    z.adresa || '');
      slSv('sl-ico',       z.ico || '');
      slSv('sl-dic',       z.dic || '');
      slSv('sl-technik',   z.technik || (window._currentUser?.displayName || window._currentUser?.email || ''));
      slSv('sl-termin',    z.termin || '');
      slSv('sl-sd1',       z.sd1 || '');
      slSv('sl-sd2',       z.sd2 || '');
      slSv('sl-prace',     z.prace || '');
      slSv('sl-pozn',      z.pozn || '');
      slSv('sl-komentar',  z.komentar || '');
      slSv('sl-duzp',      z.duzp || '');

      // Položky (rows)
      const rows = z.rows || [];
      for(let i = 1; i <= 8; i++) {
        const r = rows[i-1] || {};
        slSv('sl-pol'+i, r.pol || '');
        slSv('sl-poc'+i, r.poc || '');
        slSv('sl-cen'+i, r.cen || '');
        slSv('sl-cel'+i, r.cel || '');
      }
      // Ext (cestovné)
      const exts = z.exts || [];
      for(let i = 1; i <= 3; i++) {
        const e = exts[i-1] || {};
        slSv('sl-elab'+i, e.label || EXT_LABELS[i-1]);
        slSv('sl-epoc'+i, e.poc || '');
        slSv('sl-ecen'+i, e.cen || '');
        slSv('sl-ecel'+i, e.cel || '');
      }
      slCalcFromZ(z);

      // Fotky z zakázky
      if(z.photos && z.photos.length) {
        window._slPhotos = z.photos.map(p => ({
          dataUrl: p.cloudUrl || p.dataUrl || '',
          name:    p.name || '',
          caption: p.caption || '',
          printInclude: p.printInclude !== false
        }));
        slRenderPhotos();
      }

      // Firma
      slSetFirma(z.firma || 'aceuro');
    }
  } else {
    // Nový list — reset polí
    ['sl-nazev-inp','sl-cislo','sl-zakaznik','sl-adresa','sl-ico','sl-dic',
     'sl-termin','sl-sd1','sl-sd2','sl-prace','sl-pozn','sl-komentar','sl-duzp'].forEach(id => slSv(id,''));
    for(let i=1;i<=8;i++){slSv('sl-pol'+i,'');slSv('sl-poc'+i,'');slSv('sl-cen'+i,'');slSv('sl-cel'+i,'');}
    for(let i=1;i<=3;i++){slSv('sl-elab'+i,EXT_LABELS[i-1]);slSv('sl-epoc'+i,'');slSv('sl-ecen'+i,'');slSv('sl-ecel'+i,'');}
    slSv('sl-technik', window._currentUser?.displayName || window._currentUser?.email || '');
    slSetFirma('aceuro');
    document.getElementById('sl-total').textContent = '—';
    slRenderPhotos();
  }

  document.getElementById('sl-modal').classList.add('open');
  slGoTo(0);
  slSetupCanvases();
}

function closeServiceListModal() {
  document.getElementById('sl-modal').classList.remove('open');
  window._slStep = 0;
}

// ── Navigace ──────────────────────────────────────────────────
function slGoTo(n) {
  const MAX = 6;
  n = Math.max(0, Math.min(MAX, n));
  window._slStep = n;

  document.querySelectorAll('.sl-panel').forEach((p, i) => {
    p.classList.toggle('sl-active', i === n);
  });
  document.querySelectorAll('.sl-dot').forEach((dot, i) => {
    dot.classList.toggle('sl-dot-active', i === n);
    dot.classList.toggle('sl-dot-done', i < n);
  });

  const prev = document.getElementById('sl-btn-prev');
  const next = document.getElementById('sl-btn-next');
  const label = document.getElementById('sl-step-label');

  if(prev) prev.style.visibility = n === 0 ? 'hidden' : 'visible';
  if(label) label.textContent = `Krok ${n+1} z ${MAX+1}`;
  if(next) {
    if(n === MAX) {
      next.textContent = '✓ Hotovo';
      next.onclick = () => closeServiceListModal();
    } else {
      next.textContent = 'Pokračovat →';
      next.onclick = () => slGoTo(window._slStep + 1);
    }
  }

  // Při přechodu na krok 6 připrav souhrn
  if(n === MAX) slBuildSummary();

  // Přejdi nahoru
  const body = document.getElementById('sl-modal');
  if(body) body.scrollTop = 0;
}

// ── Volba firmy ───────────────────────────────────────────────
function slSetFirma(firma) {
  window._slFirma = firma;
  const btnA = document.getElementById('sl-btn-aceuro');
  const btnP = document.getElementById('sl-btn-progres');
  const dot  = document.getElementById('sl-brand-dot');
  if(btnA) {
    btnA.style.borderColor  = firma === 'aceuro' ? '#6abf3e' : '#d0d8e8';
    btnA.style.background   = firma === 'aceuro' ? '#f0fff4' : '#fff';
    btnA.style.color        = firma === 'aceuro' ? '#0f1f3d' : '#6b7a99';
  }
  if(btnP) {
    btnP.style.borderColor  = firma === 'progres' ? '#1e90ff' : '#d0d8e8';
    btnP.style.background   = firma === 'progres' ? '#eff6ff' : '#fff';
    btnP.style.color        = firma === 'progres' ? '#0a3d8f' : '#6b7a99';
  }
  if(dot) dot.style.background = firma === 'progres' ? '#1e90ff' : '#6abf3e';
}

// ── ARES (pro sl-zakaznik) ───────────────────────────────────
function slAresDebounce(val) {
  clearTimeout(_slAresTimer);
  if(val.length < 2) { const dd=document.getElementById('sl-ares-dd'); if(dd)dd.style.display='none'; return; }
  _slAresTimer = setTimeout(() => slAresSearch(val), 400);
}

async function slAresSearch(query) {
  const dd = document.getElementById('sl-ares-dd');
  if(!dd) return;
  dd.innerHTML = '<div style="padding:8px 12px;font-size:12px;color:#6b7a99">🔍 Hledám…</div>';
  dd.style.display = 'block';
  try {
    const isICO = /^\d{6,8}$/.test(query.trim());
    const url = isICO
      ? `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${query.trim()}`
      : `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty-vr?nazev=${encodeURIComponent(query)}&pocet=8`;
    const res = await fetch(url);
    if(!res.ok) throw new Error();
    const data = await res.json();
    const items = isICO && data.ico ? [data] : (data.ekonomickeSubjekty || []);
    if(!items.length) {
      dd.innerHTML = '<div style="padding:8px 12px;font-size:12px;color:#6b7a99">Nic nenalezeno</div>';
    } else {
      dd.innerHTML = items.map(s => {
        const ico = s.ico || '', nazev = s.obchodniJmeno || s.nazev || '';
        const adr = slFmtAresAddr(s);
        const dic = s.dic || '';
        return `<div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7"
          onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background=''"
          onclick='slAresSelect(${JSON.stringify({ico,nazev,adresa:adr,dic})})'>
          <div style="font-size:13px;font-weight:600;color:#1a2540">${esc(nazev)}</div>
          <div style="font-size:11px;color:#6b7a99">IČO: ${ico}${adr?' · '+adr:''}</div>
        </div>`;
      }).join('');
    }
  } catch(e) {
    dd.innerHTML = '<div style="padding:8px 12px;font-size:12px;color:#6b7a99">ARES nedostupný</div>';
  }
}

function slFmtAresAddr(s) {
  const a = s.sidlo || {};
  return [a.nazevUlice||'', a.cisloDomovni||'', (a.psc||'').replace(/(\d{3})(\d{2})/,'$1 $2'), a.nazevObce||''].filter(Boolean).join(' ');
}

function slAresSelect(obj) {
  slSv('sl-zakaznik', obj.nazev);
  slSv('sl-adresa', obj.adresa);
  slSv('sl-ico', obj.ico);
  slSv('sl-dic', obj.dic);
  const dd = document.getElementById('sl-ares-dd');
  if(dd) dd.style.display = 'none';
}

// Zavři ARES dropdown při kliku mimo
document.addEventListener('click', e => {
  if(!e.target.closest('#sl-ares-dd') && !e.target.matches('#sl-zakaznik')) {
    const dd = document.getElementById('sl-ares-dd');
    if(dd) dd.style.display = 'none';
  }
});

// ── Kalkulace cen ─────────────────────────────────────────────
function slCalc() {
  let total = 0;
  for(let i=1;i<=8;i++){
    const poc = parseFloat(document.getElementById('sl-poc'+i)?.value||0)||0;
    const cen = parseFloat(document.getElementById('sl-cen'+i)?.value||0)||0;
    const cel = poc && cen ? +(poc*cen).toFixed(2) : 0;
    const el = document.getElementById('sl-cel'+i);
    if(el) el.value = cel || '';
    total += cel;
  }
  for(let i=1;i<=3;i++){
    const poc = parseFloat(document.getElementById('sl-epoc'+i)?.value||0)||0;
    const cen = parseFloat(document.getElementById('sl-ecen'+i)?.value||0)||0;
    const cel = poc && cen ? +(poc*cen).toFixed(2) : 0;
    const el = document.getElementById('sl-ecel'+i);
    if(el) el.value = cel || '';
    total += cel;
  }
  const el = document.getElementById('sl-total');
  if(el) el.textContent = total ? total.toFixed(2) + ' Kč' : '—';
}

function slCalcFromZ(z) {
  // Přepočítej ze zakázky (pro případ že nemáme DOM ještě)
  let total = 0;
  (z.rows||[]).forEach(r => { const c = parseFloat(r.cel)||0; total += c; });
  (z.exts||[]).forEach(e => { const c = parseFloat(e.cel)||0; total += c; });
  const el = document.getElementById('sl-total');
  if(el) el.textContent = z.cena || (total ? total.toFixed(2)+' Kč' : '—');
}

// ── Fotky ─────────────────────────────────────────────────────
function slAddPhotos(files) {
  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      window._slPhotos.push({dataUrl: e.target.result, name: file.name, caption: '', printInclude: true});
      slRenderPhotos();
    };
    reader.readAsDataURL(file);
  });
}

function slHandleDrop(e) {
  e.preventDefault();
  const files = [...(e.dataTransfer?.files||[])].filter(f => f.type.startsWith('image/'));
  slAddPhotos(files);
}

function slRenderPhotos() {
  const grid = document.getElementById('sl-photos-grid');
  if(!grid) return;
  if(!window._slPhotos.length) { grid.innerHTML = ''; return; }
  grid.innerHTML = window._slPhotos.map((p,i) => `
    <div style="border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff">
      <div style="position:relative;aspect-ratio:4/3;overflow:hidden">
        <img src="${p.dataUrl}" style="width:100%;height:100%;object-fit:cover;display:block">
        <button onclick="slRemovePhoto(${i})"
          style="position:absolute;top:4px;right:4px;background:rgba(0,0,0,.55);border:none;color:#fff;border-radius:50%;width:22px;height:22px;font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1">×</button>
      </div>
      <div style="padding:5px 8px;background:#fafbfc;border-top:1px solid #f0f2f6">
        <input value="${esc(p.caption)}" placeholder="Popis…"
          style="width:100%;border:none;outline:none;font-size:10.5px;font-family:inherit;background:transparent"
          onchange="slPhotoCaption(${i},this.value)">
        <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);margin-top:2px;cursor:pointer">
          <input type="checkbox" ${p.printInclude?'checked':''} onchange="slPhotoToggle(${i},this.checked)" style="width:11px;height:11px">
          Tisknout
        </label>
      </div>
    </div>`).join('');
}

function slRemovePhoto(i)  { window._slPhotos.splice(i,1); slRenderPhotos(); }
function slPhotoCaption(i,v){ window._slPhotos[i].caption = v; }
function slPhotoToggle(i,v) { window._slPhotos[i].printInclude = v; }

// ── Podpisy ───────────────────────────────────────────────────
function slSetupCanvases() {
  [1,2].forEach(idx => {
    const canvas = document.getElementById('sl-sig'+idx);
    if(!canvas) return;
    // Nastav rozměry na skutečnou velikost
    setTimeout(() => {
      canvas.width  = canvas.offsetWidth  || 300;
      canvas.height = canvas.offsetHeight || 150;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Překresli existující podpis
      if(window._slSigData[idx]) {
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = window._slSigData[idx];
      }
      slBindCanvas(canvas, idx);
    }, 100);
  });
}

function slBindCanvas(canvas, idx) {
  let drawing = false, lx = 0, ly = 0;
  function pos(e) {
    const r = canvas.getBoundingClientRect();
    const sx = canvas.width/r.width, sy = canvas.height/r.height;
    if(e.touches) return {x:(e.touches[0].clientX-r.left)*sx, y:(e.touches[0].clientY-r.top)*sy};
    return {x:(e.clientX-r.left)*sx, y:(e.clientY-r.top)*sy};
  }
  canvas.onmousedown = canvas.ontouchstart = e => {
    e.preventDefault(); drawing = true;
    const p = pos(e); lx = p.x; ly = p.y;
  };
  canvas.onmousemove = canvas.ontouchmove = e => {
    if(!drawing) return; e.preventDefault();
    const ctx = canvas.getContext('2d');
    const p = pos(e);
    ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(p.x,p.y);
    ctx.strokeStyle='#0f1f3d'; ctx.lineWidth=2; ctx.lineCap='round'; ctx.stroke();
    lx = p.x; ly = p.y;
  };
  canvas.onmouseup = canvas.ontouchend = canvas.onmouseleave = () => {
    if(drawing) {
      drawing = false;
      window._slSigData[idx] = canvas.toDataURL();
    }
  };
}

function slClearSig(idx) {
  window._slSigData[idx] = null;
  const canvas = document.getElementById('sl-sig'+idx);
  if(canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}

// ── Vstup na krok 5 — inicializuj canvasy ──────────────────
// (přepíšeme slGoTo aby zavolal setup při kroku 5)
const _slGoToOrig = slGoTo;
// (setup se volá přes setTimeout v slSetupCanvases, voláme při openModal)

// ── Souhrn (krok 6) ────────────────────────────────────────
function slBuildSummary() {
  const el = document.getElementById('sl-summary');
  if(!el) return;
  const firma = (FIRMA_DATA || {})[window._slFirma] || {};
  const rows = [];
  for(let i=1;i<=8;i++){
    const pol=slGv('sl-pol'+i);
    if(pol) rows.push({pol,poc:slGv('sl-poc'+i),cel:slGv('sl-cel'+i)});
  }
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px 20px;font-size:12px">
      <div><span style="color:var(--muted)">Firma:</span> <strong>${esc(firma.name||'—')}</strong></div>
      <div><span style="color:var(--muted)">Zákazník:</span> <strong>${esc(slGv('sl-zakaznik')||'—')}</strong></div>
      <div><span style="color:var(--muted)">Zakázka:</span> <strong>${esc(slGv('sl-nazev-inp')||'—')}</strong></div>
      <div><span style="color:var(--muted)">Technik:</span> <strong>${esc(slGv('sl-technik')||'—')}</strong></div>
      <div><span style="color:var(--muted)">Datum zahájení:</span> <strong>${fmtD(slGv('sl-sd1'))||'—'}</strong></div>
      <div><span style="color:var(--muted)">Datum ukončení:</span> <strong>${fmtD(slGv('sl-sd2'))||'—'}</strong></div>
      <div><span style="color:var(--muted)">Celkem bez DPH:</span> <strong style="color:#6abf3e">${document.getElementById('sl-total')?.textContent||'—'}</strong></div>
      <div><span style="color:var(--muted)">Fotografie:</span> <strong>${window._slPhotos.length} ks</strong></div>
      <div><span style="color:var(--muted)">Podpis technika:</span> <strong>${window._slSigData[1]?'✓ Podepsáno':'—'}</strong></div>
      <div><span style="color:var(--muted)">Podpis zákazníka:</span> <strong>${window._slSigData[2]?'✓ Podepsáno':'—'}</strong></div>
    </div>
    ${rows.length ? `<div style="margin-top:10px;font-size:11px;color:var(--muted)">${rows.length} položek</div>` : ''}
  `;
}

// ── Sestavení dat pro buildPrintView ──────────────────────────
function slGetData() {
  const rows = [];
  for(let i=1;i<=8;i++) rows.push({
    pol: slGv('sl-pol'+i), poc: slGv('sl-poc'+i),
    cen: slGv('sl-cen'+i), cel: slGv('sl-cel'+i)
  });
  const exts = [];
  for(let i=1;i<=3;i++) exts.push({
    label: slGv('sl-elab'+i)||EXT_LABELS[i-1],
    poc: slGv('sl-epoc'+i), cen: slGv('sl-ecen'+i), cel: slGv('sl-ecel'+i)
  });
  const inclPhotos = document.getElementById('sl-print-photos')?.checked || false;
  return {
    nazev:    slGv('sl-nazev-inp'),
    cislo:    slGv('sl-cislo'),
    zakaznik: slGv('sl-zakaznik'),
    adresa:   slGv('sl-adresa'),
    ico:      slGv('sl-ico'),
    dic:      slGv('sl-dic'),
    technik:  slGv('sl-technik'),
    termin:   slGv('sl-termin'),
    sd1:      fmtD(slGv('sl-sd1')),
    sd2:      fmtD(slGv('sl-sd2')),
    prace:    slGv('sl-prace'),
    pozn:     slGv('sl-pozn'),
    duzp:     slGv('sl-duzp'),
    firma:    window._slFirma,
    rows, exts,
    cena:     document.getElementById('sl-total')?.textContent || '',
    sig1:     window._slSigData[1] || '',
    sig2:     window._slSigData[2] || '',
    photos:   window._slPhotos,
    showPrices:   true,
    includePhotos: inclPhotos
  };
}

// ── Tisk ──────────────────────────────────────────────────────
function slPrint() {
  const data = slGetData();
  const pv = buildPrintView(data);
  const pc = document.getElementById('print-container');
  pc.innerHTML = ''; pc.appendChild(pv);
  setTimeout(() => window.print(), 300);
}

// ── Uložit do zakázky a tisknout ─────────────────────────────
async function slSaveAndPrint() {
  const data = slGetData();
  const statusEl = document.getElementById('sl-save-status');
  if(statusEl) statusEl.textContent = '⏳ Ukládám…';

  if(window._slId) {
    // Aktualizuj existující zakázku
    try {
      const patch = {
        prace:    data.prace,
        pozn:     data.pozn,
        rows:     data.rows,
        exts:     data.exts,
        cena:     data.cena,
        duzp:     data.duzp,
        sd1:      slGv('sl-sd1'),
        sd2:      slGv('sl-sd2'),
        sig1:     data.sig1,
        sig2:     data.sig2,
        updatedAt: window._fb.serverTimestamp()
      };
      // Přidej fotky pouze pokud jsou nové (lokální dataUrl)
      const newPhotos = window._slPhotos.filter(p => p.dataUrl.startsWith('data:'));
      if(newPhotos.length) patch.photos = window._slPhotos;

      await window._fb.updateDoc(
        window._fb.doc(window._fb.db, 'zakazky', window._slId), patch
      );
      if(statusEl) statusEl.textContent = '✓ Uloženo';
    } catch(e) {
      if(statusEl) statusEl.textContent = '⚠ Chyba uložení: ' + e.message;
    }
  }

  slPrint();
}

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  SERVISNÍ LIST — autocomplete pro Zákazník a Technik
// ════════════════════════════════════════════════════════════════

// ── Helpers ───────────────────────────────────────────────────
function slShowDd(ddId, items, onSelect) {
  const dd = document.getElementById(ddId);
  if(!dd) return;
  if(!items.length) { dd.style.display = 'none'; return; }
  dd.innerHTML = items.map(item => `
    <div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7;font-size:13px"
      onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background=''"
      onclick="(${onSelect.toString()})(${JSON.stringify(item)})">
      ${item.html || esc(item.label)}
    </div>`).join('');
  dd.style.display = 'block';
}

function slHideDd(ddId) {
  const dd = document.getElementById(ddId);
  if(dd) dd.style.display = 'none';
}

// Zavři dropdowny při kliku mimo
document.addEventListener('click', e => {
  if(!e.target.closest('#sl-technik-dd') && !e.target.matches('#sl-technik'))
    slHideDd('sl-technik-dd');
  if(!e.target.closest('#sl-ares-dd') && !e.target.matches('#sl-zakaznik'))
    slHideDd('sl-ares-dd');
});

// ── TECHNIK autocomplete ──────────────────────────────────────
// Čerpá z window._techList (Firestore users) + unikátní jména z zakázek

function slGetTechnikList() {
  // Z Firestore users list (načteno v loadTechList)
  const fromUsers = (window._techList || []).map(u => ({
    label: u.name || u.email || u.uid,
    sub:   u.email || '',
    uid:   u.uid
  }));
  // Záloha z existujících zakázek (pokud _techList prázdný)
  const fromZak = [...new Set(
    (window._zakazky || []).map(z => z.technik || '').filter(Boolean)
  )].map(n => ({ label: n, sub: '' }));
  // Sloučit — preferovat Firestore
  const names = new Set(fromUsers.map(u => u.label));
  const extra = fromZak.filter(u => !names.has(u.label));
  return [...fromUsers, ...extra];
}

function slTechnikInput(val) {
  const list = slGetTechnikList();
  const q = (val || '').toLowerCase().trim();
  const filtered = q
    ? list.filter(u => u.label.toLowerCase().includes(q) || u.sub.toLowerCase().includes(q))
    : list;
  if(!filtered.length) { slHideDd('sl-technik-dd'); return; }
  const items = filtered.slice(0, 10).map(u => ({
    label: u.label,
    html: `<span style="font-weight:600;color:#1a2540">${esc(u.label)}</span>` +
          (u.sub ? `<br><span style="font-size:11px;color:#6b7a99">${esc(u.sub)}</span>` : '')
  }));
  // Při kliku vyplníme pole a zavřeme dropdown
  const dd = document.getElementById('sl-technik-dd');
  if(!dd) return;
  dd.innerHTML = filtered.slice(0, 10).map(u => `
    <div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7"
      onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background=''"
      onclick="slTechnikSelect(${JSON.stringify(u.label)})">
      <span style="font-weight:600;color:#1a2540">${esc(u.label)}</span>
      ${u.sub ? `<br><span style="font-size:11px;color:#6b7a99">${esc(u.sub)}</span>` : ''}
    </div>`).join('');
  dd.style.display = 'block';
}

function slTechnikSelect(name) {
  document.getElementById('sl-technik').value = name;
  slHideDd('sl-technik-dd');
}

// ── ZÁKAZNÍK autocomplete (history + ARES) ────────────────────

let _slZakTimer = null;

function slZakaznikInput(val) {
  clearTimeout(_slZakTimer);
  const q = (val || '').trim();

  // Okamžitě ukáž historické návrhy
  slShowZakHistory(q);

  // Po 500ms spusť ARES pokud zadáno dost znaků
  if(q.length >= 2) {
    _slZakTimer = setTimeout(() => slAresSearch(q), 500);
  }
}

function slShowZakHistory(q) {
  const dd = document.getElementById('sl-ares-dd');
  if(!dd) return;

  // Unikátní zákazníci ze zakázek
  const all = [...new Map(
    (window._zakazky || [])
      .filter(z => z.zakaznik)
      .map(z => [z.zakaznik, {
        nazev:  z.zakaznik,
        adresa: z.adresa || '',
        ico:    z.ico    || '',
        dic:    z.dic    || ''
      }])
  ).values()];

  const ql = q.toLowerCase();
  const filtered = q
    ? all.filter(z => z.nazev.toLowerCase().includes(ql) || z.ico.includes(ql))
    : all;

  if(!filtered.length) {
    // Nic v historii — počkáme na ARES nebo skryjeme
    if(!q) { dd.style.display = 'none'; }
    return;
  }

  dd.innerHTML =
    `<div style="padding:5px 12px 3px;font-size:10px;font-weight:700;color:#6b7a99;text-transform:uppercase;letter-spacing:.07em;background:#f8fafc;border-bottom:1px solid #f0f2f7">
       📋 Dříve použití zákazníci
     </div>` +
    filtered.slice(0, 8).map(z => `
      <div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7"
        onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background=''"
        onclick='slZakSelect(${JSON.stringify(z)})'>
        <span style="font-weight:600;color:#1a2540">${esc(z.nazev)}</span>
        ${z.ico ? `<br><span style="font-size:11px;color:#6b7a99">IČO: ${esc(z.ico)}${z.adresa?' · '+esc(z.adresa):''}</span>` : ''}
      </div>`).join('');

  dd.style.display = 'block';
}

function slZakSelect(obj) {
  document.getElementById('sl-zakaznik').value = obj.nazev || '';
  if(obj.adresa) document.getElementById('sl-adresa').value  = obj.adresa;
  if(obj.ico)    document.getElementById('sl-ico').value     = obj.ico;
  if(obj.dic)    document.getElementById('sl-dic').value     = obj.dic;
  slHideDd('sl-ares-dd');
}

// Přepíšeme slAresSelect aby taky plnila adresu
function slAresSelect(obj) {
  document.getElementById('sl-zakaznik').value = obj.nazev || '';
  document.getElementById('sl-adresa').value   = obj.adresa || '';
  document.getElementById('sl-ico').value      = obj.ico   || '';
  document.getElementById('sl-dic').value      = obj.dic   || '';
  slHideDd('sl-ares-dd');
}

// Přepíšeme slAresSearch aby zobrazil nadpis sekce pro ARES výsledky
const _slAresSearchOrig = slAresSearch;
slAresSearch = async function(query) {
  const dd = document.getElementById('sl-ares-dd');
  if(!dd) return;

  // Zachovej historické návrhy + přidej loading pro ARES
  const histHtml = dd.innerHTML;
  const aresHeader = `<div style="padding:5px 12px 3px;font-size:10px;font-weight:700;color:#6b7a99;text-transform:uppercase;letter-spacing:.07em;background:#f8fafc;border-bottom:1px solid #f0f2f7;margin-top:2px">
    🔍 Vyhledávání ARES…
  </div>`;
  dd.innerHTML = histHtml + aresHeader;
  dd.style.display = 'block';

  try {
    const isICO = /^\d{6,8}$/.test(query.trim());
    const url = isICO
      ? `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${query.trim()}`
      : `https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty-vr?nazev=${encodeURIComponent(query)}&pocet=6`;
    const res = await fetch(url);
    if(!res.ok) throw new Error();
    const data = await res.json();
    const items = isICO && data.ico ? [data] : (data.ekonomickeSubjekty || []);

    if(!items.length) {
      dd.innerHTML = histHtml; // zpět jen historické
      return;
    }

    const aresHtml =
      `<div style="padding:5px 12px 3px;font-size:10px;font-weight:700;color:#6b7a99;text-transform:uppercase;letter-spacing:.07em;background:#f8fafc;border-bottom:1px solid #f0f2f7;margin-top:2px">
         📡 ARES
       </div>` +
      items.map(s => {
        const ico = s.ico || '', nazev = s.obchodniJmeno || s.nazev || '';
        const adr = slFmtAresAddr(s);
        const dic = s.dic || '';
        return `<div style="padding:9px 12px;cursor:pointer;border-bottom:1px solid #f0f2f7"
          onmouseenter="this.style.background='#eff6ff'" onmouseleave="this.style.background=''"
          onclick='slAresSelect(${JSON.stringify({ico,nazev,adresa:adr,dic})})'>
          <span style="font-weight:600;color:#1a2540">${esc(nazev)}</span>
          <br><span style="font-size:11px;color:#6b7a99">IČO: ${ico}${adr?' · '+adr:''}</span>
        </div>`;
      }).join('');

    dd.innerHTML = histHtml + aresHtml;
    dd.style.display = 'block';
  } catch(e) {
    // ARES selhal — ponech historické návrhy
    dd.innerHTML = histHtml;
  }
};

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE — měsíční přehled, sklad, šablony, chat, 
//  neuhrazené, na cestě, FCM, background sync, history API
// ════════════════════════════════════════════════════════════════

// ══ MĚSÍČNÍ FINANČNÍ PŘEHLED ════════════════════════════════════
let _monthlyFirma = 'all';
let _monthlyChart = null;

function setMonthlyFirma(f) {
  _monthlyFirma = f;
  ['all','aceuro','progres'].forEach(id => {
    const btn = document.getElementById('mf-'+id);
    if(!btn) return;
    const active = id === f;
    btn.style.background  = active ? 'var(--green)' : '#fff';
    btn.style.color       = active ? '#fff' : 'var(--text)';
    btn.style.borderColor = active ? 'var(--green)' : 'var(--border)';
    btn.style.fontWeight  = active ? '700' : '600';
  });
  renderMonthlyChart();
}

function renderMonthlyChart() {
  const canvas = document.getElementById('monthly-chart');
  if(!canvas) return;

  const all = (window._zakazky || []).filter(z => {
    if(_monthlyFirma === 'all') return true;
    return (z.firma || 'aceuro') === _monthlyFirma;
  });

  function parseCena(c){ return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0; }

  // Posledních 12 měsíců
  const now = new Date();
  const months = [];
  for(let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'));
  }

  const revenueByMonth = {};
  const countByMonth = {};
  months.forEach(m => { revenueByMonth[m] = 0; countByMonth[m] = 0; });

  all.forEach(z => {
    const m = (z.termin||'').substring(0,7);
    if(revenueByMonth[m] !== undefined) {
      revenueByMonth[m] += parseCena(z.cena);
      countByMonth[m]++;
    }
  });

  const labels = months.map(m => {
    const [y,mo] = m.split('-');
    const names = ['Led','Úno','Bře','Dub','Kvě','Čvn','Čvc','Srp','Zář','Říj','Lis','Pro'];
    return names[parseInt(mo)-1] + ' ' + y.slice(2);
  });
  const data = months.map(m => revenueByMonth[m]);

  if(_monthlyChart) { _monthlyChart.destroy(); _monthlyChart = null; }

  const ctx = canvas.getContext('2d');
  if(typeof Chart !== 'undefined') {
    _monthlyChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Obrat (Kč)',
          data,
          backgroundColor: months.map((m,i) => i === months.length-1 ? '#6abf3e' : 'rgba(106,191,62,0.45)'),
          borderRadius: 5,
          borderSkipped: false
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: true,
        plugins: { legend: { display: false }, tooltip: {
          callbacks: { label: ctx => ctx.parsed.y.toLocaleString('cs-CZ',{minimumFractionDigits:0}) + ' Kč' }
        }},
        scales: {
          y: { ticks: { callback: v => v >= 1000 ? Math.round(v/1000)+'k' : v }, grid: { color: '#f0f2f6' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  // Tabulka pod grafem
  const table = document.getElementById('monthly-table');
  if(table) {
    const totalRev = data.reduce((a,b) => a+b, 0);
    const totalCnt = months.reduce((s,m) => s+countByMonth[m], 0);
    table.innerHTML = `<div style="display:flex;gap:20px;flex-wrap:wrap;font-size:12px;color:var(--muted);margin-top:4px">
      <span>Celkem <strong style="color:var(--text)">${totalCnt} zakázek</strong></span>
      <span>Obrat celkem <strong style="color:var(--green)">${totalRev.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč</strong></span>
      <span>Průměr/měsíc <strong style="color:var(--text)">${Math.round(totalRev/12).toLocaleString('cs-CZ')} Kč</strong></span>
    </div>`;
  }
}

// ══ NEUHRAZENÉ ZAKÁZKY ══════════════════════════════════════════
function renderUnpaid() {
  const list = document.getElementById('unpaid-list');
  const cnt  = document.getElementById('unpaid-count');
  if(!list) return;

  function parseCena(c){ return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0; }

  const unpaid = (window._zakazky || []).filter(z => {
    const stav = z.stav || 'nová';
    return stav === 'fakturovaná' && stav !== 'zaplacena';
  }).sort((a,b) => (a.termin||'').localeCompare(b.termin||''));

  if(cnt) cnt.textContent = unpaid.length ? `${unpaid.length} zakázek · ${unpaid.reduce((s,z)=>s+parseCena(z.cena),0).toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč` : 'vše zaplaceno';

  if(!unpaid.length) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">✅ Všechny fakturované zakázky jsou zaplaceny</div>';
    return;
  }
  list.innerHTML = unpaid.map(z => {
    const dueDate = z.duzp || z.termin || '';
    const isOverdue = dueDate && dueDate < new Date().toISOString().slice(0,10);
    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid ${isOverdue?'#fca5a5':'var(--border)'};border-radius:8px;margin-bottom:8px;background:${isOverdue?'#fff5f5':'#fff'};cursor:pointer"
      onclick="switchTab('orders');setTimeout(()=>openDetail('${z.id}'),50)">
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px;color:var(--navy)">${esc(z.nazev||'—')}</div>
        <div style="font-size:11px;color:var(--muted)">${esc(z.zakaznik||'—')} · ${fmtD(dueDate)||'bez data'}</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-weight:700;font-size:13px;color:${isOverdue?'#dc2626':'var(--text)'};font-family:'DM Mono',monospace">${z.cena||'—'}</div>
        ${isOverdue?'<div style="font-size:10px;color:#dc2626;font-weight:700">PO SPLATNOSTI</div>':''}
      </div>
      <button onclick="event.stopPropagation();markZaplacena('${z.id}')" 
        style="flex-shrink:0;padding:5px 10px;background:#d1fae5;color:#065f46;border:1px solid #6ee7b7;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap">
        💰 Zaplacena
      </button>
    </div>`;
  }).join('');
}

function markZaplacena(id) {
  if(!confirm('Označit zakázku jako zaplacenou?')) return;
  window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id),
    {stav:'zaplacena', zaplacenoDne: new Date().toISOString().slice(0,10), updatedAt: window._fb.serverTimestamp()}
  ).catch(e => alert('Chyba: '+e.message));
}

// Napojení na renderDashboard
const _renderDashboardOrig = renderDashboard;
renderDashboard = function() {
  _renderDashboardOrig();
  renderMonthlyChart();
  renderUnpaid();
};

// ══ TECHNIK — Na cestě, techUpdateStav ═══════════════════════
function techUpdateStav(id, currentStav) {
  const newStav = currentStav === 'na cestě' ? 'zpracovaná' : 'na cestě';
  const updates = {stav: newStav, updatedAt: window._fb.serverTimestamp()};
  // Pokud technik odjíždí, zaznamenej polohu
  if(newStav === 'na cestě' && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      updates.techLat = pos.coords.latitude;
      updates.techLng = pos.coords.longitude;
      updates.techPolohaTs = new Date().toISOString();
    }, ()=>{});
  }
  window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id), updates)
  .then(() => {
    const z = (_assignedZakazky||[]).find(x=>x.id===id);
    if(z) z.stav = newStav;
    renderAssignedPanel && renderAssignedPanel();
    // SMS zákazníkovi při "Na cestě"
    if(newStav === 'na cestě') sendSmsZakaznikovi(z||{id});
  }).catch(e => alert('Chyba: '+e.message));
}

// ══ CHAT / KOMENTÁŘE ════════════════════════════════════════════
// Realtime listener pro komentáře
const _chatUnsubs = {};

function loadChatMessages(zakazkaId) {
  const container = document.getElementById('chat-messages-'+zakazkaId);
  if(!container) return;

  // Unsubscribe předchozí
  if(_chatUnsubs[zakazkaId]) { _chatUnsubs[zakazkaId](); delete _chatUnsubs[zakazkaId]; }

  _chatUnsubs[zakazkaId] = window._fb.onSnapshot(
    window._fb.query(
      window._fb.collection(window._fb.db, 'zakazky/'+zakazkaId+'/chat'),
      window._fb.orderBy('createdAt','asc')
    ),
    snap => renderChatMessages(zakazkaId, snap.docs.map(d=>({id:d.id,...d.data()})))
  );
}

function renderChatMessages(zakazkaId, msgs) {
  const container = document.getElementById('chat-messages-'+zakazkaId);
  if(!container) return;
  const me = window._currentUser;

  if(!msgs.length) {
    container.innerHTML = '<div style="font-size:12px;color:var(--muted);font-style:italic;text-align:center;padding:8px">Zatím žádné zprávy</div>';
    return;
  }

  container.innerHTML = msgs.map(m => {
    const isMine = m.uid === me?.uid;
    const time = m.createdAt ? fmtTS(m.createdAt) : '';
    return `<div style="display:flex;flex-direction:column;align-items:${isMine?'flex-end':'flex-start'}">
      <div style="max-width:75%;background:${isMine?'#1d4ed8':'#f1f5f9'};color:${isMine?'#fff':'var(--text)'};padding:8px 11px;border-radius:${isMine?'12px 4px 12px 12px':'4px 12px 12px 12px'};font-size:12px;line-height:1.5;word-break:break-word">
        ${esc(m.text)}
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:2px">${esc(m.author||'')} · ${time}</div>
    </div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

async function sendChatMsg(zakazkaId) {
  const inp = document.getElementById('chat-inp-'+zakazkaId);
  if(!inp) return;
  const text = inp.value.trim();
  if(!text) return;
  const me = window._currentUser;
  inp.value = '';
  try {
    await window._fb.addDoc(
      window._fb.collection(window._fb.db, 'zakazky/'+zakazkaId+'/chat'),
      {
        text, uid: me.uid,
        author: me.displayName || me.email || 'Uživatel',
        role: window._currentRole || 'kancelar',
        createdAt: window._fb.serverTimestamp()
      }
    );
  } catch(e) { inp.value = text; alert('Nepodařilo se odeslat: '+e.message); }
}

// Napojení na openDetail — spusť chat listener
const _openDetailOrig = openDetail;
openDetail = function(id) {
  _openDetailOrig(id);
  // Po vyrenderování detailu spusť chat
  setTimeout(() => loadChatMessages(id), 200);
};

// ══ SKLAD ════════════════════════════════════════════════════════
let _skladItems = [];
let _skladUnsub = null;

function loadSklad() {
  if(_skladUnsub) return;
  _skladUnsub = window._fb.onSnapshot(
    window._fb.query(window._fb.collection(window._fb.db,'sklad'), window._fb.orderBy('nazev','asc')),
    snap => {
      _skladItems = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderSklad();
      updateSkladKatFilter();
    }
  );
}

function renderSklad() {
  const q = (document.getElementById('sklad-search')?.value||'').toLowerCase();
  const cat = document.getElementById('sklad-filter-cat')?.value||'';
  const tbody = document.getElementById('sklad-tbody');
  const empty = document.getElementById('sklad-empty');
  if(!tbody) return;

  const filtered = _skladItems.filter(i => {
    if(cat && i.kategorie !== cat) return false;
    if(q && !(i.nazev||'').toLowerCase().includes(q) && !(i.kod||'').toLowerCase().includes(q)) return false;
    return true;
  });

  if(!filtered.length) {
    tbody.innerHTML = '';
    if(empty) empty.style.display = 'block';
    return;
  }
  if(empty) empty.style.display = 'none';

  tbody.innerHTML = filtered.map(item => {
    const low = item.qty <= (item.minQty||0);
    return `<tr style="border-bottom:1px solid var(--border);${low?'background:#fff9f0':''}">
      <td style="padding:10px 12px">
        <div style="font-weight:600;font-size:13px;color:var(--navy)">${esc(item.nazev||'—')}</div>
        ${item.kod?`<div style="font-size:10px;color:var(--muted)">${esc(item.kod)}</div>`:''}
      </td>
      <td style="padding:10px 12px;font-size:12px;color:var(--muted)">${esc(item.kategorie||'—')}</td>
      <td style="text-align:center;padding:10px 12px">
        <span style="font-weight:700;font-size:14px;color:${low?'#dc2626':'var(--text)'}">${item.qty||0}</span>
        ${low?'<div style="font-size:10px;color:#dc2626;font-weight:600">↓ MIN</div>':''}
      </td>
      <td style="text-align:center;padding:10px 12px;font-size:12px;color:var(--muted)">${item.minQty||0}</td>
      <td style="text-align:right;padding:10px 12px;font-weight:600;font-family:\'DM Mono\',monospace;font-size:12px;color:var(--green)">${item.cenaks?item.cenaks.toLocaleString('cs-CZ',{maximumFractionDigits:2})+' Kč':'-'}</td>
      <td style="padding:8px 12px;text-align:right">
        <button onclick="openSkladModal('${item.id}')" style="font-size:11px;padding:4px 9px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;margin-right:4px">✎</button>
        <button onclick="adjustQty('${item.id}',${item.qty||0})" style="font-size:11px;padding:4px 9px;border:1px solid #93c5fd;border-radius:6px;background:#eff6ff;cursor:pointer;color:#1d4ed8">+/−</button>
      </td>
    </tr>`;
  }).join('');
}

function updateSkladKatFilter() {
  const sel = document.getElementById('sklad-filter-cat');
  if(!sel) return;
  const cats = [...new Set(_skladItems.map(i=>i.kategorie||'').filter(Boolean))].sort();
  const cur = sel.value;
  sel.innerHTML = '<option value="">Všechny kategorie</option>' + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  sel.value = cur;
  // Aktualizuj datalist v modalu
  const dl = document.getElementById('sklad-kat-list');
  if(dl) dl.innerHTML = cats.map(c=>`<option value="${esc(c)}">`).join('');
}

function openSkladModal(id) {
  const el = id ? _skladItems.find(i=>i.id===id) : null;
  document.getElementById('sklad-edit-id').value = id||'';
  document.getElementById('sklad-modal-title').textContent = id ? 'Upravit položku' : 'Přidat položku skladu';
  document.getElementById('sklad-nazev').value = el?.nazev||'';
  document.getElementById('sklad-kat').value   = el?.kategorie||'';
  document.getElementById('sklad-kod').value   = el?.kod||'';
  document.getElementById('sklad-qty').value   = el?.qty||0;
  document.getElementById('sklad-min').value   = el?.minQty||0;
  document.getElementById('sklad-cena').value  = el?.cenaks||'';
  document.getElementById('sklad-pozn').value  = el?.pozn||'';
  document.getElementById('sklad-modal').classList.add('open');
}

async function saveSkladItem() {
  const id   = document.getElementById('sklad-edit-id').value;
  const nazev = document.getElementById('sklad-nazev').value.trim();
  if(!nazev) { alert('Zadejte název položky'); return; }
  const data = {
    nazev,
    kategorie: document.getElementById('sklad-kat').value.trim(),
    kod:       document.getElementById('sklad-kod').value.trim(),
    qty:       parseInt(document.getElementById('sklad-qty').value)||0,
    minQty:    parseInt(document.getElementById('sklad-min').value)||0,
    cenaks:    parseFloat(document.getElementById('sklad-cena').value)||0,
    pozn:      document.getElementById('sklad-pozn').value.trim(),
    updatedAt: window._fb.serverTimestamp()
  };
  try {
    if(id) {
      await window._fb.updateDoc(window._fb.doc(window._fb.db,'sklad',id), data);
    } else {
      data.createdAt = window._fb.serverTimestamp();
      await window._fb.addDoc(window._fb.collection(window._fb.db,'sklad'), data);
    }
    closeModal('sklad-modal');
  } catch(e) { alert('Chyba: '+e.message); }
}

function adjustQty(id, current) {
  const delta = parseInt(prompt(`Upravit množství (aktuálně: ${current})\nZadejte změnu (kladné = přidat, záporné = odebrat):`));
  if(isNaN(delta)) return;
  const newQty = Math.max(0, current + delta);
  window._fb.updateDoc(window._fb.doc(window._fb.db,'sklad',id),
    {qty: newQty, updatedAt: window._fb.serverTimestamp()}
  ).catch(e => alert('Chyba: '+e.message));
}

// Spusť sklad při přepnutí na tab
const _switchTabOrig = typeof switchTab !== 'undefined' ? switchTab : null;

// ══ ŠABLONY ══════════════════════════════════════════════════════
let _sablony = [];
let _sablonyUnsub = null;

function loadSablony() {
  if(_sablonyUnsub) return;
  _sablonyUnsub = window._fb.onSnapshot(
    window._fb.query(window._fb.collection(window._fb.db,'sablony'), window._fb.orderBy('nazev','asc')),
    snap => {
      _sablony = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderSablony();
    }
  );
}

function renderSablony() {
  const grid = document.getElementById('sablony-grid');
  const empty = document.getElementById('sablony-empty');
  if(!grid) return;
  if(!_sablony.length) {
    grid.innerHTML = '';
    if(empty) empty.style.display = 'block';
    return;
  }
  if(empty) empty.style.display = 'none';
  const firmaNames = {aceuro:'AC EURO',progres:'Progresklima'};
  grid.innerHTML = _sablony.map(s => `
    <div style="background:#fff;border:1.5px solid var(--border);border-radius:12px;padding:16px;display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
        <div>
          <div style="font-weight:700;font-size:14px;color:var(--navy)">${esc(s.nazev||'—')}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">${esc(firmaNames[s.firma]||'AC EURO')}${s.typ?' · '+esc(s.typ):''}</div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button onclick="openSablonaModal('${s.id}')" style="padding:4px 8px;border:1px solid var(--border);border-radius:6px;font-size:11px;cursor:pointer;background:#fff">✎</button>
          <button onclick="deleteSablona('${s.id}')" style="padding:4px 8px;border:1px solid #fecaca;border-radius:6px;font-size:11px;cursor:pointer;background:#fff5f5;color:#dc2626">🗑</button>
        </div>
      </div>
      ${s.prace?`<div style="font-size:12px;color:var(--muted);line-height:1.4;max-height:48px;overflow:hidden;text-overflow:ellipsis">${esc(s.prace.substring(0,120))}${s.prace.length>120?'…':''}</div>`:''}
      ${s.interval?`<div style="font-size:11px;color:var(--blue);font-weight:600">🔄 Každých ${s.interval} dní</div>`:''}
      <button onclick="createFromSablona('${s.id}')" class="btn btn-green" style="margin-top:4px;font-size:12px;display:flex;align-items:center;justify-content:center;gap:5px">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Vytvořit zakázku z šablony
      </button>
    </div>`).join('');
}

function openSablonaModal(id) {
  const s = id ? _sablony.find(x=>x.id===id) : null;
  document.getElementById('sablona-edit-id').value = id||'';
  document.getElementById('sablona-modal-title').textContent = id ? 'Upravit šablonu' : 'Nová šablona zakázky';
  document.getElementById('sab-nazev').value    = s?.nazev||'';
  document.getElementById('sab-typ').value      = s?.typ||'';
  document.getElementById('sab-firma').value    = s?.firma||'aceuro';
  document.getElementById('sab-prace').value    = s?.prace||'';
  document.getElementById('sab-zadani').value   = s?.zadani||'';
  document.getElementById('sab-interval').value = s?.interval||'';
  const rows = s?.rows||[];
  for(let i=1;i<=4;i++){
    const r = rows[i-1]||{};
    document.getElementById('sab-pol'+i).value = r.pol||'';
    document.getElementById('sab-poc'+i).value = r.poc||'';
    document.getElementById('sab-cen'+i).value = r.cen||'';
    document.getElementById('sab-cel'+i).value = r.cel||'';
  }
  document.getElementById('sablona-modal').classList.add('open');
}

function sabCalc() {
  for(let i=1;i<=4;i++){
    const poc = parseFloat(document.getElementById('sab-poc'+i)?.value||0)||0;
    const cen = parseFloat(document.getElementById('sab-cen'+i)?.value||0)||0;
    const el = document.getElementById('sab-cel'+i);
    if(el) el.value = poc&&cen ? (poc*cen).toFixed(2) : '';
  }
}

async function saveSablona() {
  const id = document.getElementById('sablona-edit-id').value;
  const nazev = document.getElementById('sab-nazev').value.trim();
  if(!nazev) { alert('Zadejte název šablony'); return; }
  const rows = [];
  for(let i=1;i<=4;i++) rows.push({
    pol: document.getElementById('sab-pol'+i).value,
    poc: document.getElementById('sab-poc'+i).value,
    cen: document.getElementById('sab-cen'+i).value,
    cel: document.getElementById('sab-cel'+i).value
  });
  const data = {
    nazev, typ: document.getElementById('sab-typ').value,
    firma:    document.getElementById('sab-firma').value,
    prace:    document.getElementById('sab-prace').value,
    zadani:   document.getElementById('sab-zadani').value,
    interval: parseInt(document.getElementById('sab-interval').value)||0,
    rows, updatedAt: window._fb.serverTimestamp()
  };
  try {
    if(id) { await window._fb.updateDoc(window._fb.doc(window._fb.db,'sablony',id), data); }
    else { data.createdAt=window._fb.serverTimestamp(); await window._fb.addDoc(window._fb.collection(window._fb.db,'sablony'), data); }
    closeModal('sablona-modal');
  } catch(e) { alert('Chyba: '+e.message); }
}

async function deleteSablona(id) {
  if(!confirm('Smazat tuto šablonu?')) return;
  window._fb.deleteDoc(window._fb.doc(window._fb.db,'sablony',id)).catch(e=>alert('Chyba: '+e.message));
}

async function createFromSablona(id) {
  const s = _sablony.find(x=>x.id===id);
  if(!s) return;
  const termin = prompt('Termín zakázky (RRRR-MM-DD):', new Date().toISOString().slice(0,10));
  if(!termin) return;
  const zakaznik = prompt('Zákazník:', '');
  try {
    const newZ = {
      nazev:    s.nazev, typ: s.typ||'', firma: s.firma||'aceuro',
      prace:    s.prace||'', zadani: s.zadani||'',
      rows:     s.rows||[], exts: [],
      zakaznik: zakaznik||'',
      termin, stav: 'nová',
      createdBy: window._currentUser?.uid||'',
      technik:   window._currentUser?.displayName||window._currentUser?.email||'',
      createdAt: window._fb.serverTimestamp()
    };
    await window._fb.addDoc(window._fb.collection(window._fb.db,'zakazky'), newZ);
    alert('✅ Zakázka vytvořena ze šablony!');
    switchTab('orders');
  } catch(e) { alert('Chyba: '+e.message); }
}

// ══ HISTORY API — záložka prohlížeče ════════════════════════════
// Zabraňuje zavření celé záložky při "Zpět"
(function initHistoryAPI() {
  window.addEventListener('popstate', e => {
    if(e.state && e.state.screen) {
      // Pokud jsme v detailu, zavřeme detail
      const appK = document.getElementById('app-kancelar');
      if(appK && appK.style.display !== 'none') {
        const di = document.getElementById('detail-inner');
        if(di && di.style.display !== 'none') {
          di.style.display = 'none';
          document.getElementById('detail-empty').style.display = 'flex';
          return;
        }
      }
    }
  });
  // Push initial state
  if(history.state === null) {
    history.replaceState({screen:'main'}, '', location.href);
  }
})();

// ══ BACKGROUND SYNC (offline zakázky) ═══════════════════════════
// Registrace sync queue přes service worker
async function registerBackgroundSync() {
  if('serviceWorker' in navigator && 'SyncManager' in window) {
    try {
      const reg = await navigator.serviceWorker.ready;
      await reg.sync.register('sync-zakazky');
    } catch(e) { /* SW not available in this context */ }
  }
}

// Poslouchej zprávy od SW
if('serviceWorker' in navigator) {
  navigator.serviceWorker.addEventListener('message', e => {
    if(e.data && e.data.type === 'SYNC_COMPLETE') {
      // Reload zakázky po úspěšné sync
      loadAssignedZakazky && window._currentUser && loadAssignedZakazky(window._currentUser);
    }
  });
}

// ══ FCM PUSH NOTIFIKACE ══════════════════════════════════════════
// Inicializace FCM - technik dostane notifikaci při přiřazení zakázky
async function initFCM(user) {
  // FCM vyžaduje firebase/messaging compat script a VAPID key
  // Implementujeme přes fallback - browser Notification API
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') {
    const perm = await Notification.requestPermission();
    if(perm !== 'granted') return;
  }
  if(Notification.permission !== 'granted') return;

  // Ulož FCM token (nebo jen příznak souhlasu) do Firestore
  try {
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db,'users',user.uid),
      {notifEnabled: true, notifUpdated: window._fb.serverTimestamp()}
    );
  } catch(e) {}

  // Sleduj zakázky přiřazené tomuto technikovi - realtime notifikace
  const name = user.displayName || '';
  const email = user.email || '';
  let _prevAssigned = new Set();

  window._fb.onSnapshot(
    window._fb.query(window._fb.collection(window._fb.db,'zakazky'), window._fb.orderBy('createdAt','desc'), window._fb.limit(30)),
    snap => {
      snap.docs.forEach(d => {
        const z = {id:d.id,...d.data()};
        const isMe = z.assignedTo===name||z.assignedTo===email||z.technik===name||z.technik===email;
        if(isMe && !_prevAssigned.has(z.id) && _prevAssigned.size > 0) {
          // Nová přiřazená zakázka
          new Notification('🔧 Nová přiřazená zakázka', {
            body: `${z.nazev||'Zakázka'} · ${fmtD(z.termin)||'bez termínu'}`,
            icon: typeof LOGO_DATA !== 'undefined' ? LOGO_DATA : '/logo.jpg',
            tag: 'assigned-'+z.id
          });
        }
        if(isMe) _prevAssigned.add(z.id);
      });
      // Po prvním snapshotu inicializuj sadu
      if(_prevAssigned.size === 0) {
        snap.docs.forEach(d => {
          const z = {id:d.id,...d.data()};
          const isMe = z.assignedTo===name||z.assignedTo===email||z.technik===name||z.technik===email;
          if(isMe) _prevAssigned.add(z.id);
        });
      }
    }
  );
}

// ══ NAPOJENÍ NA INIT ═════════════════════════════════════════════
// Přidej FCM init do technik inicializace
const _initTechnikOrig = initTechnik;
initTechnik = function(user) {
  _initTechnikOrig(user);
  initFCM(user).catch(()=>{});
  registerBackgroundSync();
};

// Přidej sklad+šablony načtení do kancelář inicializace
const _initKancelarOrig = initKancelar;
initKancelar = function(user, role) {
  _initKancelarOrig(user, role);
  loadSklad();
  loadSablony();
  registerBackgroundSync();
};

// Přidej switchTab override pro lazy loading
(function() {
  let _switchTabAttempts = 0;
  const _tryOverrideSwitchTab = setInterval(() => {
    _switchTabAttempts++;
    if(typeof switchTab !== 'undefined' || _switchTabAttempts > 20) {
      clearInterval(_tryOverrideSwitchTab);
      if(typeof switchTab === 'undefined') return;
      const orig = switchTab;
      switchTab = function(tab) {
        orig(tab);
        if(tab === 'sklad') loadSklad();
        if(tab === 'sablony') loadSablony();
      };
    }
  }, 300);
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 2 — switchTab, QR, XLSX, faktura, audit log,
//  časovač, hromadné akce, záloha dat
// ════════════════════════════════════════════════════════════════

// ══ SWITCHTAB ════════════════════════════════════════════════════
function switchTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const panel = document.getElementById('tab-' + tab);
  if(panel) panel.classList.add('active');
  // Aktivuj odpovídající tab-btn
  document.querySelectorAll('.tab-btn').forEach(b => {
    if(b.getAttribute('onclick') && b.getAttribute('onclick').includes("'" + tab + "'")) {
      b.classList.add('active');
    }
  });
  // Lazy load
  if(tab === 'sklad')    loadSklad    && loadSklad();
  if(tab === 'sablony')  loadSablony  && loadSablony();
  if(tab === 'dash')     { renderDashboard && renderDashboard(); }
  if(tab === 'historie') loadHistorie && loadHistorie();
}

// ══ QR KÓD ═══════════════════════════════════════════════════════
// Jednoduchý QR generátor bez externích knihoven (micro-QR algoritmus pro URL)
// Použijeme qrious nebo vlastní canvas drawing

let _qrCurrentId = null;

function showQR(id) {
  const z = (window._zakazky||[]).find(x=>x.id===id);
  if(!z) return;
  _qrCurrentId = id;

  // URL zakázky — v produkci by to byl reálný link
  const url = `${location.origin}${location.pathname}#zakazka=${id}`;
  const title = document.getElementById('qr-modal-title');
  const info  = document.getElementById('qr-info');
  if(title) title.textContent = `QR — ${z.cislo||z.nazev||'Zakázka'}`;
  if(info)  info.innerHTML = `<strong>${esc(z.nazev||'—')}</strong><br>${esc(z.zakaznik||'')}`;

  document.getElementById('qr-modal').classList.add('open');

  // Generuj QR kód pomocí jednoduchého canvas drawing
  setTimeout(() => drawQRCanvas(url), 50);
}

function drawQRCanvas(text) {
  const canvas = document.getElementById('qr-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const size = 220;
  canvas.width = size; canvas.height = size;

  // Použij vestavěný API pokud dostupný (moderní prohlížeče mají BarcodeDetector ale ne generator)
  // Fallback: nakresli QR s knihovnou qrcode.js přes CDN
  // Načti qrcode library dynamicky
  if(typeof QRCode === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
    script.onload = () => generateQRWithLib(text, canvas);
    script.onerror = () => drawQRFallback(ctx, text, size);
    document.head.appendChild(script);
  } else {
    generateQRWithLib(text, canvas);
  }
}

function generateQRWithLib(text, canvas) {
  // QRCode.js kreslí do div, ne canvas — použij temp div
  const tmp = document.createElement('div');
  tmp.style.display = 'none';
  document.body.appendChild(tmp);
  try {
    new QRCode(tmp, { text, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.M });
    setTimeout(() => {
      const img = tmp.querySelector('img') || tmp.querySelector('canvas');
      if(img) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#fff';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        const tempImg = new Image();
        tempImg.onload = () => ctx.drawImage(tempImg, 10, 10, 200, 200);
        tempImg.src = img.tagName === 'CANVAS' ? img.toDataURL() : img.src;
      }
      tmp.remove();
    }, 200);
  } catch(e) {
    tmp.remove();
    drawQRFallback(canvas.getContext('2d'), text, 220);
  }
}

function drawQRFallback(ctx, text, size) {
  // Jednoduchý placeholder
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,size,size);
  ctx.strokeStyle = '#0f1f3d';
  ctx.lineWidth = 2;
  ctx.strokeRect(5,5,size-10,size-10);
  ctx.fillStyle = '#0f1f3d';
  ctx.font = '11px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillText('QR kód', size/2, size/2 - 10);
  ctx.font = '8px sans-serif';
  ctx.fillText(text.slice(0,40), size/2, size/2 + 10);
  ctx.fillText(text.slice(40,80), size/2, size/2 + 24);
}

function downloadQR() {
  const canvas = document.getElementById('qr-canvas');
  if(!canvas) return;
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = `QR_zakazka_${_qrCurrentId||'export'}.png`;
  a.click();
}

// ══ XLSX EXPORT ═══════════════════════════════════════════════════
function exportXLSX(id) {
  const d = getDetailData(id);
  if(!d) return;

  // Sestavíme CSV kompatibilní s Excelem - jednoduchý přístup
  // Pro plný XLSX by bylo třeba SheetJS CDN
  const rows = [
    ['FAKTURAČNÍ PODKLAD', '', '', ''],
    ['Zakázka:', d.nazev||'', 'Číslo:', d.cislo||''],
    ['Zákazník:', d.zakaznik||'', 'Technik:', d.technik||''],
    ['Termín:', fmtD(d.termin)||'', 'DUZP:', fmtD(d.duzp)||''],
    ['', '', '', ''],
    ['Položka', 'Počet ks', 'Cena Kč/ks', 'Celkem Kč'],
  ];

  (d.rows||[]).forEach(r => {
    if(r.pol||r.poc) rows.push([r.pol||'', r.poc||'', r.cen||'', r.cel||'']);
  });

  rows.push(['--- Cestovní náklady ---','','','']);
  (d.exts||[]).forEach(e => {
    if(e.poc) rows.push([e.label||'', e.poc||'', e.cen||'', e.cel||'']);
  });

  rows.push(['', '', '', '']);
  rows.push(['', '', 'Celkem bez DPH:', d.cena||'']);

  const totalNum = parseFloat((d.cena||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0;
  const dph21 = (totalNum * 0.21).toFixed(2);
  const total21 = (totalNum * 1.21).toFixed(2);
  rows.push(['', '', 'DPH 21 %:', dph21 + ' Kč']);
  rows.push(['', '', 'Celkem s DPH:', total21 + ' Kč']);
  rows.push(['', '', '', '']);
  rows.push(['Provedené práce:', (d.prace||'').replace(/\n/g,' '), '', '']);

  const csv = rows.map(r => r.map(v => '"' + (v||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'Fakturace_' + ((d.cislo||'export').replace(/[^a-z0-9_-]/gi,'_')) + '.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ══ FAKTURAČNÍ PODKLAD ════════════════════════════════════════════
let _fakturaId = null;

function exportFaktura(id) {
  const d = getDetailData(id);
  if(!d) return;
  _fakturaId = id;

  const firma = (typeof FIRMA_DATA !== 'undefined' && FIRMA_DATA) ?
    FIRMA_DATA[d.firma||'aceuro'] : {name:'AC EURO a.s.', address:'', ic:'', phone:''};

  const totalNum = parseFloat((d.cena||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0;
  const dph21 = totalNum * 0.21;
  const total21 = totalNum + dph21;

  const rowsHtml = (d.rows||[]).filter(r=>r.pol||r.poc).map(r => `
    <tr>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6">${esc(r.pol||'')}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;text-align:center">${r.poc||''}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;text-align:right">${r.cen ? parseFloat(r.cen).toLocaleString('cs-CZ',{maximumFractionDigits:2})+' Kč' : ''}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;text-align:right;font-weight:600">${r.cel ? parseFloat(r.cel).toLocaleString('cs-CZ',{maximumFractionDigits:2})+' Kč' : ''}</td>
    </tr>`).join('');

  const extsHtml = (d.exts||[]).filter(e=>e.poc).map(e => `
    <tr style="font-style:italic">
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;color:#6b7a99">${esc(e.label||'')}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;text-align:center">${e.poc||''}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;text-align:right">${e.cen ? parseFloat(e.cen).toLocaleString('cs-CZ',{maximumFractionDigits:2})+' Kč' : ''}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #f0f2f6;text-align:right;font-weight:600">${e.cel ? parseFloat(e.cel).toLocaleString('cs-CZ',{maximumFractionDigits:2})+' Kč' : ''}</td>
    </tr>`).join('');

  document.getElementById('faktura-preview').innerHTML = `
    <div style="font-family:Arial,sans-serif;font-size:12px;color:#1a2540">
      <div style="display:flex;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #0f1f3d">
        <div>
          <div style="font-size:18px;font-weight:900;color:#0f1f3d;margin-bottom:2px">${esc(firma.name||'')}</div>
          <div style="font-size:11px;color:#6b7a99">${esc(firma.address||'')} ${firma.ic?'IČ: '+firma.ic:''}</div>
          ${firma.phone?`<div style="font-size:11px;color:#6b7a99">${esc(firma.phone)}</div>`:''}
        </div>
        <div style="text-align:right">
          <div style="font-size:14px;font-weight:700;color:#0f1f3d">FAKTURAČNÍ PODKLAD</div>
          <div style="font-size:11px;color:#6b7a99;margin-top:4px">Číslo zakázky: <strong>${esc(d.cislo||'—')}</strong></div>
          <div style="font-size:11px;color:#6b7a99">DUZP: <strong>${fmtD(d.duzp)||'—'}</strong></div>
          <div style="font-size:11px;color:#6b7a99">Vystaveno: <strong>${new Date().toLocaleDateString('cs-CZ')}</strong></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div>
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#6b7a99;margin-bottom:4px">Odběratel</div>
          <div style="font-weight:700">${esc(d.zakaznik||'—')}</div>
          ${d.adresa?`<div style="font-size:11px;color:#6b7a99">${esc(d.adresa)}</div>`:''}
          ${d.ico?`<div style="font-size:11px;color:#6b7a99">IČO: ${esc(d.ico)}${d.dic?' · DIČ: '+esc(d.dic):''}</div>`:''}
        </div>
        <div>
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#6b7a99;margin-bottom:4px">Detail zakázky</div>
          <div style="font-weight:700">${esc(d.nazev||'—')}</div>
          <div style="font-size:11px;color:#6b7a99">Technik: ${esc(d.technik||'—')}</div>
          <div style="font-size:11px;color:#6b7a99">Provedeno: ${fmtD(d.sd1||'')||'—'}${d.sd2&&d.sd2!==d.sd1?' – '+fmtD(d.sd2):''}</div>
        </div>
      </div>

      ${d.prace?`<div style="margin-bottom:14px;padding:10px 12px;background:#f8fafc;border-left:3px solid #6abf3e;border-radius:0 6px 6px 0">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:#6b7a99;margin-bottom:4px">Provedené servisní práce</div>
        <div style="white-space:pre-wrap;font-size:11px;line-height:1.6">${esc(d.prace)}</div>
      </div>`:''}

      <table style="width:100%;border-collapse:collapse;margin-bottom:14px">
        <thead><tr style="background:#0f1f3d;color:#fff">
          <th style="padding:8px;text-align:left;font-size:11px">Položka</th>
          <th style="padding:8px;text-align:center;font-size:11px;width:10%">Ks</th>
          <th style="padding:8px;text-align:right;font-size:11px;width:18%">Cena/ks</th>
          <th style="padding:8px;text-align:right;font-size:11px;width:18%">Celkem</th>
        </tr></thead>
        <tbody>
          ${rowsHtml}
          ${extsHtml}
        </tbody>
      </table>

      <div style="display:flex;justify-content:flex-end">
        <table style="border-collapse:collapse;font-size:12px;min-width:260px">
          <tr><td style="padding:5px 12px;color:#6b7a99">Základ DPH (bez DPH)</td><td style="padding:5px 12px;text-align:right;font-weight:600">${totalNum.toLocaleString('cs-CZ',{maximumFractionDigits:2})} Kč</td></tr>
          <tr><td style="padding:5px 12px;color:#6b7a99">DPH 21 %</td><td style="padding:5px 12px;text-align:right">${dph21.toLocaleString('cs-CZ',{maximumFractionDigits:2})} Kč</td></tr>
          <tr style="border-top:2px solid #0f1f3d;background:#f0f9ff">
            <td style="padding:8px 12px;font-weight:900;font-size:14px">Celkem k úhradě</td>
            <td style="padding:8px 12px;text-align:right;font-weight:900;font-size:14px;color:#0f1f3d">${total21.toLocaleString('cs-CZ',{maximumFractionDigits:2})} Kč</td>
          </tr>
        </table>
      </div>

      ${d.pozn?`<div style="margin-top:14px;padding:10px 12px;background:#fff9f0;border:1px solid #fde68a;border-radius:6px;font-size:11px">
        <strong>Poznámky:</strong> ${esc(d.pozn)}
      </div>`:''}
    </div>
  `;

  document.getElementById('faktura-modal').classList.add('open');
}

function printFaktura() {
  const content = document.getElementById('faktura-preview')?.innerHTML;
  if(!content) return;
  const pc = document.getElementById('print-container');
  pc.innerHTML = `<div style="padding:20px;font-family:Arial,sans-serif">${content}</div>`;
  setTimeout(() => window.print(), 300);
}

// ══ AUDIT LOG ════════════════════════════════════════════════════
async function saveAuditLog(zakazkaId, action, value) {
  const me = window._currentUser;
  try {
    await window._fb.addDoc(
      window._fb.collection(window._fb.db, 'zakazky/' + zakazkaId + '/audit'),
      {
        action, value: String(value||''),
        uid:    me?.uid || '',
        author: me?.displayName || me?.email || 'Systém',
        role:   window._currentRole || 'kancelar',
        createdAt: window._fb.serverTimestamp()
      }
    );
  } catch(e) { /* audit není kritický */ }
}

async function showAuditLog(zakazkaId) {
  const list = document.getElementById('audit-list');
  if(!list) return;
  list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">⏳ Načítám...</div>';
  document.getElementById('audit-modal').classList.add('open');

  try {
    const snap = await window._fb.getDocs(
      window._fb.query(
        window._fb.collection(window._fb.db, 'zakazky/' + zakazkaId + '/audit'),
        window._fb.orderBy('createdAt', 'desc')
      )
    );
    const items = snap.docs.map(d=>({id:d.id,...d.data()}));
    if(!items.length) {
      list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-style:italic">Žádné záznamy v logu</div>';
      return;
    }
    const actionLabels = {
      stav_zmena: 'Změna stavu',
      cena_ulozena: 'Uloženy ceny',
      prirazeno: 'Přiřazení technika',
      smazano: 'Smazání',
      vytvoreno: 'Vytvoření'
    };
    list.innerHTML = items.map(item => {
      const time = item.createdAt ? fmtTS(item.createdAt) : '—';
      const label = actionLabels[item.action] || item.action;
      const roleColors = {admin:'#7c3aed', kancelar:'#1d4ed8', technik:'#065f46'};
      const roleColor = roleColors[item.role] || '#6b7a99';
      return `<div style="display:flex;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
        <div style="width:32px;height:32px;border-radius:50%;background:${roleColor}18;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">
          ${item.role==='technik'?'🔧':item.role==='admin'?'👑':'📋'}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:12px;font-weight:600;color:var(--navy)">${esc(label)}: <span style="color:${roleColor}">${esc(item.value||'')}</span></div>
          <div style="font-size:11px;color:var(--muted)">${esc(item.author||'—')} · ${time}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    list.innerHTML = `<div style="color:var(--err);font-size:12px;padding:10px">Chyba načtení: ${esc(e.message)}</div>`;
  }
}

// ══ ČASOVAČ ══════════════════════════════════════════════════════
const _timers = {}; // {id: {intervalId, startedAt, accumulated}}

function formatDuration(seconds) {
  const s = Math.round(seconds||0);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function toggleTimer(id) {
  const z = (window._zakazky||[]).find(x=>x.id===id);
  if(!z) return;

  if(z.timerRunning) {
    // Zastav
    const elapsed = z.timerStartedAt ?
      Math.round((Date.now() - (z.timerStartedAt.toMillis?.() || new Date(z.timerStartedAt).getTime())) / 1000) : 0;
    const total = (z.casNaZakazce||0) + elapsed;
    window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id), {
      timerRunning: false, casNaZakazce: total,
      timerStartedAt: null, updatedAt: window._fb.serverTimestamp()
    }).then(() => {
      z.timerRunning = false; z.casNaZakazce = total; z.timerStartedAt = null;
      if(_timers[id]) { clearInterval(_timers[id]); delete _timers[id]; }
      updateTimerDisplay(id, total);
      const btn = document.getElementById('timer-btn-'+id);
      if(btn) btn.textContent = '▶ Spustit čas';
    });
  } else {
    // Spusť
    const now = new Date();
    window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id), {
      timerRunning: true, timerStartedAt: window._fb.serverTimestamp(),
      updatedAt: window._fb.serverTimestamp()
    }).then(() => {
      z.timerRunning = true; z.timerStartedAt = now;
      const base = z.casNaZakazce||0;
      const startMs = now.getTime();
      _timers[id] = setInterval(() => {
        const elapsed = Math.round((Date.now()-startMs)/1000);
        updateTimerDisplay(id, base+elapsed);
      }, 1000);
      const btn = document.getElementById('timer-btn-'+id);
      if(btn) btn.textContent = '⏸ Pauza';
    });
  }
}

function updateTimerDisplay(id, seconds) {
  const el = document.getElementById('timer-val-'+id);
  if(el) el.textContent = formatDuration(seconds);
}

// Obnov běžící timery při otevření detailu
const _openDetailOrig2 = typeof openDetail !== 'undefined' ? openDetail : null;
if(_openDetailOrig2) {
  openDetail = function(id) {
    _openDetailOrig2(id);
    setTimeout(() => {
      const z = (window._zakazky||[]).find(x=>x.id===id);
      if(z && z.timerRunning && z.timerStartedAt) {
        const startMs = z.timerStartedAt.toMillis?.() || new Date(z.timerStartedAt).getTime();
        const base = z.casNaZakazce||0;
        if(_timers[id]) clearInterval(_timers[id]);
        _timers[id] = setInterval(() => {
          const elapsed = Math.round((Date.now()-startMs)/1000);
          updateTimerDisplay(id, base+elapsed);
        }, 1000);
        const btn = document.getElementById('timer-btn-'+id);
        if(btn) btn.textContent = '⏸ Pauza';
      }
    }, 300);
  };
}

// ══ HROMADNÉ AKCE ════════════════════════════════════════════════
window._bulkSelected = new Set();

function toggleBulkSelect(id, checked) {
  if(checked) window._bulkSelected.add(id);
  else        window._bulkSelected.delete(id);
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const cnt = document.getElementById('bulk-count');
  const n = window._bulkSelected.size;
  if(bar) bar.style.display = n > 0 ? 'flex' : 'none';
  if(cnt) cnt.textContent = n + ' vybráno';
}

async function bulkChangeStav() {
  const stav = document.getElementById('bulk-stav-sel')?.value;
  if(!stav) { alert('Vyberte nový stav'); return; }
  if(!window._bulkSelected.size) return;
  if(!confirm(`Změnit stav ${window._bulkSelected.size} zakázek na "${stav}"?`)) return;

  const ids = [...window._bulkSelected];
  let done = 0;
  for(const id of ids) {
    try {
      await window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',id),
        {stav, updatedAt:window._fb.serverTimestamp()});
      saveAuditLog(id, 'stav_zmena', stav + ' (hromadně)');
      done++;
    } catch(e) {}
  }
  alert(`✅ Hotovo — změněno ${done} z ${ids.length} zakázek`);
  bulkClear();
}

function bulkSelectAll() {
  const all = window._zakazky || [];
  const q   = (document.getElementById('search-inp')?.value||'').toLowerCase();
  const fs  = document.getElementById('filter-stav')?.value||'';
  const visible = all.filter(z => {
    if(fs && (z.stav||'nová') !== fs) return false;
    if(q && !(z.nazev||'').toLowerCase().includes(q) && !(z.zakaznik||'').toLowerCase().includes(q)) return false;
    return true;
  });
  visible.forEach(z => window._bulkSelected.add(z.id));
  updateBulkBar();
  renderList && renderList();
}

function bulkClear() {
  window._bulkSelected.clear();
  updateBulkBar();
  renderList && renderList();
}

// ══ ZÁLOHA DAT ════════════════════════════════════════════════════
async function backupAll() {
  const btn = event?.target;
  if(btn) { btn.disabled = true; btn.textContent = '⏳ Exportuji...'; }

  try {
    const all = window._zakazky || [];
    const backup = {
      exportDate: new Date().toISOString(),
      count: all.length,
      zakazky: all.map(z => ({...z,
        createdAt: z.createdAt?.toDate?.().toISOString() || z.createdAt,
        updatedAt: z.updatedAt?.toDate?.().toISOString() || z.updatedAt
      }))
    };

    const json = JSON.stringify(backup, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `AcEuro_Zaloha_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  } finally {
    if(btn) { btn.disabled = false; btn.textContent = '💾 Záloha JSON'; }
  }
}

async function backupAllXLSX() {
  const all = window._zakazky || [];
  const rows = [
    ['ID','Číslo','Název','Zákazník','Technik','Stav','Termín','Firma','Cena bez DPH','DUZP','Vytvořeno','IČO','Adresa','Popis prací']
  ];
  all.forEach(z => {
    const ts = z.createdAt?.toDate?.() || (z.createdAt ? new Date(z.createdAt) : null);
    rows.push([
      z.id||'', z.cislo||'', z.nazev||'', z.zakaznik||'', z.technik||'',
      z.stav||'nová', fmtD(z.termin)||'', z.firma||'aceuro', z.cena||'',
      fmtD(z.duzp)||'', ts?ts.toLocaleDateString('cs-CZ'):'',
      z.ico||'', z.adresa||'', (z.prace||'').replace(/\n/g,' ')
    ]);
  });

  const csv = rows.map(r => r.map(v => '"' + String(v||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `AcEuro_Vsechny_zakazky_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// Přidej záloha tlačítka do dashboardu při jeho renderování
(function addBackupButtons() {
  const tryAdd = () => {
    const dash = document.getElementById('tab-dash');
    if(!dash || dash.querySelector('#backup-btns')) return;
    const div = document.createElement('div');
    div.id = 'backup-btns';
    div.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;padding:14px 16px;background:#f8fafc;border:1px solid var(--border);border-radius:10px;align-items:center';
    div.innerHTML = `
      <span style="font-size:12px;font-weight:700;color:var(--navy);margin-right:4px">💾 Záloha dat:</span>
      <button onclick="backupAll()" class="btn btn-ghost" style="font-size:11px">💾 Záloha JSON</button>
      <button onclick="backupAllXLSX()" class="btn btn-ghost" style="font-size:11px">📊 Export všech zakázek CSV</button>
      <span style="font-size:10px;color:var(--muted);margin-left:4px">Záloha je vhodná pro archivaci a případnou obnovu dat.</span>
    `;
    const content = dash.querySelector('[style*="padding:20px"]');
    if(content) content.appendChild(div);
  };
  // Zkus po načtení a po přepnutí tabulky
  setTimeout(tryAdd, 1000);
  const origSwitch = typeof switchTab !== 'undefined' ? switchTab : null;
  if(origSwitch) {
    const prevSwitch = switchTab;
    switchTab = function(tab) {
      prevSwitch(tab);
      if(tab === 'dash') setTimeout(tryAdd, 100);
    };
  }
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 3 — dark mode, připomínky, počasí, drag&drop,
//  klávesové zkratky, SMS/email notif, import CSV, sortování
// ════════════════════════════════════════════════════════════════

// ══ DARK MODE ════════════════════════════════════════════════════
function toggleDarkMode() {
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', isDark ? '1' : '0');
  const btn = document.getElementById('dark-toggle');
  if(btn) btn.textContent = isDark ? '☀️' : '🌙';
}

(function initDarkMode() {
  const saved = localStorage.getItem('darkMode');
  if(saved === '1' || (saved === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-mode');
    const btn = document.getElementById('dark-toggle');
    if(btn) btn.textContent = '☀️';
  }
})();

// ══ PŘIPOMÍNKY / REMINDERS ═══════════════════════════════════════
function renderReminders() {
  const panel = document.getElementById('reminders-panel');
  const list  = document.getElementById('reminders-list');
  const cnt   = document.getElementById('reminders-count');
  if(!panel || !list) return;

  const now   = new Date();
  const today = now.toISOString().slice(0,10);
  const in7   = new Date(now.getTime() + 7*864e5).toISOString().slice(0,10);
  const in14  = new Date(now.getTime() + 14*864e5).toISOString().slice(0,10);
  const in30  = new Date(now.getTime() + 30*864e5).toISOString().slice(0,10);

  const reminders = [];
  const all = window._zakazky || [];

  // Blížící se termíny (7 dní)
  all.filter(z => {
    const t = z.termin||'';
    return t >= today && t <= in7 && !['zpracovaná','fakturovaná','zaplacena'].includes(z.stav||'nová');
  }).forEach(z => reminders.push({
    type: 'termin', zakazkaId: z.id,
    text: `Termín <strong>${esc(z.nazev||'—')}</strong> — ${fmtD(z.termin)}`,
    sub:  z.zakaznik ? `Zákazník: ${esc(z.zakaznik)}` : '',
    color: z.termin === today ? '#dc2626' : '#d97706',
    icon: z.termin === today ? '🔴' : '🟡',
    priority: z.termin === today ? 0 : 1
  }));

  // Nové nezpracované zakázky starší než 2 dny
  all.filter(z => {
    if((z.stav||'nová') !== 'nová') return false;
    const ts = z.createdAt?.toDate?.() || (z.createdAt ? new Date(z.createdAt) : null);
    if(!ts) return false;
    return (now - ts) > 2*864e5;
  }).forEach(z => reminders.push({
    type: 'nova', zakazkaId: z.id,
    text: `Nová zakázka čeká na zpracování: <strong>${esc(z.nazev||'—')}</strong>`,
    sub: `Vytvořeno: ${fmtTS(z.createdAt)}`,
    color: '#7c3aed', icon: '⚠️', priority: 2
  }));

  // Šablony s intervalem — zkontroluj jestli je čas na nový servis
  (_sablony||[]).filter(s => s.interval > 0).forEach(s => {
    // Najdi poslední zakázku z této šablony dle názvu
    const lastZ = all.filter(z => z.nazev === s.nazev)
      .sort((a,b) => (b.termin||'').localeCompare(a.termin||''))[0];
    if(lastZ && lastZ.termin) {
      const lastDate = new Date(lastZ.termin);
      const nextDate = new Date(lastDate.getTime() + s.interval*864e5);
      const nextStr  = nextDate.toISOString().slice(0,10);
      if(nextStr <= in30) {
        reminders.push({
          type: 'sablona',
          text: `Plánovaný servis: <strong>${esc(s.nazev)}</strong>`,
          sub:  `Naposledy: ${fmtD(lastZ.termin)} · Doporučeno: ${fmtD(nextStr)}`,
          color: '#0369a1', icon: '🔄', priority: 3,
          sablonaId: s.id
        });
      }
    }
  });

  reminders.sort((a,b) => a.priority - b.priority);

  if(!reminders.length) {
    panel.style.display = 'none';
    return;
  }
  panel.style.display = 'block';
  if(cnt) cnt.textContent = `${reminders.length} položek`;

  list.innerHTML = reminders.slice(0,8).map(r => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:#fff;border:1px solid #fde68a;border-radius:8px;cursor:pointer"
      onclick="${r.zakazkaId ? `switchTab('orders');setTimeout(()=>openDetail('${r.zakazkaId}'),50)` : r.sablonaId ? `switchTab('sablony')` : ''}">
      <span style="font-size:16px;flex-shrink:0">${r.icon}</span>
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;color:#1a2540">${r.text}</div>
        ${r.sub ? `<div style="font-size:11px;color:#6b7a99">${r.sub}</div>` : ''}
      </div>
      ${r.type==='sablona' ? `<button onclick="event.stopPropagation();createFromSablona('${r.sablonaId}')"
        style="font-size:10px;padding:3px 8px;background:#0369a1;color:#fff;border:none;border-radius:5px;cursor:pointer;flex-shrink:0;white-space:nowrap">Vytvořit</button>` : ''}
    </div>`).join('');
}

// Napoji na renderDashboard
const _rdOrig3 = typeof renderDashboard !== 'undefined' ? renderDashboard : null;
if(_rdOrig3) {
  renderDashboard = function() {
    _rdOrig3();
    renderReminders();
  };
}

// ══ POČASÍ (OpenWeatherMap — free tier) ═══════════════════════════
const WEATHER_CACHE = {};

async function loadWeather(zakazkaId, termin, adresa) {
  const el = document.getElementById('weather-body-'+zakazkaId);
  if(!el) return;

  // Zkontroluj jestli je datum v rozumném rozsahu (do 16 dní)
  const termDate = new Date(termin);
  const now = new Date();
  const diffDays = Math.round((termDate - now) / 864e5);
  if(diffDays < -1 || diffDays > 15) {
    el.innerHTML = `<span style="color:var(--muted)">Předpověď dostupná pouze pro termíny do 15 dní dopředu.</span>`;
    return;
  }

  const cacheKey = termin + '|' + (adresa||'Praha');
  if(WEATHER_CACHE[cacheKey]) {
    renderWeather(el, WEATHER_CACHE[cacheKey], diffDays);
    return;
  }

  // Použij Open-Meteo API — zdarma, bez klíče, spolehlivé
  try {
    // Geocoding přes nominatim
    const geoUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(adresa||'Praha, CZ')}&format=json&limit=1`;
    const geoRes = await fetch(geoUrl, {headers: {'User-Agent':'AcEuro-Service/1.0'}});
    const geoData = await geoRes.json();
    const lat = geoData[0]?.lat || '50.0755';
    const lon = geoData[0]?.lon || '14.4378';

    const wUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode&forecast_days=16&timezone=Europe%2FPrague`;
    const wRes = await fetch(wUrl);
    const wData = await wRes.json();

    // Najdi odpovídající den
    const dayIdx = (wData.daily?.time||[]).indexOf(termin);
    if(dayIdx < 0) {
      el.innerHTML = `<span>Data pro tento den nejsou dostupná.</span>`;
      return;
    }

    const result = {
      tMax:  wData.daily.temperature_2m_max[dayIdx],
      tMin:  wData.daily.temperature_2m_min[dayIdx],
      rain:  wData.daily.precipitation_sum[dayIdx],
      code:  wData.daily.weathercode[dayIdx],
      lat, lon
    };
    WEATHER_CACHE[cacheKey] = result;
    renderWeather(el, result, diffDays);
  } catch(e) {
    el.innerHTML = `<span style="color:var(--muted)">Předpověď není dostupná (offline nebo chyba sítě).</span>`;
  }
}

function renderWeather(el, data, diffDays) {
  const codes = {
    0:'☀️ Jasno',1:'🌤 Převážně jasno',2:'⛅ Polojasno',3:'☁️ Zataženo',
    45:'🌫 Mlha',48:'🌫 Námrazová mlha',
    51:'🌦 Slabé mrholení',53:'🌦 Mrholení',55:'🌧 Silné mrholení',
    61:'🌧 Slabý déšť',63:'🌧 Déšť',65:'🌧 Silný déšť',
    71:'🌨 Slabý sníh',73:'🌨 Sníh',75:'❄️ Silný sníh',
    80:'🌦 Přeháňky',81:'🌧 Silné přeháňky',82:'⛈ Bouřkové přeháňky',
    95:'⛈ Bouřka',96:'⛈ Bouřka s krupobitím',99:'⛈ Silná bouřka'
  };
  const desc = codes[data.code] || `Kód počasí: ${data.code}`;
  const rainWarn = data.rain > 5 ? `<span style="color:#dc2626;font-weight:600">⚠️ Déšť ${data.rain?.toFixed(1)} mm</span>` : '';

  el.innerHTML = `
    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
      <div style="font-size:24px">${desc.split(' ')[0]}</div>
      <div>
        <div style="font-size:13px;font-weight:600;color:var(--text)">${desc.replace(/^[^ ]+ /,'')}</div>
        <div style="font-size:12px;color:var(--muted)">Max <strong>${data.tMax}°C</strong> · Min <strong>${data.tMin}°C</strong>${data.rain>0?' · Srážky: '+(data.rain?.toFixed(1))+'mm':''}</div>
        ${rainWarn}
      </div>
      ${diffDays >= 0 ? '' : '<div style="font-size:10px;color:var(--muted);font-style:italic">Historické data</div>'}
    </div>`;
}

// Napoji na openDetail
const _odOrig3 = typeof openDetail !== 'undefined' ? openDetail : null;
if(_odOrig3) {
  const prev = openDetail;
  openDetail = function(id) {
    prev(id);
    setTimeout(() => {
      const z = (window._zakazky||[]).find(x=>x.id===id);
      if(z?.termin) loadWeather(id, z.termin, z.adresa||'Praha, CZ');
    }, 400);
  };
}

// ══ KLÁVESOVÉ ZKRATKY ════════════════════════════════════════════
document.addEventListener('keydown', e => {
  // Ignoruj pokud jsme v input/textarea
  if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName)) return;
  // Ignoruj pokud je otevřený modal
  if(document.querySelector('.modal-overlay.open')) {
    if(e.key === 'Escape') {
      document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
    }
    return;
  }

  const appK = document.getElementById('app-kancelar');
  if(!appK || appK.style.display === 'none') return;

  switch(e.key) {
    case 'n': case 'N':
      if(!e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        document.querySelector('.btn-pridat')?.click() || document.querySelector('[onclick*="openNewZakazka"]')?.click();
        // Fallback — hledej tlačítko Přidat
        document.querySelectorAll('button').forEach(b => {
          if(b.textContent.trim() === 'Přidat') b.click();
        });
      }
      break;
    case 'f': case 'F':
      if(!e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        const si = document.getElementById('search-inp');
        if(si) { si.focus(); si.select(); }
      }
      break;
    case 'Escape':
      const di = document.getElementById('detail-inner');
      if(di && di.style.display !== 'none') {
        di.style.display = 'none';
        const de = document.getElementById('detail-empty');
        if(de) de.style.display = 'flex';
      }
      break;
    case '1': switchTab && switchTab('orders'); break;
    case '2': switchTab && switchTab('dash'); break;
    case '3': switchTab && switchTab('sklad'); break;
    case '4': switchTab && switchTab('sablony'); break;
    case 'd': case 'D':
      if(!e.ctrlKey && !e.metaKey) toggleDarkMode();
      break;
  }
});

// Zobraz klávesové zkratky hint
(function addShortcutsHint() {
  const hint = document.createElement('div');
  hint.id = 'shortcuts-hint';
  hint.style.cssText = 'position:fixed;bottom:14px;right:14px;background:rgba(15,31,61,.85);color:#fff;font-size:10px;padding:8px 12px;border-radius:8px;backdrop-filter:blur(8px);z-index:800;display:none;line-height:1.8;pointer-events:none';
  hint.innerHTML = '<strong>Klávesové zkratky</strong><br>N = Nová zakázka<br>F = Hledat<br>D = Dark mode<br>Esc = Zavřít detail<br>1-4 = Přepnout záložku';
  document.body.appendChild(hint);
  document.addEventListener('keydown', e => {
    if(e.key === '?') {
      const h = document.getElementById('shortcuts-hint');
      if(h) h.style.display = h.style.display === 'none' ? 'block' : 'none';
    }
  });
})();

// ══ DRAG & DROP POŘADÍ ZAKÁZEK ════════════════════════════════════
let _dragId = null;
let _dragOrder = {}; // {id: order}

function initDragDrop() {
  const scroll = document.getElementById('list-scroll');
  if(!scroll || scroll._ddInit) return;
  scroll._ddInit = true;

  scroll.addEventListener('dragstart', e => {
    const card = e.target.closest('.zcard');
    if(!card) return;
    _dragId = card.dataset.id;
    card.style.opacity = '0.5';
    e.dataTransfer.effectAllowed = 'move';
  });

  scroll.addEventListener('dragend', e => {
    const card = e.target.closest('.zcard');
    if(card) card.style.opacity = '';
    _dragId = null;
  });

  scroll.addEventListener('dragover', e => {
    e.preventDefault();
    const card = e.target.closest('.zcard');
    if(!card || card.dataset.id === _dragId) return;
    const rect = card.getBoundingClientRect();
    const mid  = rect.top + rect.height/2;
    card.style.borderTop    = e.clientY < mid ? '2px solid var(--green)' : '';
    card.style.borderBottom = e.clientY >= mid ? '2px solid var(--green)' : '';
  });

  scroll.addEventListener('dragleave', e => {
    const card = e.target.closest('.zcard');
    if(card) { card.style.borderTop = ''; card.style.borderBottom = ''; }
  });

  scroll.addEventListener('drop', e => {
    e.preventDefault();
    const targetCard = e.target.closest('.zcard');
    if(!targetCard || !_dragId) return;
    targetCard.style.borderTop = ''; targetCard.style.borderBottom = '';

    const cards = [...scroll.querySelectorAll('.zcard[data-id]')];
    const fromIdx = cards.findIndex(c => c.dataset.id === _dragId);
    const toIdx   = cards.findIndex(c => c === targetCard);
    if(fromIdx < 0 || toIdx < 0 || fromIdx === toIdx) return;

    // Přesun v DOM
    const moving = cards[fromIdx];
    if(fromIdx < toIdx) targetCard.after(moving);
    else targetCard.before(moving);

    // Ulož pořadí do localStorage
    const newOrder = {};
    [...scroll.querySelectorAll('.zcard[data-id]')].forEach((c,i) => newOrder[c.dataset.id] = i);
    _dragOrder = newOrder;
    localStorage.setItem('zakazky-order', JSON.stringify(newOrder));
  });
}

// Přidej draggable attr do renderList + data-id
const _rlOrig3 = typeof renderList !== 'undefined' ? renderList : null;
if(_rlOrig3) {
  const prevRl = renderList;
  renderList = function() {
    prevRl();
    // Přidej draggable a data-id
    document.querySelectorAll('.zcard').forEach(c => {
      const onclick = c.getAttribute('onclick')||'';
      const m = onclick.match(/openDetail\('([^']+)'\)/);
      if(m) {
        c.setAttribute('draggable','true');
        c.dataset.id = m[1];
      }
    });
    setTimeout(initDragDrop, 50);
  };
}

// ══ E-MAIL NOTIFIKACE (EmailJS) ═══════════════════════════════════
let _emailjsReady = false;

function loadEmailJS() {
  if(_emailjsReady || typeof emailjs !== 'undefined') { _emailjsReady = true; return Promise.resolve(); }
  return new Promise((res,rej) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js';
    s.onload = () => {
      const cfg = getNotifSettings();
      if(cfg.pubkey) emailjs.init({publicKey: cfg.pubkey});
      _emailjsReady = true;
      res();
    };
    s.onerror = rej;
    document.head.appendChild(s);
  });
}

function getNotifSettings() {
  try {
    return JSON.parse(localStorage.getItem('emailjs-cfg')||'{}');
  } catch(e) { return {}; }
}

function saveNotifSettings() {
  const cfg = {
    serviceId:  document.getElementById('emailjs-service')?.value.trim(),
    templateId: document.getElementById('emailjs-template')?.value.trim(),
    pubkey:     document.getElementById('emailjs-pubkey')?.value.trim()
  };
  localStorage.setItem('emailjs-cfg', JSON.stringify(cfg));
  closeModal('notif-settings-modal');
  alert('✅ Nastavení uloženo');
}

async function sendEmailNotif(techEmail, techName, zakazka) {
  const cfg = getNotifSettings();
  if(!cfg.serviceId || !cfg.templateId || !cfg.pubkey) return; // Není nakonfigurováno

  try {
    await loadEmailJS();
    await emailjs.send(cfg.serviceId, cfg.templateId, {
      to_email:   techEmail,
      to_name:    techName,
      zakazka_name:   zakazka.nazev||'—',
      zakazka_cislo:  zakazka.cislo||'—',
      zakazka_termin: fmtD(zakazka.termin)||'—',
      zakazka_zadani: zakazka.zadani||'—',
      zakazka_adresa: zakazka.adresa||'—',
    });
    console.log('📧 Email notifikace odeslána:', techEmail);
  } catch(e) {
    console.warn('EmailJS error:', e);
  }
}

async function testEmailNotif() {
  const addr = document.getElementById('emailjs-test-addr')?.value.trim();
  if(!addr) { alert('Zadejte testovací e-mail'); return; }
  await sendEmailNotif(addr, 'Technik', {nazev:'Testovací zakázka', cislo:'TEST-001', termin: new Date().toISOString().slice(0,10)});
  alert('Test e-mail odeslán (zkontrolujte emailjs dashboard pro potvrzení)');
}

// Napoji na saveAssignment (přiřazení technika)
const _saveAssignOrig = typeof saveAssignment !== 'undefined' ? saveAssignment : null;
// Funkce saveAssignment je async — napojíme přes Firestore listener pro nové přiřazení
// Při změně zakazky.assignedTo pošleme e-mail
if(typeof window._fb !== 'undefined') {
  // Sleduj změny přiřazení
  let _prevAssignments = {};
  const _checkAssignments = (zakazky) => {
    zakazky.forEach(z => {
      const prev = _prevAssignments[z.id];
      if(prev !== undefined && prev !== z.assignedTo && z.assignedTo) {
        // Nové přiřazení — najdi e-mail technika
        const tech = (_techList||[]).find(t => t.name === z.assignedTo || t.email === z.assignedTo);
        if(tech?.email) sendEmailNotif(tech.email, tech.name||z.assignedTo, z);
      }
      _prevAssignments[z.id] = z.assignedTo;
    });
  };

  // Napoji na realtime listener
  const _sskOrig = typeof startKancelarLive !== 'undefined' ? startKancelarLive : null;
}

// ══ IMPORT CSV/EXCEL ══════════════════════════════════════════════
let _importRows = [];

function handleImportDrop(e) {
  const file = e.dataTransfer?.files?.[0];
  if(file) processImportFile(file);
}

function handleImportFile(input) {
  const file = input?.files?.[0];
  if(file) processImportFile(file);
}

function processImportFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    let rows = [];
    const name = file.name.toLowerCase();

    if(name.endsWith('.csv')) {
      // Parse CSV
      const text = e.target.result;
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if(lines.length < 2) { alert('CSV soubor je prázdný nebo neobsahuje data.'); return; }

      const sep = lines[0].includes(';') ? ';' : ',';
      const parseRow = line => {
        const cols = [];
        let cur = '', inQ = false;
        for(let i = 0; i < line.length; i++) {
          const ch = line[i];
          if(ch === '"') { inQ = !inQ; }
          else if(ch === sep && !inQ) { cols.push(cur.trim()); cur = ''; }
          else { cur += ch; }
        }
        cols.push(cur.trim());
        return cols;
      };

      const headers = parseRow(lines[0]).map(h => h.toLowerCase().replace(/['"]/g,''));
      rows = lines.slice(1).map(l => {
        const vals = parseRow(l);
        const obj = {};
        headers.forEach((h,i) => obj[h] = vals[i]||'');
        return obj;
      });

    } else if(name.endsWith('.xlsx') || name.endsWith('.xls')) {
      alert('XLSX import — načtěte soubor přes SheetJS. Zatím podporujeme CSV. Uložte jako .csv z Excelu (Soubor → Uložit jako → CSV).');
      return;
    }

    // Mapování sloupců
    const colMap = {
      nazev:    ['název','nazev','name','zakázka','zakazka','title'],
      zakaznik: ['zákazník','zakaznik','customer','firma','klient'],
      technik:  ['technik','technician','pracovnik','pracovník'],
      termin:   ['termín','termin','datum','date','deadline'],
      cena:     ['cena','price','částka','castka','hodnota'],
      stav:     ['stav','status','state'],
      ico:      ['ičo','ico','ic'],
      adresa:   ['adresa','address','místo','misto'],
      prace:    ['prace','práce','popis','description','poznamky','poznámky'],
      cislo:    ['číslo','cislo','number','č.'],
    };

    _importRows = rows.map(r => {
      const z = {};
      Object.entries(colMap).forEach(([field, aliases]) => {
        for(const alias of aliases) {
          const key = Object.keys(r).find(k => k.replace(/[^a-záčďéěíňóřšťúůýž0-9]/gi,'').toLowerCase() === alias.replace(/[^a-záčďéěíňóřšťúůýž0-9]/gi,'').toLowerCase());
          if(key && r[key]) { z[field] = r[key]; break; }
        }
      });
      return z;
    }).filter(z => z.nazev); // Musí mít název

    showImportPreview(_importRows);
  };

  if(file.name.toLowerCase().endsWith('.csv')) {
    reader.readAsText(file, 'UTF-8');
  } else {
    reader.readAsArrayBuffer(file);
  }
}

function showImportPreview(rows) {
  const preview = document.getElementById('import-preview');
  const cnt     = document.getElementById('import-preview-count');
  const tbl     = document.getElementById('import-preview-tbl');
  const btn     = document.getElementById('import-confirm-btn');
  if(!preview || !tbl) return;

  preview.style.display = 'block';
  if(cnt) cnt.textContent = `${rows.length} zakázek`;
  if(btn) btn.style.display = '';

  const fields = ['nazev','zakaznik','technik','termin','cena','stav'];
  const labels = {nazev:'Název',zakaznik:'Zákazník',technik:'Technik',termin:'Termín',cena:'Cena',stav:'Stav'};

  tbl.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:11px">
    <thead><tr style="background:var(--bg)">
      ${fields.map(f => `<th style="padding:6px 8px;text-align:left;font-weight:700;color:var(--navy);border-bottom:2px solid var(--border)">${labels[f]}</th>`).join('')}
    </tr></thead>
    <tbody>
      ${rows.slice(0,10).map((r,i) => `<tr style="border-bottom:1px solid var(--border);${i%2?'background:var(--bg)':''}">
        ${fields.map(f => `<td style="padding:5px 8px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r[f]||'—')}</td>`).join('')}
      </tr>`).join('')}
      ${rows.length > 10 ? `<tr><td colspan="${fields.length}" style="padding:6px 8px;color:var(--muted);font-style:italic">… a dalších ${rows.length-10} zakázek</td></tr>` : ''}
    </tbody>
  </table>`;
}

async function confirmImport() {
  if(!_importRows.length) return;
  const btn = document.getElementById('import-confirm-btn');
  if(btn) { btn.disabled = true; btn.textContent = `⏳ Importuji ${_importRows.length} zakázek…`; }

  let done = 0, errors = 0;
  const me = window._currentUser;

  for(const row of _importRows) {
    try {
      const newZ = {
        nazev:    row.nazev||'',
        zakaznik: row.zakaznik||'',
        technik:  row.technik||'',
        termin:   row.termin||'',
        cena:     row.cena||'',
        stav:     row.stav||'nová',
        ico:      row.ico||'',
        adresa:   row.adresa||'',
        prace:    row.prace||'',
        cislo:    row.cislo||'',
        firma:    'aceuro',
        rows:     [], exts:[],
        createdBy: me?.uid||'',
        createdAt: window._fb.serverTimestamp(),
        _importedAt: new Date().toISOString()
      };
      await window._fb.addDoc(window._fb.collection(window._fb.db,'zakazky'), newZ);
      saveAuditLog('', 'import', row.nazev);
      done++;
    } catch(e) { errors++; }
  }

  if(btn) { btn.disabled = false; btn.textContent = '📥 Importovat zakázky'; }
  closeModal('import-modal');
  _importRows = [];
  alert(`✅ Import dokončen\n${done} zakázek importováno${errors?'\n⚠️ '+errors+' chyb':''}`)
}

// Načti nastavení emailjs do formuláře při otevření modalu
document.addEventListener('click', e => {
  if(e.target.closest('[onclick*="notif-settings-modal"]')) {
    setTimeout(() => {
      const cfg = getNotifSettings();
      document.getElementById('emailjs-service')?.setAttribute('value', cfg.serviceId||'');
      document.getElementById('emailjs-template')?.setAttribute('value', cfg.templateId||'');
      document.getElementById('emailjs-pubkey')?.setAttribute('value', cfg.pubkey||'');
      if(cfg.serviceId) document.getElementById('emailjs-service').value = cfg.serviceId;
      if(cfg.templateId) document.getElementById('emailjs-template').value = cfg.templateId;
      if(cfg.pubkey) document.getElementById('emailjs-pubkey').value = cfg.pubkey;
    }, 100);
  }
});

// ══ FIREBASE STORAGE PRO FOTKY (migrační helper) ══════════════════
// Upozornění při velkém počtu fotek v zakázce
function checkPhotoStorage(zakazka) {
  const photos = zakazka.photos || [];
  const base64Count = photos.filter(p => p.dataUrl && p.dataUrl.startsWith('data:')).length;
  if(base64Count > 5) {
    console.warn(`Zakázka ${zakazka.id} má ${base64Count} base64 fotek — zvažte migraci do Firebase Storage`);
  }
}

// ══ INIT NA DASHBOARD ════════════════════════════════════════════
// Spusť připomínky kdykoli se načtou zakázky
const _sklOrig = typeof startKancelarLive !== 'undefined';
// Zachyť nové zakazky a checkni připomínky
if(typeof window._fb !== 'undefined') {
  setTimeout(() => {
    if(window._zakazky && renderReminders) renderReminders();
    if(document.getElementById('tab-orders')?.classList.contains('active')) {
      renderList && renderList();
    }
  }, 2000);
}

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 4 — výkaz práce, ceník, galerie fotek,
//  mapa techniků, SMS notifikace, km náhrady, schválení výkazu
// ════════════════════════════════════════════════════════════════

// ══ VÝKAZ PRÁCE ══════════════════════════════════════════════════
window._kmSazba = parseFloat(localStorage.getItem('km-sazba') || '5.60');

function getVykazRange() {
  const period = document.getElementById('vykaz-period')?.value || 'this-month';
  const now = new Date();
  let od, doo;

  if(period === 'this-month') {
    od  = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
    doo = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().slice(0,10);
  } else if(period === 'last-month') {
    od  = new Date(now.getFullYear(), now.getMonth()-1, 1).toISOString().slice(0,10);
    doo = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().slice(0,10);
  } else if(period === 'this-week') {
    const day = now.getDay() || 7;
    const mon = new Date(now); mon.setDate(now.getDate() - day + 1);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    od = mon.toISOString().slice(0,10); doo = sun.toISOString().slice(0,10);
  } else if(period === 'last-week') {
    const day = now.getDay() || 7;
    const mon = new Date(now); mon.setDate(now.getDate() - day - 6);
    const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
    od = mon.toISOString().slice(0,10); doo = sun.toISOString().slice(0,10);
  } else {
    od  = document.getElementById('vykaz-od')?.value || '';
    doo = document.getElementById('vykaz-do')?.value || '';
  }
  return {od, doo};
}

function renderVykaz() {
  const {od, doo} = getVykazRange();
  const period = document.getElementById('vykaz-period')?.value;
  const customDiv = document.getElementById('vykaz-custom-range');
  if(customDiv) customDiv.style.display = period === 'custom' ? 'flex' : 'none';

  const techFilter = document.getElementById('vykaz-technik')?.value || '';
  const all = (window._zakazky || []).filter(z => {
    if(!z.termin) return false;
    if(od && z.termin < od) return false;
    if(doo && z.termin > doo) return false;
    if(techFilter && z.technik !== techFilter && !(z.technici||[]).some(u=>u.name===techFilter)) return false;
    return true;
  }).sort((a,b) => (a.termin||'').localeCompare(b.termin||''));

  // Aktualizuj technik select
  const techSel = document.getElementById('vykaz-technik');
  if(techSel) {
    const techs = [...new Set((window._zakazky||[]).map(z=>z.technik||'').filter(Boolean))].sort();
    const cur = techSel.value;
    techSel.innerHTML = '<option value="">Všichni technici</option>' + techs.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');
    techSel.value = cur;
  }

  function parseCena(c){ return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0; }

  // Summary stats
  const totalHodiny = all.reduce((s,z) => s + (z.hodiny||0), 0);
  const totalKm     = all.reduce((s,z) => s + (z.km||0), 0);
  const totalRev    = all.reduce((s,z) => s + parseCena(z.cena), 0);
  const kmNahrady   = all.reduce((s,z) => s + (z.km||0) * (z.kmSazba||window._kmSazba), 0);

  const sumEl = document.getElementById('vykaz-summary');
  if(sumEl) {
    sumEl.innerHTML = [
      {val: all.length, lbl: 'Zakázek', cls: 'blue'},
      {val: totalHodiny.toFixed(1) + ' h', lbl: 'Odpracováno', cls: 'green'},
      {val: totalKm + ' km', lbl: 'Najeto km', cls: ''},
      {val: kmNahrady.toLocaleString('cs-CZ',{maximumFractionDigits:0}) + ' Kč', lbl: 'Km náhrady', cls: 'warn'},
      {val: totalRev.toLocaleString('cs-CZ',{maximumFractionDigits:0}) + ' Kč', lbl: 'Obrat', cls: 'green'},
    ].map(s => `<div class="stat-card ${s.cls||''}"><div class="val" style="font-size:18px">${s.val}</div><div class="lbl">${s.lbl}</div></div>`).join('');
  }

  const tbody = document.getElementById('vykaz-tbody');
  const thead = document.getElementById('vykaz-thead');
  const empty = document.getElementById('vykaz-empty');

  if(!all.length) {
    if(tbody) tbody.innerHTML = '';
    if(thead) thead.innerHTML = '';
    if(empty) empty.style.display = 'block';
    return;
  }
  if(empty) empty.style.display = 'none';

  if(thead) thead.innerHTML = `<tr style="background:#f8fafc;border-bottom:2px solid var(--border)">
    <th style="padding:9px 12px;text-align:left;font-weight:700;color:var(--navy)">Datum</th>
    <th style="padding:9px 12px;text-align:left;font-weight:700;color:var(--navy)">Zakázka</th>
    <th style="padding:9px 12px;text-align:left;font-weight:700;color:var(--navy)">Zákazník</th>
    <th style="padding:9px 12px;text-align:left;font-weight:700;color:var(--navy)">Technik</th>
    <th style="padding:9px 12px;text-align:center;font-weight:700;color:var(--navy)">Hodiny</th>
    <th style="padding:9px 12px;text-align:center;font-weight:700;color:var(--navy)">Km</th>
    <th style="padding:9px 12px;text-align:right;font-weight:700;color:var(--green)">Km náhrada</th>
    <th style="padding:9px 12px;text-align:right;font-weight:700;color:var(--green)">Cena</th>
    <th style="padding:9px 12px;text-align:center;font-weight:700;color:var(--navy)">Stav</th>
  </tr>`;

  if(tbody) tbody.innerHTML = all.map(z => {
    const kn = (z.km||0) * (z.kmSazba||window._kmSazba);
    return `<tr style="border-bottom:1px solid var(--border);cursor:pointer" onclick="switchTab('orders');setTimeout(()=>openDetail('${z.id}'),50)" onmouseenter="this.style.background='var(--bg)'" onmouseleave="this.style.background=''">
      <td style="padding:9px 12px;font-size:12px;white-space:nowrap">${fmtD(z.termin)||'—'}</td>
      <td style="padding:9px 12px"><div style="font-weight:600;font-size:12px">${esc(z.nazev||'—')}</div><div style="font-size:10px;color:var(--muted)">${esc(z.cislo||'')}</div></td>
      <td style="padding:9px 12px;font-size:12px;color:var(--muted)">${esc(z.zakaznik||'—')}</td>
      <td style="padding:9px 12px;font-size:12px">${esc(z.technik||'—')}</td>
      <td style="padding:9px 12px;text-align:center;font-size:12px;font-weight:${z.hodiny?'700':'400'};color:${z.hodiny?'var(--navy)':'var(--muted)'}">${z.hodiny||'—'}</td>
      <td style="padding:9px 12px;text-align:center;font-size:12px">${z.km||'—'}</td>
      <td style="padding:9px 12px;text-align:right;font-size:12px;font-family:'DM Mono',monospace">${z.km?kn.toLocaleString('cs-CZ',{maximumFractionDigits:0})+' Kč':'—'}</td>
      <td style="padding:9px 12px;text-align:right;font-size:12px;font-weight:600;font-family:'DM Mono',monospace">${z.cena||'—'}</td>
      <td style="padding:9px 12px;text-align:center">${stavBadge(z.stav||'nová')}</td>
    </tr>`;
  }).join('') + `<tr style="border-top:2px solid var(--border);background:#f8fafc;font-weight:700">
    <td colspan="4" style="padding:9px 12px;font-size:12px">Celkem</td>
    <td style="padding:9px 12px;text-align:center;font-size:12px">${totalHodiny.toFixed(1)} h</td>
    <td style="padding:9px 12px;text-align:center;font-size:12px">${totalKm} km</td>
    <td style="padding:9px 12px;text-align:right;font-size:12px;color:var(--green)">${kmNahrady.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč</td>
    <td style="padding:9px 12px;text-align:right;font-size:12px;color:var(--green)">${totalRev.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč</td>
    <td></td>
  </tr>`;

  // Zobraz schválení panel
  const approvalDiv = document.getElementById('vykaz-approval');
  if(approvalDiv) approvalDiv.style.display = all.length ? 'block' : 'none';
  const approveBtn = document.getElementById('vykaz-approve-btn');
  if(approveBtn) approveBtn.style.display = window._currentRole === 'admin' ? '' : 'none';
}

function exportVykazCSV() {
  const {od, doo} = getVykazRange();
  const techFilter = document.getElementById('vykaz-technik')?.value || '';
  function parseCena(c){ return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0; }
  const all = (window._zakazky||[]).filter(z => {
    if(!z.termin) return false;
    if(od && z.termin < od) return false;
    if(doo && z.termin > doo) return false;
    if(techFilter && z.technik !== techFilter) return false;
    return true;
  });
  const rows = [['Datum','Zakázka','Číslo','Zákazník','Technik','Hodiny','Km','Sazba Kč/km','Km náhrada Kč','Cena bez DPH','Stav']];
  all.forEach(z => {
    const ks = z.kmSazba || window._kmSazba;
    rows.push([fmtD(z.termin),z.nazev||'',z.cislo||'',z.zakaznik||'',z.technik||'',z.hodiny||0,z.km||0,ks,(z.km||0)*ks,parseCena(z.cena),z.stav||'nová']);
  });
  const csv = rows.map(r=>r.map(v=>'"'+(v||'').toString().replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Vykaz_${od}_${doo}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function printVykaz() {
  const tbl = document.getElementById('vykaz-tbl');
  if(!tbl) return;
  const pc = document.getElementById('print-container');
  const {od, doo} = getVykazRange();
  const tech = document.getElementById('vykaz-technik')?.value || 'Všichni technici';
  pc.innerHTML = `<div style="padding:20px;font-family:Arial,sans-serif">
    <h2 style="color:#0f1f3d;margin-bottom:4px">Výkaz práce</h2>
    <div style="font-size:12px;color:#6b7a99;margin-bottom:16px">Období: ${fmtD(od)} — ${fmtD(doo)} | Technik: ${esc(tech)}</div>
    ${tbl.outerHTML}
  </div>`;
  window.print();
}

function submitVykaz() {
  const {od, doo} = getVykazRange();
  const me = window._currentUser;
  window._fb.addDoc(window._fb.collection(window._fb.db,'vykazy'), {
    technik: me?.displayName || me?.email || '',
    uid: me?.uid || '',
    od, doo,
    stav: 'odeslan',
    createdAt: window._fb.serverTimestamp()
  }).then(() => {
    document.getElementById('vykaz-status').textContent = '✅ Výkaz odeslán ke schválení — ' + new Date().toLocaleString('cs-CZ');
  }).catch(e => alert('Chyba: '+e.message));
}

function approveVykaz() {
  if(!confirm('Schválit výkaz práce?')) return;
  document.getElementById('vykaz-status').textContent = '✅ Výkaz schválen adminem — ' + new Date().toLocaleString('cs-CZ');
}

// ══ CENÍK ════════════════════════════════════════════════════════
let _cenikItems = [];
let _cenikUnsub = null;

function loadCenik() {
  if(_cenikUnsub) return;
  _cenikUnsub = window._fb.onSnapshot(
    window._fb.query(window._fb.collection(window._fb.db,'cenik'), window._fb.orderBy('nazev','asc')),
    snap => {
      _cenikItems = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderCenik();
      updateCenikKatFilter();
      // Aktualizuj autocomplete v zakázkách
      updateSuggestionsFromCenik();
    }
  );
}

function updateSuggestionsFromCenik() {
  if(!_cenikItems.length) return;
  const cenikSuggestions = _cenikItems.map(i => ({
    label: i.nazev, cen: String(i.cena||''), unit: i.jednotka||'ks'
  }));
  // Přidej do _suggestions pokud existuje
  if(window._suggestions) {
    const existing = new Set(window._suggestions.map(s=>s.label));
    cenikSuggestions.forEach(s => { if(!existing.has(s.label)) window._suggestions.push(s); });
  }
}

function renderCenik() {
  const q   = (document.getElementById('cenik-search')?.value||'').toLowerCase();
  const cat = document.getElementById('cenik-kat')?.value||'';
  const tbody = document.getElementById('cenik-tbody');
  const empty = document.getElementById('cenik-empty');
  if(!tbody) return;

  const filtered = _cenikItems.filter(i => {
    if(cat && i.kategorie !== cat) return false;
    if(q && !(i.nazev||'').toLowerCase().includes(q)) return false;
    return true;
  });

  if(!filtered.length) { tbody.innerHTML=''; if(empty) empty.style.display='block'; return; }
  if(empty) empty.style.display='none';

  tbody.innerHTML = filtered.map((item,idx) => `
    <tr style="border-bottom:1px solid var(--border);${idx%2?'background:var(--bg)':''}">
      <td style="padding:10px 12px">
        <div style="font-weight:600;font-size:13px">${esc(item.nazev||'—')}</div>
        ${item.pozn?`<div style="font-size:10px;color:var(--muted)">${esc(item.pozn)}</div>`:''}
      </td>
      <td style="padding:10px 12px;font-size:12px;color:var(--muted)">${esc(item.kategorie||'—')}</td>
      <td style="padding:10px 12px;text-align:right;font-weight:700;font-family:'DM Mono',monospace;color:var(--green)">${item.cena?parseFloat(item.cena).toLocaleString('cs-CZ',{maximumFractionDigits:2})+' Kč':'—'}</td>
      <td style="padding:10px 12px;font-size:12px;color:var(--muted)">${esc(item.jednotka||'ks')}</td>
      <td style="padding:8px 12px;text-align:right;white-space:nowrap">
        <button onclick="openCenikModal('${item.id}')" style="font-size:11px;padding:4px 9px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;margin-right:4px">✎</button>
        <button onclick="deleteCenikItem('${item.id}')" style="font-size:11px;padding:4px 9px;border:1px solid #fecaca;border-radius:6px;background:#fff5f5;color:#dc2626;cursor:pointer">🗑</button>
      </td>
    </tr>`).join('');
}

function updateCenikKatFilter() {
  const sel = document.getElementById('cenik-kat');
  const dl  = document.getElementById('cenik-kat-list');
  if(!sel) return;
  const cats = [...new Set(_cenikItems.map(i=>i.kategorie||'').filter(Boolean))].sort();
  const cur = sel.value;
  sel.innerHTML = '<option value="">Všechny kategorie</option>' + cats.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join('');
  sel.value = cur;
  if(dl) dl.innerHTML = cats.map(c=>`<option value="${esc(c)}">`).join('');
}

function openCenikModal(id) {
  const item = id ? _cenikItems.find(i=>i.id===id) : null;
  document.getElementById('cenik-edit-id').value = id||'';
  document.getElementById('cenik-modal-title').textContent = id ? 'Upravit položku' : 'Přidat položku ceníku';
  document.getElementById('cenik-nazev').value    = item?.nazev||'';
  document.getElementById('cenik-kat-inp').value  = item?.kategorie||'';
  document.getElementById('cenik-jednotka').value = item?.jednotka||'ks';
  document.getElementById('cenik-cena').value     = item?.cena||'';
  document.getElementById('cenik-dph').value      = String(item?.dph??21);
  document.getElementById('cenik-pozn').value     = item?.pozn||'';
  document.getElementById('cenik-modal').classList.add('open');
}

async function saveCenikItem() {
  const id = document.getElementById('cenik-edit-id').value;
  const nazev = document.getElementById('cenik-nazev').value.trim();
  if(!nazev) { alert('Zadejte název položky'); return; }
  const data = {
    nazev,
    kategorie: document.getElementById('cenik-kat-inp').value.trim(),
    jednotka:  document.getElementById('cenik-jednotka').value.trim()||'ks',
    cena:      parseFloat(document.getElementById('cenik-cena').value)||0,
    dph:       parseInt(document.getElementById('cenik-dph').value)||21,
    pozn:      document.getElementById('cenik-pozn').value.trim(),
    updatedAt: window._fb.serverTimestamp()
  };
  try {
    if(id) { await window._fb.updateDoc(window._fb.doc(window._fb.db,'cenik',id), data); }
    else { data.createdAt=window._fb.serverTimestamp(); await window._fb.addDoc(window._fb.collection(window._fb.db,'cenik'), data); }
    closeModal('cenik-modal');
  } catch(e) { alert('Chyba: '+e.message); }
}

async function deleteCenikItem(id) {
  if(!confirm('Smazat tuto položku ceníku?')) return;
  window._fb.deleteDoc(window._fb.doc(window._fb.db,'cenik',id)).catch(e=>alert('Chyba: '+e.message));
}

// ══ GALERIE FOTEK ════════════════════════════════════════════════
function renderGalerie() {
  const grid  = document.getElementById('galerie-grid');
  const empty = document.getElementById('galerie-empty');
  const stats = document.getElementById('galerie-stats');
  if(!grid) return;

  const techFilter  = document.getElementById('galerie-technik')?.value||'';
  const monthFilter = document.getElementById('galerie-month')?.value||'';

  // Aktualizuj technik select
  const techSel = document.getElementById('galerie-technik');
  if(techSel) {
    const techs = [...new Set((window._zakazky||[]).map(z=>z.technik||'').filter(Boolean))].sort();
    const cur = techSel.value;
    techSel.innerHTML = '<option value="">Všichni technici</option>' + techs.map(t=>`<option value="${esc(t)}">${esc(t)}</option>`).join('');
    techSel.value = cur;
  }

  // Nastav výchozí měsíc
  const monthEl = document.getElementById('galerie-month');
  if(monthEl && !monthEl.value) monthEl.value = new Date().toISOString().slice(0,7);

  const effectiveMonth = monthFilter || new Date().toISOString().slice(0,7);

  // Sbírej všechny fotky
  const allPhotos = [];
  (window._zakazky||[]).forEach(z => {
    if(techFilter && z.technik !== techFilter) return;
    if(effectiveMonth && !(z.termin||'').startsWith(effectiveMonth)) return;
    (z.photos||[]).forEach(p => {
      if(p.dataUrl) allPhotos.push({
        url: p.dataUrl, zakazkaId: z.id, zakazkaNazev: z.nazev||'—',
        zakazkaZakaznik: z.zakaznik||'', cislo: z.cislo||'',
        technik: z.technik||'', termin: z.termin||'', caption: p.caption||''
      });
    });
  });

  if(stats) stats.textContent = `${allPhotos.length} fotografií z ${(window._zakazky||[]).filter(z=>techFilter?z.technik===techFilter:true).filter(z=>!(effectiveMonth)||((z.termin||'').startsWith(effectiveMonth))).length} zakázek`;

  if(!allPhotos.length) {
    grid.innerHTML=''; if(empty) empty.style.display='block'; return;
  }
  if(empty) empty.style.display='none';

  grid.innerHTML = allPhotos.map(p => `
    <div style="border-radius:10px;overflow:hidden;border:1px solid var(--border);background:var(--card);cursor:pointer"
      onclick="openLightbox('${p.url}')">
      <div style="aspect-ratio:4/3;overflow:hidden;background:#f0f2f6">
        <img src="${p.url}" alt="${esc(p.caption)}" style="width:100%;height:100%;object-fit:cover;transition:transform .3s"
          onmouseenter="this.style.transform='scale(1.05)'" onmouseleave="this.style.transform=''">
      </div>
      <div style="padding:8px 10px">
        <div style="font-size:11px;font-weight:600;color:var(--navy);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.zakazkaNazev)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:1px">${esc(p.zakazkaZakaznik)} · ${fmtD(p.termin)}</div>
        ${p.caption?`<div style="font-size:10px;color:var(--blue);margin-top:2px;font-style:italic">${esc(p.caption.substring(0,50))}</div>`:''}
      </div>
    </div>`).join('');
}

// ══ MAPA TECHNIKŮ ════════════════════════════════════════════════
function openMapaTechniku() {
  document.getElementById('mapa-modal').classList.add('open');
  setTimeout(() => renderMapaTechniku(), 200);
}

function renderMapaTechniku() {
  const content = document.getElementById('mapa-content');
  const legend  = document.getElementById('mapa-legend');
  if(!content) return;

  // Sbírej technici s polohou
  const techniciSPolohou = (window._zakazky||[])
    .filter(z => z.techLat && z.techLng)
    .map(z => ({
      lat: z.techLat, lng: z.techLng, name: z.technik||'—',
      nazev: z.nazev, stav: z.stav, ts: z.techPolohaTs
    }));

  // Zakázky s adresou (pro zobrazení jako body na mapě)
  const zakazkyBAdr = (window._zakazky||[])
    .filter(z => z.adresa && !['zpracovaná','zaplacena'].includes(z.stav||'nová'))
    .slice(0,20);

  // Použij Leaflet + OpenStreetMap (zdarma, bez API klíče)
  if(typeof L === 'undefined') {
    // Načti Leaflet dynamicky
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);

    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = () => initLeafletMap(content, techniciSPolohou, zakazkyBAdr);
    document.head.appendChild(script);
  } else {
    initLeafletMap(content, techniciSPolohou, zakazkyBAdr);
  }

  // Legend
  if(legend) {
    legend.innerHTML = `
      <span>🟢 Technik (GPS z "Na cestě")</span>
      <span>🔵 Zakázka s adresou</span>
      <span style="color:var(--muted)">Mapa: OpenStreetMap (zdarma)</span>
    `;
  }
}

function initLeafletMap(container, technici, zakazky) {
  container.style.height = '400px';

  // Zruš existující mapu
  if(container._leaflet_id) {
    try { container._leafletMap?.remove(); } catch(e) {}
  }

  const map = L.map(container).setView([49.8, 15.5], 7);
  container._leafletMap = map;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap',
    maxZoom: 18
  }).addTo(map);

  // Technici
  technici.forEach(t => {
    const marker = L.circleMarker([t.lat, t.lng], {
      radius: 10, fillColor: '#6abf3e', color: '#fff',
      weight: 2, fillOpacity: 0.9
    }).addTo(map);
    marker.bindPopup(`<strong>🔧 ${esc(t.name)}</strong><br>${esc(t.nazev||'—')}<br><small>${t.ts ? new Date(t.ts).toLocaleString('cs-CZ') : ''}</small>`);
  });

  // Zakázky s adresou — geocoduj první 3
  zakazky.slice(0,3).forEach(z => {
    fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(z.adresa)}&format=json&limit=1`, {
      headers: {'User-Agent':'AcEuro-Service/1.0'}
    }).then(r=>r.json()).then(data => {
      if(!data[0]) return;
      const m = L.marker([data[0].lat, data[0].lon]).addTo(map);
      m.bindPopup(`<strong>${esc(z.nazev||'—')}</strong><br>${esc(z.zakaznik||'')}<br>${esc(z.adresa)}`);
    }).catch(()=>{});
  });
}

// ══ SMS ZÁKAZNÍKOVI ═══════════════════════════════════════════════
function getSmsSettings() {
  try { return JSON.parse(localStorage.getItem('sms-cfg')||'{}'); } catch(e) { return {}; }
}

function saveSmsSettings() {
  const cfg = {
    provider: document.getElementById('sms-provider')?.value||'none',
    appId:    document.getElementById('sms-app-id')?.value.trim()||'',
    token:    document.getElementById('sms-token')?.value.trim()||'',
    text:     document.getElementById('sms-text')?.value||''
  };
  localStorage.setItem('sms-cfg', JSON.stringify(cfg));
  closeModal('sms-settings-modal');
  alert('✅ SMS nastavení uloženo');
}

function updateSmsProviderHelp() {
  const p = document.getElementById('sms-provider')?.value;
  const kl = document.getElementById('sms-key-label');
  const tl = document.getElementById('sms-token-label');
  if(kl) kl.textContent = p==='twilio' ? 'Account SID' : 'Application ID';
  if(tl) tl.textContent = p==='twilio' ? 'Auth Token' : 'Application Token';
}

async function sendSmsZakaznikovi(zakazka) {
  const cfg = getSmsSettings();
  if(!cfg.provider || cfg.provider === 'none') return;
  if(!zakazka?.telZakaznik && !zakazka?.tel) return; // Nemáme telefon zákazníka

  const tel = zakazka.telZakaznik || zakazka.tel || '';
  const me  = window._currentUser;
  let text  = (cfg.text || 'Váš technik {technik} je na cestě. Zakázka: {nazev}')
    .replace('{technik}', me?.displayName || me?.email || 'technik')
    .replace('{nazev}',   zakazka.nazev||'—')
    .replace('{cislo}',   zakazka.cislo||'—')
    .replace('{termin}',  fmtD(zakazka.termin)||'—');

  // BulkGate API
  if(cfg.provider === 'bulkgate') {
    try {
      const res = await fetch('https://portal.bulkgate.com/api/1.0/simple/transactional', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          application_id: cfg.appId,
          application_token: cfg.token,
          number: tel.replace(/\s/g,''),
          text, unicode: false, flash: false, sender_id: 'gSystem'
        })
      });
      console.log('SMS odeslaná:', await res.json());
    } catch(e) { console.warn('SMS error:', e); }
  }
}

async function testSms() {
  const tel = document.getElementById('sms-test-tel')?.value.trim();
  if(!tel) { alert('Zadejte testovací telefonní číslo'); return; }
  await sendSmsZakaznikovi({tel, nazev:'Testovací zakázka', cislo:'TEST', termin: new Date().toISOString().slice(0,10)});
  alert('Test SMS odeslán (zkontrolujte BulkGate dashboard)');
}

// Přidej SMS nastavení odkaz do kanceláře (vedle notif tlačítka)
(function addSmsBtn() {
  setTimeout(() => {
    const notifBtn = document.querySelector('[onclick*="notif-settings-modal"]');
    if(!notifBtn || notifBtn._smsAdded) return;
    const smsBtn = document.createElement('button');
    smsBtn.className = 'btn btn-ghost';
    smsBtn.style.cssText = 'font-size:11px;padding:5px 10px';
    smsBtn.title = 'Nastavení SMS';
    smsBtn.textContent = '📱';
    smsBtn.onclick = () => document.getElementById('sms-settings-modal').classList.add('open');
    notifBtn.after(smsBtn);
    notifBtn._smsAdded = true;
  }, 1000);
})();

// ══ SWITCHAB OVERRIDE — načti nové taby ═══════════════════════════
(function overrideSwitchTabForNewTabs() {
  let attempts = 0;
  const iv = setInterval(() => {
    attempts++;
    if(typeof switchTab !== 'undefined' || attempts > 30) {
      clearInterval(iv);
      if(typeof switchTab === 'undefined') return;
      const prev = switchTab;
      switchTab = function(tab) {
        prev(tab);
        if(tab === 'vykaz')   { renderVykaz(); }
        if(tab === 'cenik')   { loadCenik(); }
        if(tab === 'galerie') { renderGalerie(); }
      };
    }
  }, 300);
})();

// ══ INIT ═════════════════════════════════════════════════════════
// Načti km sazbu
const kmSazbaInput = document.getElementById('d-km-sazba');
if(kmSazbaInput) {
  kmSazbaInput.addEventListener('change', () => {
    window._kmSazba = parseFloat(kmSazbaInput.value)||5.60;
    localStorage.setItem('km-sazba', String(window._kmSazba));
  });
}

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 5 — mazání fotek, grafická anotace, modul zákazníků
// ════════════════════════════════════════════════════════════════

// ══ MAZÁNÍ FOTEK V KANCELÁŘI ══════════════════════════════════════
async function deleteKancelPhoto(zakazkaId, photoIndex) {
  if(!confirm('Smazat tuto fotografii?')) return;
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z || !z.photos) return;

  const photo = z.photos[photoIndex];

  // Pokus o smazání z Firebase Storage
  if(photo?.cloudUrl && window._fb?.storage) {
    try {
      // Extrahuj cestu ze URL
      const url = new URL(photo.cloudUrl);
      const path = decodeURIComponent(url.pathname.split('/o/')[1]?.split('?')[0]||'');
      if(path) {
        const storageRef = window._fb.ref(window._fb.storage, path);
        await window._fb.deleteObject(storageRef).catch(()=>{}); // ignoruj chybu pokud soubor neexistuje
      }
    } catch(e) { console.warn('Storage delete:', e); }
  }

  // Odeber z pole
  z.photos.splice(photoIndex, 1);

  // Ulož do Firestore
  try {
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', zakazkaId),
      { photos: z.photos, updatedAt: window._fb.serverTimestamp() }
    );
    // Překresli detail
    openDetail && openDetail(zakazkaId);
  } catch(e) {
    alert('Chyba při mazání: ' + e.message);
    z.photos.splice(photoIndex, 0, photo); // vrať zpět při chybě
  }
}

// ══ GRAFICKÁ ANOTACE FOTEK ════════════════════════════════════════
let _annotCtx = null;
let _annotCanvas = null;
let _annotImg = new Image();
let _annotDrawing = false;
let _annotTool = 'pen';
let _annotColor = '#ff0000';
let _annotSize = 4;
let _annotStartX = 0;
let _annotStartY = 0;
let _annotHistory = []; // stack ImageData pro undo
let _annotZakazkaId = null;
let _annotPhotoIndex = -1;

function openPhotoAnnot(zakazkaId, photoIndex) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z?.photos?.[photoIndex]) return;

  _annotZakazkaId = zakazkaId;
  _annotPhotoIndex = photoIndex;
  _annotHistory = [];

  const photo = z.photos[photoIndex];
  const src = photo.cloudUrl || photo.dataUrl;

  document.getElementById('annot-modal').classList.add('open');

  _annotImg = new Image();
  _annotImg.crossOrigin = 'anonymous';
  _annotImg.onload = () => {
    _annotCanvas = document.getElementById('annot-canvas');
    if(!_annotCanvas) return;

    // Nastav rozměry
    const maxW = Math.min(_annotImg.width, window.innerWidth * 0.9);
    const maxH = Math.min(_annotImg.height, window.innerHeight * 0.7);
    const scale = Math.min(maxW/_annotImg.width, maxH/_annotImg.height, 1);
    _annotCanvas.width  = Math.round(_annotImg.width * scale);
    _annotCanvas.height = Math.round(_annotImg.height * scale);

    _annotCtx = _annotCanvas.getContext('2d');
    _annotCtx.drawImage(_annotImg, 0, 0, _annotCanvas.width, _annotCanvas.height);

    // Uložit první stav do undo history
    _annotHistory = [_annotCtx.getImageData(0, 0, _annotCanvas.width, _annotCanvas.height)];

    initAnnotEvents();
  };
  _annotImg.onerror = () => {
    // Pokud CORS selže, zkusíme dataUrl
    if(src !== photo.dataUrl && photo.dataUrl) {
      _annotImg.src = photo.dataUrl;
    } else {
      alert('Fotografii nelze otevřít pro anotaci (CORS omezení).');
      closeModal('annot-modal');
    }
  };
  _annotImg.src = src;
}

function getAnnotPos(e) {
  const rect = _annotCanvas.getBoundingClientRect();
  const scaleX = _annotCanvas.width / rect.width;
  const scaleY = _annotCanvas.height / rect.height;
  const touch = e.touches?.[0] || e;
  return {
    x: (touch.clientX - rect.left) * scaleX,
    y: (touch.clientY - rect.top)  * scaleY
  };
}

function initAnnotEvents() {
  const c = _annotCanvas;
  if(c._annotReady) {
    c.onmousedown = c.ontouchstart = handleAnnotStart;
    c.onmousemove = c.ontouchmove  = handleAnnotMove;
    c.onmouseup   = c.ontouchend   =
    c.onmouseleave                 = handleAnnotEnd;
    return;
  }
  c._annotReady = true;
  c.onmousedown = c.ontouchstart = handleAnnotStart;
  c.onmousemove = c.ontouchmove  = handleAnnotMove;
  c.onmouseup   = c.ontouchend   =
  c.onmouseleave                 = handleAnnotEnd;

  // Ctrl+Z
  document.addEventListener('keydown', e => {
    if(e.ctrlKey && e.key === 'z' && document.getElementById('annot-modal')?.classList.contains('open')) {
      e.preventDefault();
      annotUndo();
    }
    if(e.key === 'Escape') closeModal('annot-modal');
  });
}

function handleAnnotStart(e) {
  e.preventDefault();
  _annotDrawing = true;
  _annotTool  = document.getElementById('annot-tool')?.value || 'pen';
  _annotColor = document.getElementById('annot-color')?.value || '#ff0000';
  _annotSize  = parseInt(document.getElementById('annot-size')?.value) || 4;

  const pos = getAnnotPos(e);
  _annotStartX = pos.x;
  _annotStartY = pos.y;

  // Ulož stav před kreslením
  _annotHistory.push(_annotCtx.getImageData(0, 0, _annotCanvas.width, _annotCanvas.height));
  if(_annotHistory.length > 30) _annotHistory.shift();

  if(_annotTool === 'pen' || _annotTool === 'eraser') {
    _annotCtx.beginPath();
    _annotCtx.moveTo(pos.x, pos.y);
  }

  if(_annotTool === 'text') {
    const txt = prompt('Zadejte text pro anotaci:');
    if(txt) {
      _annotCtx.font = `bold ${_annotSize * 5}px Arial`;
      _annotCtx.fillStyle = _annotColor;
      _annotCtx.strokeStyle = '#000';
      _annotCtx.lineWidth = 1;
      _annotCtx.strokeText(txt, pos.x, pos.y);
      _annotCtx.fillText(txt, pos.x, pos.y);
    }
    _annotDrawing = false;
    return;
  }
}

function handleAnnotMove(e) {
  if(!_annotDrawing) return;
  e.preventDefault();
  const pos = getAnnotPos(e);

  if(_annotTool === 'pen') {
    _annotCtx.lineTo(pos.x, pos.y);
    _annotCtx.strokeStyle = _annotColor;
    _annotCtx.lineWidth   = _annotSize;
    _annotCtx.lineCap     = 'round';
    _annotCtx.lineJoin    = 'round';
    _annotCtx.stroke();
  } else if(_annotTool === 'eraser') {
    _annotCtx.lineTo(pos.x, pos.y);
    _annotCtx.strokeStyle = 'rgba(0,0,0,1)';
    _annotCtx.globalCompositeOperation = 'destination-out';
    _annotCtx.lineWidth = _annotSize * 4;
    _annotCtx.lineCap   = 'round';
    _annotCtx.stroke();
    _annotCtx.globalCompositeOperation = 'source-over';
  } else {
    // Pro shapes — překresli z posledního history stavu
    if(_annotHistory.length) {
      _annotCtx.putImageData(_annotHistory[_annotHistory.length-1], 0, 0);
    }
    _annotCtx.strokeStyle = _annotColor;
    _annotCtx.lineWidth   = _annotSize;
    _annotCtx.fillStyle   = 'transparent';

    if(_annotTool === 'rect') {
      _annotCtx.strokeRect(_annotStartX, _annotStartY, pos.x-_annotStartX, pos.y-_annotStartY);
    } else if(_annotTool === 'circle') {
      const rx = Math.abs(pos.x - _annotStartX) / 2;
      const ry = Math.abs(pos.y - _annotStartY) / 2;
      const cx = (_annotStartX + pos.x) / 2;
      const cy = (_annotStartY + pos.y) / 2;
      _annotCtx.beginPath();
      _annotCtx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI*2);
      _annotCtx.stroke();
    } else if(_annotTool === 'arrow') {
      drawArrow(_annotCtx, _annotStartX, _annotStartY, pos.x, pos.y, _annotColor, _annotSize);
    }
  }
}

function handleAnnotEnd(e) {
  if(!_annotDrawing) return;
  _annotDrawing = false;
  _annotCtx.beginPath(); // reset path
}

function drawArrow(ctx, x1, y1, x2, y2, color, size) {
  const angle = Math.atan2(y2-y1, x2-x1);
  const headLen = size * 5;
  ctx.strokeStyle = color;
  ctx.fillStyle   = color;
  ctx.lineWidth   = size;
  ctx.lineCap = 'round';
  // Tělo šipky
  ctx.beginPath();
  ctx.moveTo(x1, y1);
  ctx.lineTo(x2, y2);
  ctx.stroke();
  // Hlavička
  ctx.beginPath();
  ctx.moveTo(x2, y2);
  ctx.lineTo(x2 - headLen*Math.cos(angle-Math.PI/6), y2 - headLen*Math.sin(angle-Math.PI/6));
  ctx.lineTo(x2 - headLen*Math.cos(angle+Math.PI/6), y2 - headLen*Math.sin(angle+Math.PI/6));
  ctx.closePath();
  ctx.fill();
}

function annotUndo() {
  if(_annotHistory.length <= 1) return; // zachovej původní obrázek
  _annotHistory.pop();
  _annotCtx.putImageData(_annotHistory[_annotHistory.length-1], 0, 0);
}

function annotClear() {
  if(!confirm('Smazat všechny anotace?')) return;
  // Vrať na původní obrázek (první history stav)
  if(_annotHistory.length) {
    _annotCtx.putImageData(_annotHistory[0], 0, 0);
    _annotHistory = [_annotHistory[0]];
  }
}

async function saveAnnotation() {
  if(!_annotCanvas || !_annotZakazkaId || _annotPhotoIndex < 0) return;

  const btn = document.querySelector('#annot-modal .btn-green');
  if(btn) { btn.disabled = true; btn.textContent = '⏳ Ukládám…'; }

  try {
    const annotatedDataUrl = _annotCanvas.toDataURL('image/jpeg', 0.88);
    const z = (window._zakazky||[]).find(x=>x.id===_annotZakazkaId);
    if(!z?.photos?.[_annotPhotoIndex]) throw new Error('Zakázka nebo foto nenalezena');

    // Ulož anotovanou verzi
    z.photos[_annotPhotoIndex].dataUrl = annotatedDataUrl;
    // Cloud URL zrušit — je to nový obrázek
    z.photos[_annotPhotoIndex].cloudUrl = '';
    z.photos[_annotPhotoIndex].annotated = true;

    // Upload do Storage pokud online
    if(navigator.onLine && window._fb?.storage) {
      try {
        const user = window._currentUser;
        const path = `photos/${user?.uid||'anon'}/${Date.now()}_annotated.jpg`;
        const storageRef = window._fb.ref(window._fb.storage, path);
        const res = await fetch(annotatedDataUrl);
        const blob = await res.blob();
        await window._fb.uploadBytes(storageRef, blob);
        z.photos[_annotPhotoIndex].cloudUrl = await window._fb.getDownloadURL(storageRef);
      } catch(e) { console.warn('Upload annotated:', e); }
    }

    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', _annotZakazkaId),
      { photos: z.photos, updatedAt: window._fb.serverTimestamp() }
    );

    closeModal('annot-modal');
    openDetail && openDetail(_annotZakazkaId);
  } catch(e) {
    alert('Chyba při ukládání: ' + e.message);
  } finally {
    if(btn) { btn.disabled = false; btn.textContent = '💾 Uložit anotaci'; }
  }
}

// ══ MODUL ZÁKAZNÍKŮ ══════════════════════════════════════════════
let _zakaznici = [];
let _zakazniciUnsub = null;
let _activeZakId = null;

function loadZakaznici() {
  if(_zakazniciUnsub) return;
  _zakazniciUnsub = window._fb.onSnapshot(
    window._fb.query(
      window._fb.collection(window._fb.db, 'zakaznici'),
      window._fb.orderBy('nazev', 'asc')
    ),
    snap => {
      _zakaznici = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderZakaznici();
    }
  );
}

function renderZakaznici() {
  const list  = document.getElementById('zak-list');
  const cntEl = document.getElementById('zak-count');
  if(!list) return;

  const q   = (document.getElementById('zak-search')?.value||'').toLowerCase();
  const typ = document.getElementById('zak-filter-typ')?.value||'';

  const filtered = _zakaznici.filter(z => {
    if(typ && z.typ !== typ) return false;
    if(q && ![ z.nazev, z.ico, z.email, z.tel, z.adresa, z.kontakt ]
      .some(f => (f||'').toLowerCase().includes(q))) return false;
    return true;
  });

  if(cntEl) cntEl.textContent = `${filtered.length} zákazníků`;

  const typIcon = {firma:'🏢', fyzicka:'👤', vip:'⭐'};
  list.innerHTML = filtered.length ? filtered.map(z => {
    // Počet zakázek tohoto zákazníka
    const zakCount = (window._zakazky||[]).filter(zak =>
      zak.zakaznik === z.nazev || zak.ico === z.ico
    ).length;
    return `<div class="zcard${z.id===_activeZakId?' active':''}"
      style="padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border)"
      onclick="openZakDetail('${z.id}')">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:32px;height:32px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">
          ${typIcon[z.typ]||'👤'}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:13px;color:var(--navy);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(z.nazev||'—')}</div>
          <div style="font-size:11px;color:var(--muted)">${z.ico?'IČO: '+esc(z.ico)+' · ':''} ${esc(z.tel||z.email||'')}</div>
        </div>
        <div style="font-size:10px;color:var(--muted);flex-shrink:0;text-align:right">
          ${zakCount} zak.<br>
          ${z.adresa?`<span style="font-size:9px">${esc(z.adresa.substring(0,20))}</span>`:''}
        </div>
      </div>
    </div>`;
  }).join('') : '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Žádní zákazníci</div>';
}

function openZakDetail(id) {
  _activeZakId = id;
  renderZakaznici(); // aktualizuj active stav

  const z = _zakaznici.find(x=>x.id===id);
  if(!z) return;

  const detail = document.getElementById('zak-detail');
  const empty  = document.getElementById('zak-detail-empty');
  if(!detail) return;
  detail.style.display = 'block';
  if(empty) empty.style.display = 'none';

  // Historie zakázek tohoto zákazníka
  const zakHist = (window._zakazky||[])
    .filter(zak => zak.zakaznik === z.nazev || (z.ico && zak.ico === z.ico))
    .sort((a,b) => (b.termin||'').localeCompare(a.termin||''));

  const typIcon = {firma:'🏢', fyzicka:'👤', vip:'⭐'};
  const totalRev = zakHist.reduce((s,zak) => {
    return s + (parseFloat((zak.cena||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0);
  }, 0);

  detail.innerHTML = `
    <!-- Header zákazníka -->
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
      <div style="display:flex;align-items:center;gap:14px">
        <div style="width:56px;height:56px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0">
          ${typIcon[z.typ]||'👤'}
        </div>
        <div>
          <h2 style="font-size:18px;font-weight:800;color:var(--navy);margin:0 0 3px">${esc(z.nazev||'—')}</h2>
          ${z.ico?`<div style="font-size:12px;color:var(--muted)">IČO: <strong>${esc(z.ico)}</strong>${z.dic?' · DIČ: '+esc(z.dic):''}</div>`:''}
          ${z.adresa?`<div style="font-size:12px;color:var(--muted)">${esc(z.adresa)}</div>`:''}
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${z.tel?`<a href="tel:${z.tel}" class="btn btn-ghost" style="font-size:11px;text-decoration:none">📞 ${esc(z.tel)}</a>`:''}
        ${z.email?`<a href="mailto:${z.email}" class="btn btn-ghost" style="font-size:11px;text-decoration:none">✉️ ${esc(z.email)}</a>`:''}
        ${z.adresa?`<a href="https://maps.google.com/?q=${encodeURIComponent(z.adresa)}" target="_blank" class="btn btn-ghost" style="font-size:11px;text-decoration:none">🗺 Mapa</a>`:''}
        <button onclick="openZakaznikModal('${z.id}')" class="btn btn-ghost" style="font-size:11px">✎ Upravit</button>
        <button onclick="openHodnoceniLink('${z.id}')" class="btn btn-ghost" style="font-size:11px" title="Odeslat zákazníkovi odkaz na hodnocení">⭐ Hodnocení</button>
        <button onclick="newZakazkaForZakaznik('${z.id}')" class="btn btn-green" style="font-size:11px">+ Nová zakázka</button>
      </div>
    </div>

    <!-- Stats -->
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-bottom:20px">
      <div class="stat-card"><div class="val">${zakHist.length}</div><div class="lbl">Celkem zakázek</div></div>
      <div class="stat-card"><div class="val" style="font-size:14px">${totalRev.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč</div><div class="lbl">Celkový obrat</div></div>
      <div class="stat-card"><div class="val">${zakHist.filter(z=>z.stav==='zaplacena').length}</div><div class="lbl">Zaplacených</div></div>
      <div class="stat-card"><div class="val" style="color:var(--warn)">${zakHist.filter(z=>z.stav==='fakturovaná').length}</div><div class="lbl">Nezaplacených</div></div>
    </div>

    <!-- Kontaktní info -->
    ${z.kontakt||z.pozn?`<div class="dsec" style="margin-bottom:14px">
      <div class="dsec-hdr">📋 Kontakt a poznámky</div>
      <div class="dsec-body" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        ${z.kontakt?`<div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Kontaktní osoba</div><div style="font-size:13px">${esc(z.kontakt)}</div></div>`:''}
        ${z.pozn?`<div style="grid-column:1/-1"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:2px">Poznámky</div><div style="font-size:12px;white-space:pre-wrap">${esc(z.pozn)}</div></div>`:''}
      </div>
    </div>`:''}

    <!-- Historie zakázek -->
    <div class="dsec">
      <div class="dsec-hdr" style="justify-content:space-between">
        <span>📦 Historie zakázek (${zakHist.length})</span>
      </div>
      <div class="dsec-body" style="padding:0">
        ${zakHist.length ? `<table style="width:100%;border-collapse:collapse;font-size:12px">
          <thead><tr style="background:var(--bg)">
            <th style="padding:8px 12px;text-align:left;font-weight:700;color:var(--navy)">Datum</th>
            <th style="padding:8px 12px;text-align:left;font-weight:700;color:var(--navy)">Zakázka</th>
            <th style="padding:8px 12px;text-align:left;font-weight:700;color:var(--navy)">Technik</th>
            <th style="padding:8px 12px;text-align:right;font-weight:700;color:var(--green)">Cena</th>
            <th style="padding:8px 12px;text-align:center;font-weight:700;color:var(--navy)">Stav</th>
          </tr></thead>
          <tbody>${zakHist.map(zak=>`
            <tr style="border-bottom:1px solid var(--border);cursor:pointer"
              onclick="switchTab('orders');setTimeout(()=>openDetail('${zak.id}'),50)"
              onmouseenter="this.style.background='var(--bg)'" onmouseleave="this.style.background=''">
              <td style="padding:8px 12px;white-space:nowrap">${fmtD(zak.termin)||'—'}</td>
              <td style="padding:8px 12px"><div style="font-weight:600">${esc(zak.nazev||'—')}</div><div style="font-size:10px;color:var(--muted)">${esc(zak.cislo||'')}</div></td>
              <td style="padding:8px 12px;color:var(--muted)">${esc(zak.technik||'—')}</td>
              <td style="padding:8px 12px;text-align:right;font-family:'DM Mono',monospace;font-weight:600;color:var(--green)">${zak.cena||'—'}</td>
              <td style="padding:8px 12px;text-align:center">${stavBadge(zak.stav||'nová')}</td>
            </tr>`).join('')}
          </tbody>
        </table>` : '<div style="padding:16px;color:var(--muted);font-style:italic;font-size:12px">Žádné zakázky</div>'}
      </div>
    </div>
  `;
}

function openZakaznikModal(id) {
  const z = id ? _zakaznici.find(x=>x.id===id) : null;
  document.getElementById('zakaznik-edit-id').value = id||'';
  document.getElementById('zakaznik-modal-title').textContent = id ? 'Upravit zákazníka' : 'Přidat zákazníka';
  document.getElementById('zak-nazev').value   = z?.nazev||'';
  document.getElementById('zak-ico').value     = z?.ico||'';
  document.getElementById('zak-dic').value     = z?.dic||'';
  document.getElementById('zak-adresa').value  = z?.adresa||'';
  document.getElementById('zak-tel').value     = z?.tel||'';
  document.getElementById('zak-email').value   = z?.email||'';
  document.getElementById('zak-kontakt').value = z?.kontakt||'';
  document.getElementById('zak-typ').value     = z?.typ||'firma';
  document.getElementById('zak-pozn').value    = z?.pozn||'';
  document.getElementById('zakaznik-modal').classList.add('open');
}

async function aresLookupZak() {
  const ico = document.getElementById('zak-ico')?.value.trim();
  if(ico.length !== 8) return;
  try {
    const r = await fetch(`https://ares.gov.cz/ekonomicke-subjekty-v-be/rest/ekonomicke-subjekty/${ico}`);
    if(!r.ok) return;
    const d = await r.json();
    if(d.obchodniJmeno) document.getElementById('zak-nazev').value = d.obchodniJmeno;
    if(d.sidlo?.textovaAdresa) document.getElementById('zak-adresa').value = d.sidlo.textovaAdresa;
    if(d.dic) document.getElementById('zak-dic').value = d.dic;
  } catch(e) { /* ARES nedostupný */ }
}

async function saveZakaznik() {
  const id    = document.getElementById('zakaznik-edit-id').value;
  const nazev = document.getElementById('zak-nazev')?.value.trim();
  if(!nazev) { alert('Zadejte název zákazníka'); return; }

  const data = {
    nazev,
    ico:     document.getElementById('zak-ico')?.value.trim()||'',
    dic:     document.getElementById('zak-dic')?.value.trim()||'',
    adresa:  document.getElementById('zak-adresa')?.value.trim()||'',
    tel:     document.getElementById('zak-tel')?.value.trim()||'',
    email:   document.getElementById('zak-email')?.value.trim()||'',
    kontakt: document.getElementById('zak-kontakt')?.value.trim()||'',
    typ:     document.getElementById('zak-typ')?.value||'firma',
    pozn:    document.getElementById('zak-pozn')?.value.trim()||'',
    updatedAt: window._fb.serverTimestamp()
  };

  try {
    if(id) {
      await window._fb.updateDoc(window._fb.doc(window._fb.db,'zakaznici',id), data);
    } else {
      data.createdAt = window._fb.serverTimestamp();
      const ref = await window._fb.addDoc(window._fb.collection(window._fb.db,'zakaznici'), data);
      _activeZakId = ref.id;
    }
    closeModal('zakaznik-modal');
  } catch(e) { alert('Chyba: '+e.message); }
}

async function deleteZakaznik(id) {
  if(!confirm('Smazat zákazníka? Zakázky zůstanou zachovány.')) return;
  window._fb.deleteDoc(window._fb.doc(window._fb.db,'zakaznici',id))
    .then(() => {
      if(_activeZakId === id) {
        _activeZakId = null;
        document.getElementById('zak-detail').style.display = 'none';
        document.getElementById('zak-detail-empty').style.display = 'flex';
      }
    })
    .catch(e => alert('Chyba: '+e.message));
}

function newZakazkaForZakaznik(zakaznikId) {
  const z = _zakaznici.find(x=>x.id===zakaznikId);
  if(!z) return;
  switchTab('orders');
  setTimeout(() => {
    openAddZakazkaModal && openAddZakazkaModal();
    setTimeout(() => {
      // Předvyplň zákazníka
      const inp = document.getElementById('nz-zakaznik') || document.getElementById('f_zakaznik');
      if(inp) { inp.value = z.nazev; inp.dispatchEvent(new Event('input')); }
      const adresa = document.getElementById('nz-adresa') || document.getElementById('f_adresa');
      if(adresa) { adresa.value = z.adresa||''; }
      const ico = document.getElementById('nz-ico') || document.getElementById('f_ico');
      if(ico) { ico.value = z.ico||''; }
    }, 200);
  }, 100);
}

// Importuj existující zákazníky ze zakázek (jednorázový helper)
async function importZakazniciFromZakazky() {
  const existing = new Set(_zakaznici.map(z=>z.nazev));
  const toImport = [];
  const seen = new Set();
  (window._zakazky||[]).forEach(zak => {
    const n = (zak.zakaznik||'').trim();
    if(!n || seen.has(n) || existing.has(n)) return;
    seen.add(n);
    toImport.push({ nazev: n, ico: zak.ico||'', dic: zak.dic||'', adresa: zak.adresa||'', typ: 'firma' });
  });
  if(!toImport.length) { alert('Žádní noví zákazníci k importu.'); return; }
  if(!confirm(`Importovat ${toImport.length} zákazníků ze stávajících zakázek?`)) return;

  let done = 0;
  for(const z of toImport) {
    await window._fb.addDoc(window._fb.collection(window._fb.db,'zakaznici'), {
      ...z, createdAt: window._fb.serverTimestamp(), updatedAt: window._fb.serverTimestamp()
    });
    done++;
  }
  alert(`✅ Importováno ${done} zákazníků`);
}

// ══ SWITCHAB OVERRIDE — zákazníci ═══════════════════════════════
(function overrideSwitchTabForZakaznici() {
  let attempts = 0;
  const iv = setInterval(() => {
    attempts++;
    if(typeof switchTab !== 'undefined' || attempts > 40) {
      clearInterval(iv);
      if(typeof switchTab === 'undefined') return;
      const prev = switchTab;
      switchTab = function(tab) {
        prev(tab);
        if(tab === 'zakaznici') loadZakaznici();
      };
    }
  }, 200);
})();

// ══ AUTO-DOPLNĚNÍ ZÁKAZNÍKA PŘI PSANÍ V ZAKÁZCE ══════════════════
// Při psaní zákazníka v nové zakázce nabídni data z modulu zákazníků
document.addEventListener('input', e => {
  const inp = e.target;
  if(!inp.id || !['f_zakaznik','nz-zakaznik'].includes(inp.id)) return;
  const q = inp.value.toLowerCase();
  if(q.length < 2) return;

  const matches = _zakaznici.filter(z => (z.nazev||'').toLowerCase().includes(q)).slice(0,5);
  if(!matches.length) return;

  // Jednoduchý dropdown
  let dd = document.getElementById('zak-autocomplete');
  if(!dd) {
    dd = document.createElement('ul');
    dd.id = 'zak-autocomplete';
    dd.style.cssText = 'position:fixed;z-index:9999;background:#fff;border:1.5px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);list-style:none;margin:0;padding:4px 0;font-size:12px;max-height:180px;overflow-y:auto;min-width:240px';
    document.body.appendChild(dd);
  }
  const rect = inp.getBoundingClientRect();
  dd.style.left = rect.left+'px';
  dd.style.top  = (rect.bottom+2)+'px';
  dd.style.width = Math.max(rect.width,240)+'px';
  dd.style.display = 'block';
  dd.innerHTML = matches.map(z=>`<li data-id="${z.id}" style="padding:8px 12px;cursor:pointer;display:flex;flex-direction:column">
    <span style="font-weight:600">${esc(z.nazev)}</span>
    <span style="font-size:10px;color:var(--muted)">${z.ico?'IČO: '+z.ico+' · ':''}${z.adresa||''}</span>
  </li>`).join('');
  dd.querySelectorAll('li').forEach(li=>{
    li.onmousedown = ev => {
      ev.preventDefault();
      const z = _zakaznici.find(x=>x.id===li.dataset.id);
      if(!z) return;
      inp.value = z.nazev;
      // Vyplň ostatní pole
      ['f_adresa','nz-adresa'].forEach(id=>{const el=document.getElementById(id);if(el&&z.adresa)el.value=z.adresa;});
      ['f_ico','nz-ico'].forEach(id=>{const el=document.getElementById(id);if(el&&z.ico)el.value=z.ico;});
      ['f_dic','nz-dic'].forEach(id=>{const el=document.getElementById(id);if(el&&z.dic)el.value=z.dic;});
      dd.style.display='none';
    };
  });
  // Skryj při kliknutí jinam
  const hide = () => { dd.style.display='none'; document.removeEventListener('mousedown',hide); };
  setTimeout(()=>document.addEventListener('mousedown',hide),100);
});

// ══ IMPORT BUTTON DO ZÁKAZNÍCI TABU ══════════════════════════════
(function addImportBtn() {
  setTimeout(() => {
    const zakList = document.getElementById('zak-list');
    if(!zakList || zakList._importBtnAdded) return;
    zakList._importBtnAdded = true;
    const wrap = zakList.parentElement;
    const btnWrap = document.createElement('div');
    btnWrap.style.cssText = 'padding:8px 14px;border-top:1px solid var(--border);flex-shrink:0';
    btnWrap.innerHTML = `<button onclick="importZakazniciFromZakazky()" class="btn btn-ghost" style="font-size:11px;width:100%">
      📥 Importovat zákazníky ze zakázek
    </button>`;
    wrap.appendChild(btnWrap);
  }, 1500);
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  ZÁKAZNÍK PODPIS — celoobrazovkový podpis pro zákazníka
// ════════════════════════════════════════════════════════════════

let _zakSigCtx = null;
let _zakSigDrawing = false;
let _zakSigLx = 0, _zakSigLy = 0;
let _zakSigHasData = false;

function openZakaznikSig() {
  const overlay = document.getElementById('zakaznik-sig-overlay');
  const canvas  = document.getElementById('zak-sig-canvas');
  if(!overlay || !canvas) return;

  // Naplň souhrn zakázky
  const nazev = document.getElementById('f_nazev')?.value || document.getElementById('f_cislo')?.value || 'Servisní zásah';
  const prace = document.getElementById('f_prace')?.value || '';
  const zakaznik = document.getElementById('f_zakaznik')?.value || '';

  document.getElementById('zak-sig-nazev').textContent = nazev;
  document.getElementById('zak-sig-prace').textContent = zakaznik ? `Zákazník: ${zakaznik}` : '';

  const summary = document.getElementById('zak-sig-summary');
  if(summary) {
    summary.innerHTML = prace
      ? `<strong>Provedené práce:</strong> ${esc(prace.substring(0,300))}${prace.length>300?'…':''}`
      : '<em>Servisní zásah dle dohody</em>';
  }

  // Zobraz overlay
  overlay.style.display = 'flex';
  _zakSigHasData = false;

  // Inicializuj canvas
  canvas.width  = window.innerWidth;
  canvas.height = canvas.offsetHeight || (window.innerHeight - 260);
  _zakSigCtx = canvas.getContext('2d');
  _zakSigCtx.clearRect(0, 0, canvas.width, canvas.height);

  // Nakresli vodítko (jemná čára)
  _zakSigCtx.strokeStyle = '#dde3f0';
  _zakSigCtx.lineWidth = 1;
  _zakSigCtx.setLineDash([8, 8]);
  _zakSigCtx.beginPath();
  _zakSigCtx.moveTo(20, canvas.height * 0.65);
  _zakSigCtx.lineTo(canvas.width - 20, canvas.height * 0.65);
  _zakSigCtx.stroke();
  _zakSigCtx.setLineDash([]);

  // Nápis "Podpis zákazníka" jako vodoznak
  _zakSigCtx.font = '13px Arial';
  _zakSigCtx.fillStyle = '#c8d0e0';
  _zakSigCtx.textAlign = 'center';
  _zakSigCtx.fillText('Podpis zákazníka', canvas.width / 2, canvas.height * 0.65 + 20);
  _zakSigCtx.textAlign = 'left';

  // Zamkni scroll stránky
  document.body.style.overflow = 'hidden';

  // Event listenery na canvas
  canvas.onmousedown  = canvas.ontouchstart = zakSigStart;
  canvas.onmousemove  = canvas.ontouchmove  = zakSigMove;
  canvas.onmouseup    = canvas.ontouchend   =
  canvas.onmouseleave                       = zakSigEnd;
}

function zakSigPos(e) {
  const rect = document.getElementById('zak-sig-canvas').getBoundingClientRect();
  const touch = e.touches?.[0] || e;
  return {
    x: touch.clientX - rect.left,
    y: touch.clientY - rect.top
  };
}

function zakSigStart(e) {
  e.preventDefault();
  _zakSigDrawing = true;
  _zakSigHasData = true;
  const p = zakSigPos(e);
  _zakSigLx = p.x;
  _zakSigLy = p.y;
  _zakSigCtx.beginPath();
  _zakSigCtx.moveTo(p.x, p.y);
}

function zakSigMove(e) {
  if(!_zakSigDrawing) return;
  e.preventDefault();
  const p = zakSigPos(e);
  _zakSigCtx.lineTo(p.x, p.y);
  _zakSigCtx.strokeStyle = '#0f1f3d';
  _zakSigCtx.lineWidth = 2.5;
  _zakSigCtx.lineCap = 'round';
  _zakSigCtx.lineJoin = 'round';
  _zakSigCtx.stroke();
  _zakSigLx = p.x;
  _zakSigLy = p.y;
}

function zakSigEnd(e) {
  _zakSigDrawing = false;
}

function clearZakaznikSig() {
  const canvas = document.getElementById('zak-sig-canvas');
  if(!canvas) return;
  _zakSigCtx.clearRect(0, 0, canvas.width, canvas.height);
  _zakSigHasData = false;
  // Překresli vodítko
  _zakSigCtx.strokeStyle = '#dde3f0';
  _zakSigCtx.lineWidth = 1;
  _zakSigCtx.setLineDash([8, 8]);
  _zakSigCtx.beginPath();
  _zakSigCtx.moveTo(20, canvas.height * 0.65);
  _zakSigCtx.lineTo(canvas.width - 20, canvas.height * 0.65);
  _zakSigCtx.stroke();
  _zakSigCtx.setLineDash([]);
  _zakSigCtx.font = '13px Arial';
  _zakSigCtx.fillStyle = '#c8d0e0';
  _zakSigCtx.textAlign = 'center';
  _zakSigCtx.fillText('Podpis zákazníka', canvas.width / 2, canvas.height * 0.65 + 20);
  _zakSigCtx.textAlign = 'left';
}

function cancelZakaznikSig() {
  document.getElementById('zakaznik-sig-overlay').style.display = 'none';
  document.body.style.overflow = '';
}

function confirmZakaznikSig() {
  if(!_zakSigHasData) {
    // Vizuální feedback — zákazník ještě nepodepsal
    const canvas = document.getElementById('zak-sig-canvas');
    canvas.style.border = '3px solid #ef4444';
    setTimeout(() => canvas.style.border = '', 1000);
    return;
  }

  const canvas = document.getElementById('zak-sig-canvas');
  const dataUrl = canvas.toDataURL('image/png');

  // Ulož do _sigData[2] — stejné místo jako ruční podpis zákazníka
  _sigData[2] = dataUrl;
  updateSigPreview && updateSigPreview(2);

  // Nastav datum podpisu na dnešek
  const sd2 = document.getElementById('sd2');
  if(sd2 && !sd2.value) sd2.value = new Date().toISOString().slice(0, 10);

  // Zavři overlay
  document.getElementById('zakaznik-sig-overlay').style.display = 'none';
  document.body.style.overflow = '';

  // Vizuální potvrzení
  const hint = document.getElementById('sh2');
  if(hint) hint.style.display = 'none';
  const preview = document.getElementById('sp2');
  if(preview) {
    preview.innerHTML = `<img src="${dataUrl}" style="max-height:80px;max-width:100%;object-fit:contain">`;
  }

  // Uložit draft
  saveDraft && saveDraft();

  // Krátký toast
  showToast('✅ Zákazník podepsal');
}

// ── Toast helper (pokud neexistuje) ──────────────────────────────
function showToast(msg) {
  let toast = document.getElementById('toast-msg');
  if(!toast) {
    toast = document.createElement('div');
    toast.id = 'toast-msg';
    toast.style.cssText = 'position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#0f1f3d;color:#fff;padding:10px 20px;border-radius:30px;font-size:13px;font-weight:700;z-index:9999;pointer-events:none;transition:opacity .3s';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  clearTimeout(toast._t);
  toast._t = setTimeout(() => toast.style.opacity = '0', 2500);
}

// ── Orientace obrazovky pro zákazníka ────────────────────────────
// Pokud je telefon na výšku, vyčkej na otočení nebo pokračuj v landscape
(function handleOrientation() {
  const overlay = document.getElementById('zakaznik-sig-overlay');
  if(!overlay) return;

  window.addEventListener('orientationchange', () => {
    if(overlay.style.display === 'flex') {
      // Přizpůsob canvas po otočení
      setTimeout(() => {
        const canvas = document.getElementById('zak-sig-canvas');
        if(!canvas) return;
        const saved = canvas.toDataURL();
        canvas.width  = window.innerWidth;
        canvas.height = canvas.offsetHeight || (window.innerHeight - 260);
        // Obnov obsah
        if(_zakSigHasData) {
          const img = new Image();
          img.onload = () => _zakSigCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
          img.src = saved;
        }
      }, 300);
    }
  });
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 6: komprese fotek, notifikace kanceláře,
//  workflow role, portál zákazníka, user management
// ════════════════════════════════════════════════════════════════

// ══ KOMPRESE FOTEK ═══════════════════════════════════════════════
async function compressPhoto(dataUrl, maxPx = 1400, quality = 0.78) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      // Zmenši pokud je větší než maxPx
      if(w > maxPx || h > maxPx) {
        if(w > h) { h = Math.round(h * maxPx / w); w = maxPx; }
        else       { w = Math.round(w * maxPx / h); h = maxPx; }
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // JPEG komprese
      const compressed = canvas.toDataURL('image/jpeg', quality);
      const origKB  = Math.round(dataUrl.length * 0.75 / 1024);
      const compKB  = Math.round(compressed.length * 0.75 / 1024);
      console.log(`📸 Foto zkomprimováno: ${origKB}KB → ${compKB}KB (${w}×${h}px)`);
      resolve(compressed);
    };
    img.onerror = () => resolve(dataUrl); // fallback bez komprese
    img.src = dataUrl;
  });
}

// Přidej kompresi i do kancelar foto uploadu
async function addKancelPhoto(input, zakazkaId) {
  const files = Array.from(input.files);
  if(!files.length) return;
  const progEl = document.getElementById('kphoto-prog-'+zakazkaId);
  if(progEl) progEl.style.display = 'block';

  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;
  if(!z.photos) z.photos = [];

  let done = 0;
  for(const file of files) {
    try {
      const dataUrl = await new Promise(res => {
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.readAsDataURL(file);
      });
      // Komprimuj
      const compressed = await compressPhoto(dataUrl, 1400, 0.78);
      const photoObj = { dataUrl: compressed, cloudUrl: '', name: file.name, caption: '', addedBy: 'kancelar' };
      z.photos.push(photoObj);

      // Upload do Storage
      if(navigator.onLine && window._fb?.storage) {
        try {
          const user = window._currentUser;
          const path = `photos/${user?.uid||'k'}/${Date.now()}_${file.name}`;
          const ref = window._fb.ref(window._fb.storage, path);
          const resp = await fetch(compressed);
          const blob = await resp.blob();
          await window._fb.uploadBytes(ref, blob);
          photoObj.cloudUrl = await window._fb.getDownloadURL(ref);
        } catch(e) { console.warn('Upload failed:', e); }
      }
      done++;
      if(progEl) progEl.textContent = `⏳ Nahráno ${done}/${files.length}…`;
    } catch(e) { console.warn('Photo error:', e); }
  }

  // Ulož do Firestore
  try {
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', zakazkaId),
      { photos: z.photos, updatedAt: window._fb.serverTimestamp() }
    );
    openDetail && openDetail(zakazkaId);
  } catch(e) { alert('Chyba: '+e.message); }
  finally { if(progEl) progEl.style.display = 'none'; }
  input.value = '';
}

// ══ WORKFLOW & ROLE SYSTÉM ════════════════════════════════════════
// Definice workflow - pořadí stavů a kdo je zodpovědný
const WORKFLOW = [
  { stav: 'nová',           icon: '🆕', role: 'kancelar',    label: 'Nová zakázka',      color: '#6b7a99' },
  { stav: 'ke zpracování',  icon: '👁',  role: 'dispatcher',  label: 'Ke zpracování',     color: '#0369a1' },
  { stav: 'rozpracovaná',   icon: '🔧', role: 'technik',     label: 'V řešení',          color: '#7c3aed' },
  { stav: 'na cestě',       icon: '🚗', role: 'technik',     label: 'Na cestě',          color: '#0891b2' },
  { stav: 'čeká na díly',   icon: '🔩', role: 'technik',     label: 'Čeká na díly',      color: '#d97706' },
  { stav: 'zpracovaná',     icon: '✅', role: 'technik',     label: 'Dokončena',         color: '#16a34a' },
  { stav: 'ke kontrole',    icon: '🔍', role: 'dispatcher',  label: 'Ke kontrole',       color: '#9333ea' },
  { stav: 'ke fakturaci',   icon: '📤', role: 'kancelar',    label: 'Ke fakturaci',      color: '#ea580c' },
  { stav: 'fakturovaná',    icon: '🧾', role: 'kancelar',    label: 'Fakturováno',       color: '#0f766e' },
  { stav: 'zaplacena',      icon: '💚', role: 'kancelar',    label: 'Zaplaceno',         color: '#15803d' },
  { stav: 'stornována',     icon: '🚫', role: 'admin',       label: 'Stornováno',        color: '#dc2626' },
];

// Vrať workflow krok pro stav
function getWorkflowStep(stav) {
  return WORKFLOW.find(w => w.stav === stav) || WORKFLOW[0];
}

// Workflow progress bar v detailu
function renderWorkflowBar(zakazkaId) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;

  const mainSteps = WORKFLOW.filter(w => !['stornována','čeká na díly'].includes(w.stav));
  const curIdx = mainSteps.findIndex(w => w.stav === (z.stav||'nová'));
  const role = window._currentRole;

  // Přidej workflow bar pod detail-hdr
  let wfBar = document.getElementById('workflow-bar-'+zakazkaId);
  if(!wfBar) {
    wfBar = document.createElement('div');
    wfBar.id = 'workflow-bar-'+zakazkaId;
    wfBar.style.cssText = 'margin:0 0 10px;padding:12px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px';
    const di = document.getElementById('detail-inner');
    const firstDsec = di?.querySelector('.dsec');
    if(firstDsec) firstDsec.before(wfBar);
  }

  // Zjisti dostupné akce pro aktuálního uživatele
  const curStep = getWorkflowStep(z.stav||'nová');
  const nextStav = getNextStav(z.stav||'nová', role);
  const prevStav = getPrevStav(z.stav||'nová');

  wfBar.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <div style="font-size:11px;font-weight:700;text-transform:uppercase;color:var(--muted)">Průběh zakázky</div>
      <div style="display:flex;gap:6px">
        ${prevStav ? `<button onclick="workflowMove('${zakazkaId}','${prevStav}','back')"
          style="font-size:11px;padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:#fff5f5;color:#dc2626;cursor:pointer">
          ← Vrátit zpět
        </button>` : ''}
        ${nextStav ? `<button onclick="workflowMove('${zakazkaId}','${nextStav}','next')"
          style="font-size:11px;padding:4px 12px;border:none;border-radius:6px;background:var(--green);color:#fff;cursor:pointer;font-weight:700">
          Předat dál →
        </button>` : ''}
      </div>
    </div>
    <div style="display:flex;gap:2px;align-items:center;overflow-x:auto;padding-bottom:4px">
      ${mainSteps.map((w,i) => {
        const done = curIdx > i;
        const active = curIdx === i;
        return `<div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0">
          <div style="width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;
            background:${active ? w.color : done ? '#d1fae5' : '#f1f5f9'};
            border:2px solid ${active ? w.color : done ? '#6ee7b7' : '#e2e8f0'};
            color:${done ? '#059669' : '#64748b'}">${done ? '✓' : w.icon}</div>
          <div style="font-size:9px;color:${active?w.color:'var(--muted)'};font-weight:${active?'700':'400'};white-space:nowrap;max-width:52px;text-align:center;overflow:hidden;text-overflow:ellipsis">${w.label}</div>
          ${i < mainSteps.length-1 ? '' : ''}
        </div>
        ${i < mainSteps.length-1 ? `<div style="flex:1;height:2px;background:${done?'#6ee7b7':'#e2e8f0'};min-width:8px;margin-bottom:18px"></div>` : ''}`;
      }).join('')}
    </div>
    <div style="font-size:11px;color:var(--muted);margin-top:6px">
      Zodpovědná role: <strong style="color:var(--navy)">${getRoleLabel(curStep.role)}</strong>
      ${z.stav === 'čeká na díly' ? ' · <span style="color:#d97706">⚠️ Blokováno — čeká na dodávku dílů</span>' : ''}
    </div>`;
}

function getNextStav(stav, role) {
  const idx = WORKFLOW.findIndex(w => w.stav === stav);
  if(idx < 0 || idx >= WORKFLOW.length-2) return null;
  const next = WORKFLOW[idx+1];
  // Admin může vždy, ostatní jen svůj krok
  if(role === 'admin') return next.stav;
  if(WORKFLOW[idx].role === role || WORKFLOW[idx].role === 'kancelar' && role === 'dispatcher') return next.stav;
  return null;
}

function getPrevStav(stav) {
  const idx = WORKFLOW.findIndex(w => w.stav === stav);
  if(idx <= 0) return null;
  return WORKFLOW[idx-1].stav;
}

function getRoleLabel(role) {
  const labels = {admin:'👑 Admin', kancelar:'🏢 Kancelář', dispatcher:'📋 Dispečer', technik:'🔧 Technik'};
  return labels[role] || role;
}

async function workflowMove(zakazkaId, newStav, direction) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;

  const step = getWorkflowStep(newStav);
  const msg = direction === 'back'
    ? `Vrátit zakázku zpět na stav "${step.label}"?`
    : `Předat zakázku na "${step.label}" (zodpovědnost: ${getRoleLabel(step.role)})?`;

  if(!confirm(msg)) return;

  try {
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', zakazkaId),
      { stav: newStav, updatedAt: window._fb.serverTimestamp() }
    );
    z.stav = newStav;
    saveAuditLog && saveAuditLog(zakazkaId, 'workflow_'+(direction==='back'?'return':'forward'), newStav);

    // Notifikace kanceláři/dispečerovi
    sendKancelarNotif({
      type: 'workflow', zakazkaId, zakazkaNazev: z.nazev,
      text: direction === 'back'
        ? `↩ Zakázka vrácena: ${z.nazev} → ${step.label}`
        : `➡ Zakázka předána: ${z.nazev} → ${step.label}`,
      stav: newStav, role: step.role
    });

    renderWorkflowBar(zakazkaId);
    const sel = document.getElementById('stav-sel');
    if(sel) sel.value = newStav;
  } catch(e) { alert('Chyba: '+e.message); }
}

// ══ SPRÁVA UŽIVATELŮ — rozšířené role ════════════════════════════
const ROLES_CONFIG = [
  { value: 'admin',      label: '👑 Admin',     desc: 'Plný přístup ke všemu' },
  { value: 'kancelar',   label: '🏢 Kancelář',  desc: 'Správa zakázek, fakturace' },
  { value: 'dispatcher', label: '📋 Dispečer',  desc: 'Přiřazování, kontrola kvality' },
  { value: 'technik',    label: '🔧 Technik',   desc: 'Terénní práce, zakázky' },
  { value: 'pending',    label: '⏳ Čekající',  desc: 'Čeká na schválení' },
];

function reloadUserList() {
  // Načti znovu s filtrem role
  const filter = document.getElementById('user-filter-role')?.value || '';
  const list = document.getElementById('user-list');
  if(!list) return;

  window._fb.getDocs(window._fb.collection(window._fb.db, 'users')).then(snap => {
    let users = snap.docs.map(d=>({id:d.id,...d.data()}));
    if(filter) users = users.filter(u => u.role === filter);
    users.sort((a,b) => (a.name||'').localeCompare(b.name||''));

    if(!users.length) {
      list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Žádní uživatelé</div>';
      return;
    }

    list.innerHTML = users.map(u => {
      const roleCfg = ROLES_CONFIG.find(r=>r.value===u.role) || {label:u.role,desc:''};
      return `<div class="user-row" style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">
        <div class="user-av" style="width:36px;height:36px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;flex-shrink:0">
          ${(u.name||u.email||'?')[0].toUpperCase()}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:13px;color:var(--navy)">${esc(u.name||'—')}</div>
          <div style="font-size:11px;color:var(--muted)">${esc(u.email||'')}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <select onchange="changeUserRole('${u.id}',this.value)"
            style="font-size:11px;padding:5px 8px;border:1px solid var(--border);border-radius:7px;background:#fff;color:var(--navy)">
            ${ROLES_CONFIG.map(r=>`<option value="${r.value}" ${u.role===r.value?'selected':''}>${r.label}</option>`).join('')}
          </select>
          <button onclick="deleteUser('${u.id}','${esc(u.name||u.email)}')"
            style="font-size:11px;padding:4px 8px;border:1px solid #fecaca;border-radius:6px;background:#fff5f5;color:#dc2626;cursor:pointer">🗑</button>
        </div>
      </div>`;
    }).join('');
  }).catch(e => console.warn('loadUsers:', e));
}

async function changeUserRole(uid, newRole) {
  try {
    await window._fb.updateDoc(window._fb.doc(window._fb.db,'users',uid), {
      role: newRole, updatedAt: window._fb.serverTimestamp()
    });
    showToast && showToast(`✅ Role změněna na ${getRoleLabel(newRole)}`);
  } catch(e) { alert('Chyba: '+e.message); }
}

async function deleteUser(uid, name) {
  if(!confirm(`Smazat uživatele ${name}?`)) return;
  window._fb.deleteDoc(window._fb.doc(window._fb.db,'users',uid))
    .then(()=>{ showToast && showToast('Uživatel smazán'); reloadUserList(); })
    .catch(e=>alert('Chyba: '+e.message));
}

// Načti users při vstupu na tab
(function hookUsersTab() {
  let a = 0;
  const iv = setInterval(()=>{
    a++;
    if(typeof switchTab!=='undefined'||a>40){
      clearInterval(iv);
      if(typeof switchTab==='undefined') return;
      const prev = switchTab;
      switchTab = t => { prev(t); if(t==='users') setTimeout(reloadUserList,100); };
    }
  },200);
})();

// ══ NOTIFIKACE PRO KANCELÁŘ ════════════════════════════════════════
let _notifList = [];
let _notifUnsub = null;

function initKancelarNotif() {
  if(_notifUnsub) return;

  // Poslouchej real-time změny zakázek
  const firma = window._currentFirma || 'aceuro';
  _notifUnsub = window._fb.onSnapshot(
    window._fb.query(
      window._fb.collection(window._fb.db,'zakazky'),
      window._fb.where('firma','==',firma),
      window._fb.orderBy('updatedAt','desc'),
      window._fb.limit(50)
    ),
    snap => {
      snap.docChanges().forEach(change => {
        if(change.type !== 'modified') return;
        const z = {id:change.doc.id,...change.doc.data()};
        const prev = (window._zakazky||[]).find(x=>x.id===z.id);
        if(!prev) return;

        // Stav se změnil
        if(prev.stav !== z.stav) {
          const step = getWorkflowStep(z.stav);
          addNotif({
            id: Date.now()+'_stav',
            type: 'stav',
            icon: step.icon,
            title: `Zakázka: ${z.nazev||'—'}`,
            text: `Nový stav: ${step.label}`,
            zakazkaId: z.id,
            time: new Date(),
            color: step.color
          });
        }

        // Dokončena technikem
        if(z.stav === 'zpracovaná' && prev.stav !== 'zpracovaná') {
          addNotif({
            id: Date.now()+'_done',
            type: 'done',
            icon: '✅',
            title: `Technik dokončil: ${z.nazev||'—'}`,
            text: `${z.technik||'Technik'} uzavřel zakázku — potřebuje kontrolu`,
            zakazkaId: z.id,
            time: new Date(),
            color: '#16a34a',
            action: { label: 'Zkontrolovat', stav: 'ke kontrole' }
          });
        }

        // Ke fakturaci
        if(z.stav === 'ke fakturaci' && prev.stav !== 'ke fakturaci') {
          addNotif({
            id: Date.now()+'_fakt',
            type: 'faktura',
            icon: '📤',
            title: `K fakturaci: ${z.nazev||'—'}`,
            text: `Zákazník: ${z.zakaznik||'—'} · Cena: ${z.cena||'?'}`,
            zakazkaId: z.id,
            time: new Date(),
            color: '#ea580c'
          });
        }
      });
    }
  );

  // Také sleduj nové zakázky od technika
  window._fb.onSnapshot(
    window._fb.query(
      window._fb.collection(window._fb.db,'zakazky'),
      window._fb.where('firma','==',firma),
      window._fb.orderBy('createdAt','desc'),
      window._fb.limit(5)
    ),
    snap => {
      snap.docChanges().forEach(change => {
        if(change.type !== 'added') return;
        const z = {id:change.doc.id,...change.doc.data()};
        const ts = z.createdAt?.toDate?.() || new Date();
        if(Date.now() - ts.getTime() > 30000) return; // ignoruj staré

        if(z.source === 'technik') {
          addNotif({
            id: Date.now()+'_new',
            type: 'new',
            icon: '🆕',
            title: `Nová zakázka od technika`,
            text: `${z.nazev||'—'} · ${z.technik||'—'}`,
            zakazkaId: z.id,
            time: new Date(),
            color: '#7c3aed'
          });
        }
      });
    }
  );
}

function addNotif(notif) {
  _notifList.unshift(notif);
  if(_notifList.length > 50) _notifList.pop();
  renderNotifPanel();
  // Prohlížečová notifikace
  if(Notification.permission === 'granted') {
    new Notification(notif.title, { body: notif.text, icon: '/favicon.ico' });
  }
}

function sendKancelarNotif(data) {
  addNotif({
    id: Date.now()+'_k',
    type: data.type,
    icon: data.type==='workflow' ? '🔄' : '📋',
    title: data.text,
    text: `Stav: ${getWorkflowStep(data.stav).label}`,
    zakazkaId: data.zakazkaId,
    time: new Date(),
    color: '#0369a1'
  });
}

function renderNotifPanel() {
  const list  = document.getElementById('notif-list');
  const count = document.getElementById('notif-count');
  if(!list) return;

  const unread = _notifList.filter(n=>!n.read).length;
  if(count) {
    count.textContent = unread;
    count.style.display = unread > 0 ? 'block' : 'none';
  }

  if(!_notifList.length) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted);font-size:12px">Žádné notifikace</div>';
    return;
  }

  list.innerHTML = _notifList.slice(0,20).map(n => `
    <div style="padding:10px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start;${n.read?'opacity:.6':''}"
      onclick="notifClick('${n.id}','${n.zakazkaId||''}')">
      <div style="width:28px;height:28px;border-radius:50%;background:${n.color||'var(--navy)'}22;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${n.icon}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:700;color:var(--navy)">${esc(n.title)}</div>
        <div style="font-size:11px;color:var(--muted)">${esc(n.text)}</div>
        <div style="font-size:10px;color:var(--lt);margin-top:2px">${n.time?.toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
    </div>`).join('');
}

function toggleNotifPanel() {
  const panel = document.getElementById('notif-panel');
  if(!panel) return;
  const visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : 'block';
  if(!visible) {
    // Označ jako přečtené
    _notifList.forEach(n=>n.read=true);
    const count = document.getElementById('notif-count');
    if(count) count.style.display = 'none';
  }
  // Zavři při kliknutí mimo
  if(!visible) {
    setTimeout(() => document.addEventListener('click', function h(e) {
      if(!document.getElementById('notif-panel')?.contains(e.target) &&
         !document.getElementById('notif-bell')?.contains(e.target)) {
        document.getElementById('notif-panel').style.display = 'none';
        document.removeEventListener('click', h);
      }
    }), 100);
  }
}

function notifClick(notifId, zakazkaId) {
  document.getElementById('notif-panel').style.display = 'none';
  if(zakazkaId) {
    switchTab && switchTab('orders');
    setTimeout(() => openDetail && openDetail(zakazkaId), 100);
  }
}

function clearAllNotifs() {
  _notifList = [];
  renderNotifPanel();
}

// Požádej o povolení notifikací
(function requestNotifPermission() {
  setTimeout(() => {
    if(Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }, 3000);
})();

// ══ PORTÁL ZÁKAZNÍKA ══════════════════════════════════════════════
function generatePortalLink(zakazkaId) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;

  // Generuj 4místný přístupový kód z ID (deterministický)
  const kod = (parseInt(zakazkaId.slice(-8),16) % 9000 + 1000).toString();

  // Ulož kód do Firestore
  window._fb.updateDoc(window._fb.doc(window._fb.db,'zakazky',zakazkaId), {
    portalKod: kod, portalEnabled: true, updatedAt: window._fb.serverTimestamp()
  }).catch(()=>{});

  // Vytvoř odkaz
  const url = window.location.href.split('?')[0] + `?portal=${z.cislo||zakazkaId}&kod=${kod}`;

  // Zobraz dialog
  const msg = document.createElement('div');
  msg.style.cssText = 'position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5)';
  msg.innerHTML = `<div style="background:#fff;border-radius:14px;padding:24px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
    <h3 style="margin:0 0 8px;font-size:16px;color:var(--navy)">🔗 Odkaz pro zákazníka</h3>
    <p style="font-size:12px;color:var(--muted);margin:0 0 14px">Zákazník uvidí stav, fotky a servisní protokol.</p>
    <div style="background:#f8fafc;border:1.5px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:10px">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Přístupový kód</div>
      <div style="font-size:28px;font-weight:900;letter-spacing:8px;color:var(--navy);font-family:'DM Mono',monospace">${kod}</div>
    </div>
    <div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--muted);word-break:break-all;margin-bottom:14px">${url}</div>
    <div style="display:flex;gap:8px">
      <button onclick="navigator.clipboard.writeText('${url}').then(()=>{showToast('✅ Odkaz zkopírován')})"
        style="flex:1;padding:10px;background:var(--navy);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">
        📋 Kopírovat odkaz
      </button>
      <button onclick="navigator.share&&navigator.share({title:'Zakázka ${esc(z.cislo||'')}',url:'${url}'})"
        style="flex:1;padding:10px;background:var(--green);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">
        📤 Sdílet
      </button>
    </div>
    <button onclick="this.closest('[style*=fixed]').remove()"
      style="width:100%;margin-top:8px;padding:8px;background:none;border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;color:var(--muted)">
      Zavřít
    </button>
  </div>`;
  document.body.appendChild(msg);
  msg.onclick = e => { if(e.target===msg) msg.remove(); };
}

// Zkontroluj URL při načtení — portál
(function checkPortalUrl() {
  const params = new URLSearchParams(window.location.search);
  const portal = params.get('portal');
  const kod    = params.get('kod');
  if(!portal || !kod) return;

  // Zobraz portál
  setTimeout(() => openPortal(portal, kod), 1000);
})();

async function portalLogin() {
  const cislo = document.getElementById('portal-cislo')?.value.trim();
  const kod   = document.getElementById('portal-kod')?.value.trim();
  if(!cislo || !kod) return;
  openPortal(cislo, kod);
}

async function openPortal(cislo, kod) {
  // Zobraz portál screen
  document.querySelectorAll('[id^="app-"]').forEach(el => el.style.display='none');
  const portalEl = document.getElementById('app-portal');
  if(portalEl) portalEl.style.display='block';

  try {
    // Hledej zakázku
    const snap = await window._fb.getDocs(window._fb.query(
      window._fb.collection(window._fb.db,'zakazky'),
      window._fb.where('cislo','==',cislo)
    ));

    if(snap.empty) {
      // Zkus podle ID
      const byId = await window._fb.getDoc(window._fb.doc(window._fb.db,'zakazky',cislo)).catch(()=>null);
      if(!byId?.exists()) throw new Error('Zakázka nenalezena');
    }

    const doc = snap.empty ? null : snap.docs[0];
    const z   = doc ? {id:doc.id,...doc.data()} : null;

    if(!z) { showPortalError('Zakázka nenalezena'); return; }

    // Ověř kód
    const expectedKod = (parseInt(z.id.slice(-8)||z.id,16) % 9000 + 1000).toString();
    if(z.portalKod !== kod && expectedKod !== kod) {
      showPortalError('Nesprávný přístupový kód'); return;
    }

    renderPortal(z);
  } catch(e) {
    showPortalError('Chyba: ' + e.message);
  }
}

function showPortalError(msg) {
  const err = document.getElementById('portal-login-err');
  if(err) { err.textContent = msg; err.style.display='block'; }
}

function renderPortal(z) {
  document.getElementById('portal-login').style.display = 'none';
  const content = document.getElementById('portal-content');
  if(content) content.style.display='block';

  // Název a meta
  document.getElementById('portal-nazev').textContent = z.nazev||'—';
  document.getElementById('portal-meta').textContent =
    `Č. ${z.cislo||'—'} · Technik: ${z.technik||'—'} · Termín: ${fmtD(z.termin)||'—'}`;
  document.getElementById('portal-badge').innerHTML = stavBadge(z.stav||'nová');

  // Progress
  const mainSteps = WORKFLOW.filter(w=>!['stornována','čeká na díly'].includes(w.stav));
  const curIdx = mainSteps.findIndex(w=>w.stav===(z.stav||'nová'));
  document.getElementById('portal-progress').innerHTML = `
    <div style="display:flex;gap:0;align-items:center;overflow-x:auto;margin:10px 0">
      ${mainSteps.map((w,i)=>{
        const done=curIdx>i, active=curIdx===i;
        return `<div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;min-width:48px">
          <div style="width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;
            background:${active?w.color:done?'#d1fae5':'#f1f5f9'};border:2px solid ${active?w.color:done?'#6ee7b7':'#e2e8f0'}">${done?'✓':w.icon}</div>
          <div style="font-size:8px;color:${active?w.color:'#94a3b8'};text-align:center">${w.label}</div>
        </div>${i<mainSteps.length-1?`<div style="flex:1;height:2px;background:${done?'#6ee7b7':'#e2e8f0'};min-width:6px;margin-bottom:16px"></div>`:''}`;
      }).join('')}
    </div>`;

  // Detaily
  document.getElementById('portal-details').innerHTML = [
    z.zakaznik?`<div>🏢 <strong>Zákazník:</strong> ${esc(z.zakaznik)}</div>`:'',
    z.adresa?`<div>📍 <strong>Adresa:</strong> ${esc(z.adresa)}</div>`:'',
    z.duzp?`<div>📅 <strong>DUZP:</strong> ${fmtD(z.duzp)}</div>`:'',
  ].filter(Boolean).join('');

  // Práce
  if(z.prace) {
    document.getElementById('portal-prace-wrap').style.display='block';
    document.getElementById('portal-prace').textContent = z.prace;
  }

  // Fotky
  const photos = (z.photos||[]).filter(p=>p.cloudUrl||p.dataUrl);
  if(photos.length) {
    document.getElementById('portal-foto-wrap').style.display='block';
    document.getElementById('portal-foto').innerHTML = photos.map(p=>
      `<img src="${p.cloudUrl||p.dataUrl}" alt="${esc(p.caption||'')}"
        style="width:100%;aspect-ratio:4/3;object-fit:cover;border-radius:8px;cursor:zoom-in"
        onclick="openLightbox(this.src)">`
    ).join('');
  }

  // Kontakt
  document.getElementById('portal-kontakt').textContent = `Pro dotazy kontaktujte svého technika: ${z.technik||'—'}`;
}

// ══ WORKFLOW BAR HOOK DO OPENDETAIL ═══════════════════════════════
(function hookWorkflowBar() {
  let a = 0;
  const iv = setInterval(()=>{
    a++;
    if(typeof openDetail!=='undefined'||a>40){
      clearInterval(iv);
      if(typeof openDetail==='undefined') return;
      const prev = openDetail;
      openDetail = id => {
        prev(id);
        setTimeout(()=>renderWorkflowBar(id), 300);
      };
    }
  },200);
})();

// ══ INIT NOTIFIKACÍ PO PŘIHLÁŠENÍ ════════════════════════════════
(function hookInitNotif() {
  let a = 0;
  const iv = setInterval(()=>{
    a++;
    if((window._currentRole && window._zakazky)||a>60){
      clearInterval(iv);
      if(['admin','kancelar','dispatcher'].includes(window._currentRole)) {
        setTimeout(initKancelarNotif, 2000);
      }
    }
  },500);
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 6 — workflow role, kancelář notifikace,
//  komprese kancelář fotek, souhrn zakázky, addUser s rolí
// ════════════════════════════════════════════════════════════════

// ══ WORKFLOW DEFINICE ════════════════════════════════════════════
// Kdo může posunout na jaký krok a co znamená "předat dál" / "vrátit zpět"
const WORKFLOW_STEPS = [
  { stav: 'nová',           label: 'Nová',          icon: '🆕', role: ['admin','dispatcher','kancelar','koordinator'] },
  { stav: 'ke zpracování',  label: 'Zadána',         icon: '📋', role: ['admin','dispatcher','kancelar'] },
  { stav: 'rozpracovaná',   label: 'V terénu',       icon: '🔧', role: ['admin','koordinator','kancelar'] },
  { stav: 'ke kontrole',    label: 'Ke kontrole',    icon: '🔍', role: ['admin','koordinator','kancelar'] },
  { stav: 'ke fakturaci',   label: 'Ke fakturaci',   icon: '📤', role: ['admin','fakturant','kancelar'] },
  { stav: 'fakturovaná',    label: 'Fakturovaná',    icon: '🧾', role: ['admin','fakturant','kancelar'] },
  { stav: 'zaplacena',      label: 'Zaplacena',      icon: '✅', role: ['admin','fakturant','kancelar'] },
];

// Role popis
const ROLE_LABELS = {
  admin:       '👑 Admin',
  kancelar:    '💼 Kancelář',
  dispatcher:  '📋 Dispečer',
  koordinator: '🔄 Koordinátor',
  fakturant:   '🧾 Fakturant',
  technik:     '🔧 Technik',
};

function getWorkflowIdx(stav) {
  return WORKFLOW_STEPS.findIndex(s => s.stav === stav);
}

function canActOnWorkflow(stav) {
  const role = window._currentRole || 'kancelar';
  const idx  = getWorkflowIdx(stav);
  if(idx < 0) return true; // neznámý stav — povolíme
  return WORKFLOW_STEPS[idx].role.includes(role);
}

function renderWorkflowSteps(zakazkaId, currentStav) {
  const el = document.getElementById('workflow-steps-' + zakazkaId);
  const badge = document.getElementById('workflow-role-badge-' + zakazkaId);
  if(!el) return;

  const curIdx = getWorkflowIdx(currentStav);
  const role   = window._currentRole || 'kancelar';
  if(badge) badge.textContent = ROLE_LABELS[role] || role;

  el.innerHTML = WORKFLOW_STEPS.map((step, i) => {
    const done    = i < curIdx;
    const current = i === curIdx;
    const future  = i > curIdx;
    const bg      = done ? 'var(--green)' : current ? 'var(--navy)' : 'var(--border)';
    const color   = (done||current) ? '#fff' : 'var(--muted)';
    const connector = i < WORKFLOW_STEPS.length-1
      ? `<div style="width:20px;height:2px;background:${done?'var(--green)':'var(--border)'}"></div>` : '';
    return `<div style="display:flex;align-items:center;flex-shrink:0">
      <div title="${step.label}" style="display:flex;flex-direction:column;align-items:center;gap:2px;cursor:${canActOnWorkflow(step.stav)?'pointer':'default'}"
        onclick="${!future?`workflowJumpTo('${zakazkaId}','${step.stav}')`:''}">
        <div style="width:30px;height:30px;border-radius:50%;background:${bg};display:flex;align-items:center;justify-content:center;font-size:13px;transition:transform .15s"
          onmouseenter="if(${!future})this.style.transform='scale(1.15)'" onmouseleave="this.style.transform=''">
          ${done ? '✓' : step.icon}
        </div>
        <div style="font-size:9px;color:${color==='#fff'?'var(--navy)':'var(--muted)'};white-space:nowrap;font-weight:${current?'700':'400'}">${step.label}</div>
      </div>
      ${connector}
    </div>`;
  }).join('');

  // Zobraz/skryj tlačítka podle role
  const canNext = canActOnWorkflow(currentStav) && curIdx < WORKFLOW_STEPS.length - 1;
  const canBack = canActOnWorkflow(currentStav) && curIdx > 0;
  const nextBtn = document.getElementById('wf-next-' + zakazkaId);
  const backBtn = document.getElementById('wf-back-' + zakazkaId);
  if(nextBtn) {
    nextBtn.style.display = canNext ? '' : 'none';
    const nextStep = WORKFLOW_STEPS[curIdx + 1];
    if(nextStep) nextBtn.innerHTML = `✅ Předat: ${nextStep.icon} ${nextStep.label}`;
  }
  if(backBtn) backBtn.style.display = canBack ? '' : 'none';
}

async function workflowNext(zakazkaId) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;
  const curIdx  = getWorkflowIdx(z.stav||'nová');
  const nextStep = WORKFLOW_STEPS[curIdx + 1];
  if(!nextStep) return;

  const note = document.getElementById('wf-note-' + zakazkaId)?.value.trim() || '';
  await doWorkflowTransition(zakazkaId, z.stav, nextStep.stav, note, 'předáno_dál');
}

async function workflowBack(zakazkaId) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;
  const curIdx  = getWorkflowIdx(z.stav||'nová');
  const prevStep = WORKFLOW_STEPS[curIdx - 1];
  if(!prevStep) return;

  const note = document.getElementById('wf-note-' + zakazkaId)?.value.trim();
  if(!note && !confirm('Vrátit zakázku bez poznámky?')) return;
  await doWorkflowTransition(zakazkaId, z.stav, prevStep.stav, note||'Vráceno', 'vráceno');
}

async function workflowJumpTo(zakazkaId, newStav) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z || z.stav === newStav) return;
  if(!canActOnWorkflow(newStav)) { alert('Nemáte oprávnění pro tento krok.'); return; }
  const step = WORKFLOW_STEPS.find(s=>s.stav===newStav);
  if(!confirm(`Přeskočit na: ${step?.icon} ${step?.label}?`)) return;
  await doWorkflowTransition(zakazkaId, z.stav, newStav, 'Přeskočeno', 'přeskočeno');
}

async function doWorkflowTransition(zakazkaId, fromStav, toStav, note, action) {
  const me = window._currentUser;
  const role = window._currentRole || 'kancelar';

  try {
    // Ulož přechod do audit logu
    await window._fb.addDoc(
      window._fb.collection(window._fb.db, 'zakazky', zakazkaId, 'audit'),
      {
        action: action,
        value: `${fromStav} → ${toStav}`,
        note: note || '',
        uid: me?.uid || '',
        author: me?.displayName || me?.email || 'Neznámý',
        role,
        createdAt: window._fb.serverTimestamp()
      }
    );

    // Aktualizuj stav
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', zakazkaId),
      {
        stav: toStav,
        workflowNote: note || '',
        workflowUpdatedBy: me?.displayName || me?.email || '',
        workflowUpdatedAt: window._fb.serverTimestamp(),
        updatedAt: window._fb.serverTimestamp()
      }
    );

    // Notifikace kanceláři
    const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
    sendKancelarNotif(z||{id:zakazkaId}, `${action === 'vráceno' ? '↩' : '➡'} ${fromStav} → ${toStav}`, note, role);

    // Vymaž pole poznámky
    const noteInp = document.getElementById('wf-note-' + zakazkaId);
    if(noteInp) noteInp.value = '';

    showToast && showToast(`✓ Předáno: ${toStav}`);

  } catch(e) {
    alert('Chyba workflow: ' + e.message);
  }
}

// Napoj renderWorkflow na openDetail
(function hookWorkflowOnDetail() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof openDetail !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof openDetail === 'undefined') return;
      const prev = openDetail;
      openDetail = function(id) {
        prev(id);
        setTimeout(() => {
          const z = (window._zakazky||[]).find(x=>x.id===id);
          if(z) renderWorkflowSteps(id, z.stav||'nová');
        }, 300);
      };
    }
  }, 200);
})();

// Napoj renderWorkflow na changeStav
(function hookWorkflowOnChangeStav() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof changeStav !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof changeStav === 'undefined') return;
      const prev = changeStav;
      changeStav = function(id, stav) {
        prev(id, stav);
        setTimeout(() => renderWorkflowSteps(id, stav), 300);
      };
    }
  }, 200);
})();

// ══ KANCELÁŘ NOTIFIKACE ══════════════════════════════════════════
// Sleduje změny zakázek a posílá notifikace relevantním rolím

const NOTIF_TRIGGERS = {
  // stav → kdo dostane notifikaci
  'zpracovaná':   ['admin','koordinator','fakturant','kancelar'],
  'ke kontrole':  ['admin','koordinator','kancelar'],
  'ke fakturaci': ['admin','fakturant','kancelar'],
  'vrácena':      ['admin','dispatcher','koordinator'],
  'zaplacena':    ['admin','kancelar'],
  'fakturovaná':  ['admin','fakturant'],
};

let _prevStavMap = {};

function checkStavChanges(zakazky) {
  zakazky.forEach(z => {
    const prev = _prevStavMap[z.id];
    if(prev !== undefined && prev !== z.stav) {
      // Stav se změnil
      const notifRoles = NOTIF_TRIGGERS[z.stav] || [];
      const myRole = window._currentRole || 'kancelar';
      if(notifRoles.includes(myRole)) {
        triggerKancelarNotif(z, prev, z.stav);
      }
    }
    _prevStavMap[z.id] = z.stav;
  });
}

function triggerKancelarNotif(zakazka, fromStav, toStav) {
  // In-app notifikace (toast + badge)
  const msg = `📋 ${zakazka.nazev||'—'}: ${fromStav} → ${toStav}`;
  showInAppNotif(msg, zakazka.id);

  // E-mail notifikace pokud nakonfigurováno
  const cfg = getNotifSettings();
  if(cfg.serviceId && cfg.templateId && cfg.pubkey) {
    const me = window._currentUser;
    if(me?.email) {
      sendEmailNotif(me.email, me.displayName||'Kancelář', {
        ...zakazka,
        nazev: `[${toStav.toUpperCase()}] ${zakazka.nazev||'—'}`,
      });
    }
  }

  // Browser push notifikace
  if('Notification' in window && Notification.permission === 'granted') {
    try {
      new Notification('AC EURO — Změna zakázky', {
        body: msg,
        icon: '/favicon.ico',
        tag: 'zakazka-' + zakazka.id,
      });
    } catch(e) {}
  }
}

// In-app notifikace panel
let _inAppNotifs = [];

function showInAppNotif(msg, zakazkaId) {
  _inAppNotifs.unshift({ msg, zakazkaId, ts: Date.now() });
  if(_inAppNotifs.length > 20) _inAppNotifs.pop();
  updateNotifBadge();

  // Toast
  showToast && showToast(msg);
}

function sendKancelarNotif(zakazka, action, note, fromRole) {
  const cfg = getNotifSettings();
  const myRole = window._currentRole || 'kancelar';

  // In-app
  const msg = `${ROLE_LABELS[fromRole]||fromRole}: ${zakazka.nazev||'—'} — ${action}${note?' · '+note:''}`;
  showInAppNotif(msg, zakazka.id);

  // E-mail
  if(cfg.serviceId && cfg.templateId && cfg.pubkey) {
    const me = window._currentUser;
    if(me?.email) {
      sendEmailNotif(me.email, 'Kancelář', {
        ...zakazka,
        zadani: note || action,
      });
    }
  }
}

function updateNotifBadge() {
  const badge = document.getElementById('notif-badge');
  if(badge) {
    badge.textContent = _inAppNotifs.length;
    badge.style.display = _inAppNotifs.length ? 'flex' : 'none';
  }
}

function toggleNotifPanel() {
  let panel = document.getElementById('notif-panel');
  if(!panel) {
    panel = document.createElement('div');
    panel.id = 'notif-panel';
    panel.style.cssText = 'position:fixed;top:54px;right:14px;width:320px;max-height:400px;background:var(--card);border:1.5px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.15);z-index:900;overflow:hidden;display:flex;flex-direction:column';
    panel.innerHTML = `<div style="padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <span style="font-size:13px;font-weight:700;color:var(--navy)">🔔 Oznámení</span>
      <button onclick="clearNotifs()" style="font-size:10px;color:var(--muted);background:none;border:none;cursor:pointer">Smazat vše</button>
    </div>
    <div id="notif-list" style="overflow-y:auto;flex:1;padding:6px 0"></div>`;
    document.body.appendChild(panel);

    // Zavři při kliknutí jinam
    setTimeout(() => {
      document.addEventListener('click', function closePanel(e) {
        if(!panel.contains(e.target) && !e.target.closest('#notif-btn')) {
          panel.remove();
          document.removeEventListener('click', closePanel);
        }
      });
    }, 100);
  } else {
    panel.remove();
    return;
  }
  renderNotifPanel();
}

function renderNotifPanel() {
  const list = document.getElementById('notif-list');
  if(!list) return;
  list.innerHTML = _inAppNotifs.length
    ? _inAppNotifs.map(n => `<div style="padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;font-size:12px"
        onclick="if('${n.zakazkaId}'){switchTab('orders');setTimeout(()=>openDetail('${n.zakazkaId}'),50)}"
        onmouseenter="this.style.background='var(--bg)'" onmouseleave="this.style.background=''">
        <div style="color:var(--text)">${esc(n.msg)}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${new Date(n.ts).toLocaleTimeString('cs-CZ')}</div>
      </div>`).join('')
    : '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Žádná oznámení</div>';
}

function clearNotifs() {
  _inAppNotifs = [];
  updateNotifBadge();
  renderNotifPanel();
}

// Přidej 🔔 tlačítko do kancelář topbaru
(function addNotifButton() {
  setTimeout(() => {
    const darkBtn = document.getElementById('dark-toggle');
    if(!darkBtn || darkBtn._notifAdded) return;
    darkBtn._notifAdded = true;

    const btn = document.createElement('button');
    btn.id = 'notif-btn';
    btn.title = 'Oznámení';
    btn.style.cssText = 'position:relative;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:7px;padding:5px 10px;cursor:pointer;font-size:14px';
    btn.innerHTML = '🔔<span id="notif-badge" style="position:absolute;top:-5px;right:-5px;background:#ef4444;color:#fff;font-size:9px;font-weight:700;border-radius:50%;width:16px;height:16px;display:none;align-items:center;justify-content:center"></span>';
    btn.onclick = toggleNotifPanel;
    darkBtn.before(btn);

    // Požádej o push notifikace
    if('Notification' in window && Notification.permission === 'default') {
      setTimeout(() => Notification.requestPermission(), 3000);
    }
  }, 800);
})();

// Napoj checkStavChanges na realtime listener
(function hookNotifOnListener() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(window._zakazky || tries > 30) {
      clearInterval(iv);
      // Inicializuj _prevStavMap se současným stavem (nezasílej notifikace pro existující)
      if(window._zakazky) {
        window._zakazky.forEach(z => { _prevStavMap[z.id] = z.stav; });
      }
      // Override renderList pro checkování
      if(typeof renderList !== 'undefined') {
        const prev = renderList;
        renderList = function() {
          prev();
          checkStavChanges(window._zakazky || []);
        };
      }
    }
  }, 500);
})();

// ══ KOMPRESE FOTEK V KANCELÁŘI ════════════════════════════════════
// Přepiš upload fotek v kancelář detailu (photo-input v detail panelu)
(function hookKancelarPhotoCompression() {
  // compressPhoto je definována v technik scriptu — bude dostupná globálně
  // Override upload při přidání fotek v kanceláři
  document.addEventListener('change', async e => {
    const inp = e.target;
    if(inp.id !== 'kancelar-photo-input') return; // jen kancelář upload
    // Toto je handled jinde — hook přidáme na savePhotoCaption extension
  });

  // Přepiš kancelář addKancelPhoto pokud existuje
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof compressPhoto !== 'undefined' || tries > 30) {
      clearInterval(iv);
      // compressPhoto je dostupná — patch foto uploadů v kanceláři
      window._compressReady = true;
    }
  }, 300);
})();

// Přidej komprimovaný upload pro kancelář foto input
document.addEventListener('change', async function(e) {
  const inp = e.target;
  // Kancelář upload - photo-input v detail sekci  
  if(inp.type !== 'file' || !inp.accept?.includes('image')) return;
  if(inp.id === 'photo-input') return; // technik - má vlastní handler
  if(!inp.files?.length) return;

  // Najdi zakazkaId z context
  const zakazkaId = window.activeId;
  if(!zakazkaId) return;

  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;

  if(!z.photos) z.photos = [];

  const prog = document.createElement('div');
  prog.style.cssText = 'position:fixed;bottom:20px;right:20px;background:var(--navy);color:#fff;padding:10px 16px;border-radius:8px;font-size:12px;z-index:999';
  prog.id = 'kancelar-upload-prog';
  document.body.appendChild(prog);

  let done = 0;
  const total = inp.files.length;

  for(const file of Array.from(inp.files)) {
    try {
      prog.textContent = `Komprimuji ${file.name}…`;
      const dataUrl = await (typeof compressPhoto !== 'undefined'
        ? compressPhoto(file, 1600, 1200, 0.82)
        : new Promise(res => { const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); })
      );

      const photoObj = { dataUrl, cloudUrl: '', name: file.name, caption: '' };
      z.photos.push(photoObj);

      // Upload do Storage
      if(navigator.onLine && window._fb?.storage) {
        try {
          const user = window._currentUser;
          const path = `photos/${user?.uid||'admin'}/${Date.now()}_${file.name.replace(/\.[^.]+$/, '.jpg')}`;
          const storageRef = window._fb.ref(window._fb.storage, path);
          const blob = await (await fetch(dataUrl)).blob();
          await window._fb.uploadBytes(storageRef, blob);
          photoObj.cloudUrl = await window._fb.getDownloadURL(storageRef);
          // Cache verze
          photoObj.dataUrl = await (typeof compressPhoto !== 'undefined'
            ? compressPhoto(file, 400, 300, 0.6)
            : dataUrl);
        } catch(err) { console.warn('Kancelář upload failed:', err); }
      }

      done++;
      prog.textContent = `Nahráno ${done}/${total}`;

      // Ulož do Firestore
      await window._fb.updateDoc(
        window._fb.doc(window._fb.db, 'zakazky', zakazkaId),
        { photos: z.photos, updatedAt: window._fb.serverTimestamp() }
      );

      // Překresli detail
      openDetail && openDetail(zakazkaId);
    } catch(err) {
      console.error('Upload error:', err);
      done++;
    }
  }

  setTimeout(() => prog.remove(), 2000);
  inp.value = '';
});

// ══ SOUHRN ZAKÁZKY ════════════════════════════════════════════════
function openZakazkaSouhrn(zakazkaId) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  if(!z) return;

  const body = document.getElementById('souhrn-body');
  if(!body) return;

  function parseCena(c) { return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0; }

  // Načti audit log
  window._fb.getDocs(
    window._fb.query(
      window._fb.collection(window._fb.db, 'zakazky', zakazkaId, 'audit'),
      window._fb.orderBy('createdAt', 'asc')
    )
  ).then(snap => {
    const auditItems = snap.docs.map(d => d.data());

    body.innerHTML = `
      <!-- Hlavička -->
      <div style="background:var(--navy);color:#fff;padding:20px;border-radius:12px;margin-bottom:16px">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px">
          <div>
            <div style="font-size:20px;font-weight:800;margin-bottom:4px">${esc(z.nazev||'—')}</div>
            <div style="font-size:13px;color:rgba(255,255,255,.7)">
              Číslo: <strong style="color:#fff">${esc(z.cislo||'—')}</strong>
              · Termín: <strong style="color:#fff">${fmtD(z.termin)||'—'}</strong>
            </div>
          </div>
          <div>${stavBadge(z.stav||'nová')}</div>
        </div>
      </div>

      <!-- Zákazník + technik -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div class="dsec">
          <div class="dsec-hdr">🏢 Zákazník</div>
          <div class="dsec-body" style="font-size:13px">
            <div style="font-weight:700">${esc(z.zakaznik||'—')}</div>
            ${z.ico?`<div style="font-size:11px;color:var(--muted)">IČO: ${esc(z.ico)}</div>`:''}
            ${z.adresa?`<div style="font-size:11px;color:var(--muted)">${esc(z.adresa)}</div>`:''}
            ${z.adresa?`<a href="https://maps.google.com/?q=${encodeURIComponent(z.adresa)}" target="_blank"
              style="font-size:11px;color:#1d4ed8;display:inline-flex;align-items:center;gap:3px;margin-top:4px;text-decoration:none">📍 Mapa</a>`:''}
          </div>
        </div>
        <div class="dsec">
          <div class="dsec-hdr">🔧 Technik</div>
          <div class="dsec-body" style="font-size:13px">
            <div style="font-weight:700">${esc(z.technik||'—')}</div>
            ${z.hodiny?`<div style="font-size:11px;color:var(--muted)">⏱ ${z.hodiny} h odpracováno</div>`:''}
            ${z.km?`<div style="font-size:11px;color:var(--muted)">🚗 ${z.km} km · náhrada ${((z.km||0)*(z.kmSazba||5.6)).toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč</div>`:''}
            ${z.casNaZakazce?`<div style="font-size:11px;color:var(--muted)">⏰ Časovač: ${formatDuration(z.casNaZakazce)}</div>`:''}
          </div>
        </div>
      </div>

      <!-- Popis prací -->
      ${z.prace||z.zadani?`<div class="dsec" style="margin-bottom:12px">
        <div class="dsec-hdr">📝 Provedené práce</div>
        <div class="dsec-body" style="font-size:13px;white-space:pre-wrap">${esc(z.prace||z.zadani||'—')}</div>
      </div>`:''}

      <!-- Cena -->
      <div class="dsec" style="margin-bottom:12px;border:1.5px solid var(--green)">
        <div class="dsec-hdr" style="background:rgba(106,191,62,.08)">💰 Fakturační souhrn</div>
        <div class="dsec-body">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <span style="font-size:13px">Celková cena (bez DPH)</span>
            <span style="font-size:16px;font-weight:800;color:var(--green);font-family:'DM Mono',monospace">${z.cena||'—'}</span>
          </div>
          ${z.duzp?`<div style="font-size:12px;color:var(--muted)">DUZP: ${fmtD(z.duzp)}</div>`:''}
        </div>
      </div>

      <!-- Fotky -->
      ${z.photos?.length?`<div class="dsec" style="margin-bottom:12px">
        <div class="dsec-hdr">📷 Fotodokumentace (${z.photos.length} ks)</div>
        <div class="dsec-body" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px">
          ${z.photos.map(p=>`<div style="aspect-ratio:4/3;border-radius:6px;overflow:hidden;cursor:pointer" onclick="openLightbox('${p.cloudUrl||p.dataUrl}')">
            <img src="${p.cloudUrl||p.dataUrl}" style="width:100%;height:100%;object-fit:cover">
          </div>`).join('')}
        </div>
      </div>`:''}

      <!-- Časová osa -->
      ${auditItems.length?`<div class="dsec">
        <div class="dsec-hdr">📅 Průběh zakázky</div>
        <div class="dsec-body" style="padding:0">
          ${auditItems.map(a=>{
            const ts = a.createdAt?.toDate?.() || new Date();
            const icon = {stav_zmena:'🔄',předáno_dál:'➡',vráceno:'↩',vytvoreno:'🆕',import:'📥'}[a.action]||'📋';
            return `<div style="display:flex;gap:10px;padding:8px 14px;border-bottom:1px solid var(--border)">
              <span style="font-size:16px;flex-shrink:0">${icon}</span>
              <div style="flex:1">
                <div style="font-size:12px;font-weight:600">${esc(a.value||a.action||'—')}</div>
                ${a.note?`<div style="font-size:11px;color:var(--muted)">${esc(a.note)}</div>`:''}
                <div style="font-size:10px;color:var(--muted)">${esc(a.author||'')} · ${ts.toLocaleString('cs-CZ')}</div>
              </div>
            </div>`;
          }).join('')}
        </div>
      </div>`:''}
    `;
  }).catch(() => {
    body.innerHTML = '<div style="padding:20px;color:var(--muted)">Chyba při načítání souhrnu.</div>';
  });

  document.getElementById('souhrn-modal').classList.add('open');
}

function printSouhrn() {
  const body = document.getElementById('souhrn-body');
  const pc = document.getElementById('print-container');
  if(body && pc) {
    pc.innerHTML = `<div style="padding:20px;font-family:Arial,sans-serif">${body.innerHTML}</div>`;
    window.print();
  }
}

// ══ OVERRIDE addUser — ulož roli ═════════════════════════════════
(function hookAddUserRole() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof addUser !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof addUser === 'undefined') return;
      const prev = addUser;
      addUser = async function() {
        // Zavolej původní funkci
        await prev();
        // Pokud bylo vytvoření úspěšné, ulož roli do Firestore
        // (bohužel původní addUser nevrací uid — sledujeme přes auth)
        const role = document.getElementById('nu-role')?.value || 'technik';
        const notifEmail = document.getElementById('nu-notif-email')?.value.trim() || '';
        const email = document.getElementById('nu-email')?.value.trim();
        if(!email) return;
        // Najdi uživatele podle emailu v users kolekci
        try {
          const snap = await window._fb.getDocs(
            window._fb.query(
              window._fb.collection(window._fb.db, 'users'),
              window._fb.where('email', '==', email)
            )
          );
          snap.forEach(async doc => {
            await window._fb.updateDoc(doc.ref, {
              role,
              notifEmail: notifEmail || email,
              updatedAt: window._fb.serverTimestamp()
            });
          });
          console.log(`Role ${role} nastavena pro ${email}`);
        } catch(e) { console.warn('Role set error:', e); }
      };
    }
  }, 300);
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  SOUHRN PRO TECHNIKA — stažení jako HTML soubor
// ════════════════════════════════════════════════════════════════

async function downloadZakazkaSouhrn(zakazkaId) {
  if(!zakazkaId) return;

  // Najdi zakázku — funguje jak v kanceláři tak u technika
  const z = (window._zakazky || window._assignedZakazky || []).find(x => x.id === zakazkaId)
         || (_assignedZakazky||[]).find(x => x.id === zakazkaId);
  if(!z) { alert('Zakázka nenalezena'); return; }

  // Načti audit log pro historii (neblokující)
  let auditItems = [];
  try {
    const snap = await window._fb.getDocs(
      window._fb.query(
        window._fb.collection(window._fb.db, 'zakazky', zakazkaId, 'audit'),
        window._fb.orderBy('createdAt', 'asc')
      )
    );
    auditItems = snap.docs.map(d => {
      const data = d.data();
      const ts = data.createdAt?.toDate?.() || new Date();
      return { ...data, tsStr: ts.toLocaleString('cs-CZ') };
    });
  } catch(e) { /* audit nemusí existovat */ }

  const firma = window._currentFirma === 'progres' ? 'PROGRESKLIMA CZ s.r.o.' : 'AC EURO s.r.o.';
  const dnes  = new Date().toLocaleDateString('cs-CZ');
  const kmNahrada = z.km ? `${z.km} km × ${z.kmSazba||5.60} Kč = ${((z.km||0)*(z.kmSazba||5.60)).toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč` : '—';

  // Fotky — max 6 pro přehlednost, jako base64 inline
  const fotoHtml = (z.photos||[]).slice(0,6).map(p => {
    const src = p.cloudUrl || p.dataUrl || '';
    if(!src) return '';
    return `<div style="break-inside:avoid">
      <img src="${src}" style="width:100%;height:120px;object-fit:cover;border-radius:6px;border:1px solid #e2e8f0;display:block">
      ${p.caption ? `<div style="font-size:10px;color:#64748b;margin-top:3px;text-align:center">${p.caption}</div>` : ''}
    </div>`;
  }).join('');

  const html = `<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Souhrn zakázky — ${z.cislo||z.nazev||'—'}</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, Helvetica, sans-serif; font-size: 13px; color: #1e293b; background: #f8fafc; padding: 16px; }
  .page { max-width: 720px; margin: 0 auto; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 16px rgba(0,0,0,.1); }

  /* Header */
  .hdr { background: #0f1f3d; color: #fff; padding: 20px 24px; }
  .hdr-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px; }
  .hdr-firma { font-size: 11px; color: rgba(255,255,255,.6); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .hdr-nazev { font-size: 20px; font-weight: 800; line-height: 1.2; }
  .hdr-meta { font-size: 12px; color: rgba(255,255,255,.7); margin-top: 6px; }
  .stav-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; background: rgba(255,255,255,.15); color: #fff; border: 1px solid rgba(255,255,255,.3); white-space: nowrap; }

  /* Sekce */
  .body { padding: 20px 24px; }
  .sec { margin-bottom: 16px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
  .sec-hdr { background: #f8fafc; padding: 8px 14px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .05em; color: #475569; border-bottom: 1px solid #e2e8f0; }
  .sec-body { padding: 12px 14px; }

  /* Grid pro info */
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .info-item label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #94a3b8; display: block; margin-bottom: 2px; }
  .info-item span { font-size: 13px; color: #1e293b; font-weight: 500; }

  /* Zadání */
  .zadani-box { background: #eff6ff; border: 1.5px solid #93c5fd; border-radius: 8px; padding: 14px; white-space: pre-wrap; line-height: 1.6; color: #1e3a5f; font-size: 13px; }

  /* Fotky */
  .foto-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }

  /* Audit */
  .audit-row { display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
  .audit-row:last-child { border-bottom: none; }
  .audit-icon { font-size: 16px; flex-shrink: 0; width: 24px; text-align: center; }
  .audit-text { flex: 1; }
  .audit-val { font-size: 12px; font-weight: 600; }
  .audit-note { font-size: 11px; color: #64748b; }
  .audit-meta { font-size: 10px; color: #94a3b8; }

  /* Podpisy */
  .sig-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .sig-box { border: 1.5px dashed #cbd5e1; border-radius: 8px; padding: 12px; text-align: center; }
  .sig-box img { max-height: 80px; max-width: 100%; object-fit: contain; display: block; margin: 0 auto; }
  .sig-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #94a3b8; margin-bottom: 8px; }

  /* Cena */
  .cena-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
  .cena-row:last-child { border-bottom: none; padding-top: 10px; font-weight: 800; font-size: 16px; color: #16a34a; }

  /* Footer */
  .foot { padding: 14px 24px; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; }

  /* Tisk */
  @media print {
    body { background: #fff; padding: 0; }
    .page { box-shadow: none; border-radius: 0; }
    .no-print { display: none !important; }
  }
</style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <div class="hdr">
    <div class="hdr-top">
      <div>
        <div class="hdr-firma">${firma}</div>
        <div class="hdr-nazev">${z.nazev||'Servisní zakázka'}</div>
        <div class="hdr-meta">
          Číslo: <strong style="color:#fff">${z.cislo||'—'}</strong>
          &nbsp;·&nbsp; Termín: <strong style="color:#fff">${z.termin ? new Date(z.termin+'T12:00').toLocaleDateString('cs-CZ',{weekday:'long',day:'numeric',month:'long',year:'numeric'}) : '—'}</strong>
        </div>
      </div>
      <div>
        <span class="stav-badge">${z.stav||'nová'}</span>
        <div style="font-size:10px;color:rgba(255,255,255,.5);margin-top:6px;text-align:right">Vytištěno: ${dnes}</div>
      </div>
    </div>
  </div>

  <div class="body">

    <!-- Tlačítka (skryjí se při tisku) -->
    <div class="no-print" style="display:flex;gap:8px;margin-bottom:16px">
      <button onclick="window.print()" style="background:#0f1f3d;color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px">
        🖨 Tisknout
      </button>
      <button onclick="window.close()" style="background:#f1f5f9;color:#475569;border:1px solid #e2e8f0;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:13px">
        Zavřít
      </button>
    </div>

    <!-- Zákazník + Technik -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
      <div class="sec">
        <div class="sec-hdr">🏢 Zákazník</div>
        <div class="sec-body">
          <div style="font-weight:700;font-size:14px;margin-bottom:4px">${z.zakaznik||'—'}</div>
          ${z.ico ? `<div style="font-size:11px;color:#64748b">IČO: ${z.ico}${z.dic?' · DIČ: '+z.dic:''}</div>` : ''}
          ${z.adresa ? `<div style="font-size:11px;color:#475569;margin-top:4px">${z.adresa}</div>
          <a href="https://maps.google.com/?q=${encodeURIComponent(z.adresa)}" style="font-size:11px;color:#1d4ed8;display:inline-block;margin-top:4px">📍 Otevřít v mapách</a>` : ''}
        </div>
      </div>
      <div class="sec">
        <div class="sec-hdr">🔧 Přiřazený technik</div>
        <div class="sec-body">
          <div style="font-weight:700;font-size:14px;margin-bottom:4px">${z.technik||'—'}</div>
          ${z.hodiny ? `<div style="font-size:11px;color:#64748b">⏱ Odpracováno: ${z.hodiny} h</div>` : ''}
          ${z.km ? `<div style="font-size:11px;color:#64748b">🚗 Km: ${kmNahrada}</div>` : ''}
        </div>
      </div>
    </div>

    <!-- Zadání od kanceláře -->
    ${z.zadani ? `<div class="sec" style="margin-bottom:16px;border-color:#93c5fd">
      <div class="sec-hdr" style="background:#eff6ff;color:#1d4ed8">📋 Zadání od kanceláře</div>
      <div class="sec-body">
        <div class="zadani-box">${z.zadani}</div>
      </div>
    </div>` : ''}

    <!-- Provedené práce -->
    ${z.prace ? `<div class="sec" style="margin-bottom:16px">
      <div class="sec-hdr">🔧 Provedené práce (technik)</div>
      <div class="sec-body" style="white-space:pre-wrap;line-height:1.6">${z.prace}</div>
    </div>` : ''}

    <!-- Použité díly / cena -->
    ${z.cena ? `<div class="sec" style="margin-bottom:16px;border-color:#86efac">
      <div class="sec-hdr" style="background:#f0fdf4;color:#15803d">💰 Fakturační souhrn</div>
      <div class="sec-body">
        ${z.rows ? z.rows.filter(r=>r.pol).map(r=>`
          <div class="cena-row">
            <span>${r.pol}${r.poc?` (${r.poc} ks)`:''}</span>
            <span style="font-family:monospace">${r.cel||r.cen||'—'} Kč</span>
          </div>`).join('') : ''}
        <div class="cena-row">
          <span>CELKEM BEZ DPH</span>
          <span style="font-family:monospace">${z.cena}</span>
        </div>
        ${z.duzp ? `<div style="font-size:11px;color:#64748b;margin-top:6px">DUZP: ${z.duzp}</div>` : ''}
      </div>
    </div>` : ''}

    <!-- Fotodokumentace -->
    ${fotoHtml ? `<div class="sec" style="margin-bottom:16px">
      <div class="sec-hdr">📷 Fotodokumentace (${(z.photos||[]).length} ks${(z.photos||[]).length>6?' · zobrazeno 6':''})</div>
      <div class="sec-body">
        <div class="foto-grid">${fotoHtml}</div>
      </div>
    </div>` : ''}

    <!-- Průběh zakázky -->
    ${auditItems.length ? `<div class="sec" style="margin-bottom:16px">
      <div class="sec-hdr">📅 Průběh zakázky</div>
      <div class="sec-body">
        ${auditItems.map(a => {
          const icon = {stav_zmena:'🔄','předáno_dál':'➡',vráceno:'↩',vytvoreno:'🆕',import:'📥'}[a.action]||'📋';
          return `<div class="audit-row">
            <div class="audit-icon">${icon}</div>
            <div class="audit-text">
              <div class="audit-val">${a.value||a.action||'—'}</div>
              ${a.note?`<div class="audit-note">${a.note}</div>`:''}
              <div class="audit-meta">${a.author||''} · ${a.tsStr||''}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>` : ''}

    <!-- Podpisy -->
    ${(z.sig1||z.sig2) ? `<div class="sec" style="margin-bottom:0">
      <div class="sec-hdr">✍️ Podpisy</div>
      <div class="sec-body">
        <div class="sig-grid">
          <div class="sig-box">
            <div class="sig-label">Za zhotovitele</div>
            ${z.sig1 ? `<img src="${z.sig1}">` : '<div style="height:60px;border:1px dashed #cbd5e1;border-radius:4px"></div>'}
            <div style="font-size:10px;color:#94a3b8;margin-top:6px">${z.sigDate1||''}</div>
          </div>
          <div class="sig-box">
            <div class="sig-label">Za objednatele (zákazník)</div>
            ${z.sig2 ? `<img src="${z.sig2}">` : '<div style="height:60px;border:1px dashed #cbd5e1;border-radius:4px"></div>'}
            <div style="font-size:10px;color:#94a3b8;margin-top:6px">${z.sigDate2||''}</div>
          </div>
        </div>
      </div>
    </div>` : ''}

  </div><!-- /body -->

  <!-- FOOTER -->
  <div class="foot">
    <span>${firma}</span>
    <span>Zakázka č. ${z.cislo||'—'} · Vygenerováno ${dnes}</span>
  </div>

</div><!-- /page -->
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 7 — rychlá zakázka, opakující se zakázky,
//  hodnocení zákazníkem, auto-check šablon
// ════════════════════════════════════════════════════════════════

// ══ RYCHLÁ ZAKÁZKA (technik) ══════════════════════════════════════
function openQuickZakazka() {
  const overlay = document.getElementById('quick-zakaz-overlay');
  if(!overlay) return;

  // Nastav dnešní datum
  const termin = document.getElementById('qz-termin');
  if(termin && !termin.value) termin.value = new Date().toISOString().slice(0,10);

  // Naplň autocomplete zákazníků
  const dl = document.getElementById('qz-zak-list');
  if(dl && window._zakaznici?.length) {
    dl.innerHTML = window._zakaznici.map(z=>`<option value="${z.nazev}">`).join('');
  } else if(dl && window._zakazky?.length) {
    const names = [...new Set(window._zakazky.map(z=>z.zakaznik||'').filter(Boolean))];
    dl.innerHTML = names.map(n=>`<option value="${n}">`).join('');
  }

  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('qz-nazev')?.focus(), 100);
}

function closeQuickZakazka() {
  const overlay = document.getElementById('quick-zakaz-overlay');
  if(overlay) overlay.style.display = 'none';
  document.body.style.overflow = '';
}

async function saveQuickZakazka() {
  const nazev = document.getElementById('qz-nazev')?.value.trim();
  if(!nazev) {
    document.getElementById('qz-nazev').style.borderColor = '#ef4444';
    return;
  }

  const btn = document.querySelector('#quick-zakaz-overlay button[onclick="saveQuickZakazka()"]');
  if(btn) { btn.disabled = true; btn.textContent = '⏳ Ukládám…'; }

  const me = window._currentUser;
  const data = {
    nazev,
    zakaznik: document.getElementById('qz-zakaznik')?.value.trim() || '',
    adresa:   document.getElementById('qz-adresa')?.value.trim() || '',
    termin:   document.getElementById('qz-termin')?.value || '',
    prace:    document.getElementById('qz-popis')?.value.trim() || '',
    zadani:   document.getElementById('qz-popis')?.value.trim() || '',
    stav:     'nová',
    firma:    window._currentFirma || 'aceuro',
    technik:  me?.displayName || me?.email || '',
    technikUid: me?.uid || '',
    createdBy: me?.uid || '',
    quickCreate: true,
    createdAt: window._fb.serverTimestamp(),
    updatedAt: window._fb.serverTimestamp(),
  };

  // Generuj číslo
  const year = new Date().getFullYear();
  const count = (window._zakazky||[]).filter(z=>z.cislo?.startsWith(String(year))).length + 1;
  data.cislo = `${year}-${String(count).padStart(4,'0')}`;

  try {
    await window._fb.addDoc(window._fb.collection(window._fb.db,'zakazky'), data);
    closeQuickZakazka();
    // Vymaž formulář
    ['qz-nazev','qz-zakaznik','qz-adresa','qz-popis'].forEach(id => {
      const el = document.getElementById(id);
      if(el) el.value = '';
    });
    showToast && showToast('✅ Zakázka vytvořena');
    // Načti přiřazené zakázky
    loadAssignedZakazky && loadAssignedZakazky(window._currentUser);
  } catch(e) {
    alert('Chyba: ' + e.message);
  } finally {
    if(btn) { btn.disabled = false; btn.textContent = '✓ Vytvořit zakázku'; }
  }
}

// Zavři na klik mimo
document.getElementById('quick-zakaz-overlay')?.addEventListener('click', e => {
  if(e.target.id === 'quick-zakaz-overlay') closeQuickZakazka();
});

// ══ OPAKUJÍCÍ SE ZAKÁZKY (automatické vytváření ze šablon) ════════
async function checkAndCreateRepeatZakazky() {
  if(!window._sablony?.length) return;
  const dnes = new Date().toISOString().slice(0,10);
  const me = window._currentUser;
  let created = 0;

  for(const s of window._sablony) {
    if(!s.interval || !s.autoCreate) continue; // jen šablony s autoCreate=true

    // Najdi poslední zakázku z této šablony
    const fromSablona = (window._zakazky||[])
      .filter(z => z.sablonaId === s.id)
      .sort((a,b) => (b.termin||'').localeCompare(a.termin||''));

    const lastZ = fromSablona[0];
    let nextTermin;

    if(lastZ?.termin) {
      const last = new Date(lastZ.termin);
      last.setDate(last.getDate() + parseInt(s.interval));
      nextTermin = last.toISOString().slice(0,10);
    } else {
      // Žádná předchozí — naplánuj na dnes + interval
      const next = new Date();
      next.setDate(next.getDate() + parseInt(s.interval));
      nextTermin = next.toISOString().slice(0,10);
    }

    // Vytvoř jen pokud termín je do 7 dní od teď a zakázka ještě neexistuje
    const diffDays = Math.ceil((new Date(nextTermin) - new Date(dnes)) / 86400000);
    if(diffDays > 7 || diffDays < 0) continue;

    // Zkontroluj zda už taková zakázka v tomto termínu existuje
    const alreadyExists = (window._zakazky||[]).some(z =>
      z.sablonaId === s.id && z.termin === nextTermin
    );
    if(alreadyExists) continue;

    // Vytvoř zakázku
    try {
      await window._fb.addDoc(window._fb.collection(window._fb.db,'zakazky'), {
        nazev:    s.nazev,
        typ:      s.typ||'',
        firma:    s.firma||window._currentFirma||'aceuro',
        prace:    s.prace||'',
        zadani:   s.zadani||s.prace||'',
        rows:     s.rows||[],
        zakaznik: s.zakaznik||'',
        adresa:   s.adresa||'',
        termin:   nextTermin,
        stav:     'nová',
        sablonaId: s.id,
        sablonaAutoCreate: true,
        createdBy: me?.uid||'system',
        createdAt: window._fb.serverTimestamp(),
        updatedAt: window._fb.serverTimestamp(),
      });
      created++;
    } catch(e) { console.warn('Auto-create failed:', e); }
  }

  if(created > 0) {
    showToast && showToast(`🔄 Automaticky vytvořeno ${created} opakujících se zakázek`);
    showInAppNotif && showInAppNotif(`🔄 Automaticky vytvořeno ${created} zakázek ze šablon`, null);
  }
}

// Spusť kontrolu po načtení šablon
(function scheduleRepeatCheck() {
  let checked = false;
  const iv = setInterval(() => {
    if(window._sablony && window._zakazky && !checked) {
      checked = true;
      clearInterval(iv);
      checkAndCreateRepeatZakazky();
    }
  }, 2000);
})();

// ══ HODNOCENÍ ZÁKAZNÍKEM ══════════════════════════════════════════
let _hodnoceniValue = 0;

function setHvezda(n) {
  _hodnoceniValue = n;
  for(let i=1;i<=5;i++) {
    const el = document.getElementById('hv'+i);
    if(el) {
      el.textContent = i <= n ? '★' : '☆';
      el.style.color = i <= n ? '#f59e0b' : '#9ca3af';
      el.style.transform = i === n ? 'scale(1.3)' : 'scale(1)';
    }
  }
  setTimeout(() => {
    for(let i=1;i<=5;i++) {
      const el = document.getElementById('hv'+i);
      if(el) el.style.transform = '';
    }
  }, 200);
}

function hoverHvezda(n) {
  for(let i=1;i<=5;i++) {
    const el = document.getElementById('hv'+i);
    if(!el) continue;
    if(n === 0) {
      // Vrať na aktuální hodnocení
      el.textContent = i <= _hodnoceniValue ? '★' : '☆';
      el.style.color = i <= _hodnoceniValue ? '#f59e0b' : '#9ca3af';
    } else {
      el.textContent = i <= n ? '★' : '☆';
      el.style.color = i <= n ? '#f59e0b' : '#d1d5db';
    }
  }
}

function openHodnoceniModal(zakazkaId) {
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  document.getElementById('hodnoceni-id').value = zakazkaId;
  document.getElementById('hodnoceni-nazev').textContent =
    z ? `Hodnocení: ${z.nazev||'Zakázka'}` : 'Hodnocení zakázky';
  document.getElementById('hodnoceni-sub').textContent =
    z?.zakaznik ? `Zákazník: ${z.zakaznik}` : 'Jak jste spokojeni se servisním zásahem?';
  document.getElementById('hodnoceni-text').value = '';
  document.getElementById('hodnoceni-jmeno').value = z?.zakaznik||'';
  _hodnoceniValue = 0;
  setHvezda(0);
  document.getElementById('hodnoceni-modal').classList.add('open');
}

async function saveHodnoceni() {
  const id = document.getElementById('hodnoceni-id').value;
  if(!_hodnoceniValue) {
    // Vizuální feedback — musí vybrat hvězdičky
    document.getElementById('hvezdicky').style.animation = 'shake .3s';
    setTimeout(() => document.getElementById('hvezdicky').style.animation = '', 400);
    return;
  }
  const text  = document.getElementById('hodnoceni-text')?.value.trim() || '';
  const jmeno = document.getElementById('hodnoceni-jmeno')?.value.trim() || '';
  try {
    // Ulož hodnocení do Firestore
    await window._fb.addDoc(
      window._fb.collection(window._fb.db,'hodnoceni'),
      {
        zakazkaId: id,
        hvezdicky: _hodnoceniValue,
        text, jmeno,
        createdAt: window._fb.serverTimestamp()
      }
    );
    // Ulož průměr na zakázku
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db,'zakazky',id),
      { hodnoceni: _hodnoceniValue, hodnoceniText: text, updatedAt: window._fb.serverTimestamp() }
    );
    closeModal('hodnoceni-modal');
    showToast && showToast('⭐ Hodnocení odesláno, děkujeme!');
    // Notifikace kanceláři
    const z = (window._zakazky||[]).find(x=>x.id===id);
    showInAppNotif && showInAppNotif(
      `⭐ Nové hodnocení (${_hodnoceniValue}/5): ${z?.nazev||'—'}${text?' · '+text.substring(0,40):''}`,
      id
    );
  } catch(e) { alert('Chyba: '+e.message); }
}

// Odkaz na hodnocení pro zákazníka (otevře modal přímo)
function openHodnoceniLink(zakazkaId) {
  // Generuj sdílitelný odkaz — zakázka ID jako hash parametr
  const url = location.origin + location.pathname + '#hodnoceni=' + zakazkaId;

  // Zobraz dialog s možností kopírovat nebo odeslat SMS
  const z = (window._zakazky||[]).find(x=>x.id===zakazkaId);
  const smsText = `Dobrý den, ${z?.zakaznik?z.zakaznik+', ':''
    }rádi bychom znali Váš názor na náš servisní zásah. Ohodnoťte nás: ${url}`;

  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = `<div style="background:#fff;border-radius:14px;padding:24px;max-width:460px;width:100%">
    <h3 style="margin-bottom:4px;color:var(--navy)">⭐ Odkaz na hodnocení</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:14px">Zákazník klikne na odkaz a ohodnotí zakázku bez nutnosti přihlášení.</p>
    <div style="background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px;word-break:break-all;margin-bottom:12px;font-family:monospace">${url}</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="navigator.clipboard.writeText('${url}');showToast&&showToast('✓ Odkaz zkopírován')"
        class="btn btn-primary" style="font-size:12px">📋 Kopírovat odkaz</button>
      <button onclick="navigator.clipboard.writeText('${smsText.replace(/'/g,'&apos;')}');showToast&&showToast('✓ SMS text zkopírován')"
        class="btn btn-ghost" style="font-size:12px">📱 Kopírovat SMS text</button>
      <button onclick="this.closest('.hodnoceni-link-modal').remove()"
        class="btn btn-ghost" style="font-size:12px;margin-left:auto">Zavřít</button>
    </div>
  </div>`;
  modal.className = 'hodnoceni-link-modal';
  modal.onclick = e => { if(e.target===modal) modal.remove(); };
  document.body.appendChild(modal);
}

// Zkontroluj hash při načtení — otevři hodnocení pokud je v URL
(function checkHodnoceniHash() {
  const hash = location.hash;
  if(hash.startsWith('#hodnoceni=')) {
    const id = hash.replace('#hodnoceni=','');
    if(id) {
      // Počkej na načtení dat
      let tries = 0;
      const iv = setInterval(() => {
        tries++;
        if(window._zakazky || tries > 20) {
          clearInterval(iv);
          openHodnoceniModal(id);
          history.replaceState(null,'',location.pathname); // odstraň hash
        }
      }, 500);
    }
  }
})();

// ══ HODNOCENÍ V KANCELÁŘ DETAILU ══════════════════════════════════
// Zobraz hvězdičky v detailu zakázky pokud existuje hodnocení
(function hookHodnoceniOnDetail() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof openDetail !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof openDetail === 'undefined') return;
      const prev = openDetail;
      openDetail = function(id) {
        prev(id);
        setTimeout(() => {
          const z = (window._zakazky||[]).find(x=>x.id===id);
          if(!z?.hodnoceni) return;
          // Najdi header detailu a přidej hvězdičky
          const hdr = document.querySelector('.detail-hdr-left');
          if(hdr && !hdr.querySelector('.hodnoceni-stars')) {
            const stars = document.createElement('div');
            stars.className = 'hodnoceni-stars';
            stars.style.cssText = 'font-size:13px;margin-top:4px';
            stars.innerHTML = '★'.repeat(z.hodnoceni) + '☆'.repeat(5-z.hodnoceni) +
              `<span style="font-size:11px;color:rgba(255,255,255,.7);margin-left:6px">${z.hodnoceni}/5</span>` +
              (z.hodnoceniText ? `<span style="font-size:11px;color:rgba(255,255,255,.6);margin-left:8px;font-style:italic">"${z.hodnoceniText.substring(0,40)}"</span>` : '');
            stars.style.color = '#fbbf24';
            hdr.appendChild(stars);
          }
        }, 400);
      };
    }
  }, 200);
})();

// ══ AUTO-CREATE šablony — přidej pole autoCreate do šablona modalu ══
(function patchSablonaModal() {
  setTimeout(() => {
    // Najdi sablona modal form a přidej checkbox autoCreate pokud neexistuje
    const form = document.getElementById('sablona-form') || document.querySelector('[id*="sablona"]');
    // Přidáme přes interval field description
    const intervalInp = document.querySelector('input[id*="interval"]') || document.getElementById('s-interval');
    if(intervalInp && !intervalInp._patched) {
      intervalInp._patched = true;
      const wrapper = intervalInp.closest('.fg2') || intervalInp.parentElement;
      if(wrapper) {
        const autoDiv = document.createElement('div');
        autoDiv.style.cssText = 'margin-top:8px;display:flex;align-items:center;gap:8px';
        autoDiv.innerHTML = `<input type="checkbox" id="s-auto-create" style="width:16px;height:16px">
          <label for="s-auto-create" style="font-size:12px;cursor:pointer;user-select:none">
            Automaticky vytvořit zakázku ${intervalInp.value||'N'} dní před termínem
          </label>`;
        wrapper.appendChild(autoDiv);
      }
    }
  }, 2000);
})();

// ══ CSS pro shake animaci hvězdiček ══════════════════════════════
(function addShakeCSS() {
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }
  `;
  document.head.appendChild(style);
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 8 — rozšířený dashboard KPI, API bridge
// ════════════════════════════════════════════════════════════════

// ══ ROZŠÍŘENÝ renderDashboard — patch stávající funkce ═══════════
(function patchRenderDashboard() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof renderDashboard !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof renderDashboard === 'undefined') return;
      const prev = renderDashboard;
      renderDashboard = function() {
        prev(); // původní render
        renderKpiExtended(); // nové KPI sekce
      };
    }
  }, 200);
})();

function parseCenaVal(c) {
  return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0;
}

function renderKpiExtended() {
  const all = window._zakazky || [];
  const now  = new Date();

  // Určení období
  const period = document.getElementById('dash-tech-period')?.value || 'month';
  let periodStart;
  if(period === 'month') {
    periodStart = new Date(now.getFullYear(), now.getMonth(), 1);
  } else if(period === 'quarter') {
    const q = Math.floor(now.getMonth()/3);
    periodStart = new Date(now.getFullYear(), q*3, 1);
  } else {
    periodStart = new Date(now.getFullYear(), 0, 1);
  }
  const periodStr = periodStart.toISOString().slice(0,10);

  const periodZ = all.filter(z => (z.termin||z.createdAt?.toDate?.().toISOString().slice(0,10)||'') >= periodStr);

  // ── KPI ALERTS ─────────────────────────────────────────────
  const alertsEl = document.getElementById('kpi-alerts');
  const alertsInner = document.getElementById('kpi-alerts-inner');
  if(alertsEl && alertsInner) {
    const alerts = [];

    // Zakázky po termínu
    const overdue = all.filter(z => {
      if(!z.termin || ['zaplacena','fakturovaná'].includes(z.stav)) return false;
      return z.termin < now.toISOString().slice(0,10);
    });
    if(overdue.length) {
      alerts.push({
        color: '#dc2626', bg: '#fef2f2', icon: '🔴',
        msg: `${overdue.length} zakázek po termínu`,
        action: `onclick="filterOverdue()"`,
        detail: overdue.slice(0,3).map(z=>z.nazev||'—').join(', ') + (overdue.length>3?'…':'')
      });
    }

    // Nezaplacené faktury starší 30 dní
    const oldUnpaid = all.filter(z => {
      if(z.stav !== 'fakturovaná') return false;
      const termin = new Date(z.termin||'2000-01-01');
      return (now - termin) > 30*86400000;
    });
    if(oldUnpaid.length) {
      const suma = oldUnpaid.reduce((s,z)=>s+parseCenaVal(z.cena),0);
      alerts.push({
        color: '#d97706', bg: '#fffbeb', icon: '🟡',
        msg: `${oldUnpaid.length} neuhrazených faktur > 30 dní`,
        detail: `Celkem: ${suma.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč`
      });
    }

    // Zakázky bez technika
    const unassigned = all.filter(z =>
      !z.technik && !['zaplacena','fakturovaná','zpracovaná'].includes(z.stav)
    );
    if(unassigned.length) {
      alerts.push({
        color: '#6d28d9', bg: '#f5f3ff', icon: '🔵',
        msg: `${unassigned.length} zakázek bez přiřazeného technika`,
        detail: ''
      });
    }

    if(alerts.length) {
      alertsEl.style.display = 'block';
      alertsInner.innerHTML = alerts.map(a => `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:${a.bg};border:1.5px solid ${a.color}30;border-radius:8px;cursor:pointer" ${a.action||''}>
          <span style="font-size:18px">${a.icon}</span>
          <div style="flex:1">
            <div style="font-size:12px;font-weight:700;color:${a.color}">${a.msg}</div>
            ${a.detail?`<div style="font-size:11px;color:#6b7280;margin-top:1px">${a.detail}</div>`:''}
          </div>
        </div>`).join('');
    } else {
      alertsEl.style.display = 'none';
    }
  }

  // ── VÝKONNOST TECHNIKŮ ──────────────────────────────────────
  const techGrid = document.getElementById('tech-performance-grid');
  if(techGrid) {
    const byTech = {};
    periodZ.forEach(z => {
      const t = z.technik || 'Nepřiřazeno';
      if(!byTech[t]) byTech[t] = { name:t, count:0, rev:0, hours:0, done:0, rated:0, ratingSum:0 };
      byTech[t].count++;
      byTech[t].rev += parseCenaVal(z.cena);
      byTech[t].hours += parseFloat(z.hodiny||0);
      if(['zpracovaná','fakturovaná','zaplacena'].includes(z.stav)) byTech[t].done++;
      if(z.hodnoceni) { byTech[t].rated++; byTech[t].ratingSum += z.hodnoceni; }
    });

    const entries = Object.values(byTech)
      .filter(t => t.name !== 'Nepřiřazeno')
      .sort((a,b) => b.count - a.count)
      .slice(0, 8);

    if(!entries.length) {
      techGrid.innerHTML = '<div style="font-size:12px;color:var(--muted);font-style:italic">Žádná data pro zvolené období</div>';
    } else {
      const maxCount = Math.max(...entries.map(t=>t.count), 1);
      techGrid.innerHTML = entries.map(t => {
        const doneRate = t.count ? Math.round(t.done/t.count*100) : 0;
        const avgRating = t.rated ? (t.ratingSum/t.rated).toFixed(1) : null;
        const avatar = t.name[0].toUpperCase();
        return `<div style="background:var(--card);border:1.5px solid var(--border);border-radius:10px;padding:12px">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <div style="width:34px;height:34px;border-radius:50%;background:var(--navy);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0">${avatar}</div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:700;font-size:12px;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.name)}</div>
              <div style="font-size:10px;color:var(--muted)">${t.count} zakázek · ${doneRate}% hotovo</div>
            </div>
          </div>
          <!-- Progress bar -->
          <div style="background:var(--bg);border-radius:4px;height:5px;margin-bottom:8px;overflow:hidden">
            <div style="width:${Math.round(t.count/maxCount*100)}%;height:100%;background:var(--navy);border-radius:4px;transition:width .5s"></div>
          </div>
          <!-- Metriky -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px">
            <div style="color:var(--muted)">💰 Obrat</div>
            <div style="font-weight:600;text-align:right;font-family:monospace">${t.rev.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč</div>
            ${t.hours ? `<div style="color:var(--muted)">⏱ Hodiny</div><div style="font-weight:600;text-align:right">${t.hours.toFixed(1)} h</div>` : ''}
            ${avgRating ? `<div style="color:var(--muted)">⭐ Hodnocení</div><div style="font-weight:600;text-align:right;color:#f59e0b">${avgRating}/5</div>` : ''}
          </div>
        </div>`;
      }).join('');
    }
  }

  // ── PRŮMĚRNÁ DOBA ZPRACOVÁNÍ ────────────────────────────────
  const avgTimeEl = document.getElementById('avg-time-stats');
  if(avgTimeEl) {
    const completed = all.filter(z => z.stav === 'zpracovaná' || z.stav === 'zaplacena');
    const withDates = completed.filter(z => z.termin && z.createdAt?.toDate);

    let avgDays = null;
    if(withDates.length) {
      const totalDays = withDates.reduce((s,z) => {
        const created = z.createdAt.toDate();
        const termin  = new Date(z.termin);
        return s + Math.max(0, Math.ceil((termin - created) / 86400000));
      }, 0);
      avgDays = (totalDays / withDates.length).toFixed(1);
    }

    // Průměrné hodiny
    const withHours = all.filter(z => z.hodiny > 0);
    const avgHours = withHours.length
      ? (withHours.reduce((s,z)=>s+parseFloat(z.hodiny||0),0) / withHours.length).toFixed(1)
      : null;

    avgTimeEl.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="text-align:center;padding:14px;background:var(--bg);border-radius:8px">
          <div style="font-size:28px;font-weight:800;color:var(--navy)">${avgDays||'—'}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">průměr dní na zakázku</div>
        </div>
        <div style="text-align:center;padding:14px;background:var(--bg);border-radius:8px">
          <div style="font-size:28px;font-weight:800;color:var(--green)">${avgHours||'—'}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">průměr hodin práce</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted);text-align:center;margin-top:6px">
        Z ${completed.length} dokončených zakázek · ${withHours.length} se zápisem hodin
      </div>`;
  }

  // ── PRŮMĚRNÉ HODNOCENÍ ──────────────────────────────────────
  const avgHodEl = document.getElementById('avg-hodnoceni-stats');
  if(avgHodEl) {
    const rated = all.filter(z => z.hodnoceni);
    if(!rated.length) {
      avgHodEl.innerHTML = '<div style="font-size:12px;color:var(--muted);font-style:italic">Zatím žádná hodnocení</div>';
    } else {
      const avg = rated.reduce((s,z)=>s+z.hodnoceni,0) / rated.length;
      const byStars = {1:0,2:0,3:0,4:0,5:0};
      rated.forEach(z => byStars[z.hodnoceni] = (byStars[z.hodnoceni]||0) + 1);

      avgHodEl.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <div style="font-size:40px;font-weight:800;color:var(--navy);line-height:1">${avg.toFixed(1)}</div>
          <div>
            <div style="color:#f59e0b;font-size:20px">${'★'.repeat(Math.round(avg))}${'☆'.repeat(5-Math.round(avg))}</div>
            <div style="font-size:11px;color:var(--muted)">${rated.length} hodnocení</div>
          </div>
        </div>
        ${[5,4,3,2,1].map(n => {
          const count = byStars[n]||0;
          const pct = Math.round(count/rated.length*100);
          return `<div style="display:flex;align-items:center;gap:6px;font-size:11px;margin-bottom:4px">
            <span style="width:20px;text-align:right;color:var(--muted)">${n}★</span>
            <div style="flex:1;background:var(--bg);border-radius:3px;height:8px;overflow:hidden">
              <div style="width:${pct}%;height:100%;background:#f59e0b;border-radius:3px;transition:width .5s"></div>
            </div>
            <span style="width:28px;color:var(--muted)">${count}</span>
          </div>`;
        }).join('')}`;
    }
  }

  // ── ROZŠÍŘENÉ STATS KARTY ───────────────────────────────────
  // Přidej do stats-grid další info — zakázky po termínu count
  const sg = document.getElementById('stats-grid');
  if(sg && !sg._extended) {
    sg._extended = true;
    // Přidej extra karty za existující
    const overdue2 = all.filter(z =>
      z.termin < now.toISOString().slice(0,10) &&
      !['zaplacena','fakturovaná','zpracovaná'].includes(z.stav||'nová')
    ).length;
    const avgRatingAll = all.filter(z=>z.hodnoceni).length
      ? (all.filter(z=>z.hodnoceni).reduce((s,z)=>s+z.hodnoceni,0) /
         all.filter(z=>z.hodnoceni).length).toFixed(1) : '—';

    const extra = document.createElement('div');
    extra.id = 'stats-extra';
    extra.style.cssText = 'display:contents';
    extra.innerHTML = `
      <div class="stat-card ${overdue2>0?'warn':'green'}">
        <div class="val">${overdue2}</div>
        <div class="lbl">Po termínu</div>
      </div>
      <div class="stat-card blue">
        <div class="val">${avgRatingAll}</div>
        <div class="lbl">Avg. hodnocení ⭐</div>
      </div>`;
    sg.appendChild(extra);
  }
}

// Filtr zakázek po termínu
function filterOverdue() {
  switchTab('orders');
  setTimeout(() => {
    const sf = document.getElementById('stav-filter');
    if(sf) { sf.value = ''; sf.dispatchEvent(new Event('change')); }
    // Filtry nastaví list na "po termínu"
    window._filterOverdue = true;
    renderList && renderList();
  }, 100);
}

// ══ API BRIDGE — propojení s plánovací aplikací ══════════════════
//
// REST-like rozhraní pro externí aplikace přes PostMessage nebo URL hash
// Umožňuje plánovací aplikaci:
//  1. Číst seznam zakázek a techniků
//  2. Vytvořit/aktualizovat zakázku
//  3. Přiřadit technika
//  4. Číst stav v reálném čase

// Webhook URL pro odchozí události (nastavitelné)
let _webhookUrl = localStorage.getItem('webhook-url') || '';
let _apiKey      = localStorage.getItem('api-key') || '';

// Odchozí události → plánovací aplikace
async function sendWebhook(event, data) {
  if(!_webhookUrl) return;
  try {
    await fetch(_webhookUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': _apiKey,
        'X-Source': 'ac-euro-servis',
      },
      body: JSON.stringify({
        event,
        timestamp: new Date().toISOString(),
        data,
      })
    });
  } catch(e) {
    console.warn('Webhook failed:', e.message);
  }
}

// PostMessage API — pro embed nebo iframe integrace
window.addEventListener('message', async e => {
  if(!e.data?.type?.startsWith('SERVIS_')) return;
  const { type, payload, requestId } = e.data;

  const reply = (data, error) => {
    e.source?.postMessage({ requestId, data, error }, e.origin);
  };

  try {
    switch(type) {

      case 'SERVIS_GET_ZAKAZKY':
        // Vrátí seznam zakázek (filtrované)
        const zakazky = (window._zakazky || []).map(z => ({
          id:       z.id,
          cislo:    z.cislo,
          nazev:    z.nazev,
          zakaznik: z.zakaznik,
          technik:  z.technik,
          termin:   z.termin,
          stav:     z.stav,
          adresa:   z.adresa,
          cena:     z.cena,
        }));
        reply({ zakazky });
        break;

      case 'SERVIS_GET_TECHNICI':
        // Vrátí seznam techniků
        const technici = [...new Set(
          (window._zakazky||[]).map(z=>z.technik||'').filter(Boolean)
        )].map(name => ({ name }));
        reply({ technici });
        break;

      case 'SERVIS_CREATE_ZAKAZKA':
        // Vytvoří novou zakázku z plánovací aplikace
        if(!payload?.nazev) { reply(null, 'Chybí nazev'); break; }
        const ref = await window._fb.addDoc(
          window._fb.collection(window._fb.db, 'zakazky'),
          {
            ...payload,
            stav: payload.stav || 'ke zpracování',
            source: 'planning-app',
            createdAt: window._fb.serverTimestamp(),
            updatedAt: window._fb.serverTimestamp(),
          }
        );
        reply({ id: ref.id });
        break;

      case 'SERVIS_UPDATE_ZAKAZKA':
        // Aktualizuje existující zakázku
        if(!payload?.id) { reply(null, 'Chybí id'); break; }
        const { id: updateId, ...updateData } = payload;
        await window._fb.updateDoc(
          window._fb.doc(window._fb.db, 'zakazky', updateId),
          { ...updateData, updatedAt: window._fb.serverTimestamp() }
        );
        reply({ ok: true });
        break;

      case 'SERVIS_ASSIGN_TECHNIK':
        // Přiřadí technika k zakázce
        if(!payload?.zakazkaId || !payload?.technik) { reply(null, 'Chybí zakazkaId nebo technik'); break; }
        await window._fb.updateDoc(
          window._fb.doc(window._fb.db, 'zakazky', payload.zakazkaId),
          {
            technik:  payload.technik,
            termin:   payload.termin || '',
            zadani:   payload.zadani || '',
            stav:     'ke zpracování',
            updatedAt: window._fb.serverTimestamp(),
          }
        );
        reply({ ok: true });
        break;

      default:
        reply(null, `Neznámý typ: ${type}`);
    }
  } catch(err) {
    reply(null, err.message);
  }
});

// Webhook při změně stavu zakázky — napoj na changeStav
(function hookWebhookOnChangeStav() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof changeStav !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof changeStav === 'undefined') return;
      const prev = changeStav;
      changeStav = async function(id, stav) {
        await prev(id, stav);
        const z = (window._zakazky||[]).find(x=>x.id===id);
        sendWebhook('zakazka.stav_changed', {
          id, stav,
          nazev:    z?.nazev,
          technik:  z?.technik,
          zakaznik: z?.zakaznik,
          termin:   z?.termin,
        });
      };
    }
  }, 300);
})();

// ── API nastavení UI ──────────────────────────────────────────────
function openApiSettings() {
  let modal = document.getElementById('api-settings-modal');
  if(!modal) {
    modal = document.createElement('div');
    modal.id = 'api-settings-modal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `<div class="modal-box" style="max-width:500px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
        <h3>🔌 Propojení s plánovací aplikací</h3>
        <button onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:none;border:none;font-size:20px;cursor:pointer">×</button>
      </div>

      <div style="background:#eff6ff;border:1.5px solid #93c5fd;border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px;color:#1e3a5f">
        <strong>Jak propojit plánovací aplikaci:</strong><br>
        Vaše plánovací aplikace může posílat zakázky do tohoto systému přes:<br>
        <strong>1. Webhook (doporučeno)</strong> — zadejte URL endpointu vaší aplikace níže<br>
        <strong>2. PostMessage API</strong> — pro iframe/embed integrace<br>
        <strong>3. Přímý Firestore přístup</strong> — pomocí Firebase Admin SDK
      </div>

      <div class="fg2" style="margin-bottom:10px">
        <label>Webhook URL (plánovací aplikace → sem pošleme události)</label>
        <input id="api-webhook-url" value="${_webhookUrl}" placeholder="https://vase-planovaci-app.cz/webhook/servis">
      </div>
      <div class="fg2" style="margin-bottom:16px">
        <label>API klíč (volitelné — pro ověření)</label>
        <input id="api-key-inp" value="${_apiKey}" placeholder="váš-tajný-klíč" type="password">
      </div>

      <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:12px;margin-bottom:16px;font-size:12px">
        <strong>PostMessage API příklady (pro vaši plánovací aplikaci):</strong>
        <pre style="margin-top:6px;font-size:10px;overflow-x:auto;color:#166534">// Načíst zakázky
window.postMessage({type:'SERVIS_GET_ZAKAZKY'}, '*')

// Vytvořit zakázku
window.postMessage({
  type: 'SERVIS_CREATE_ZAKAZKA',
  payload: { nazev:'Klimatizace', technik:'Jan Novák', termin:'2025-09-01' }
}, '*')

// Přiřadit technika
window.postMessage({
  type: 'SERVIS_ASSIGN_TECHNIK',
  payload: { zakazkaId:'abc123', technik:'Jan Novák', termin:'2025-09-01' }
}, '*')</pre>
      </div>

      <div style="background:#fafbfc;border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:16px;font-size:11px;color:var(--muted)">
        <strong>Firebase přístup (pro vlastní integrace):</strong><br>
        Project ID: <code>servis-3213b</code><br>
        Kolekce: <code>zakazky</code>, <code>users</code>, <code>zakaznici</code><br>
        Vyžaduje Firebase Admin SDK s service account klíčem.
      </div>

      <div class="modal-foot">
        <button onclick="this.closest('.modal-overlay').classList.remove('open')" class="btn btn-ghost">Zavřít</button>
        <button onclick="saveApiSettings()" class="btn btn-green">Uložit nastavení</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
  }
  modal.classList.add('open');
}

function saveApiSettings() {
  _webhookUrl = document.getElementById('api-webhook-url')?.value.trim() || '';
  _apiKey     = document.getElementById('api-key-inp')?.value.trim() || '';
  localStorage.setItem('webhook-url', _webhookUrl);
  localStorage.setItem('api-key', _apiKey);
  document.getElementById('api-settings-modal')?.classList.remove('open');
  showToast && showToast('✓ API nastavení uloženo');
}

// Přidej 🔌 tlačítko do kancelář topbaru
(function addApiButton() {
  setTimeout(() => {
    const darkBtn = document.getElementById('dark-toggle');
    if(!darkBtn || darkBtn._apiAdded) return;
    darkBtn._apiAdded = true;
    const btn = document.createElement('button');
    btn.title = 'Propojení s plánovací aplikací';
    btn.style.cssText = 'background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.85);border-radius:7px;padding:5px 10px;cursor:pointer;font-size:13px';
    btn.textContent = '🔌';
    btn.onclick = openApiSettings;
    darkBtn.before(btn);
  }, 900);
})();

// ══ SERVICE WORKER REGISTRACE ═════════════════════════════════════
(function registerServiceWorker() {
  if(!('serviceWorker' in navigator)) return;

  // Service Worker kód jako Blob (inline — nepotřebujeme externý soubor)
  const swCode = `
const CACHE = 'servis-v1';
const CORE = [location.pathname];

self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(CACHE).then(c => c.addAll(CORE)).then(() => self.skipWaiting())
  );
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys => Promise.all(
      keys.filter(k => k !== CACHE).map(k => caches.delete(k))
    )).then(() => self.clients.claim())
  );
});

self.addEventListener('fetch', e => {
  // Jen GET requesty
  if(e.request.method !== 'GET') return;
  // Jen same-origin nebo CDN resources
  const url = new URL(e.request.url);
  const isSameOrigin = url.origin === location.origin;
  const isCDN = url.hostname.includes('gstatic') ||
                url.hostname.includes('googleapis') ||
                url.hostname.includes('cloudflare') ||
                url.hostname.includes('unpkg');

  if(!isSameOrigin && !isCDN) return;

  e.respondWith(
    caches.match(e.request).then(cached => {
      const fetchPromise = fetch(e.request).then(resp => {
        if(resp.ok && (isSameOrigin || isCDN)) {
          const clone = resp.clone();
          caches.open(CACHE).then(c => c.put(e.request, clone));
        }
        return resp;
      }).catch(() => cached); // offline fallback
      return cached || fetchPromise;
    })
  );
});

// Background sync pro offline akce
self.addEventListener('sync', e => {
  if(e.tag === 'sync-zakazky') {
    e.waitUntil(self.clients.matchAll().then(clients => {
      clients.forEach(client => client.postMessage({type:'SW_SYNC_REQUEST'}));
    }));
  }
});

// Push notifikace
self.addEventListener('push', e => {
  const data = e.data?.json() || {};
  e.waitUntil(self.registration.showNotification(data.title || 'AC EURO Servis', {
    body: data.body || '',
    icon: '/favicon.ico',
    badge: '/favicon.ico',
    data: data,
  }));
});

self.addEventListener('notificationclick', e => {
  e.notification.close();
  e.waitUntil(self.clients.matchAll({type:'window'}).then(clients => {
    const client = clients.find(c => c.url.includes(location.origin));
    if(client) { client.focus(); }
    else { self.clients.openWindow('/'); }
  }));
});
`;

  // Registruj SW přes Blob URL
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swUrl = URL.createObjectURL(blob);

  navigator.serviceWorker.register(swUrl, {scope: '/'})
    .then(reg => {
      console.log('✓ Service Worker registrován:', reg.scope);
      window._swRegistration = reg;

      // Poslouchej zprávy ze SW
      navigator.serviceWorker.addEventListener('message', e => {
        if(e.data?.type === 'SW_SYNC_REQUEST') {
          // SW žádá o sync — zkontroluj offline frontu
          processOfflineQueue();
        }
      });
    })
    .catch(err => {
      console.warn('SW registrace selhala (Blob URL):', err.message);
      // Fallback — offline podpora nebude dostupná
    });
})();

// Offline fronta — operace provedené offline
let _offlineQueue = JSON.parse(localStorage.getItem('offline-queue')||'[]');

function queueOfflineAction(action, data) {
  _offlineQueue.push({ action, data, ts: Date.now(), id: Math.random().toString(36).slice(2) });
  localStorage.setItem('offline-queue', JSON.stringify(_offlineQueue));
}

async function processOfflineQueue() {
  if(!_offlineQueue.length || !navigator.onLine) return;
  const queue = [..._offlineQueue];
  _offlineQueue = [];
  localStorage.removeItem('offline-queue');

  let processed = 0;
  for(const item of queue) {
    try {
      if(item.action === 'updateStav') {
        await window._fb.updateDoc(
          window._fb.doc(window._fb.db,'zakazky',item.data.id),
          { stav: item.data.stav, updatedAt: window._fb.serverTimestamp() }
        );
        processed++;
      }
    } catch(e) {
      _offlineQueue.push(item); // vrátíme zpět při chybě
    }
  }
  if(processed) {
    showToast && showToast(`✓ Synchronizováno ${processed} offline akcí`);
    localStorage.setItem('offline-queue', JSON.stringify(_offlineQueue));
  }
}

// Online/offline indikátor
window.addEventListener('online',  () => {
  showToast && showToast('🟢 Jste online — synchronizuji…');
  processOfflineQueue();
});
window.addEventListener('offline', () => {
  showToast && showToast('🔴 Offline režim — akce se uloží lokálně');
});

// Přidej offline status do UI
(function addOfflineIndicator() {
  setTimeout(() => {
    const darkBtn = document.getElementById('dark-toggle');
    if(!darkBtn || darkBtn._offlineAdded) return;
    darkBtn._offlineAdded = true;
    const ind = document.createElement('div');
    ind.id = 'online-indicator';
    ind.style.cssText = 'display:flex;align-items:center;gap:4px;font-size:11px;color:rgba(255,255,255,.6);padding:4px 8px;border-radius:6px';
    ind.innerHTML = `<span id="online-dot" style="width:6px;height:6px;border-radius:50%;background:#4ade80;flex-shrink:0"></span>
      <span id="online-txt">Online</span>`;
    darkBtn.before(ind);

    const update = () => {
      const dot = document.getElementById('online-dot');
      const txt = document.getElementById('online-txt');
      if(dot) dot.style.background = navigator.onLine ? '#4ade80' : '#f87171';
      if(txt) txt.textContent = navigator.onLine ? 'Online' : 'Offline';
    };
    update();
    window.addEventListener('online', update);
    window.addEventListener('offline', update);
  }, 1000);
})();

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  NOVÉ FUNKCE 9 — měsíční PDF report, výkon (lazy init),
//                  vylepšené dashboard CSS sekce
// ════════════════════════════════════════════════════════════════

// ══ MĚSÍČNÍ PDF REPORT ═══════════════════════════════════════════

// Přidej tlačítko do dashboardu
(function addReportButton() {
  setTimeout(() => {
    const statsGrid = document.getElementById('stats-grid');
    if(!statsGrid || statsGrid._reportBtnAdded) return;
    statsGrid._reportBtnAdded = true;

    const wrap = statsGrid.closest('div[style*="padding"]') ||
                 statsGrid.parentElement;
    if(!wrap) return;

    const toolbar = document.createElement('div');
    toolbar.style.cssText = 'display:flex;align-items:center;justify-content:space-between;margin-bottom:14px';
    toolbar.innerHTML = `
      <h2 style="font-size:16px;font-weight:800;color:var(--navy);margin:0">
        📊 Dashboard
      </h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="report-period-sel" style="font-size:11px;padding:5px 10px;border:1.5px solid var(--border);border-radius:8px;background:var(--card);color:var(--text);font-family:inherit">
          <option value="this">Tento měsíc</option>
          <option value="last">Minulý měsíc</option>
          <option value="q1">Q1</option>
          <option value="q2">Q2</option>
          <option value="q3">Q3</option>
          <option value="q4">Q4</option>
          <option value="year">Celý rok</option>
        </select>
        <button onclick="generatePdfReport()" style="display:flex;align-items:center;gap:6px;padding:5px 14px;background:var(--navy);color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
          PDF report
        </button>
        <button onclick="sendMonthlyReportEmail()" style="display:flex;align-items:center;gap:6px;padding:5px 14px;background:var(--card);color:var(--navy);border:1.5px solid var(--border);border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit">
          ✉️ Odeslat e-mailem
        </button>
      </div>`;

    wrap.insertBefore(toolbar, wrap.firstChild);
  }, 600);
})();

// Pomocné funkce pro report
function getPeriodZakazky() {
  const all = window._zakazky || [];
  const sel = document.getElementById('report-period-sel')?.value || 'this';
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();

  let from, to, label;

  switch(sel) {
    case 'this':
      from = new Date(y, m, 1); to = new Date(y, m+1, 0);
      label = `${now.toLocaleString('cs-CZ',{month:'long'})} ${y}`;
      break;
    case 'last':
      from = new Date(y, m-1, 1); to = new Date(y, m, 0);
      label = `${new Date(y,m-1).toLocaleString('cs-CZ',{month:'long'})} ${y}`;
      break;
    case 'q1': from=new Date(y,0,1); to=new Date(y,3,0); label=`Q1 ${y}`; break;
    case 'q2': from=new Date(y,3,1); to=new Date(y,6,0); label=`Q2 ${y}`; break;
    case 'q3': from=new Date(y,6,1); to=new Date(y,9,0); label=`Q3 ${y}`; break;
    case 'q4': from=new Date(y,9,1); to=new Date(y,12,0); label=`Q4 ${y}`; break;
    case 'year': from=new Date(y,0,1); to=new Date(y,12,0); label=`Rok ${y}`; break;
    default:    from=new Date(y,m,1); to=new Date(y,m+1,0); label=`${m+1}/${y}`;
  }

  const fromStr = from.toISOString().slice(0,10);
  const toStr   = to.toISOString().slice(0,10);

  const filtered = all.filter(z =>
    z.termin && z.termin >= fromStr && z.termin <= toStr
  );

  return { zakazky: filtered, label, from: fromStr, to: toStr };
}

function buildReportData() {
  const { zakazky, label, from, to } = getPeriodZakazky();
  const all = window._zakazky || [];

  function parseCena(c) {
    return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0;
  }

  const totalCount   = zakazky.length;
  const totalRevenue = zakazky.reduce((s,z) => s+parseCena(z.cena), 0);
  const paid         = zakazky.filter(z => z.stav === 'zaplacena');
  const invoiced     = zakazky.filter(z => ['fakturovaná','zaplacena'].includes(z.stav));
  const paidRevenue  = paid.reduce((s,z) => s+parseCena(z.cena), 0);
  const done         = zakazky.filter(z => ['zpracovaná','fakturovaná','zaplacena'].includes(z.stav));

  // Podle technika
  const byTech = {};
  zakazky.forEach(z => {
    const t = z.technik || 'Nepřiřazeno';
    if(!byTech[t]) byTech[t] = { name:t, count:0, rev:0, hours:0, rated:0, ratingSum:0 };
    byTech[t].count++;
    byTech[t].rev += parseCena(z.cena);
    byTech[t].hours += parseFloat(z.hodiny||0);
    if(z.hodnoceni) { byTech[t].rated++; byTech[t].ratingSum += z.hodnoceni; }
  });

  // Podle zákazníka (top 5)
  const byZak = {};
  zakazky.forEach(z => {
    const k = z.zakaznik || 'Neznámý';
    if(!byZak[k]) byZak[k] = { name:k, count:0, rev:0 };
    byZak[k].count++;
    byZak[k].rev += parseCena(z.cena);
  });

  // Průměrné hodnocení
  const rated = zakazky.filter(z => z.hodnoceni);
  const avgRating = rated.length
    ? (rated.reduce((s,z)=>s+z.hodnoceni,0) / rated.length).toFixed(1) : null;

  // Průměrné hodiny
  const withHours = zakazky.filter(z => z.hodiny > 0);
  const avgHours = withHours.length
    ? (withHours.reduce((s,z)=>s+parseFloat(z.hodiny||0),0) / withHours.length).toFixed(1) : null;

  // Celkové km
  const totalKm = zakazky.reduce((s,z) => s+parseFloat(z.km||0), 0);

  return {
    label, from, to,
    totalCount, totalRevenue, paidRevenue,
    doneCount: done.length, invoicedCount: invoiced.length,
    completionRate: totalCount ? Math.round(done.length/totalCount*100) : 0,
    byTech: Object.values(byTech).sort((a,b) => b.count-a.count),
    topZakaznici: Object.values(byZak).sort((a,b) => b.rev-a.rev).slice(0,5),
    avgRating, avgHours, totalKm,
    firma: window._currentFirma === 'progres' ? 'PROGRESKLIMA CZ s.r.o.' : 'AC EURO s.r.o.',
    dnes: new Date().toLocaleDateString('cs-CZ'),
    recentZakazky: zakazky.slice(0,20),
  };
}

async function generatePdfReport() {
  const btn = document.querySelector('button[onclick="generatePdfReport()"]');
  if(btn) { btn.disabled=true; btn.textContent='⏳ Generuji…'; }

  try {
    const data = buildReportData();
    const html = buildReportHtml(data);

    // Otevři přes souhrn viewer (stejný iframe modal)
    const fakeZ = { nazev: `Report ${data.label}`, cislo: '', id: '' };
    showSouhrn(html, { nazev: `Měsíční report — ${data.label}`, id:'' });
  } finally {
    if(btn) { btn.disabled=false; btn.innerHTML='<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg> PDF report'; }
  }
}

function buildReportHtml(d) {
  const fmtCzk = n => n.toLocaleString('cs-CZ', {maximumFractionDigits:0}) + ' Kč';
  const stars = n => n ? ('★'.repeat(Math.round(n)) + '☆'.repeat(5-Math.round(n))) : '—';

  return `<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Report ${d.label} — ${d.firma}</title>
<style>
  * { box-sizing:border-box; margin:0; padding:0; }
  body { font-family:Arial,sans-serif; font-size:12px; color:#1e293b; background:#f8fafc; padding:20px; }
  .page { max-width:800px; margin:0 auto; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 20px rgba(0,0,0,.1); }
  .hdr { background:#0f1f3d; color:#fff; padding:24px 28px; }
  .hdr-firma { font-size:11px; color:rgba(255,255,255,.6); letter-spacing:1px; text-transform:uppercase; margin-bottom:6px; }
  .hdr-title { font-size:22px; font-weight:800; margin-bottom:4px; }
  .hdr-sub { font-size:12px; color:rgba(255,255,255,.65); }
  .body { padding:24px 28px; }

  /* KPI grid */
  .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
  .kpi { background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:14px; text-align:center; }
  .kpi-val { font-size:22px; font-weight:800; color:#0f1f3d; }
  .kpi-lbl { font-size:10px; color:#64748b; text-transform:uppercase; letter-spacing:.5px; margin-top:3px; }
  .kpi.green .kpi-val { color:#16a34a; }
  .kpi.blue .kpi-val  { color:#1d4ed8; }
  .kpi.warn .kpi-val  { color:#d97706; }

  /* Sekce */
  .sec { margin-bottom:18px; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; }
  .sec-hdr { background:#f8fafc; padding:8px 14px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.05em; color:#475569; border-bottom:1px solid #e2e8f0; }
  .sec-body { padding:14px; }

  /* Technici tabulka */
  table { width:100%; border-collapse:collapse; font-size:12px; }
  th { text-align:left; font-size:10px; font-weight:700; text-transform:uppercase; color:#94a3b8; padding:6px 8px; border-bottom:2px solid #e2e8f0; }
  td { padding:7px 8px; border-bottom:1px solid #f1f5f9; }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:#f8fafc; }

  /* Progress bar */
  .bar-wrap { background:#f1f5f9; border-radius:4px; height:6px; width:100px; display:inline-block; vertical-align:middle; }
  .bar-fill { height:100%; border-radius:4px; background:#0f1f3d; }

  /* Hodnocení hvězdičky */
  .stars { color:#f59e0b; font-size:13px; }

  /* Footer */
  .foot { padding:14px 28px; border-top:1px solid #e2e8f0; display:flex; justify-content:space-between; font-size:10px; color:#94a3b8; }

  /* Tisk */
  @media print {
    body { background:#fff; padding:0; }
    .page { box-shadow:none; border-radius:0; }
    .no-print { display:none !important; }
    .kpi-grid { grid-template-columns:repeat(4,1fr); }
  }

  .no-print { margin-bottom:16px; display:flex; gap:8px; }
</style>
</head>
<body>
<div class="page">

<div class="hdr">
  <div class="hdr-firma">${d.firma}</div>
  <div class="hdr-title">📊 Výkonnostní report</div>
  <div class="hdr-sub">Období: <strong style="color:#fff">${d.label}</strong> &nbsp;·&nbsp; ${d.from} – ${d.to} &nbsp;·&nbsp; Vygenerováno: ${d.dnes}</div>
</div>

<div class="body">

  <div class="no-print">
    <button onclick="window.print()" style="background:#0f1f3d;color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:13px;font-weight:600">🖨 Tisknout / Uložit jako PDF</button>
  </div>

  <!-- KPI KARTY -->
  <div class="kpi-grid">
    <div class="kpi">
      <div class="kpi-val">${d.totalCount}</div>
      <div class="kpi-lbl">Zakázek celkem</div>
    </div>
    <div class="kpi green">
      <div class="kpi-val">${fmtCzk(d.totalRevenue)}</div>
      <div class="kpi-lbl">Celkový obrat</div>
    </div>
    <div class="kpi blue">
      <div class="kpi-val">${fmtCzk(d.paidRevenue)}</div>
      <div class="kpi-lbl">Zaplaceno</div>
    </div>
    <div class="kpi warn">
      <div class="kpi-val">${d.completionRate}%</div>
      <div class="kpi-lbl">Dokončenost</div>
    </div>
  </div>

  <!-- DOPLŇKOVÉ METRIKY -->
  <div class="kpi-grid" style="margin-bottom:20px">
    <div class="kpi">
      <div class="kpi-val">${d.doneCount}</div>
      <div class="kpi-lbl">Dokončených</div>
    </div>
    <div class="kpi">
      <div class="kpi-val">${d.invoicedCount}</div>
      <div class="kpi-lbl">Fakturovaných</div>
    </div>
    <div class="kpi ${d.avgRating>=4?'green':d.avgRating>=3?'':'warn'}">
      <div class="kpi-val" style="color:#f59e0b">${d.avgRating||'—'}</div>
      <div class="kpi-lbl">Avg. hodnocení</div>
    </div>
    <div class="kpi">
      <div class="kpi-val">${d.totalKm>0 ? Math.round(d.totalKm)+' km' : '—'}</div>
      <div class="kpi-lbl">Celkem km</div>
    </div>
  </div>

  <!-- VÝKONNOST TECHNIKŮ -->
  <div class="sec">
    <div class="sec-hdr">👥 Výkonnost techniků</div>
    <div class="sec-body" style="padding:0">
      <table>
        <thead>
          <tr>
            <th>Technik</th>
            <th>Zakázek</th>
            <th>Podíl</th>
            <th>Obrat</th>
            <th>Hodiny</th>
            <th>Hodnocení</th>
          </tr>
        </thead>
        <tbody>
          ${d.byTech.map(t => {
            const pct = d.totalCount ? Math.round(t.count/d.totalCount*100) : 0;
            const avgR = t.rated ? (t.ratingSum/t.rated).toFixed(1) : null;
            return `<tr>
              <td><strong>${t.name}</strong></td>
              <td>${t.count}</td>
              <td>
                <div class="bar-wrap"><div class="bar-fill" style="width:${pct}%"></div></div>
                <span style="margin-left:6px;color:#64748b">${pct}%</span>
              </td>
              <td style="font-family:monospace;white-space:nowrap">${fmtCzk(t.rev)}</td>
              <td>${t.hours>0 ? t.hours.toFixed(1)+' h' : '—'}</td>
              <td class="stars">${avgR ? avgR+'/5 '+'★'.repeat(Math.round(avgR)) : '—'}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
  </div>

  <!-- TOP ZÁKAZNÍCI -->
  ${d.topZakaznici.length ? `<div class="sec">
    <div class="sec-hdr">🏢 Top zákazníci</div>
    <div class="sec-body" style="padding:0">
      <table>
        <thead><tr><th>Zákazník</th><th>Zakázek</th><th>Obrat</th></tr></thead>
        <tbody>
          ${d.topZakaznici.map(z => `<tr>
            <td><strong>${z.name}</strong></td>
            <td>${z.count}</td>
            <td style="font-family:monospace">${fmtCzk(z.rev)}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>` : ''}

  <!-- PŘEHLED ZAKÁZEK -->
  ${d.recentZakazky.length ? `<div class="sec">
    <div class="sec-hdr">📋 Zakázky v období (${d.recentZakazky.length}${d.totalCount>20?' z '+d.totalCount:''})</div>
    <div class="sec-body" style="padding:0">
      <table>
        <thead><tr><th>Číslo</th><th>Název</th><th>Zákazník</th><th>Technik</th><th>Termín</th><th>Stav</th><th>Cena</th></tr></thead>
        <tbody>
          ${d.recentZakazky.map(z => `<tr>
            <td style="font-family:monospace;font-size:10px;color:#64748b">${z.cislo||'—'}</td>
            <td><strong>${(z.nazev||'—').substring(0,30)}</strong></td>
            <td style="font-size:11px">${(z.zakaznik||'—').substring(0,20)}</td>
            <td style="font-size:11px">${z.technik||'—'}</td>
            <td style="font-size:11px;white-space:nowrap">${z.termin ? z.termin.split('-').reverse().join('.') : '—'}</td>
            <td style="font-size:11px">${z.stav||'—'}</td>
            <td style="font-family:monospace;white-space:nowrap;font-size:11px">${z.cena||'—'}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>` : ''}

</div><!-- /body -->

<div class="foot">
  <span>${d.firma}</span>
  <span>Report: ${d.label} · Vygenerováno ${d.dnes}</span>
</div>

</div><!-- /page -->
</body></html>`;
}

// E-mail report — otevře dialog s textem pro kopírování
function sendMonthlyReportEmail() {
  const data = buildReportData();
  const fmtCzk = n => n.toLocaleString('cs-CZ', {maximumFractionDigits:0}) + ' Kč';

  const subject = `Výkonnostní report — ${data.label} — ${data.firma}`;
  const body = `Dobrý den,

zasílám výkonnostní report za období: ${data.label}

PŘEHLED:
• Zakázek celkem: ${data.totalCount}
• Celkový obrat: ${fmtCzk(data.totalRevenue)}
• Zaplaceno: ${fmtCzk(data.paidRevenue)}
• Dokončenost: ${data.completionRate}%
${data.avgRating ? `• Průměrné hodnocení: ${data.avgRating}/5` : ''}
${data.totalKm > 0 ? `• Celkem km: ${Math.round(data.totalKm)} km` : ''}

TECHNICI:
${data.byTech.map(t => `• ${t.name}: ${t.count} zakázek, ${fmtCzk(t.rev)}${t.hours>0?' ('+t.hours.toFixed(1)+' h)':''}`).join('\n')}

Pro detailní PDF report otevřete aplikaci a použijte Dashboard → PDF report.

S pozdravem,
${data.firma}`;

  // Otevři mailto nebo zkopíruj
  const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  const win = window.open(mailto, '_blank');
  if(!win) {
    navigator.clipboard.writeText(body)
      .then(() => showToast && showToast('✓ Text reportu zkopírován do schránky'))
      .catch(() => alert(body));
  } else {
    showToast && showToast('✓ E-mailový klient otevřen');
  }
}

// ══ VÝKON — lazy inicializace tabů ═══════════════════════════════
// Odloží načítání heavy tabů dokud nejsou potřeba
(function lazyTabInit() {
  // Přidej třídu pro animaci přepnutí
  const style = document.createElement('style');
  style.textContent = `
    .tab-panel { opacity:1; transition:opacity .15s; }
    .tab-panel.loading { opacity:.5; }

    /* Kompaktnější detail panel na mobile */
    @media (max-width:768px) {
      .detail-inner { padding:10px !important; }
      .dsec { margin-bottom:10px !important; }
      .dsec-hdr { font-size:11px !important; }
    }

    /* Dashboard KPI */
    .kpi-spark { display:inline-block; width:40px; height:16px; vertical-align:middle; }

    /* Tech performance cards hover */
    #tech-performance-grid > div {
      transition: box-shadow .15s, transform .15s;
    }
    #tech-performance-grid > div:hover {
      box-shadow: 0 4px 16px rgba(15,31,61,.12);
      transform: translateY(-1px);
    }

    /* Alert animace */
    #kpi-alerts-inner > div {
      transition: opacity .2s;
    }
    #kpi-alerts-inner > div:hover {
      opacity: .85;
    }

    /* Nezaplacene highlight */
    .nezap-row { cursor:pointer; transition:background .1s; }
    .nezap-row:hover { background:var(--bg); }
  `;
  document.head.appendChild(style);

  // Cache výsledků dashboardu — přepočítávej max 1x za 30s
  let _dashLastRender = 0;
  if(typeof renderDashboard !== 'undefined') {
    const prevDash = renderDashboard;
    renderDashboard = function() {
      const now = Date.now();
      if(now - _dashLastRender < 30000) return; // debounce 30s
      _dashLastRender = now;
      prevDash();
    };
  }
})();

// ══ VYLEPŠENÍ NEZAPLACENÉ FAKTURY V DASHBOARDU ════════════════════
// Přepiš unpaid-list na klikací tabulku
(function enhanceUnpaidList() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    const el = document.getElementById('unpaid-list');
    if(el || tries > 40) {
      clearInterval(iv);
      if(!el) return;
      // Nahraď basic unpaid-list s rozšířenou verzí
      el._enhanced = true;
    }
  }, 500);
})();

// Přidej render unpaid do renderDashboard
(function hookUnpaidRender() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(typeof renderDashboard !== 'undefined' || tries > 40) {
      clearInterval(iv);
      if(typeof renderDashboard === 'undefined') return;
      const prev = renderDashboard;
      renderDashboard = function() {
        prev();
        setTimeout(renderUnpaidTable, 100);
      };
    }
  }, 400);
})();

function renderUnpaidTable() {
  const listEl = document.getElementById('unpaid-list');
  const totalEl = document.getElementById('nezaplacene-total') ||
                  document.getElementById('unpaid-count');
  if(!listEl) return;

  function parseCena(c) {
    return parseFloat((c||'0').replace(/[^\d,.-]/g,'').replace(',','.'))||0;
  }

  const unpaid = (window._zakazky||[])
    .filter(z => z.stav === 'fakturovaná' && z.cena)
    .sort((a,b) => (a.termin||'').localeCompare(b.termin||''));

  const totalUnpaid = unpaid.reduce((s,z) => s+parseCena(z.cena), 0);

  if(totalEl) {
    totalEl.textContent = unpaid.length
      ? `${unpaid.length} faktur · ${totalUnpaid.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč`
      : 'Vše zaplaceno ✓';
    totalEl.style.color = unpaid.length ? '#dc2626' : '#16a34a';
  }

  if(!unpaid.length) {
    listEl.innerHTML = '<div style="font-size:12px;color:var(--muted);font-style:italic;padding:10px 0">Všechny faktury jsou zaplaceny ✓</div>';
    return;
  }

  const now = new Date();
  listEl.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead>
      <tr style="border-bottom:2px solid var(--border)">
        <th style="text-align:left;padding:6px 8px;font-size:10px;color:var(--muted);text-transform:uppercase">Zakázka</th>
        <th style="text-align:left;padding:6px 8px;font-size:10px;color:var(--muted);text-transform:uppercase">Zákazník</th>
        <th style="text-align:left;padding:6px 8px;font-size:10px;color:var(--muted);text-transform:uppercase">Termín</th>
        <th style="text-align:left;padding:6px 8px;font-size:10px;color:var(--muted);text-transform:uppercase">Po splatnosti</th>
        <th style="text-align:right;padding:6px 8px;font-size:10px;color:var(--muted);text-transform:uppercase">Částka</th>
      </tr>
    </thead>
    <tbody>
      ${unpaid.map(z => {
        const days = z.termin
          ? Math.floor((now - new Date(z.termin)) / 86400000)
          : null;
        const daysColor = days > 60 ? '#dc2626' : days > 30 ? '#d97706' : 'var(--text)';
        return `<tr class="nezap-row" onclick="switchTab('orders');setTimeout(()=>openDetail('${z.id}'),50)">
          <td style="padding:7px 8px;border-bottom:1px solid var(--border)">
            <strong style="font-size:12px">${(z.nazev||'—').substring(0,25)}</strong>
            <br><span style="font-size:10px;color:var(--muted)">${z.cislo||''}</span>
          </td>
          <td style="padding:7px 8px;border-bottom:1px solid var(--border);font-size:11px">${(z.zakaznik||'—').substring(0,20)}</td>
          <td style="padding:7px 8px;border-bottom:1px solid var(--border);font-size:11px;white-space:nowrap">${z.termin ? z.termin.split('-').reverse().join('.') : '—'}</td>
          <td style="padding:7px 8px;border-bottom:1px solid var(--border);font-size:11px;font-weight:600;color:${daysColor}">
            ${days !== null ? (days > 0 ? `+${days} dní` : days===0 ? 'Dnes' : `za ${-days} dní`) : '—'}
          </td>
          <td style="padding:7px 8px;border-bottom:1px solid var(--border);text-align:right;font-family:monospace;font-weight:700;color:var(--navy)">
            ${parseCena(z.cena).toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč
          </td>
        </tr>`;
      }).join('')}
    </tbody>
    <tfoot>
      <tr style="background:var(--bg)">
        <td colspan="4" style="padding:8px;font-weight:700;font-size:12px">CELKEM</td>
        <td style="padding:8px;text-align:right;font-family:monospace;font-weight:800;font-size:14px;color:#dc2626">
          ${totalUnpaid.toLocaleString('cs-CZ',{maximumFractionDigits:0})} Kč
        </td>
      </tr>
    </tfoot>
  </table>`;
}

</script>
<script>
// ════════════════════════════════════════════════════════════════
//  MODUL: MÍSTA & KLIMATIZACE
//  Hierarchie: Zakázka → Místa (150) → Klimatizace (~800)
// ════════════════════════════════════════════════════════════════

// ── State ─────────────────────────────────────────────────────────
let _activeMistaZakazkaId = null;
let _mista = [];           // [{id, nazev, adresa, poznamka}]
let _klimatizace = {};     // {mistaId: [{id, model, sn, stav, ...}]}
let _selectedMistaId = null;
let _mistaUnsub = null;
let _klimUnsubMap = {};    // {mistaId: unsubscribe}
let _csvImportData = null; // parsed CSV ready to import
let _klimFotoFiles = [];   // soubory fotek pro aktuální klimatizaci

// ── Stav labels ───────────────────────────────────────────────────
const KLIM_STAV = {
  ok:       { label:'✅ OK',        color:'#16a34a', bg:'#f0fdf4', border:'#86efac' },
  zavada:   { label:'⚠️ Závada',    color:'#d97706', bg:'#fffbeb', border:'#fcd34d' },
  opraveno: { label:'🔧 Opraveno',  color:'#2563eb', bg:'#eff6ff', border:'#93c5fd' },
  vyrazeno: { label:'❌ Vyřazeno',  color:'#dc2626', bg:'#fef2f2', border:'#fca5a5' },
  nova:     { label:'🆕 Nová',      color:'#6b7280', bg:'#f9fafb', border:'#d1d5db' },
};

function klimStavBadge(stav) {
  const s = KLIM_STAV[stav] || KLIM_STAV.nova;
  return `<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:${s.bg};color:${s.color};border:1px solid ${s.border};white-space:nowrap">${s.label}</span>`;
}

// ── Otevřít panel ─────────────────────────────────────────────────
async function openMistaPanel(zakazkaId) {
  _activeMistaZakazkaId = zakazkaId;
  _selectedMistaId = null;

  const overlay = document.getElementById('mista-overlay');
  overlay.style.display = 'flex';
  document.body.style.overflow = 'hidden';

  const z = (window._zakazky||[]).find(x => x.id === zakazkaId);
  document.getElementById('mista-zakaz-nazev').textContent =
    `🏢 ${z?.nazev || 'Zakázka'} — Místa & Klimatizace`;
  document.getElementById('mista-zakaz-sub').textContent =
    `${z?.zakaznik||''} ${z?.cislo ? '· '+z.cislo : ''}`;

  // Vymaž pravý panel
  document.getElementById('klim-empty').style.display = 'flex';
  document.getElementById('klim-content').style.display = 'none';

  await loadMista(zakazkaId);
}

function closeMistaPanel() {
  document.getElementById('mista-overlay').style.display = 'none';
  document.body.style.overflow = '';
  // Odhlásit listenery
  if(_mistaUnsub) { _mistaUnsub(); _mistaUnsub = null; }
  Object.values(_klimUnsubMap).forEach(u => u());
  _klimUnsubMap = {};
  _klimatizace = {};
  _mista = [];
}

// ── Načtení dat ───────────────────────────────────────────────────
async function loadMista(zakazkaId) {
  if(_mistaUnsub) _mistaUnsub();

  const col = window._fb.collection(
    window._fb.db, 'zakazky', zakazkaId, 'mista'
  );
  const q = window._fb.query(col, window._fb.orderBy('nazev'));

  _mistaUnsub = window._fb.onSnapshot(q, snap => {
    _mista = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderMistaList();
    updateMistaProgress();

    // Načti klimatizace pro všechna místa
    _mista.forEach(m => {
      if(!_klimUnsubMap[m.id]) loadKlimatizaceForMisto(zakazkaId, m.id);
    });
  });
}

function loadKlimatizaceForMisto(zakazkaId, mistaId) {
  if(_klimUnsubMap[mistaId]) return;

  const col = window._fb.collection(
    window._fb.db, 'zakazky', zakazkaId, 'mista', mistaId, 'klimatizace'
  );
  const q = window._fb.query(col, window._fb.orderBy('model'));

  _klimUnsubMap[mistaId] = window._fb.onSnapshot(q, snap => {
    _klimatizace[mistaId] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderMistaList(); // aktualizuj progress na místu
    updateMistaProgress();
    if(_selectedMistaId === mistaId) renderKlimList(mistaId);
  });
}

// ── Render: seznam míst ───────────────────────────────────────────
function renderMistaList() {
  const inner = document.getElementById('mista-list-inner');
  if(!inner) return;

  const q = (document.getElementById('mista-search')?.value || '').toLowerCase();
  const filter = document.getElementById('mista-filter-stav')?.value || '';

  let list = _mista;
  if(q) list = list.filter(m => (m.nazev||'').toLowerCase().includes(q) || (m.adresa||'').toLowerCase().includes(q));

  if(filter) {
    list = list.filter(m => {
      const klims = _klimatizace[m.id] || [];
      const done = klims.filter(k => k.stav && k.stav !== 'nova').length;
      if(filter === 'done')    return done === klims.length && klims.length > 0;
      if(filter === 'partial') return done > 0 && done < klims.length;
      if(filter === 'new')     return done === 0;
      return true;
    });
  }

  if(!list.length) {
    inner.innerHTML = `<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">
      ${_mista.length ? 'Žádná místa nevyhovují filtru' : 'Zatím žádná místa.<br>Přidejte místo nebo importujte CSV.'}
    </div>`;
    return;
  }

  inner.innerHTML = list.map(m => {
    const klims = _klimatizace[m.id] || [];
    const total = klims.length;
    const done  = klims.filter(k => k.stav && k.stav !== 'nova').length;
    const hasZavada = klims.some(k => k.stav === 'zavada');
    const pct   = total ? Math.round(done/total*100) : 0;
    const isSelected = m.id === _selectedMistaId;

    let statusColor = '#94a3b8';
    if(total > 0 && done === total) statusColor = '#16a34a';
    else if(done > 0) statusColor = hasZavada ? '#d97706' : '#2563eb';

    return `<div onclick="selectMisto('${m.id}')"
      style="padding:10px 12px;border-radius:8px;cursor:pointer;border:2px solid ${isSelected?'var(--navy)':'transparent'};background:${isSelected?'var(--bg)':'transparent'};margin-bottom:4px;transition:all .1s">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:13px;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(m.nazev)}</div>
          ${m.adresa ? `<div style="font-size:10px;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(m.adresa)}</div>` : ''}
        </div>
        <div style="display:flex;gap:4px;align-items:center;flex-shrink:0">
          <button onclick="event.stopPropagation();editMisto('${m.id}')" style="background:none;border:none;cursor:pointer;font-size:12px;color:var(--muted);padding:2px 4px" title="Upravit místo">✎</button>
          <button onclick="event.stopPropagation();openAddKlimModal('${m.id}')" style="background:var(--green);border:none;cursor:pointer;font-size:11px;color:#fff;border-radius:4px;padding:2px 8px;font-weight:700" title="Přidat klimatizaci">+</button>
        </div>
      </div>
      <!-- Progress bar místa -->
      <div style="margin-top:7px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px">
          <span style="font-size:10px;color:var(--muted)">${total} klimatizací</span>
          <span style="font-size:10px;font-weight:700;color:${statusColor}">${done}/${total} (${pct}%)</span>
        </div>
        <div style="background:var(--border);border-radius:3px;height:4px;overflow:hidden">
          <div style="width:${pct}%;height:100%;background:${statusColor};border-radius:3px;transition:width .3s"></div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ── Vybrat místo ─────────────────────────────────────────────────
function selectMisto(mistaId) {
  _selectedMistaId = mistaId;
  renderMistaList(); // aktualizuj selected highlight

  document.getElementById('klim-empty').style.display = 'none';
  document.getElementById('klim-content').style.display = 'block';

  const m = _mista.find(x => x.id === mistaId);
  const hdr = document.getElementById('klim-header');
  if(hdr && m) {
    hdr.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
        <div>
          <h3 style="font-size:16px;font-weight:800;color:var(--navy);margin-bottom:2px">${esc(m.nazev)}</h3>
          ${m.adresa ? `<div style="font-size:12px;color:var(--muted)">${esc(m.adresa)}</div>` : ''}
          ${m.poznamka ? `<div style="font-size:11px;color:var(--muted);font-style:italic;margin-top:2px">${esc(m.poznamka)}</div>` : ''}
        </div>
        <button onclick="openAddKlimModal('${mistaId}')" class="btn btn-green" style="font-size:12px">+ Přidat klimatizaci</button>
      </div>`;
  }

  renderKlimList(mistaId);
}

// ── Render: seznam klimatizací ────────────────────────────────────
function renderKlimList(mistaId) {
  const listEl = document.getElementById('klim-list');
  if(!listEl) return;

  const klims = _klimatizace[mistaId] || [];

  if(!klims.length) {
    listEl.innerHTML = `<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px">
      <div style="font-size:32px;margin-bottom:8px">🌡</div>
      Zatím žádné klimatizace na tomto místě.<br>
      <button onclick="openAddKlimModal('${mistaId}')" class="btn btn-green" style="margin-top:12px;font-size:12px">+ Přidat klimatizaci</button>
    </div>`;
    return;
  }

  listEl.innerHTML = klims.map(k => {
    const s = KLIM_STAV[k.stav || 'nova'];
    const hasPhotos = (k.photos||[]).length > 0;
    return `<div style="background:var(--card);border:1.5px solid ${s.border};border-radius:10px;padding:14px">
      <div style="display:flex;align-items:flex-start;gap:10px">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px">
            <span style="font-weight:800;font-size:14px;color:var(--navy)">${esc(k.model||'—')}</span>
            ${klimStavBadge(k.stav||'nova')}
            ${hasPhotos ? `<span style="font-size:10px;color:var(--muted)">📷 ${k.photos.length}</span>` : ''}
          </div>
          ${k.seriove_cislo ? `<div style="font-size:11px;color:var(--muted);margin-bottom:3px">SN: <code>${esc(k.seriove_cislo)}</code></div>` : ''}
          ${k.umisteni ? `<div style="font-size:11px;color:var(--muted);margin-bottom:3px">📍 ${esc(k.umisteni)}</div>` : ''}
          ${k.poznamka ? `<div style="font-size:12px;color:var(--text);margin-top:6px;padding:8px;background:${s.bg};border-radius:6px">${esc(k.poznamka)}</div>` : ''}
          ${k.prace ? `<div style="font-size:11px;color:var(--muted);margin-top:4px">🔧 ${esc(k.prace)}</div>` : ''}
          ${k.zkontrolovano ? `<div style="font-size:10px;color:var(--muted);margin-top:4px">Zkontrolováno: ${k.datum_kontroly||'—'}</div>` : ''}
          <!-- Miniatury fotek -->
          ${hasPhotos ? `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">
            ${k.photos.slice(0,4).map(p => `<img src="${p}" style="width:48px;height:48px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="showFullPhoto('${p}')">`).join('')}
            ${k.photos.length>4 ? `<div style="width:48px;height:48px;background:var(--bg);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--muted);font-weight:700">+${k.photos.length-4}</div>` : ''}
          </div>` : ''}
        </div>
        <!-- Akce -->
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          ${['ok','zavada','opraveno','vyrazeno'].map(stav => {
            const ss = KLIM_STAV[stav];
            const active = k.stav === stav;
            return `<button onclick="quickSetKlimStav('${mistaId}','${k.id}','${stav}')"
              title="${ss.label}"
              style="padding:4px 8px;border-radius:6px;border:1.5px solid ${active ? ss.color : ss.border};background:${active ? ss.bg : 'transparent'};cursor:pointer;font-size:11px;font-weight:${active?'800':'400'};color:${active ? ss.color : '#9ca3af'};transition:all .1s">
              ${ss.label.split(' ')[0]}
            </button>`;
          }).join('')}
          <button onclick="editKlimatizace('${mistaId}','${k.id}')"
            style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--card);cursor:pointer;font-size:11px;color:var(--muted)">
            ✎ Edit
          </button>
          <button onclick="deleteKlimatizace('${mistaId}','${k.id}')"
            style="padding:4px 8px;border-radius:6px;border:1px solid #fecaca;background:#fef2f2;cursor:pointer;font-size:10px;color:#dc2626">
            🗑
          </button>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ── Progress bar celkový ──────────────────────────────────────────
function updateMistaProgress() {
  let total = 0, done = 0;
  Object.values(_klimatizace).forEach(klims => {
    total += klims.length;
    done  += klims.filter(k => k.stav && k.stav !== 'nova').length;
  });
  const pct = total ? Math.round(done/total*100) : 0;
  const lbl = document.getElementById('mista-progress-label');
  const pctEl = document.getElementById('mista-progress-pct');
  const bar   = document.getElementById('mista-progress-bar');
  if(lbl) lbl.textContent = `${done} / ${total} klimatizací zkontrolováno`;
  if(pctEl) pctEl.textContent = `${pct}%`;
  if(bar) bar.style.width = pct + '%';
}

// ── CRUD: Místa ───────────────────────────────────────────────────
function openAddMistoModal() {
  document.getElementById('edit-misto-id').value = '';
  document.getElementById('misto-nazev-inp').value = '';
  document.getElementById('misto-adresa-inp').value = '';
  document.getElementById('misto-pozn-inp').value = '';
  document.getElementById('add-misto-modal').classList.add('open');
  setTimeout(() => document.getElementById('misto-nazev-inp').focus(), 100);
}

function editMisto(mistaId) {
  const m = _mista.find(x => x.id === mistaId);
  if(!m) return;
  document.getElementById('edit-misto-id').value = mistaId;
  document.getElementById('misto-nazev-inp').value = m.nazev || '';
  document.getElementById('misto-adresa-inp').value = m.adresa || '';
  document.getElementById('misto-pozn-inp').value = m.poznamka || '';
  document.getElementById('add-misto-modal').classList.add('open');
}

async function saveMisto() {
  const nazev = document.getElementById('misto-nazev-inp').value.trim();
  if(!nazev) {
    document.getElementById('misto-nazev-inp').style.borderColor = '#ef4444';
    return;
  }
  const editId = document.getElementById('edit-misto-id').value;
  const data = {
    nazev,
    adresa:   document.getElementById('misto-adresa-inp').value.trim(),
    poznamka: document.getElementById('misto-pozn-inp').value.trim(),
    updatedAt: window._fb.serverTimestamp(),
  };
  try {
    const col = window._fb.collection(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista');
    if(editId) {
      await window._fb.updateDoc(window._fb.doc(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', editId), data);
    } else {
      data.createdAt = window._fb.serverTimestamp();
      await window._fb.addDoc(col, data);
    }
    closeModal('add-misto-modal');
    showToast && showToast('✓ Místo uloženo');
  } catch(e) { alert('Chyba: ' + e.message); }
}

// ── CRUD: Klimatizace ─────────────────────────────────────────────
function openAddKlimModal(mistaId) {
  _klimFotoFiles = [];
  document.getElementById('edit-klim-id').value = '';
  document.getElementById('edit-klim-misto-id').value = mistaId;
  document.getElementById('klim-modal-title').textContent = '🌡 Přidat klimatizaci';
  document.getElementById('klim-model-inp').value = '';
  document.getElementById('klim-sn-inp').value = '';
  document.getElementById('klim-umisteni-inp').value = '';
  document.getElementById('klim-pozn-inp').value = '';
  document.getElementById('klim-prace-inp').value = '';
  document.getElementById('klim-foto-inp').value = '';
  document.getElementById('klim-foto-preview').innerHTML = '';
  setKlimStav('');
  document.getElementById('add-klim-modal').classList.add('open');
  setTimeout(() => document.getElementById('klim-model-inp').focus(), 100);
}

function editKlimatizace(mistaId, klimId) {
  const k = (_klimatizace[mistaId]||[]).find(x => x.id === klimId);
  if(!k) return;
  _klimFotoFiles = [];
  document.getElementById('edit-klim-id').value = klimId;
  document.getElementById('edit-klim-misto-id').value = mistaId;
  document.getElementById('klim-modal-title').textContent = '🌡 Upravit klimatizaci';
  document.getElementById('klim-model-inp').value = k.model || '';
  document.getElementById('klim-sn-inp').value = k.seriove_cislo || '';
  document.getElementById('klim-umisteni-inp').value = k.umisteni || '';
  document.getElementById('klim-pozn-inp').value = k.poznamka || '';
  document.getElementById('klim-prace-inp').value = k.prace || '';
  document.getElementById('klim-foto-inp').value = '';
  // Zobraz existující fotky
  const prev = document.getElementById('klim-foto-preview');
  if(prev && k.photos?.length) {
    prev.innerHTML = k.photos.map(p => `<img src="${p}" style="width:48px;height:48px;object-fit:cover;border-radius:4px">`).join('');
  } else if(prev) { prev.innerHTML = ''; }
  setKlimStav(k.stav || '');
  document.getElementById('add-klim-modal').classList.add('open');
}

function setKlimStav(stav) {
  document.getElementById('klim-stav-val').value = stav;
  document.querySelectorAll('.klim-stav-btn').forEach(btn => {
    const active = btn.dataset.stav === stav;
    const s = KLIM_STAV[btn.dataset.stav] || {};
    btn.style.borderWidth = active ? '2.5px' : '2px';
    btn.style.fontWeight  = active ? '800' : '600';
    btn.style.opacity     = active ? '1' : '0.6';
    btn.style.transform   = active ? 'scale(1.05)' : '';
  });
}

async function saveKlimatizace() {
  const model = document.getElementById('klim-model-inp').value.trim();
  if(!model) {
    document.getElementById('klim-model-inp').style.borderColor = '#ef4444';
    return;
  }
  const btn = document.getElementById('save-klim-btn');
  if(btn) { btn.disabled = true; btn.textContent = '⏳ Ukládám…'; }

  const mistaId = document.getElementById('edit-klim-misto-id').value;
  const editId  = document.getElementById('edit-klim-id').value;
  const stav    = document.getElementById('klim-stav-val').value;

  // Nahraj fotky
  const fileInput = document.getElementById('klim-foto-inp');
  const newPhotos = [];
  if(fileInput?.files?.length) {
    for(const file of Array.from(fileInput.files).slice(0,5)) {
      try {
        const compressed = typeof compressPhoto === 'function'
          ? await compressPhoto(file, 1200, 900, 0.8)
          : await new Promise(res => { const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); });
        // Nahrát do Storage pokud online
        if(navigator.onLine && window._fb.storage) {
          const path = `klim/${_activeMistaZakazkaId}/${mistaId}/${Date.now()}_${file.name}`;
          const ref = window._fb.ref(window._fb.storage, path);
          await window._fb.uploadString(ref, compressed, 'data_url');
          const url = await window._fb.getDownloadURL(ref);
          newPhotos.push(url);
        } else {
          newPhotos.push(compressed); // offline — uloží base64
        }
      } catch(e) { console.warn('Photo upload failed:', e); }
    }
  }

  // Existující fotky
  const editedKlim = editId ? (_klimatizace[mistaId]||[]).find(x=>x.id===editId) : null;
  const existingPhotos = editedKlim?.photos || [];
  const allPhotos = [...existingPhotos, ...newPhotos];

  const data = {
    model,
    seriove_cislo: document.getElementById('klim-sn-inp').value.trim(),
    umisteni:      document.getElementById('klim-umisteni-inp').value.trim(),
    poznamka:      document.getElementById('klim-pozn-inp').value.trim(),
    prace:         document.getElementById('klim-prace-inp').value.trim(),
    stav:          stav || 'nova',
    photos:        allPhotos,
    zkontrolovano: !!stav,
    datum_kontroly: stav ? new Date().toLocaleDateString('cs-CZ') : (editedKlim?.datum_kontroly||''),
    updatedAt: window._fb.serverTimestamp(),
  };

  try {
    const col = window._fb.collection(
      window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', mistaId, 'klimatizace'
    );
    if(editId) {
      await window._fb.updateDoc(
        window._fb.doc(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', mistaId, 'klimatizace', editId),
        data
      );
    } else {
      data.createdAt = window._fb.serverTimestamp();
      await window._fb.addDoc(col, data);
    }
    closeModal('add-klim-modal');
    showToast && showToast('✓ Klimatizace uložena');
  } catch(e) { alert('Chyba: ' + e.message); }
  finally { if(btn) { btn.disabled=false; btn.textContent='Uložit'; } }
}

// Rychlé nastavení stavu přímo z kartičky
async function quickSetKlimStav(mistaId, klimId, stav) {
  try {
    await window._fb.updateDoc(
      window._fb.doc(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', mistaId, 'klimatizace', klimId),
      {
        stav,
        zkontrolovano: true,
        datum_kontroly: new Date().toLocaleDateString('cs-CZ'),
        updatedAt: window._fb.serverTimestamp(),
      }
    );
    // Optimistická aktualizace
    const k = (_klimatizace[mistaId]||[]).find(x=>x.id===klimId);
    if(k) { k.stav = stav; k.zkontrolovano = true; }
    renderKlimList(mistaId);
    updateMistaProgress();
  } catch(e) { showToast && showToast('Chyba: '+e.message); }
}

async function deleteKlimatizace(mistaId, klimId) {
  if(!confirm('Smazat tuto klimatizaci?')) return;
  try {
    await window._fb.deleteDoc(
      window._fb.doc(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', mistaId, 'klimatizace', klimId)
    );
    showToast && showToast('🗑 Klimatizace smazána');
  } catch(e) { alert('Chyba: '+e.message); }
}

// ── Import CSV ────────────────────────────────────────────────────
function openMistaImport() {
  document.getElementById('mista-csv-file').value = '';
  document.getElementById('mista-csv-text').value = '';
  document.getElementById('mista-csv-preview').innerHTML = '';
  document.getElementById('mista-import-btn').style.display = 'none';
  _csvImportData = null;
  document.getElementById('mista-import-modal').classList.add('open');
}

// Načíst soubor do textarea
document.getElementById('mista-csv-file')?.addEventListener('change', e => {
  const file = e.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    document.getElementById('mista-csv-text').value = ev.target.result;
    parseMistaCsv();
  };
  reader.readAsText(file, 'UTF-8');
});

function parseMistaCsv() {
  const raw = document.getElementById('mista-csv-text').value.trim();
  if(!raw) return;

  const lines = raw.split(/\r?\n/).filter(l => l.trim());
  if(lines.length < 2) {
    document.getElementById('mista-csv-preview').innerHTML =
      '<div style="color:#dc2626;font-size:12px">CSV musí mít záhlaví a alespoň jeden řádek dat.</div>';
    return;
  }

  // Parse záhlaví
  const header = lines[0].split(',').map(h => h.trim().toLowerCase()
    .replace('místo','misto').replace('místa','misto')
    .replace('sériové číslo','seriove_cislo').replace('sériové_číslo','seriove_cislo')
    .replace('umístění','umisteni').replace('poznámka','poznamka'));

  const getCol = name => {
    const idx = header.findIndex(h => h === name || h.includes(name.split('_')[0]));
    return idx;
  };
  const iMisto   = getCol('misto');
  const iModel   = getCol('model');
  const iSn      = getCol('seriove');
  const iUmist   = getCol('umist');
  const iPozn    = getCol('pozn');

  const rows = lines.slice(1).map(line => {
    const cols = line.split(',').map(c => c.trim().replace(/^"|"$/g,''));
    return {
      misto:     iMisto>=0  ? cols[iMisto]  : '',
      model:     iModel>=0  ? cols[iModel]  : '',
      sn:        iSn>=0     ? cols[iSn]     : '',
      umisteni:  iUmist>=0  ? cols[iUmist]  : '',
      poznamka:  iPozn>=0   ? cols[iPozn]   : '',
    };
  }).filter(r => r.misto || r.model);

  // Seskup podle míst
  const byMisto = {};
  rows.forEach(r => {
    if(!byMisto[r.misto]) byMisto[r.misto] = [];
    if(r.model) byMisto[r.misto].push(r);
  });

  const mistaCount = Object.keys(byMisto).length;
  const klimCount  = rows.filter(r=>r.model).length;

  _csvImportData = byMisto;

  const prevEl = document.getElementById('mista-csv-preview');
  prevEl.innerHTML = `
    <div style="background:#f0fdf4;border:1px solid #86efac;border-radius:8px;padding:10px;font-size:12px;margin-bottom:8px">
      ✅ Načteno: <strong>${mistaCount} míst</strong>, <strong>${klimCount} klimatizací</strong>
    </div>
    <div style="max-height:200px;overflow-y:auto;font-size:11px">
      ${Object.entries(byMisto).slice(0,10).map(([misto, klims]) =>
        `<div style="padding:4px 8px;border-bottom:1px solid var(--border)">
          <strong>${esc(misto)}</strong> — ${klims.length} klimatizací
          ${klims.slice(0,3).map(k=>`<span style="color:var(--muted)"> · ${esc(k.model)}</span>`).join('')}
          ${klims.length>3?`<span style="color:var(--muted)"> +${klims.length-3}</span>`:''}
        </div>`
      ).join('')}
      ${mistaCount>10 ? `<div style="padding:4px 8px;color:var(--muted)">… a ${mistaCount-10} dalších míst</div>` : ''}
    </div>`;

  document.getElementById('mista-import-btn').style.display = 'inline-flex';
}

async function importMistaCsv() {
  if(!_csvImportData || !_activeMistaZakazkaId) return;
  const btn = document.getElementById('mista-import-btn');
  if(btn) { btn.disabled=true; btn.textContent='⏳ Importuji…'; }

  let mistaCreated = 0, klimCreated = 0;

  try {
    for(const [mistoNazev, klims] of Object.entries(_csvImportData)) {
      // Vytvoř nebo najdi místo
      let mistaId = (_mista.find(m => m.nazev === mistoNazev))?.id;
      if(!mistaId) {
        const ref = await window._fb.addDoc(
          window._fb.collection(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista'),
          { nazev: mistoNazev, adresa:'', poznamka:'',
            createdAt: window._fb.serverTimestamp(), updatedAt: window._fb.serverTimestamp() }
        );
        mistaId = ref.id;
        mistaCreated++;
      }

      // Přidej klimatizace
      for(const k of klims) {
        if(!k.model) continue;
        await window._fb.addDoc(
          window._fb.collection(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', mistaId, 'klimatizace'),
          { model: k.model, seriove_cislo: k.sn, umisteni: k.umisteni,
            poznamka: k.poznamka, prace:'', stav:'nova', photos:[],
            zkontrolovano: false, datum_kontroly:'',
            createdAt: window._fb.serverTimestamp(), updatedAt: window._fb.serverTimestamp() }
        );
        klimCreated++;
      }
    }

    closeModal('mista-import-modal');
    showToast && showToast(`✅ Importováno ${mistaCreated} míst, ${klimCreated} klimatizací`);
    _csvImportData = null;
  } catch(e) {
    alert('Chyba při importu: ' + e.message);
  } finally {
    if(btn) { btn.disabled=false; btn.textContent='✓ Importovat'; }
  }
}

// ── Kopírovat strukturu z jiné zakázky ───────────────────────────
async function copyMistaFromSablona() {
  const all = window._zakazky || [];
  if(!all.length) { alert('Žádné zakázky k dispozici'); return; }

  // Vytvoř dialog pro výběr
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:20px';
  modal.innerHTML = `<div style="background:var(--card);border-radius:14px;padding:20px;max-width:480px;width:100%;max-height:80vh;display:flex;flex-direction:column">
    <h3 style="margin-bottom:12px;color:var(--navy)">📋 Kopírovat strukturu míst</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Zkopíruje místa a klimatizace z vybrané zakázky (bez výsledků kontrol).</p>
    <select id="copy-zakaz-sel" style="padding:8px;border:1px solid var(--border);border-radius:8px;font-size:13px;margin-bottom:12px">
      <option value="">— Vyberte zakázku —</option>
      ${all.filter(z=>z.id!==_activeMistaZakazkaId).map(z=>
        `<option value="${z.id}">${esc(z.nazev||'—')} ${z.cislo?'('+z.cislo+')':''}</option>`
      ).join('')}
    </select>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button onclick="this.closest('.mista-copy-modal').remove()" class="btn btn-ghost">Zrušit</button>
      <button onclick="executeCopyMista(document.getElementById('copy-zakaz-sel').value)" class="btn btn-green">Kopírovat</button>
    </div>
  </div>`;
  modal.className = 'mista-copy-modal';
  modal.querySelector('button.btn-ghost').onclick = () => modal.remove();
  document.body.appendChild(modal);
}

async function executeCopyMista(sourceZakazkaId) {
  if(!sourceZakazkaId) { alert('Vyberte zakázku'); return; }
  document.querySelector('.mista-copy-modal')?.remove();

  showToast && showToast('⏳ Kopíruji strukturu míst…');

  try {
    // Načti místa ze zdrojové zakázky
    const mistaSnap = await window._fb.getDocs(
      window._fb.collection(window._fb.db, 'zakazky', sourceZakazkaId, 'mista')
    );

    let mc = 0, kc = 0;
    for(const mistaDoc of mistaSnap.docs) {
      const m = mistaDoc.data();
      const newMistaRef = await window._fb.addDoc(
        window._fb.collection(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista'),
        { nazev: m.nazev, adresa: m.adresa||'', poznamka: m.poznamka||'',
          createdAt: window._fb.serverTimestamp(), updatedAt: window._fb.serverTimestamp() }
      );
      mc++;

      // Načti klimatizace z tohoto místa
      const klimSnap = await window._fb.getDocs(
        window._fb.collection(window._fb.db, 'zakazky', sourceZakazkaId, 'mista', mistaDoc.id, 'klimatizace')
      );
      for(const klimDoc of klimSnap.docs) {
        const k = klimDoc.data();
        await window._fb.addDoc(
          window._fb.collection(window._fb.db, 'zakazky', _activeMistaZakazkaId, 'mista', newMistaRef.id, 'klimatizace'),
          { model: k.model, seriove_cislo: k.seriove_cislo||'',
            umisteni: k.umisteni||'', poznamka:'', prace:'',
            stav:'nova', photos:[], zkontrolovano:false, datum_kontroly:'',
            createdAt: window._fb.serverTimestamp(), updatedAt: window._fb.serverTimestamp() }
        );
        kc++;
      }
    }

    showToast && showToast(`✅ Zkopírováno ${mc} míst, ${kc} klimatizací`);
  } catch(e) {
    alert('Chyba: ' + e.message);
  }
}

// ── Zobraz foto ve fullscreen ─────────────────────────────────────
function showFullPhoto(url) {
  const div = document.createElement('div');
  div.style.cssText = 'position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.92);display:flex;align-items:center;justify-content:center;cursor:pointer';
  div.innerHTML = `<img src="${url}" style="max-width:95vw;max-height:95vh;object-fit:contain;border-radius:8px">`;
  div.onclick = () => div.remove();
  document.body.appendChild(div);
}

// ── Preview fotek při výběru ──────────────────────────────────────
document.getElementById('klim-foto-inp')?.addEventListener('change', e => {
  const prev = document.getElementById('klim-foto-preview');
  if(!prev) return;
  const files = Array.from(e.target.files||[]).slice(0,5);
  prev.innerHTML = '';
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      img.style.cssText = 'width:48px;height:48px;object-fit:cover;border-radius:4px';
      prev.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

// ── Keyboard shortcut pro zavření panelu ──────────────────────────
document.addEventListener('keydown', e => {
  if(e.key === 'Escape') {
    const overlay = document.getElementById('mista-overlay');
    if(overlay?.style.display === 'flex') closeMistaPanel();
  }
});

</script>
<!-- ══ PROTOKOL WIZARD ═══════════════════════════════════════════ -->
<div class="modal-overlay" id="protocol-wizard-modal">
  <div class="modal-box" style="max-width:600px;max-height:90vh;overflow-y:auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="pw-title">📋 Generovat protokol</h3>
      <button onclick="closeModal('protocol-wizard-modal')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
    </div>
    <input type="hidden" id="pw-zakaz-id">

    <!-- Info o přiřazeném protokolu -->
    <div id="pw-info" style="background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;padding:10px 14px;font-size:12px;margin-bottom:14px;color:#1e3a5f"></div>

    <!-- Výběr protokolu (přepíše zákazníkův default) -->
    <div class="fg2" style="margin-bottom:12px">
      <label>Typ protokolu</label>
      <select id="pw-typ" onchange="pwOnTypChange()" style="width:100%;padding:8px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;background:var(--card)">
        <option value="kaufland_rocni">Kaufland — Roční revize (05A)</option>
        <option value="kaufland_pulrocni">Kaufland — Půlroční revize (05B)</option>
        <option value="minobr">Ministerstvo obrany — Zápis o údržbě KJ</option>
      </select>
    </div>

    <!-- Sdílená pole -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div class="fg2">
        <label>Datum</label>
        <input type="date" id="pw-datum">
      </div>
      <div class="fg2" id="pw-smlouva-row">
        <label id="pw-smlouva-label">Číslo smlouvy</label>
        <input id="pw-smlouva" placeholder="">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div class="fg2">
        <label>Zahájení [hod]</label>
        <input type="time" id="pw-zahajeni">
      </div>
      <div class="fg2">
        <label>Ukončení [hod]</label>
        <input type="time" id="pw-ukonceni">
      </div>
    </div>

    <!-- Kaufland pole -->
    <div id="pw-kaufland-fields">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="fg2">
          <label>Objekt (filiálka)</label>
          <input id="pw-objekt" placeholder="Kaufland Praha Letňany">
        </div>
        <div class="fg2">
          <label>Domovní technik</label>
          <input id="pw-domovni-tech" placeholder="Jméno DT zákazníka">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="fg2">
          <label>Typ zařízení</label>
          <input id="pw-typ-zarizeni" placeholder="Chiller Carrier 30RB">
        </div>
        <div class="fg2">
          <label>Výrobní číslo</label>
          <input id="pw-vyrobni-cislo" placeholder="SN123456">
        </div>
      </div>
      <div class="fg2" style="margin-bottom:12px">
        <label>Rok výroby</label>
        <input id="pw-rok-vyroby" placeholder="2018" style="max-width:120px">
      </div>

      <!-- Sekce A — Provozní připravenost -->
      <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:10px">
        <div style="font-weight:700;font-size:12px;margin-bottom:8px;color:var(--navy)">A — Provozní připravenost</div>
        <div style="display:flex;gap:16px">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-provoz" value="funkční"> Funkční</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-provoz" value="nefunkční"> Nefunkční</label>
        </div>
      </div>

      <!-- Sekce B — Revizní kniha -->
      <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:10px">
        <div style="font-weight:700;font-size:12px;margin-bottom:8px;color:var(--navy)">B — Revizní kniha</div>
        <div style="display:flex;gap:16px">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-revkniha" value="k dispozici"> K dispozici</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-revkniha" value="není k dispozici"> Není k dispozici</label>
        </div>
      </div>

      <!-- Dynamické sekce dle typu -->
      <div id="pw-dynamic-sections"></div>

      <!-- Stav zařízení -->
      <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:10px">
        <div style="font-weight:700;font-size:12px;margin-bottom:8px;color:var(--navy)" id="pw-stav-label">D — Stav zařízení</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-stav" value="zelena"> 🟢 Zelená — zařízení je plně funkční</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-stav" value="zluta"> 🟡 Žlutá — vyhovující s nedostatky, následuje nabídka</label>
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="radio" name="pw-stav" value="cervena"> 🔴 Červená — zařízení nevyhovující dle Vyhl.246/2001 Sb.</label>
        </div>
      </div>
    </div>

    <!-- Ministerstvo obrany specifická pole -->
    <div id="pw-minobr-fields" style="display:none">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="fg2">
          <label>Evidenční číslo</label>
          <input id="pw-ev-cislo" placeholder="POZ-913401-2026">
        </div>
        <div class="fg2">
          <label>Vojenský útvar</label>
          <input id="pw-voj-utvar" placeholder="VÚ 3255">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="fg2">
          <label>Místo provedení</label>
          <input id="pw-misto-proven" placeholder="Praha / Olomouc">
        </div>
        <div class="fg2">
          <label>Budova / místnost</label>
          <input id="pw-budova" placeholder="B004/1NP/139">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
        <div class="fg2">
          <label>Typ klimatizační jednotky</label>
          <input id="pw-typ-kj" placeholder="ATREA DUPLEX">
        </div>
        <div class="fg2">
          <label>Výr. číslo vnitřní / vnější</label>
          <input id="pw-sn-kj" placeholder="227387 / 227387">
        </div>
      </div>
      <div class="fg2" style="margin-bottom:12px">
        <label>Chladivo</label>
        <input id="pw-chladivo" placeholder="R410A">
      </div>
      <div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:10px;font-size:12px">
        <div style="font-weight:700;margin-bottom:8px;color:var(--navy)">Provedené práce — zaškrtněte provedené:</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px" id="pw-minobr-checks"></div>
      </div>
    </div>

    <!-- Společná závěrečná pole -->
    <div class="fg2" style="margin-bottom:14px">
      <label>Závěr / Popis zjištěných skutečností a závad</label>
      <textarea id="pw-zaver" rows="4" style="resize:vertical" placeholder="Popis provedené práce, zjištěné závady, doporučení…"></textarea>
    </div>

    <div class="modal-foot">
      <button onclick="closeModal('protocol-wizard-modal')" class="btn btn-ghost">Zrušit</button>
      <button onclick="generateProtocol()" class="btn btn-green" style="font-size:13px;font-weight:700">📄 Generovat protokol</button>
    </div>
  </div>
</div>

<script>
// ════════════════════════════════════════════════════════════════
//  MODUL: ZÁKAZNICKÉ PROTOKOLY
//  Kaufland 05A (roční), Kaufland 05B (půlroční), Min. obrany
// ════════════════════════════════════════════════════════════════

// ── Kaufland sekce pro 05A (roční revize) ────────────────────────
const KL_SEKCE_ROCNI = [
  { id: 'C', label: 'Kontrola zařízení (celek)', polozky: [
    'Vizuální kontrola jednotky',
    'Ověření neporušené tepelné izolace',
    'Čištění a oprava laku dle potřeby',
  ]},
  { id: 'D', label: 'Elektroinstalace', polozky: [
    'Kontrola řídících prvků - aktualizace software',
    'Kontrola opotřebených stykačů – dle potřeby výměna',
    'Kontrola dotažení všech elektrických spojů – dle potřeby dotažení',
    'Vizuální kontrola součástí',
    'Ověření chodu kompresorů',
    'Měření izolačního odporu elektromotoru kompresoru',
  ]},
  { id: 'E', label: 'Okruh chlazení', polozky: [
    'Kontrola průtoku chladiva v kontrolním průhledítku (musí být plný kapaliny)',
    'Kontrola tlakové ztráty dehydrátoru',
    'Kontrola tlakové ztráty olejového filtru',
    'Kontrola vibrací kompresoru',
    'Analýza kyselosti oleje v kompresoru',
    'Kontrola pojistných ventilů – případná výměna',
  ]},
  { id: 'F', label: 'Kondenzátor', polozky: [
    'Chemické čištění kondenzátoru',
    'Kontrola chodu ventilátoru',
    'Kontrola žeber kondenzátoru – dle potřeby vykartáčování',
  ]},
  { id: 'G', label: 'Testy - sestavy', polozky: [
    'max. výkon při režimu chlazení',
    'Kontrola tlaků – chlazení',
    'Kontrola – proměření odběru kompresorů - ventilátorů',
    'Kontrola funkce přetlakového jističe',
  ]},
  { id: 'H', label: 'Revize okruhu chlazení', polozky: [
    'Kontrola tlaku v potrubním systému a revize úniku fluorovaných skleníkových plynů dle zákona o ochraně ovzduší (kontrola dle čl. 2 odst. 5 Nařízení EP a Rady EU č. 517/2014)',
  ]},
];

// Ministerstvo obrany — seznam prací
const MINOBR_PRACE = [
  'Kontrola funkcí',
  'Vyčištění vnitřní jednotky',
  'Vyčištění vnější jednotky',
  'Kontrola funkčnosti zimní výbavy',
  'Kontrola těsnosti okruh, doplnění chladiva',
  'Kontrola výrobních čísel jednotek',
  'Kontrola baterií v dálkovém ovládání',
  'Výměna baterií v dálkovém ovládání',
  'Kontrola kondenzačních tlaků kompresoru',
  'Seřízení kondenzačních tlaků kompresoru',
  'Kontrola elektrické části kompresoru',
  'Kontrola chodu a uložení kompresoru',
  'Kontrola motoru, ložisek a vyváženosti venkovního ventilátoru',
  'Kontrola značení a evidence v souladu s vyhláškou 201/2012 Sb. a ES 517/2014',
  'Ostatní dle specifikace údržby výrobce KJ',
];

// ── Otevřít wizard ────────────────────────────────────────────────
function openProtocolWizard(zakazkaId) {
  const z = (window._zakazky||[]).find(x => x.id === zakazkaId);
  if(!z) return;

  document.getElementById('pw-zakaz-id').value = zakazkaId;

  // Předvyplň z dat zakázky
  const dnes = new Date().toISOString().slice(0,10);
  document.getElementById('pw-datum').value = z.termin || dnes;
  document.getElementById('pw-zaver').value = z.prace || '';

  // Kaufland pole
  document.getElementById('pw-objekt').value = z.adresa || '';
  document.getElementById('pw-domovni-tech').value = '';

  // Zjisti protokol zákazníka
  const zakaznik = (window._zakaznici||[]).find(k =>
    k.nazev === z.zakaznik || k.id === z.zakaznikId
  );
  const protokolTyp = zakaznik?.protokol || 'kaufland_rocni';
  const smlouva     = zakaznik?.smlouva  || '';

  // Info řádek
  const infoEl = document.getElementById('pw-info');
  if(zakaznik?.protokol) {
    const labels = {
      kaufland_rocni:   'Kaufland — Roční revize (05A)',
      kaufland_pulrocni:'Kaufland — Půlroční revize (05B)',
      minobr:           'Ministerstvo obrany — Zápis o údržbě KJ',
    };
    infoEl.innerHTML = `<strong>Zákazník ${esc(zakaznik.nazev)}</strong> má přiřazen protokol: <strong>${labels[zakaznik.protokol]||zakaznik.protokol}</strong>`;
    infoEl.style.display = 'block';
  } else {
    infoEl.style.display = 'none';
  }

  // Nastav select
  const sel = document.getElementById('pw-typ');
  if(sel) sel.value = protokolTyp;

  // Smlouva
  document.getElementById('pw-smlouva').value = smlouva;

  // Technik
  const techJmeno = z.technik || (window._currentUser?.displayName) || '';
  // Uložíme pro použití v generování

  // Ministr. obrany specifika
  document.getElementById('pw-ev-cislo').value = '';
  document.getElementById('pw-voj-utvar').value = zakaznik?.voj_utvar || '';
  document.getElementById('pw-misto-proven').value = z.adresa || '';

  // Renderuj dynamické části
  pwOnTypChange();

  document.getElementById('protocol-wizard-modal').classList.add('open');
}

function pwOnTypChange() {
  const typ = document.getElementById('pw-typ')?.value;
  const isKaufland = typ === 'kaufland_rocni' || typ === 'kaufland_pulrocni';
  const isMinobr   = typ === 'minobr';

  document.getElementById('pw-kaufland-fields').style.display = isKaufland ? 'block' : 'none';
  document.getElementById('pw-minobr-fields').style.display   = isMinobr   ? 'block' : 'none';

  // Smlouva label
  const lbl = document.getElementById('pw-smlouva-label');
  if(lbl) lbl.textContent = isMinobr ? 'Číslo rámcové dohody' : 'Číslo rámcové smlouvy';
  const sRow = document.getElementById('pw-smlouva-row') || document.getElementById('zak-smlouva-row');

  // Stav label (I pro roční, D pro půlroční)
  const stavLbl = document.getElementById('pw-stav-label');
  if(stavLbl) {
    if(typ === 'kaufland_rocni')    stavLbl.textContent = 'I — Stav zařízení';
    else if(typ === 'kaufland_pulrocni') stavLbl.textContent = 'D — Stav zařízení';
  }

  // Dynamické sekce
  const dynEl = document.getElementById('pw-dynamic-sections');
  if(!dynEl) return;

  if(typ === 'kaufland_rocni') {
    dynEl.innerHTML = KL_SEKCE_ROCNI.map(s => renderKlSekce(s)).join('');
  } else if(typ === 'kaufland_pulrocni') {
    // 05B má jen sekci C — Revize okruhu chlazení
    dynEl.innerHTML = renderKlSekce({
      id: 'C', label: 'Revize okruhu chlazení',
      polozky: ['Kontrola tlaku v potrubním systému a revize úniku fluorovaných skleníkových plynů dle zákona o ochraně ovzduší (kontrola dle čl. 2 odst. 5 Nařízení EP a Rady EU č. 517/2014)'],
    });
  } else {
    dynEl.innerHTML = '';
  }

  // Min. obrany — checklist prací
  if(isMinobr) {
    const checksEl = document.getElementById('pw-minobr-checks');
    if(checksEl) {
      checksEl.innerHTML = MINOBR_PRACE.map((p, i) =>
        `<label style="display:flex;align-items:flex-start;gap:6px;font-size:11px;cursor:pointer;line-height:1.3">
          <input type="checkbox" id="pw-prace-${i}" value="${p}" style="margin-top:2px;flex-shrink:0"> ${p}
        </label>`
      ).join('');
    }
  }
}

function renderKlSekce(s) {
  return `<div style="background:var(--bg);border-radius:8px;padding:12px;margin-bottom:10px">
    <div style="font-weight:700;font-size:12px;margin-bottom:8px;color:var(--navy)">${s.id} — ${s.label}</div>
    <div style="display:grid;grid-template-columns:auto 1fr auto auto auto auto;gap:4px 8px;align-items:center;font-size:11px">
      <div></div><div style="color:var(--muted);font-size:10px">Položka</div>
      <div style="color:var(--muted);font-size:10px;text-align:center">OK</div>
      <div style="color:var(--muted);font-size:10px;text-align:center">Ne OK</div>
      <div style="color:var(--muted);font-size:10px;text-align:center">Napr.</div>
      <div style="color:var(--muted);font-size:10px;text-align:center">Nabíd.</div>
      ${s.polozky.map((p, i) => {
        const key = `${s.id}_${i}`;
        return `<div style="font-size:10px;color:var(--muted)">${i+1}.</div>
          <div style="font-size:11px">${p}</div>
          <div style="text-align:center"><input type="radio" name="pw-${key}" value="ok"></div>
          <div style="text-align:center"><input type="radio" name="pw-${key}" value="neok"></div>
          <div style="text-align:center"><input type="radio" name="pw-${key}" value="napraveno"></div>
          <div style="text-align:center"><input type="radio" name="pw-${key}" value="nabidka"></div>`;
      }).join('')}
    </div>
  </div>`;
}

// ── Pomocná: získej hodnotu radio group ───────────────────────────
function getRadio(name) {
  const el = document.querySelector(`input[name="${name}"]:checked`);
  return el ? el.value : '';
}

// ── Shromaždi výsledky checklist sekcí ───────────────────────────
function collectKlSekce(sekce) {
  return sekce.map(s => ({
    ...s,
    vysledky: s.polozky.map((p, i) => ({
      polozka: p,
      stav: getRadio(`pw-${s.id}_${i}`) || '',
    })),
  }));
}

// ── Generovat a zobrazit protokol ────────────────────────────────
function generateProtocol() {
  const zakazkaId = document.getElementById('pw-zakaz-id').value;
  const z = (window._zakazky||[]).find(x => x.id === zakazkaId);
  const typ = document.getElementById('pw-typ')?.value;

  const firma = window._currentFirma === 'progres'
    ? 'Progresklima CZ s.r.o.' : 'AC EURO s.r.o.';

  const common = {
    datum:    document.getElementById('pw-datum')?.value || '',
    zahajeni: document.getElementById('pw-zahajeni')?.value || '',
    ukonceni: document.getElementById('pw-ukonceni')?.value || '',
    smlouva:  document.getElementById('pw-smlouva')?.value || '',
    zaver:    document.getElementById('pw-zaver')?.value || '',
    technik:  z?.technik || (window._currentUser?.displayName) || '',
    pracovnici: z?.technik || '',
    firma,
  };

  let html;
  if(typ === 'kaufland_rocni') {
    html = genKauflandRocni(z, common);
  } else if(typ === 'kaufland_pulrocni') {
    html = genKauflandPulrocni(z, common);
  } else if(typ === 'minobr') {
    html = genMinObrany(z, common);
  } else {
    showToast && showToast('Neznámý typ protokolu');
    return;
  }

  closeModal('protocol-wizard-modal');

  // Zobraz v iframe (stejný systém jako souhrn zakázky)
  const modal = document.getElementById('souhrn-modal') ||
    (() => { const m = document.createElement('div'); m.id='souhrn-modal'; m.className='modal-overlay'; document.body.appendChild(m); return m; })();

  modal.innerHTML = `<div style="background:var(--card);border-radius:14px;width:min(900px,95vw);max-height:90vh;display:flex;flex-direction:column;overflow:hidden">
    <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <span style="font-weight:700;font-size:14px">📋 Protokol — ${esc(z?.nazev||'')}</span>
      <div style="display:flex;gap:8px">
        <button onclick="document.getElementById('proto-iframe').contentWindow.print()" class="btn btn-green" style="font-size:12px">🖨 Tisk / PDF</button>
        <button onclick="this.closest('.modal-overlay').classList.remove('open')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted)">×</button>
      </div>
    </div>
    <iframe id="proto-iframe" style="flex:1;border:none;min-height:600px"></iframe>
  </div>`;
  modal.classList.add('open');

  setTimeout(() => {
    const iframe = document.getElementById('proto-iframe');
    if(iframe) {
      iframe.contentDocument.open();
      iframe.contentDocument.write(html);
      iframe.contentDocument.close();
    }
  }, 100);
}

// ── Helpers pro generování HTML ───────────────────────────────────
function checkBox(val, target) {
  return `<span style="display:inline-block;width:14px;height:14px;border:1.5px solid #333;text-align:center;line-height:12px;font-size:10px;margin:0 2px">${val===target?'✓':''}</span>`;
}

function klRow(polozka, stav) {
  return `<tr>
    <td style="padding:3px 6px;font-size:11px">${polozka}</td>
    <td style="text-align:center;width:40px">${checkBox(stav,'ok')}</td>
    <td style="text-align:center;width:40px">${checkBox(stav,'neok')}</td>
    <td style="text-align:center;width:40px">${checkBox(stav,'napraveno')}</td>
    <td style="text-align:center;width:40px">${checkBox(stav,'nabidka')}</td>
  </tr>`;
}

function klSekceHtml(sekce_data) {
  return sekce_data.map(s => `
    <tr><td colspan="5" style="padding:6px 6px 2px;background:#f5f5f5">
      <strong style="font-size:11px">${s.id} &nbsp; ${s.label}</strong>
      <span style="float:right;font-size:10px;color:#666">OK &nbsp;&nbsp; Ne OK &nbsp;&nbsp; Napr. &nbsp;&nbsp; Nabíd.</span>
    </td></tr>
    ${s.vysledky.map(v => klRow(v.polozka, v.stav)).join('')}
  `).join('');
}

function pdfStyles() {
  return `<style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;font-size:11px;color:#000;padding:16px;background:#fff}
    table{width:100%;border-collapse:collapse}
    td,th{font-size:11px;vertical-align:top}
    .hdr-table td{padding:2px 4px;font-size:11px}
    .checklist td{border:1px solid #ccc;padding:3px 5px}
    .checklist th{border:1px solid #ccc;padding:3px 5px;background:#f5f5f5;font-size:10px;text-align:center}
    .sig-table{border-collapse:collapse;width:100%}
    .sig-table td{border:1px solid #000;padding:30px 8px 6px;font-size:10px;font-weight:bold;width:33%}
    .footer{font-size:9px;color:#666;border-top:1px solid #ccc;padding-top:4px;margin-top:10px;display:flex;justify-content:space-between}
    @media print{body{padding:8px} .no-print{display:none!important}}
    .no-print{margin-bottom:12px}
    .kaufland-logo{color:#e2000f;font-size:22px;font-weight:900;font-family:Arial;border:3px solid #e2000f;padding:2px 6px;display:inline-block}
  </style>`;
}

// ── KAUFLAND 05A — Roční revize ───────────────────────────────────
function genKauflandRocni(z, c) {
  const sekce = collectKlSekce(KL_SEKCE_ROCNI);
  const provoz  = getRadio('pw-provoz');
  const revknih = getRadio('pw-revkniha');
  const stav    = getRadio('pw-stav');
  const objekt  = document.getElementById('pw-objekt')?.value || z?.adresa || '';
  const domTech = document.getElementById('pw-domovni-tech')?.value || '';
  const typZar  = document.getElementById('pw-typ-zarizeni')?.value || '';
  const vyrobCis= document.getElementById('pw-vyrobni-cislo')?.value || '';
  const rokVyr  = document.getElementById('pw-rok-vyroby')?.value || '';
  const smlouva = c.smlouva || 'R-878-2745-2023-C';

  const datumFmt = c.datum ? c.datum.split('-').reverse().join('.') : '';
  const odpr = (c.zahajeni && c.ukonceni)
    ? (() => {
        const [h1,m1]=c.zahajeni.split(':').map(Number);
        const [h2,m2]=c.ukonceni.split(':').map(Number);
        const mins=(h2*60+m2)-(h1*60+m1);
        return mins>0 ? `${Math.floor(mins/60)}:${String(mins%60).padStart(2,'0')}` : '';
      })() : '';

  const stavColors = { zelena:'🟢', zluta:'🟡', cervena:'🔴' };

  return `<!DOCTYPE html><html lang="cs"><head><meta charset="UTF-8"><title>Kaufland 05A</title>${pdfStyles()}</head><body>
<div class="no-print"><button onclick="window.print()" style="background:#0f1f3d;color:#fff;border:none;border-radius:6px;padding:7px 16px;cursor:pointer;font-size:13px;font-weight:600">🖨 Tisk / Uložit PDF</button></div>

<!-- Hlavička -->
<table style="border:2px solid #000;border-bottom:none;margin-bottom:0">
  <tr>
    <td style="padding:8px 10px;width:80%">
      <div style="font-weight:900;font-size:13px">Příloha č. 05A k Rámcové smlouvě ${esc(smlouva)} / ${esc(c.firma)}</div>
      <div style="font-weight:700;font-size:12px">Protokol o údržbě – Zdroj chladu</div>
      <div style="font-weight:700;font-size:12px">Roční revize Zdroje chladu – březen / duben</div>
    </td>
    <td style="text-align:right;padding:8px;vertical-align:middle">
      <div class="kaufland-logo">K</div>
    </td>
  </tr>
</table>

<!-- Hlavní tabulka údajů -->
<table style="border:2px solid #000;width:100%;margin-bottom:6px" class="hdr-table">
  <tr>
    <td style="border-right:1px solid #ccc;width:20%;padding:5px 8px"><strong>Datum:</strong> ${datumFmt}</td>
    <td style="border-right:1px solid #ccc;width:40%;padding:5px 8px"><strong>Objekt:</strong> ${esc(objekt)}</td>
    <td style="padding:5px 8px"><strong>Domovní technik:</strong> ${esc(domTech)}</td>
  </tr>
  <tr>
    <td colspan="2" style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Firma:</strong> ${esc(c.firma)} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <strong>Pracovníci:</strong> ${esc(c.pracovnici)}</td>
    <td style="border-top:1px solid #ccc;padding:5px 8px"></td>
  </tr>
  <tr>
    <td style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Zahájení:</strong> ${c.zahajeni} hod</td>
    <td style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Ukončení:</strong> ${c.ukonceni} hod &nbsp;&nbsp; <strong>Odpracováno:</strong> ${odpr} hod</td>
    <td style="border-top:1px solid #ccc;padding:5px 8px"></td>
  </tr>
  <tr>
    <td colspan="2" style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Typ zařízení:</strong> ${esc(typZar)}</td>
    <td style="border-top:1px solid #ccc;padding:5px 8px"><strong>Výrobní číslo:</strong> ${esc(vyrobCis)}</td>
  </tr>
  <tr>
    <td colspan="3" style="border-top:1px solid #ccc;padding:5px 8px"><strong>Rok výroby:</strong> ${esc(rokVyr)}</td>
  </tr>
</table>

<!-- Checklist -->
<table class="checklist" style="border:1px solid #000;margin-bottom:6px">
  <tr>
    <td colspan="5" style="padding:5px 6px;background:#f0f0f0;font-weight:bold;font-size:11px">
      A &nbsp;&nbsp; <strong>Provozní připravenost</strong> před provedením údržby
      <span style="float:right">Funkční ${checkBox(provoz,'funkční')} &nbsp; Nefunkční ${checkBox(provoz,'nefunkční')}</span>
    </td>
  </tr>
  <tr>
    <td colspan="5" style="padding:5px 6px;background:#f0f0f0;font-weight:bold;font-size:11px">
      B &nbsp;&nbsp; <strong>Revizní kniha</strong> kompletně vyplněna
      <span style="float:right">K dispozici ${checkBox(revknih,'k dispozici')} &nbsp; Není k dispozici ${checkBox(revknih,'není k dispozici')}</span>
    </td>
  </tr>
  <tr style="background:#e8e8e8">
    <th style="text-align:left;padding:4px 6px">Sekce</th>
    <th>OK</th><th>Ne OK</th><th>Napraveno</th><th>Nabídka</th>
  </tr>
  ${klSekceHtml(sekce)}
</table>

<!-- Stav zařízení -->
<table style="border:1px solid #000;margin-bottom:6px;width:100%">
  <tr>
    <td style="padding:8px;background:#f0f0f0;font-weight:bold;font-size:11px;width:180px">I &nbsp;&nbsp; <strong>Stav zařízení</strong></td>
    <td style="padding:8px">
      <div>${checkBox(stav,'zelena')} Zelená &nbsp; (zařízení je plně funkční)</div>
      <div style="margin-top:3px">${checkBox(stav,'zluta')} Žlutá &nbsp;&nbsp; (vyhovující s nedostatky, následuje nabídka)</div>
      <div style="margin-top:3px">${checkBox(stav,'cervena')} Červená (zařízení je nevyhovující dle Vyhl.246/2001 Sb.)</div>
    </td>
  </tr>
</table>

<!-- Závěr -->
<div style="border:1px solid #000;padding:8px;margin-bottom:6px;min-height:80px">
  <div style="font-weight:bold;font-size:11px;margin-bottom:6px">Závěr / Poznámky:</div>
  <div style="font-size:11px;white-space:pre-wrap">${esc(c.zaver)}</div>
  ${Array(6).fill('<div style="border-bottom:1px dotted #ccc;height:18px;margin-top:4px"></div>').join('')}
</div>

<!-- Podpisy -->
<table class="sig-table">
  <tr>
    <td>Razítko filiálky, Podpis VOD + DT</td>
    <td>Datum</td>
    <td>Podpis technika dodavatele</td>
  </tr>
</table>

<div class="footer">
  <span>© Kaufland Česká republika v.o.s., Praha 6, Bělohorská 203, PSČ 169 00, IČ: 25110161 &nbsp; ze dne 22.06.2023</span>
  <span>Strana 1 z 2</span>
</div>
</body></html>`;
}

// ── KAUFLAND 05B — Půlroční revize ────────────────────────────────
function genKauflandPulrocni(z, c) {
  const provoz  = getRadio('pw-provoz');
  const revknih = getRadio('pw-revkniha');
  const stav    = getRadio('pw-stav');
  const sekceC  = collectKlSekce([{
    id:'C', label:'Revize okruhu chlazení',
    polozky:['Kontrola tlaku v potrubním systému a revize úniku fluorovaných skleníkových plynů dle zákona o ochraně ovzduší (kontrola dle čl. 2 odst. 5 Nařízení EP a Rady EU č. 517/2014)'],
  }]);
  const objekt  = document.getElementById('pw-objekt')?.value || z?.adresa || '';
  const domTech = document.getElementById('pw-domovni-tech')?.value || '';
  const typZar  = document.getElementById('pw-typ-zarizeni')?.value || '';
  const vyrobCis= document.getElementById('pw-vyrobni-cislo')?.value || '';
  const rokVyr  = document.getElementById('pw-rok-vyroby')?.value || '';
  const smlouva = c.smlouva || 'R-878-2745-2023-C';
  const datumFmt = c.datum ? c.datum.split('-').reverse().join('.') : '';

  return `<!DOCTYPE html><html lang="cs"><head><meta charset="UTF-8"><title>Kaufland 05B</title>${pdfStyles()}</head><body>
<div class="no-print"><button onclick="window.print()" style="background:#0f1f3d;color:#fff;border:none;border-radius:6px;padding:7px 16px;cursor:pointer;font-size:13px;font-weight:600">🖨 Tisk / Uložit PDF</button></div>

<table style="border:2px solid #000;border-bottom:none">
  <tr>
    <td style="padding:8px 10px">
      <div style="font-weight:900;font-size:13px">Příloha č. 05B k Rámcové smlouvě ${esc(smlouva)} / ${esc(c.firma)}</div>
      <div style="font-weight:700;font-size:12px">Protokol o údržbě – Zdroj chladu</div>
      <div style="font-weight:700;font-size:12px">Půlroční revize okruhu chlazení (únik chladiva) – září / říjen</div>
    </td>
    <td style="text-align:right;padding:8px;vertical-align:middle"><div class="kaufland-logo">K</div></td>
  </tr>
</table>

<table style="border:2px solid #000;width:100%;margin-bottom:6px" class="hdr-table">
  <tr>
    <td style="border-right:1px solid #ccc;width:25%;padding:5px 8px"><strong>Datum:</strong> ${datumFmt}</td>
    <td style="border-right:1px solid #ccc;width:40%;padding:5px 8px"><strong>Objekt:</strong> ${esc(objekt)}</td>
    <td style="padding:5px 8px"><strong>Domovní technik:</strong> ${esc(domTech)}</td>
  </tr>
  <tr>
    <td colspan="2" style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Firma:</strong> ${esc(c.firma)} &nbsp;&nbsp;&nbsp; <strong>Pracovníci:</strong> ${esc(c.pracovnici)}</td>
    <td style="border-top:1px solid #ccc"></td>
  </tr>
  <tr>
    <td style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Zahájení:</strong> ${c.zahajeni} hod</td>
    <td style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Ukončení:</strong> ${c.ukonceni} hod</td>
    <td style="border-top:1px solid #ccc;padding:5px 8px"></td>
  </tr>
  <tr>
    <td colspan="2" style="border-right:1px solid #ccc;border-top:1px solid #ccc;padding:5px 8px"><strong>Typ zařízení:</strong> ${esc(typZar)}</td>
    <td style="border-top:1px solid #ccc;padding:5px 8px"><strong>Výrobní číslo:</strong> ${esc(vyrobCis)}</td>
  </tr>
  <tr><td colspan="3" style="border-top:1px solid #ccc;padding:5px 8px"><strong>Rok výroby:</strong> ${esc(rokVyr)}</td></tr>
</table>

<table class="checklist" style="border:1px solid #000;margin-bottom:6px">
  <tr>
    <td colspan="5" style="padding:5px 6px;background:#f0f0f0;font-weight:bold">
      A &nbsp;&nbsp; <strong>Provozní připravenost</strong> před provedením údržby
      <span style="float:right">Funkční ${checkBox(provoz,'funkční')} &nbsp; Nefunkční ${checkBox(provoz,'nefunkční')}</span>
    </td>
  </tr>
  <tr>
    <td colspan="5" style="padding:5px 6px;background:#f0f0f0;font-weight:bold">
      B &nbsp;&nbsp; <strong>Revizní kniha</strong>
      <span style="float:right">K dispozici ${checkBox(revknih,'k dispozici')} &nbsp; Není k dispozici ${checkBox(revknih,'není k dispozici')}</span>
    </td>
  </tr>
  <tr style="background:#e8e8e8">
    <th style="text-align:left;padding:4px 6px">Sekce</th>
    <th>OK</th><th>Ne OK</th><th>Napraveno</th><th>Nabídka</th>
  </tr>
  ${klSekceHtml(sekceC)}
  <tr><td colspan="5" style="padding:4px 8px;border-top:1px solid #ccc;font-size:10px;color:#666">……………………………………………………………………………………………………</td></tr>
</table>

<table style="border:1px solid #000;margin-bottom:6px;width:100%">
  <tr>
    <td style="padding:8px;background:#f0f0f0;font-weight:bold;width:160px">D &nbsp;&nbsp; <strong>Stav zařízení</strong></td>
    <td style="padding:8px">
      <div>${checkBox(stav,'zelena')} Zelená &nbsp; (zařízení je plně funkční)</div>
      <div style="margin-top:3px">${checkBox(stav,'zluta')} Žlutá &nbsp;&nbsp; (vyhovující s nedostatky, následuje nabídka)</div>
      <div style="margin-top:3px">${checkBox(stav,'cervena')} Červená (zařízení je nevyhovující dle Vyhl.246/2001 Sb.)</div>
    </td>
  </tr>
</table>

<div style="border:1px solid #000;padding:8px;margin-bottom:6px;min-height:100px">
  <div style="font-weight:bold;margin-bottom:6px">Závěr / Poznámky:</div>
  <div style="font-size:11px;white-space:pre-wrap">${esc(c.zaver)}</div>
  ${Array(6).fill('<div style="border-bottom:1px dotted #ccc;height:18px;margin-top:4px"></div>').join('')}
</div>

<table class="sig-table">
  <tr>
    <td>Razítko filiálky, Podpis VOD + DT</td>
    <td>Datum</td>
    <td>Podpis technika dodavatele</td>
  </tr>
</table>

<div class="footer">
  <span>© Kaufland Česká republika v.o.s., Praha 6, Bělohorská 203, PSČ 169 00, IČ: 25110161 &nbsp; ze dne 22.06.2023</span>
  <span>Strana 1 z 1</span>
</div>
</body></html>`;
}

// ── MINISTERSTVO OBRANY ───────────────────────────────────────────
function genMinObrany(z, c) {
  const evCislo  = document.getElementById('pw-ev-cislo')?.value  || '';
  const vojUtvar = document.getElementById('pw-voj-utvar')?.value || '';
  const misto    = document.getElementById('pw-misto-proven')?.value || z?.adresa || '';
  const budova   = document.getElementById('pw-budova')?.value    || '';
  const typKJ    = document.getElementById('pw-typ-kj')?.value    || '';
  const snKJ     = document.getElementById('pw-sn-kj')?.value     || '';
  const chladivo = document.getElementById('pw-chladivo')?.value  || '';
  const smlouva  = c.smlouva || '25106000371';
  const datumFmt = c.datum ? c.datum.split('-').reverse().join('.') : '';

  // Provedené práce — checked items
  const provedenePrace = MINOBR_PRACE.filter((p, i) => {
    const el = document.getElementById(`pw-prace-${i}`);
    return el?.checked;
  });

  // Rozdělení do dvou sloupců (8+7)
  const leva  = provedenePrace.slice(0, Math.ceil(provedenePrace.length/2));
  const prava = provedenePrace.slice(Math.ceil(provedenePrace.length/2));
  const maxR  = Math.max(leva.length, prava.length);

  const pracoRadky = [];
  for(let i=0; i<maxR; i++) {
    pracoRadky.push(`<tr>
      <td style="border:1px solid #ccc;padding:3px 6px;font-size:11px">✓ ${esc(leva[i]||'')}</td>
      <td style="border:1px solid #ccc;padding:3px 6px;font-size:11px">✓ ${esc(prava[i]||'')}</td>
    </tr>`);
  }

  return `<!DOCTYPE html><html lang="cs"><head><meta charset="UTF-8"><title>Min. obrany — Zápis o údržbě</title>${pdfStyles()}</head><body>
<div class="no-print"><button onclick="window.print()" style="background:#0f1f3d;color:#fff;border:none;border-radius:6px;padding:7px 16px;cursor:pointer;font-size:13px;font-weight:600">🖨 Tisk / Uložit PDF</button></div>

<!-- Záhlaví -->
<div style="border:2px solid #000;padding:10px 14px;margin-bottom:8px">
  <div style="font-weight:900;font-size:14px;text-align:center;margin-bottom:4px">ZÁPIS O PROVEDENÉ ÚDRŽBĚ KLIMATIZAČNÍ JEDNOTKY</div>
  <div style="text-align:center;font-size:12px">dle Rámcové dohody č. ${esc(smlouva)}</div>
</div>

<!-- Smluvní strany -->
<table style="border:1px solid #000;width:100%;margin-bottom:6px" class="hdr-table">
  <tr>
    <td style="border-right:1px solid #000;width:50%;padding:5px 8px;vertical-align:top">
      <div><strong>${esc(vojUtvar||'Vojenský útvar')}</strong></div>
    </td>
    <td style="padding:5px 8px;vertical-align:top">
      <div><strong>Datum a čas:</strong> ${datumFmt} ${c.zahajeni}</div>
      <div><strong>Evidenční číslo:</strong> ${esc(evCislo)}</div>
    </td>
  </tr>
  <tr style="border-top:1px solid #ccc">
    <td style="border-right:1px solid #000;padding:5px 8px;font-weight:bold">Objednatel:</td>
    <td style="padding:5px 8px;font-weight:bold">Poskytovatel:</td>
  </tr>
  <tr>
    <td style="border-right:1px solid #000;padding:4px 8px;font-size:11px">
      Česká republika – Ministerstvo obrany<br>
      ${esc(misto||'Praha 6')}<br>
      zastoupena: Ředitelem vojenského útvaru
    </td>
    <td style="padding:4px 8px;font-size:11px">
      ${esc(c.firma)}<br>
      Sídlo: Houbalova 2553/4, 628 00 Brno<br>
      IČ: 60707780 &nbsp; DIČ: CZ60707780<br>
      zastoupen: Ing. Jiřím Čtvrtníčkem, jednatel
    </td>
  </tr>
</table>

<!-- Detaily zakázky -->
<table style="border:1px solid #000;width:100%;margin-bottom:6px" class="hdr-table">
  <tr>
    <td style="border-right:1px solid #ccc;width:40%;padding:5px 8px"><strong>Datum a čas provedení:</strong></td>
    <td style="padding:5px 8px">${datumFmt} &nbsp; ${c.zahajeni}–${c.ukonceni}</td>
  </tr>
  <tr style="border-top:1px solid #ccc">
    <td style="border-right:1px solid #ccc;padding:5px 8px"><strong>Místo:</strong></td>
    <td style="padding:5px 8px">${esc(misto)}</td>
  </tr>
  <tr style="border-top:1px solid #ccc">
    <td style="border-right:1px solid #ccc;padding:5px 8px"><strong>Budova / místnost:</strong></td>
    <td style="padding:5px 8px">${esc(budova)}</td>
  </tr>
  <tr style="border-top:1px solid #ccc">
    <td style="border-right:1px solid #ccc;padding:5px 8px"><strong>Typ klimatizační jednotky:</strong></td>
    <td style="padding:5px 8px">${esc(typKJ)}</td>
  </tr>
  <tr style="border-top:1px solid #ccc">
    <td style="border-right:1px solid #ccc;padding:5px 8px"><strong>Výrobní číslo vnitřní / vnější:</strong></td>
    <td style="padding:5px 8px">${esc(snKJ)}</td>
  </tr>
  <tr style="border-top:1px solid #ccc">
    <td style="border-right:1px solid #ccc;padding:5px 8px"><strong>Chladivo:</strong></td>
    <td style="padding:5px 8px">${esc(chladivo)}</td>
  </tr>
</table>

<!-- Provedené práce -->
${provedenePrace.length ? `<div style="border:1px solid #000;margin-bottom:6px">
  <div style="background:#f0f0f0;font-weight:bold;font-size:11px;padding:5px 8px;border-bottom:1px solid #000">Provedené práce:</div>
  <table style="width:100%;border-collapse:collapse">${pracoRadky.join('')}</table>
</div>` : ''}

<!-- Závěr -->
<div style="border:1px solid #000;padding:8px;margin-bottom:8px;min-height:80px">
  <div style="font-weight:bold;font-size:11px;margin-bottom:6px">Popis zjištěných skutečností, závad a návrh jejich odstranění:</div>
  <div style="font-size:11px;white-space:pre-wrap">${esc(c.zaver)}</div>
  ${Array(5).fill('<div style="border-bottom:1px dotted #ccc;height:18px;margin-top:4px"></div>').join('')}
</div>

<!-- Podpisy Předal/Převzal -->
<table class="sig-table">
  <tr>
    <td style="padding:6px 8px 2px;font-weight:bold;width:120px"></td>
    <td style="padding:6px 8px 2px;font-weight:bold;width:200px">Za</td>
    <td style="padding:6px 8px 2px;font-weight:bold">Jméno a příjmení</td>
    <td style="padding:6px 8px 2px;font-weight:bold">Podpis</td>
  </tr>
  <tr>
    <td style="border:1px solid #000;padding:24px 8px 6px;font-weight:bold">Předal</td>
    <td style="border:1px solid #000;padding:24px 8px 6px">${esc(c.firma)}</td>
    <td style="border:1px solid #000;padding:24px 8px 6px">${esc(c.technik)}</td>
    <td style="border:1px solid #000;padding:24px 8px 6px"></td>
  </tr>
  <tr>
    <td style="border:1px solid #000;padding:24px 8px 6px;font-weight:bold">Převzal</td>
    <td style="border:1px solid #000;padding:24px 8px 6px">${esc(vojUtvar)}</td>
    <td style="border:1px solid #000;padding:24px 8px 6px"></td>
    <td style="border:1px solid #000;padding:24px 8px 6px"></td>
  </tr>
</table>
</body></html>`;
}

// ── Patch saveZakaznik a openZakaznikModal pro nová pole ──────────
(function patchZakaznikForms() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if((typeof saveZakaznik !== 'undefined' && typeof openZakaznikModal !== 'undefined') || tries > 40) {
      clearInterval(iv);

      // Patch saveZakaznik — přidej protokol a smlouva
      if(typeof saveZakaznik !== 'undefined') {
        const prevSave = saveZakaznik;
        saveZakaznik = async function() {
          // Přidej nová pole do data před uložením
          const origDoc = window._fb.doc;
          const origUpdate = window._fb.updateDoc;
          const origAdd = window._fb.addDoc;

          // Hook: přidej pole do dalšího volání
          window._fb._protokolPatch = {
            protokol: document.getElementById('zak-protokol')?.value || '',
            smlouva:  document.getElementById('zak-smlouva')?.value.trim() || '',
          };
          await prevSave();
          window._fb._protokolPatch = null;
        };
      }

      // Patch openZakaznikModal — načti nová pole
      if(typeof openZakaznikModal !== 'undefined') {
        const prevOpen = openZakaznikModal;
        openZakaznikModal = function(id) {
          prevOpen(id);
          setTimeout(() => {
            const z = id ? (window._zakaznici||[]).find(x=>x.id===id) : null;
            const sel = document.getElementById('zak-protokol');
            const sInp= document.getElementById('zak-smlouva');
            if(sel)  sel.value  = z?.protokol || '';
            if(sInp) sInp.value = z?.smlouva  || '';
            // Ukaž smlouva pole
            const sRow = document.getElementById('zak-smlouva-row');
            if(sRow) sRow.style.display = (z?.protokol) ? 'block' : 'none';
          }, 50);
        };
      }

      // Show/hide smlouva row při změně protokolu
      const sel = document.getElementById('zak-protokol');
      if(sel) {
        sel.addEventListener('change', () => {
          const sRow = document.getElementById('zak-smlouva-row');
          if(sRow) sRow.style.display = sel.value ? 'block' : 'none';
        });
      }
    }
  }, 300);
})();

// Patch Firestore update/addDoc pro protokol pole
(function patchFirestoreForProtokol() {
  let tries = 0;
  const iv = setInterval(() => {
    tries++;
    if(window._fb?.updateDoc || tries > 40) {
      clearInterval(iv);
      if(!window._fb?.updateDoc) return;

      const origUpdate = window._fb.updateDoc;
      window._fb.updateDoc = async function(ref, data, ...args) {
        if(window._fb._protokolPatch && ref.path?.includes('zakaznici')) {
          data = { ...data, ...window._fb._protokolPatch };
        }
        return origUpdate(ref, data, ...args);
      };

      const origAdd = window._fb.addDoc;
      window._fb.addDoc = async function(col, data, ...args) {
        if(window._fb._protokolPatch && col.path?.includes('zakaznici')) {
          data = { ...data, ...window._fb._protokolPatch };
        }
        return origAdd(col, data, ...args);
      };
    }
  }, 500);
})();

</script>
</body>
</html>`;

  // Zobraz souhrn v inline modalu
  showSouhrn(html, z);
}

function showSouhrn(htmlContent, z) {
  // Vytvoř nebo najdi modal
  let modal = document.getElementById('souhrn-view-modal');
  if(!modal) {
    modal = document.createElement('div');
    modal.id = 'souhrn-view-modal';
    modal.style.cssText = 'position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.6);display:flex;align-items:flex-start;justify-content:center;overflow-y:auto;padding:16px';
    modal.innerHTML = `
      <div style="background:#fff;border-radius:14px;width:100%;max-width:740px;min-height:200px;display:flex;flex-direction:column;margin:auto;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3)">
        <div id="souhrn-view-topbar" style="display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:#0f1f3d;flex-shrink:0">
          <span style="color:#fff;font-size:13px;font-weight:700" id="souhrn-view-title">Souhrn zakázky</span>
          <div style="display:flex;gap:8px">
            <button id="souhrn-print-btn" onclick="printSouhrnView()"
              style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:7px;padding:5px 12px;cursor:pointer;font-size:12px;font-family:inherit;display:flex;align-items:center;gap:5px">
              <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
              Tisknout / PDF
            </button>
            <button onclick="closeSouhrnView()"
              style="background:none;border:none;color:rgba(255,255,255,.7);font-size:22px;cursor:pointer;line-height:1;padding:0 4px">×</button>
          </div>
        </div>
        <iframe id="souhrn-view-iframe" style="flex:1;border:none;width:100%;min-height:75vh"></iframe>
      </div>`;
    modal.addEventListener('click', e => { if(e.target === modal) closeSouhrnView(); });
    document.body.appendChild(modal);
  }

  // Nastav obsah
  document.getElementById('souhrn-view-title').textContent =
    'Souhrn: ' + (z.cislo||'') + ' — ' + (z.nazev||'Zakázka');

  // Injektuj HTML do iframe (funguje offline, bez popup blokace)
  const iframe = document.getElementById('souhrn-view-iframe');
  // Odeber tlačítka Tisknout/Zavřít uvnitř iframe (máme je v topbaru)
  const cleanHtml = htmlContent.replace(
    /<div class="no-print"[\s\S]*?<\/div>\s*<\/div>/,
    ''
  );
  iframe.srcdoc = cleanHtml;

  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeSouhrnView() {
  const modal = document.getElementById('souhrn-view-modal');
  if(modal) modal.style.display = 'none';
  document.body.style.overflow = '';
}

function printSouhrnView() {
  const iframe = document.getElementById('souhrn-view-iframe');
  if(iframe?.contentWindow) {
    iframe.contentWindow.print();
  }
}

</script>
</body>
</html>